<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Henry Blog</title>
  <subtitle>Javaer</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://hjcenry.github.io/"/>
  <updated>2016-10-22T15:37:00.000Z</updated>
  <id>http://hjcenry.github.io/</id>
  
  <author>
    <name>Henry He</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>SLG手游Java服务器数据管理方案</title>
    <link href="http://hjcenry.github.io/2016/10/22/SLG%E6%89%8B%E6%B8%B8Java%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86%E6%96%B9%E6%A1%88/"/>
    <id>http://hjcenry.github.io/2016/10/22/SLG手游Java服务器数据管理方案/</id>
    <published>2016-10-22T07:25:00.000Z</published>
    <updated>2016-10-22T15:37:00.000Z</updated>
    
    <content type="html"><![CDATA[<ul>
<li><code>文章版权归腾讯GAD所有，禁止匿名转载；禁止商业使用；禁止个人使用。</code></li>
</ul>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这一年左右的时间，我参与并完成了一款SLG手游的研发，我负责游戏的服务端研发。这是一款以三国为题材的游戏，除了有三国名将的卡牌养成、多种多样装备养成、PVE，玩家竞技场等常见玩法外，我们的游戏的主打特色是国战和军团战，目前我们正在进行国战部分的开发和优化，军团战部分仍在策划中。<a id="more"></a>军团战预计是一种以公会形式存在的策略玩法，国战是全服玩家达到一定等级就可以参与的混战玩法，玩家的阵营由玩家创建角色时选择的国家（魏蜀吴）决定，进入国战地图之后，服务器会根据玩家选择的国家分配阵营，然后玩家就可以在世界地图中进行攻打敌国城池，在世界地图中，除了三国城池，还有一些资源城池和关隘城池，玩家占领资源城池可以获得一定的资源收益，而关隘一般是设定在两国交界处，只有打通了关隘城池，国家内的人才能通过关隘攻打帝国，这一系列的玩法都非常具有策略性，需要同国玩家之间的相互协作才能共同立足于三国之中。国战的过程中，玩家在混战的同时也能获得一部分的收益。整个国战的玩法充分体现了SLG的策略性。<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/IMG_1145.PNG" alt="游戏截图1"><br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/IMG_1155.PNG" alt="游戏截图2"><br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/IMG_0653.PNG" alt="游戏截图3"><br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/IMG_1148.PNG" alt="游戏截图4"><br>前文主要讲解我们的游戏的功能和玩法，大家应该都知道，一款游戏里，处处都充满了“数据”，有关卡配置数据，有人物属性数据，有玩家基础数据等，正是这些各种各样的数据，才让我们在游戏中更加数字化的感知游戏的乐趣，本文就从游戏服务器的“数据”角度，来分享我们的游戏的数据管理方案。本文的内容只针对我们的游戏的一种解决方案，不包括其他游戏的解决方案，相信不同的游戏中，架构师应该会对数据管理有不同的解决方案，但万变不离其宗，我们只需掌握数据管理中的核心概念，就可以轻松自如的应对各种应用场景下的数据管理。</p>
<p>我们的游戏服务器的技术架构是用Java来做的，使用Java作为游戏服务器开发语言的成功案例已经越来越多了，Java的网络应用技术也是越来越成熟，不说太多的语言之争，总之最后，我们选用了Java作为了整个游戏服务器的技术支撑，其中网络通信采用Netty，数据与缓存分别选用了MySQL，Memcache和Redis。本文主要讲解数据管理，因此重点也就是讲解MySQL。Memcache和Redis是如何在我们的服务器架构中应用的。</p>
<h2 id="数据分析"><a href="#数据分析" class="headerlink" title="数据分析"></a>数据分析</h2><p>在开始讲解如何具体实施之间，我们可以先对游戏中的数据进行一个简单的分析。相信大家一定都常玩游戏，一定可以感觉到，游戏中的虽然处处是数据，但各种数据的性质又不完全一样，比如怪物的攻击力，防御力等战斗属性，一般情况是一组静态数据，这部分数据可以由策划在配置关卡时提前配置好，而玩家的战斗属性，却是玩家在游戏中一系列养成的综合因素所决定，这是一组动态的数据。按照宏观上分，游戏数据大致就可以分为静态数据和动态数据，静态数据，如签到奖励，战斗掉落，抽卡概率等内容，一般情况下均由策划配置好静态表，服务器启动时直接读取静态表，将表中内容加载到服务器内存，使用时直接从内存读取，而动态数据，是根据玩家的游戏进度所决定的，因此这部分数据就需要一个数据管理系统来统一管理，也就是我们常用的数据库，这部分的数据我又细分为热数据和冷数据，热数据指游戏中操作频繁的数据，如体力恢复时间，抽卡免费次数，国战城池状态等，这部分的数据的特点，就是读写频繁，并且其数据结构也是复杂多变的，玩家的每一步操作，都可能涉及到这部分数据的读取或更新。相反，冷数据，则泛指游戏中更新并不频繁，却仍然十分重要的数据，如君主信息，卡牌信息，装备信息等，这部分的数据可能只有特定的操作才会触发这部分数据的变化，比如卡牌的星级，只有当玩家进行了卡牌升星操作，卡牌的星级才有可能发生变化，这部分的数据，更新不频繁，且数据结构稳定，一般在一开始就已经设计好，这部分数据，非常易于管理。基于以上总结，可以得出如下分类图：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/GameData.png" alt="游戏数据"></p>
<h2 id="技术选型"><a href="#技术选型" class="headerlink" title="技术选型"></a>技术选型</h2><h3 id="静态数据"><a href="#静态数据" class="headerlink" title="静态数据"></a>静态数据</h3><p>游戏中的静态数据，一般由策划进行配置，一般情况下是xml文件或csv文件，在我们的游戏中，我们采用了读取策划配置的csv文件来获取游戏中的静态数据，服务器启动时加载游戏中的csv静态数据，把所有的静态数据加载到Java的内存中，用Map进行管理。我们的游戏中，使用静态数据的步骤如下：<br>1.读取csv文件<br>2.按一定格式对文件内容进行解析<br>3.将内容封装到JavaBean<br>4.存放数据到Map中<br>5.从Map中取出数据使用（使用时）<br>当然读取静态数据，也有其他的形式，比如配置xml表，从xml表中读取数据，这里说的只是我们的采用的其中一种形式。</p>
<h3 id="热数据"><a href="#热数据" class="headerlink" title="热数据"></a>热数据</h3><p>一说到频繁交互，大家第一反应一定是内存，是的，Redis就是一款基于内存的数据库，网上有很多帖子说Redis会如何如何吃内存，在大数据量下的效率如何低下，其实我认为，Redis，它只是一款内存数据库，至于它会发挥怎样的功效，还是得看我们如何去使用它，有一把好枪不代表我们就有了好枪法，还是得根据我们自己的应用场景，合理运用。我也说说我为什么选择Redis的原因吧：<br>1.Redis是内存数据，其操作均基于内存，可以满足我的“频繁”需求<br>2.虽然是内存数据库，但同时它也具有RDB和AOF两种持久化功能，可以满足我的“存储”需求<br>3.Redis支持String，Set，List，Sorted Set和Hash五种数据结构，丰富的数据结构，可以满足我的“数据结构复杂多变”需求<br>4.Redis可以很容易实现cluster以及主从等分布式扩展，可以满足我的“数据扩展性”需求<br>当然，Redis的优点远远不止以上四点，但从这四点来说，我觉得Redis就非常适合作为我的游戏动态数据中的热数据的存储。</p>
<h3 id="冷数据"><a href="#冷数据" class="headerlink" title="冷数据"></a>冷数据</h3><p>前文分析到这部分数据的特点是更新不频繁且数据结构稳定，我们采用MySQL来存储这部分数据，MySQL不仅结构清晰，更是方便数据管理。MySQL也有许多很适合我们这部分数据的特点：<br>1.关系型数据库，支持标准的SQL语言，适合结构化的数据<br>2.支持多种列类型，能存储各种数据格式<br>3.多线程运行，高并发环境下高效稳定<br>4.支持事务控制<br>以上我只列举了我认为比较重要的四点，MySQL已经足以满足我对冷数据的所有存储需求。</p>
<h3 id="缓存数据"><a href="#缓存数据" class="headerlink" title="缓存数据"></a>缓存数据</h3><p>这部分数据是在前文在数据分析中没有提到的，因为这部分数据，只是临时的，严格的说，如果不需要考虑服务器的效率问题，没有缓存也是可以照常运行的。缓存的出现是为了减轻服务器的负载，我们可以把客户端的请求全部交给缓存去做，缓存再通过一定的策略与数据库同步，这样，我们就不必要重复的查找或插入同一条数据。这就相当于，在客户端和数据库中间，添加一个挡板，这个挡板先行对数据进行过滤处理，而缓存就是这个挡板。我认为，在服务器中，缓存是一门艺术，用好了缓存，可以让整个架构都看起来赏心悦目。在缓存技术上，我选择Memcache，Memcache作为内存数据库，在高并发及大数据下的性能都是不错的，Memcache采用一致性Hash算法，并且具有数据分布式的特点。</p>
<h2 id="技术实现"><a href="#技术实现" class="headerlink" title="技术实现"></a>技术实现</h2><h3 id="Redis存储数据"><a href="#Redis存储数据" class="headerlink" title="Redis存储数据"></a>Redis存储数据</h3><p>对于我们游戏中需要使用Redis存储的部分热数据，我做了如下总结:<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/Redis%E6%95%B0%E6%8D%AE.png" alt="Redis数据"><br>使用Redis，除了要理解Redis的内存模型原理外，首先还得了解Redis的五种基本数据类型，每一种数据类型都对应不同的Redis操作API，在Java中使用Redis可以使用官方提供的Jedis客户端，Jedis客户端中包含了各种数据类型的操作。Redis既可以作为单服务器使用，也可以做cluster或主从的集群扩展，方便日益庞大的游戏数据的扩展。</p>
<h3 id="MySQL存储数据"><a href="#MySQL存储数据" class="headerlink" title="MySQL存储数据"></a>MySQL存储数据</h3><p>在游戏数据中，我对游戏中的冷数据做了一个总结，如下图所示：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/Mysql%E6%95%B0%E6%8D%AE.png" alt="Mysql数据"><br>完成要存储的游戏数据的分析之后，我们就可以进行具体建模建表的工作，完成对数据的设计。由于在游戏服务器的数据存储中，数据库基本上只是一个玩家下线后的游戏数据临时存放的地方，所以游戏数据表中的关联性并不是特别强，不需要特别严密的数据库设计，只需简单的将玩家所有的数据按照一个userid进行关联即可。<br>我们使用Druid和Hibernate来管理数据库的连接以及进行增删改查的操作。在使用Hibernate的时候，我们使用了Hibernate4，我们只需将需要存储的Model写成JavaBean，并加上作为数据Model的注解，在启动时，Hibernate扫描到JavaBean会自动为我们创建或更新表结构。</p>
<h4 id="Druid数据库连接池"><a href="#Druid数据库连接池" class="headerlink" title="Druid数据库连接池"></a>Druid数据库连接池</h4><p>游戏服务器运行中经常是多个玩家同时在线的，可想而知，如果同时进行某一项涉及数据库的操作时，会并发请求数据库，多个数据库请求就需要我们对多个数据库连接进行有效的管理，当然，我们可以自己写一个数据库连接池来进行数据库管理，但好在前辈们为我们做足了工作，有很多成型的开源数据库连接池可供我们选择，常见的有c3p0、dbcp、proxool和driud等，这里我们使用阿里巴巴公司的开源产品Druid，这是我个人认为最好用的数据库连接池，它不仅提供了数据库连接池应有的功能，更是提供了良好的数据库监控性能，这是我们作为开发人员在遇到性能瓶颈时最需要的东西，感兴趣的朋友可以参考下官方github，根据官方wiki配置一个Druid的数据监控系统，通过系统可以查看数据库的各种性能指标。<br>Druid在github中的地址是：<a href="https://github.com/alibaba/druid" target="_blank" rel="external">https://github.com/alibaba/druid</a></p>
<h4 id="Hibernate"><a href="#Hibernate" class="headerlink" title="Hibernate"></a>Hibernate</h4><p>使用Hibernate作为Mysql数据库的ORM框架，主要是因为其良好的封装，首先我个人认为Hibernate的性能是不足与和原生JDBC以及MyBatis这样的框架所匹敌的，封装的更好却带来了更多的性能损失，但我使用他也是看中他良好的封装性，因为我对性能的需求还没有达到很高的级别；其次，Hibernate不适用于写复杂的SQL查询，而MyBatis可以写出一些复杂的SQL。但在我的设计中，我不需要太复杂的查询，基本上我所有的SQL语句的where条件都是”where userid=?”，因此在性能需求上以及易用的对比上，我选择了Hibernate。</p>
<h3 id="Memcache缓存数据"><a href="#Memcache缓存数据" class="headerlink" title="Memcache缓存数据"></a>Memcache缓存数据</h3><p>Memcache作为一种内存数据库，经常用作应用系统的缓存系统，在我们的游戏服务器中，我使用Memcache应用在三处地方。<br>1.MySQL的数据表主键自增ID的生成<br>2.MySQL的查询结果集的缓存<br>3.国战数据缓存</p>
<h4 id="MySQL数据表ID生成器"><a href="#MySQL数据表ID生成器" class="headerlink" title="MySQL数据表ID生成器"></a>MySQL数据表ID生成器</h4><p>在数据库的设计中，我们的主键ID是自增，但由于自增ID也是会消耗一定的MySQL性能的，因此我使用Memcache封装了一个ID生成器，其原理就是利用Memcache的incr方法实现ID的自增，Memcache的incr方法是并发安全的，能保证在多线程环境下，MySQL的数据表ID的唯一。</p>
<h4 id="MySQL查询结果集的缓存"><a href="#MySQL查询结果集的缓存" class="headerlink" title="MySQL查询结果集的缓存"></a>MySQL查询结果集的缓存</h4><p>我在将Memcache引入到项目作为Mysql数据结果集的缓存系统的过程中，曾进行了多种缓存方案的尝试，具体有以下几种缓存模型：<br>1.无缓存<br>这种方式不使用Memcache缓存，游戏服务器的操作直接穿透到Mysql中，这种方式在高并发环境下容易引起Mysql服务器高负载情况。如下图所示：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B1.png" alt="缓存模型1"><br>2.查询使用缓存，更新穿透到数据库，数据库同步数据到缓存<br>这种方式在客户端表现来看可以提高一部分速度，因为查询操作都是基于缓存的，但实际上Mysql的负担反而加大了，因为每一个更新请求，都需要Mysql同步最新的查询结果集给Memcache，因为每一个更新操作都会带来一个查询操作，当然这个同步过程可以是异步的，但是就算我们感受不到这个同步的过程，在实际上也是加大了数据库的负担。如下图所示：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B2.png" alt="缓存模型2"><br>3.更新和查询都使用缓存，缓存按策略与数据库进行同步<br>这种方式是比较好的方式，因为客户端的所有操作都是被缓存给拦截下来了，所有操作均是基于缓存，不会穿透到数据库，而缓存与数据库之间可以按照一定策略进行同步，如每5分钟同步一次数据到数据库等，具体同步策略可根据情况具体调整，当然这种方式的缺陷就是一旦服务器宕机，那么在上次同步到宕机这段时间之间的数据都会丢失。如下图所示：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B3.png" alt="缓存模型3"><br>4.更新和查询都是用缓存，更新操作同时穿透到数据库，数据库同步缓存的查询<br>这种方式是我最终使用的方式，虽然更新操作穿透到数据库，但是我可以在保证查询效率的同时，也保证数据的安全稳定性，因为每一步更新操作都是要进行数据库存储的，并且所有的查询操作可以直接在缓存中进行。如下图所示：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B4.png" alt="缓存模型4"></p>
<h4 id="国战数据缓存"><a href="#国战数据缓存" class="headerlink" title="国战数据缓存"></a>国战数据缓存</h4><p>在我们的数据管理中，前文提到的所有数据均是基于玩家的个人数据，游戏服务器与Web服务器最大的不同，就是游戏服务器中存在一个“游戏世界”，在这个游戏世界中，多个玩家均操作同一套数据，稍有经验的后端开发者就知道，在多线程环境下操作共享资源，需要处理好共享数据的安全同步问题。在我们的国战玩法中，共享资源就是世界地图上的城池，以及各个玩家的国战信息(玩家被打败后会更改玩家的占领城池信息)。<br>我们的国战数据是存储在Redis中的，但如果我们不做任何安全问题的保护，就会出现数据的混乱，举个例子，当玩家A和玩家B同时操作一座城池的信息时，假设有以下步骤：<br>1.玩家A从Redis读取城池信息<br>2.玩家A对城池信息进行更改<br>3.玩家A将城池数据入库<br>4.玩家B从Redis读取城池信息<br>5.玩家B对城池信息进行更改<br>6.玩家B将城池数据入库<br>如下图所示：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/syn_correct.png" alt="同步顺序1"><br>以上是一种A和B按顺序分别对城池信息操作的正常情况，在这种情况下，城池信息的数据是不会有异常的，可如果A和B的的操作顺序变成了如下这样，就会产生数据的安全问题了：<br>1.玩家A从Redis读取城池信息<br>2.玩家B从Redis读取城池信息<br>3.玩家A对城池信息进行更改<br>5.玩家A将城池数据入库<br>6.玩家B将城池数据入库<br>如下图所示：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/synerr.png" alt="同步顺序2"><br>可以假象以下，如果两个玩家按照如上步骤对城池数据进行操作，那么玩家B的操作将完全覆盖玩家A的操作，其最后的结果肯定是不允许的，这种需要将一系列操作执行完的叫做事务，在一个线程对当前的共享数据进行事务操作的过程中，其他线程是不允许操作这个共享数据的。Redis中，是提供了这样的事务操作API的，Redis的multi和exec函数，可以保证如果玩家A正在操作数据，玩家B的操作无效。而在我们的服务器中，我使用了Memcache提供的CAS原子操作来保证同步数据安全。因为国战数据的操作频繁，且大部分数据需要保证同步安全，因此我在客户端和Redis数据库的中间，用了Memcache作为缓存，既保证了国战数据的操作效率，也保证了其事务的特性。<br>所谓CAS(check and set)，即在写操作时，先检查数据是否被别的线程修改过。其基本原理就是对每次存储的对象分配一个版本号（casUnique）。客户端每次读取数据时，调用gets，Memcache返回当前数据的casUnique，在客户端提交数据的时候，客户端将此casUnique一起提交，Memcache会判断此casUnique是否是当前版本最新的casUnique，如果不是，则本次操作失效，如果是，则操作成功。对于操作失效的情况，我的处理是让此请求重复执行一定的次数，如果执行完这个次数之后仍未成功，则返回“系统繁忙，请稍后再试”。其操作过程如下图所示：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/syn_solution.png" alt="MemcacheCAS"><br>如图所示，通过如上图的流程，A和B的操作流程如下：<br>1.玩家A读取城池信息，并获取到CAS-ID1；<br>2.玩家B读取城池信息，并获取到CAS-ID2；<br>3.玩家A对城池信息进行更改<br>4.玩家B对城池信息进行更改<br>5.玩家B将城池数据返回给Memcache，在写入缓存前，检查CAS-ID与缓存空间中该数据的CAS-ID是否一致。结果是“一致”，就将修改后的带有CAS-ID2的X写入到缓存。<br>6.玩家A将城池数据返回给Memcache，在写入缓存前，检查CAS-ID与缓存空间中该数据的CAS-ID是否一致。结果是“不一致”，则拒绝写入，返回存储失败。<br>通过Memcache作为Redis前面的中间层，既提高了读写效率，又保证了多线程环境下的同步数据的安全。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文讲解了我们的游戏服务器的游戏管理方案，通过使用MySQL、Redis和Memcache，使它们各司其职，各自承担不同的功能，发挥它们的最大功效，如今我们的游戏仍在紧张的新版本开发中，目前已经登录一些平台进行内测。本文仅作为参考，其中的所有内容是我在对我们当前游戏的开发中所总结出的一点经验，或许并不适用于其他的数据管理方案，但应该可以帮助一些人填坑，这些也是我曾经爬过的坑。本人学艺不精，文中难免有不严谨之处，希望发现的同学给提出来，不要误导了大家。感谢大家欣赏！</p>
]]></content>
    
    <summary type="html">
    
      &lt;ul&gt;
&lt;li&gt;&lt;code&gt;文章版权归腾讯GAD所有，禁止匿名转载；禁止商业使用；禁止个人使用。&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;这一年左右的时间，我参与并完成了一款SLG手游的研发，我负责游戏的服务端研发。这是一款以三国为题材的游戏，除了有三国名将的卡牌养成、多种多样装备养成、PVE，玩家竞技场等常见玩法外，我们的游戏的主打特色是国战和军团战，目前我们正在进行国战部分的开发和优化，军团战部分仍在策划中。
    
    </summary>
    
      <category term="Java" scheme="http://hjcenry.github.io/categories/Java/"/>
    
    
      <category term="Java" scheme="http://hjcenry.github.io/tags/Java/"/>
    
      <category term="游戏服务器" scheme="http://hjcenry.github.io/tags/%E6%B8%B8%E6%88%8F%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    
      <category term="SLG" scheme="http://hjcenry.github.io/tags/SLG/"/>
    
  </entry>
  
  <entry>
    <title>SLG手游Java服务器的设计与开发——数据管理</title>
    <link href="http://hjcenry.github.io/2016/09/04/SLG%E6%89%8B%E6%B8%B8Java%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/"/>
    <id>http://hjcenry.github.io/2016/09/04/SLG手游Java服务器的设计与开发——数据管理/</id>
    <published>2016-09-04T02:13:00.000Z</published>
    <updated>2016-09-04T12:01:33.000Z</updated>
    
    <content type="html"><![CDATA[<ul>
<li><code>文章版权归腾讯GAD所有，禁止匿名转载；禁止商业使用；禁止个人使用。</code></li>
</ul>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>上文介绍了我们的SLG手游的服务器架构设计以及网络通信部分，本文介绍数据管理部分，在数据存储方面，我选择了Mysql、Memcache和Redis，利用这三种数据库各自的优势，各自发挥所长，在项目中有着不同的应用。<br><a id="more"></a></p>
<h2 id="游戏数据分析"><a href="#游戏数据分析" class="headerlink" title="游戏数据分析"></a>游戏数据分析</h2><p>前文已经对游戏数据做了大概的分析，如下图所示：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/%E6%B8%B8%E6%88%8F%E6%95%B0%E6%8D%AE.png" alt="游戏数据"><br>这是我个人对游戏中的数据进行的一种划分。其中，游戏数据直接使用代码将表文件中的数据加载到内存，然后从内存中读取数据即可。玩家数据则分为了热数据和冷数据两部分分别进行存储，最大程度利用Mysql和Redis各自的优势。</p>
<h2 id="游戏静态数据"><a href="#游戏静态数据" class="headerlink" title="游戏静态数据"></a>游戏静态数据</h2><p>在我们的这款游戏中，我们的静态数据配置在CSV表文件中，在服务器启动时，我读取所有的表文件，然后取出数据放到Map中，一般以一个标志性列（如ID）为key，一个JavaBean作为value放入到Map中。<br>读取CSV表文件步骤如下：<br>1.读取CSV文件<br>2.按一定格式对文件内容进行解析<br>3.将内容封装到JavaBean<br>4.存放数据到Map中<br>读取完了之后，在代码中如果需要，只需通过key在Map中来读取即可。<br>在项目中，我将整个过程进行了封装，封装成了dataConfig.xml文件、*.csv文件、JavaBean、CsvLoader.java、CsvParser.java和TempletService.java，添加一个CSV文件的步骤如下：<br>1.在dataConfig.xml中添加csv文件路径<br>2.创建一个和CSV文件中结构一模一样的JavaBean<br>3.服务器启动时调用CsvLoader的load()方法来加载所有的CSV文件<br>4.调用TempletService.listAll()方法，并传入Javabean的simpleName来加载CSV文件内容到List中<br>5.将List中的内容按一定结构存储（我一般都存为Map结构）</p>
<h3 id="dataConfig-xml"><a href="#dataConfig-xml" class="headerlink" title="dataConfig.xml"></a>dataConfig.xml</h3><p>dataConfig.xml中存储所有CSV表的路径，在CsvLoader.java中直接对这个xml表中的路径下的CSV文件进行读取加载。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">file</span> <span class="attr">name</span>=<span class="string">"Card.csv"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">file</span> <span class="attr">name</span>=<span class="string">"Equip.csv"</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--省略更多CSV表--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">config</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="CSV文件"><a href="#CSV文件" class="headerlink" title="CSV文件"></a>CSV文件</h3><p>CSV文件中存储具体的游戏数据，这个数据表一般是由数值策划来进行配置。CSV表的本质就是按逗号进行分割的数据，如下是卡牌表的前两行数据。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">卡牌ID,卡牌名称,英雄动画名称,卡牌兵种name,卡牌兵种类型,卡牌兵种美术资源ID,品质编号,所属势力,英雄等级,英雄升星等级,技能id,统,勇,智,初始兵力,初始攻击力,兵力,攻击力,克制系数,被克制系数,移动速度,爆击率,爆击倍数,普攻伤害加深,普攻伤害减免,技能伤害加深,技能伤害减免,普攻伤害点数,普攻免伤点数,技能伤害点数,技能减伤点数,KPI,技能名称,技能描述：目标 目标个数（范围）效果数值buff描述,英雄定位</span><br><span class="line">CardId,CardName,CardFlashName,CardSoldName,CardSoldID,CardSoldFlashID,RMBID,CountryID,CardLv,CardStar,SkillID,Tong,Yong,Zhi,HpStar,AttackStar,Hp,Attack,Kezhi,Beikezhi,Speed,Crit,Double,AttackAddbaifen,Attackreducebaifen,SkillAddbaifen,Skillreducebaifen,AttackNum,AttackreduceNum,SkillAddNum,SkillreduceNum,KPI,SkillName,SkillDes,HeroLocal</span><br><span class="line">200001,吕布,lvbu,骑兵,2,4,8,4,1,1,200001,105,110,90,344,70,2.22,2.26,0.17,0.43,385,0.16,1.44,0.176,0.144,0.176,0.144,0,0,0,0,1000,猛将无双,对敌方所有目标造成 1倍伤害并且全体晕眩3秒</span><br><span class="line">200002,赵云,zhaoyun,步兵,3,1,8,2,1,1,200002,103,106,100,381,62,2.464,2.008,0.31,0.29,300,0.16,1.44,0.128,0.208,0.128,0.208,0,0,0,0,1000,枪出如龙,对敌方目标造成3次0.5倍伤害并提升自身50%爆击率持续4秒</span><br></pre></td></tr></table></figure></p>
<h3 id="JavaBean"><a href="#JavaBean" class="headerlink" title="JavaBean"></a>JavaBean</h3><p>添加了CSV文件之后，我们需要创建一个和CSV表结构一模一样的JavaBean，如下是卡牌表对应的JavaBean。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kidbear._36.template;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Card</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> CardId;</span><br><span class="line">    <span class="keyword">private</span> String CardName;</span><br><span class="line">    <span class="keyword">private</span> String CardFlashName;</span><br><span class="line">    <span class="keyword">private</span> String CardSoldName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> CardSoldID;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> CardSoldFlashID;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> RMBID;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> CountryID;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> CardLv;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> CardStar;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> SkillID;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> Tong;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> Yong;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> Zhi;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> HpStar;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> AttackStar;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> Hp;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> Attack;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> Kezhi;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> Beikezhi;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> Speed;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> Crit;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> Double;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> AttackAddbaifen;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> Attackreducebaifen;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> SkillAddbaifen;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> Skillreducebaifen;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> AttackreduceNum;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> AttackNum;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> SkillAddNum;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> SkillreduceNum;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> KPI;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// getter/setter</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="CsvDataLoader-java"><a href="#CsvDataLoader-java" class="headerlink" title="CsvDataLoader.java"></a>CsvDataLoader.java</h3><p>CsvDataLoader封装了对CSV数据的载入，包括使用SAXReader对dataConfig.xml文件的读取，以及对其中的CSV文件的内容的读取，代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kidbear._36.util.csv;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"><span class="keyword">import</span> java.sql.Timestamp;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.dom4j.Document;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.DocumentException;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.Element;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.io.SAXReader;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.core.GameInit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CsvDataLoader</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(CsvDataLoader.class);</span><br><span class="line">    <span class="keyword">private</span> String packageName;</span><br><span class="line">    <span class="keyword">private</span> String config; <span class="comment">// 每一行就是一个配置文件名字</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> ActivityMaxValue;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> CsvDataLoader inst;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CsvDataLoader</span><span class="params">(String packageName, String config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.packageName = packageName;</span><br><span class="line">        <span class="keyword">this</span>.config = config;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CsvDataLoader <span class="title">getInstance</span><span class="params">(String packageName, String config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (inst == <span class="keyword">null</span>) &#123;</span><br><span class="line">            inst = <span class="keyword">new</span> CsvDataLoader(packageName, config);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> inst;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 调用load方法加载所有的配置文件</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SAXReader reader = <span class="keyword">new</span> SAXReader();</span><br><span class="line">        InputStream resourceStream = <span class="keyword">this</span>.getClass().getResourceAsStream(</span><br><span class="line">                <span class="keyword">this</span>.config);</span><br><span class="line">        InputStreamReader resourceStreamReader = <span class="keyword">new</span> InputStreamReader(</span><br><span class="line">                resourceStream);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Document doc = reader.read(resourceStreamReader);</span><br><span class="line">            List&lt;?&gt; nodes = doc.selectNodes(<span class="string">"/config/file"</span>);</span><br><span class="line">            Map&lt;String, List&lt;?&gt;&gt; dataMap = <span class="keyword">new</span> HashMap&lt;String, List&lt;?&gt;&gt;();</span><br><span class="line">            List&lt;String&gt; files = <span class="keyword">new</span> LinkedList&lt;String&gt;();</span><br><span class="line">            <span class="keyword">for</span> (Object n : nodes) &#123;</span><br><span class="line">                Element t = (Element) n;</span><br><span class="line">                String f = t.attributeValue(<span class="string">"name"</span>);</span><br><span class="line">                List&lt;?&gt; dataList = <span class="keyword">this</span>.loadFile(f, <span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">for</span> (Object o : dataList) &#123;</span><br><span class="line">                    TempletService.getInstance().registerObject(o, dataMap);</span><br><span class="line">                &#125;</span><br><span class="line">                files.add(f);</span><br><span class="line">            &#125;</span><br><span class="line">            logger.info(<span class="string">"读取配置完毕，准备afterLoad"</span>);</span><br><span class="line">            TempletService.templetMap = dataMap;</span><br><span class="line">            TempletService.getInstance().afterLoad();</span><br><span class="line">            logger.info(<span class="string">"afterLoad 完毕"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DocumentException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (resourceStreamReader != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    resourceStreamReader.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (resourceStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    resourceStream.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;?&gt; loadFile(String file, <span class="keyword">boolean</span> exitWhenFail) &#123;<span class="comment">// 读文件</span></span><br><span class="line">        InputStream resourceAsStream = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String clzName = file.replaceAll(<span class="string">".csv"</span>, <span class="string">""</span>);</span><br><span class="line">            file = GameInit.confFileBasePath + file;</span><br><span class="line">            logger.info(<span class="string">"load file: &#123;&#125;"</span>, file);</span><br><span class="line">            <span class="comment">// resourceAsStream = this.getClass().getResourceAsStream(file);</span></span><br><span class="line">            resourceAsStream = <span class="keyword">this</span>.getClass().getClassLoader()</span><br><span class="line">                    .getResource(file).openStream();</span><br><span class="line">            <span class="keyword">if</span> (resourceAsStream == <span class="keyword">null</span>) &#123;</span><br><span class="line">                logger.error(<span class="string">"文件不存在:"</span> + file);</span><br><span class="line">                <span class="keyword">if</span> (exitWhenFail) &#123;</span><br><span class="line">                    System.exit(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> loadFromStream(resourceAsStream, clzName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">"载入文件出错："</span> + file);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (resourceAsStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    resourceAsStream.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Collections.EMPTY_LIST;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;?&gt; loadFromStream(InputStream resourceAsStream, String clzName)</span><br><span class="line">            <span class="keyword">throws</span> DocumentException, InstantiationException,</span><br><span class="line">            IllegalAccessException, IOException &#123;<span class="comment">// 读csv文件</span></span><br><span class="line">        CsvParser csvParser = <span class="keyword">new</span> CsvParser(resourceAsStream);</span><br><span class="line">        List&lt;String&gt; nodes = csvParser.getListWithNoHeader();</span><br><span class="line">        <span class="comment">// get clazz</span></span><br><span class="line">        String className = <span class="keyword">this</span>.packageName + clzName;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; classObject = Class.forName(className);</span><br><span class="line">            <span class="keyword">if</span> (classObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">                logger.error(<span class="string">"未找到类"</span> + className);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Get all the declared fields</span></span><br><span class="line">            Field[] fields = classObject.getDeclaredFields();</span><br><span class="line">            LinkedList&lt;Field&gt; fieldList = <span class="keyword">new</span> LinkedList&lt;Field&gt;();</span><br><span class="line">            <span class="keyword">int</span> length = fields.length;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = -<span class="number">1</span>; ++i &lt; length;) &#123;</span><br><span class="line">                <span class="keyword">boolean</span> isStaticField = Modifier.isStatic(fields[i]</span><br><span class="line">                        .getModifiers());</span><br><span class="line">                <span class="keyword">if</span> (isStaticField)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">boolean</span> isTransientField = Modifier.isTransient(fields[i]</span><br><span class="line">                        .getModifiers());</span><br><span class="line">                <span class="keyword">if</span> (isTransientField)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                fieldList.add(fields[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Get all the declared fields of supper class</span></span><br><span class="line">            Class&lt;?&gt; tmp = classObject;</span><br><span class="line">            <span class="keyword">while</span> ((tmp = tmp.getSuperclass()) != Object.class) &#123;</span><br><span class="line">                System.out.print(<span class="string">"the extends class is"</span> + tmp.getName());</span><br><span class="line">                fields = tmp.getDeclaredFields();</span><br><span class="line">                length = fields.length;</span><br><span class="line">                <span class="keyword">if</span> (length == <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = -<span class="number">1</span>; ++i &lt; length;) &#123;</span><br><span class="line">                    <span class="keyword">boolean</span> isStaticField = Modifier.isStatic(fields[i]</span><br><span class="line">                            .getModifiers());</span><br><span class="line">                    <span class="keyword">if</span> (isStaticField)</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    <span class="keyword">boolean</span> isTransientField = Modifier.isTransient(fields[i]</span><br><span class="line">                            .getModifiers());</span><br><span class="line">                    <span class="keyword">if</span> (isTransientField)</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    fieldList.add(fields[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// The truly need to return object</span></span><br><span class="line">            List&lt;Object&gt; instances = <span class="keyword">new</span> ArrayList&lt;Object&gt;(nodes.size());</span><br><span class="line">            Object instance = <span class="keyword">null</span>;</span><br><span class="line">            String fieldName = <span class="keyword">null</span>;</span><br><span class="line">            String fieldValue = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (String node : nodes) &#123;</span><br><span class="line">                <span class="keyword">if</span> (node != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    instance = classObject.newInstance();</span><br><span class="line">                    <span class="keyword">boolean</span> ok = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="comment">// Element row = (Element) node;</span></span><br><span class="line">                    String[] values = node.split(<span class="string">","</span>);<span class="comment">// csv文件以英文逗号分割值</span></span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; fieldList.size(); i++) &#123;</span><br><span class="line">                        Field field = fieldList.get(i);</span><br><span class="line">                        fieldName = field.getName();</span><br><span class="line">                        fieldValue = values[i];</span><br><span class="line">                        <span class="keyword">if</span> (fieldValue == <span class="keyword">null</span>)</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">this</span>.setField(instance, field, fieldValue);</span><br><span class="line">                            ok = <span class="keyword">true</span>;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                            logger.error(<span class="string">"类名称是"</span> + className + <span class="string">"的属性"</span> + fieldName</span><br><span class="line">                                    + <span class="string">"没有被成功赋予静态数据"</span>);</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (ok) &#123;</span><br><span class="line">                        instances.add(instance);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> instances;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e1) &#123;</span><br><span class="line">            e1.printStackTrace();</span><br><span class="line">            logger.error(<span class="string">"未找到类"</span> + className);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * </span><br><span class="line">     * <span class="doctag">@Title</span>: setUnknowField</span><br><span class="line">     * <span class="doctag">@Description</span>:</span><br><span class="line">     * <span class="doctag">@param</span> ob</span><br><span class="line">     * <span class="doctag">@param</span> f</span><br><span class="line">     * <span class="doctag">@param</span> v</span><br><span class="line">     * <span class="doctag">@throws</span> IllegalArgumentException</span><br><span class="line">     * <span class="doctag">@throws</span> IllegalAccessException</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Object obj, Field f, String v)</span></span><br><span class="line">            <span class="keyword">throws</span> IllegalArgumentException, IllegalAccessException </span>&#123;</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (f.getType() == <span class="keyword">int</span>.class) &#123;</span><br><span class="line">            f.setInt(obj, Integer.parseInt(v));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (f.getType() == <span class="keyword">short</span>.class) &#123;</span><br><span class="line">            f.setShort(obj, Short.parseShort(v));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (f.getType() == <span class="keyword">byte</span>.class) &#123;</span><br><span class="line">            f.setByte(obj, Byte.parseByte(v));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (f.getType() == <span class="keyword">long</span>.class) &#123;</span><br><span class="line">            f.setLong(obj, Long.parseLong(v));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (f.getType() == <span class="keyword">double</span>.class) &#123;</span><br><span class="line">            f.setDouble(obj, Double.parseDouble(v));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (f.getType() == <span class="keyword">float</span>.class) &#123;</span><br><span class="line">            f.setFloat(obj, Float.parseFloat(v));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (f.getType() == Timestamp.class) &#123;</span><br><span class="line">            f.set(obj, Timestamp.valueOf(v));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            f.set(obj, f.getType().cast(v));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Test Code</span><br><span class="line">     * </span><br><span class="line">     * <span class="doctag">@param</span> args</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        CsvDataLoader dl = <span class="keyword">new</span> CsvDataLoader(<span class="string">"com.kidbear._36.template."</span>,</span><br><span class="line">                <span class="string">"/dataConfig.xml"</span>);</span><br><span class="line">        dl.load();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="CsvParser"><a href="#CsvParser" class="headerlink" title="CsvParser"></a>CsvParser</h3><p>CsvDataLoader中用到的CsvParser是具体对CSV文件按逗号分割的格式的解析的类，代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kidbear._36.util.csv;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStreamWriter;</span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">//JAVA 操作 excel 中的 .csv文件格式</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CsvParser</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> BufferedReader bufferedreader = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> List list = <span class="keyword">new</span> ArrayList();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CsvParser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CsvParser</span><span class="params">(InputStream inStream)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        InputStreamReader isr = <span class="keyword">new</span> InputStreamReader(inStream, <span class="string">"UTF-8"</span>);</span><br><span class="line">        bufferedreader = <span class="keyword">new</span> BufferedReader(isr);</span><br><span class="line">        String stemp;</span><br><span class="line">        <span class="keyword">while</span> ((stemp = bufferedreader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            list.add(stemp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List <span class="title">getList</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> List <span class="title">getListWithNoHeader</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> list.subList(<span class="number">2</span>, list.size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 得到csv文件的行数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getRowNum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> list.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 得到csv文件的列数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getColNum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!list.toString().equals(<span class="string">"[]"</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (list.get(<span class="number">0</span>).toString().contains(<span class="string">","</span>)) &#123; <span class="comment">// csv文件中，每列之间的是用','来分隔的</span></span><br><span class="line">                <span class="keyword">return</span> list.get(<span class="number">0</span>).toString().split(<span class="string">","</span>).length;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (list.get(<span class="number">0</span>).toString().trim().length() != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取得指定行的值</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRow</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.list.size() != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> (String) list.get(index);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取得指定列的值</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCol</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.getColNum() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuffer scol = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        String temp = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> colnum = <span class="keyword">this</span>.getColNum();</span><br><span class="line">        <span class="keyword">if</span> (colnum &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Iterator it = list.iterator(); it.hasNext();) &#123;</span><br><span class="line">                temp = it.next().toString();</span><br><span class="line">                scol = scol.append(temp.split(<span class="string">","</span>)[index] + <span class="string">","</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (Iterator it = list.iterator(); it.hasNext();) &#123;</span><br><span class="line">                temp = it.next().toString();</span><br><span class="line">                scol = scol.append(temp + <span class="string">","</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        String str = <span class="keyword">new</span> String(scol.toString());</span><br><span class="line">        str = str.substring(<span class="number">0</span>, str.length() - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取得指定行，指定列的值</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getString</span><span class="params">(<span class="keyword">int</span> row, <span class="keyword">int</span> col)</span> </span>&#123;</span><br><span class="line">        String temp = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> colnum = <span class="keyword">this</span>.getColNum();</span><br><span class="line">        <span class="keyword">if</span> (colnum &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            temp = list.get(row).toString().split(<span class="string">","</span>)[col];</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (colnum == <span class="number">1</span>) &#123;</span><br><span class="line">            temp = list.get(row).toString();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            temp = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> temp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CsvClose</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bufferedreader.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List <span class="title">readCvs</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        CsvParser cu = <span class="keyword">new</span> CsvParser(<span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(filename)));</span><br><span class="line">        List list = cu.getList();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createCsv</span><span class="params">(String biao, List list, String path)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        List tt = list;</span><br><span class="line">        String data = <span class="string">""</span>;</span><br><span class="line">        SimpleDateFormat dataFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMdd"</span>);</span><br><span class="line">        Date today = <span class="keyword">new</span> Date();</span><br><span class="line">        String dateToday = dataFormat.format(today);</span><br><span class="line">        File file = <span class="keyword">new</span> File(path + <span class="string">"resource/expert/"</span> + dateToday</span><br><span class="line">                + <span class="string">"importerrorinfo.csv"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!file.exists())</span><br><span class="line">            file.createNewFile();</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            file.delete();</span><br><span class="line">        String str[];</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder(<span class="string">""</span>);</span><br><span class="line">        sb.append(biao);</span><br><span class="line">        FileOutputStream writerStream = <span class="keyword">new</span> FileOutputStream(file, <span class="keyword">true</span>);</span><br><span class="line">        BufferedWriter output = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> OutputStreamWriter(</span><br><span class="line">                writerStream, <span class="string">"UTF-8"</span>));</span><br><span class="line">        <span class="keyword">for</span> (Iterator itt = tt.iterator(); itt.hasNext();) &#123;</span><br><span class="line">            String fileStr = itt.next().toString();</span><br><span class="line">            <span class="comment">// str = fileStr.split(",");</span></span><br><span class="line">            <span class="comment">// for (int i = 0; i &lt;= str.length - 1; i++) &#123; // 拆分成数组 用于插入数据库中</span></span><br><span class="line">            <span class="comment">// System.out.print("str[" + i + "]=" + str[i] + " ");</span></span><br><span class="line">            <span class="comment">// &#125;</span></span><br><span class="line">            <span class="comment">// System.out.println("");</span></span><br><span class="line">            sb.append(fileStr + <span class="string">"\r\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        output.write(sb.toString());</span><br><span class="line">        output.flush();</span><br><span class="line">        output.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="TempletService-java"><a href="#TempletService-java" class="headerlink" title="TempletService.java"></a>TempletService.java</h3><p>服务器启动时，调用CsvDataLoader的load()方法，以完成对CSV文件的加载，之后就需要使用TempletService的listAll方法来讲数据加载到List中，TempletService根据JavaBean的simpleName来对数据进行加载，代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kidbear._36.util.csv;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * 添加一个数据表需要做以下几步 </span><br><span class="line"> * 1.在包com.kidbear._36.template下创建对应的模板类，类名与数据文件一致 </span><br><span class="line"> * 2.在src/main/resources/csv/中添加模板数据文件</span><br><span class="line"> * 3.在src/main/resources/dataConfig.xml加入刚才的模板数据文件</span><br><span class="line"> * </span><br><span class="line"> * <span class="doctag">@author</span> 何金成</span><br><span class="line"> * </span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TempletService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Logger log = LoggerFactory.getLogger(TempletService.class);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> TempletService templetService = <span class="keyword">new</span> TempletService();</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * key:实体名 value:该实体下的所有模板数据</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, List&lt;?&gt;&gt; templetMap = <span class="keyword">new</span> HashMap&lt;String, List&lt;?&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TempletService</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TempletService <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> templetService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 获取该实体类下所有模板数据</span><br><span class="line">     * </span><br><span class="line">     * <span class="doctag">@param</span> beanName</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List <span class="title">listAll</span><span class="params">(String beanName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> templetMap.get(beanName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@Title</span>: registerObject </span><br><span class="line">     * <span class="doctag">@Description</span>: 注册对象到对应类的List中</span><br><span class="line">     * <span class="doctag">@param</span> o</span><br><span class="line">     * <span class="doctag">@param</span> dataMap</span><br><span class="line">     * <span class="doctag">@return</span> void</span><br><span class="line">     * <span class="doctag">@throws</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerObject</span><span class="params">(Object o, Map&lt;String, List&lt;?&gt;&gt; dataMap)</span> </span>&#123;</span><br><span class="line">        add(o.getClass().getSimpleName(), o, dataMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(String key, Object data, Map&lt;String, List&lt;?&gt;&gt; dataMap)</span> </span>&#123;</span><br><span class="line">        List list = dataMap.get(key);</span><br><span class="line">        <span class="keyword">if</span> (list == <span class="keyword">null</span>) &#123;</span><br><span class="line">            list = <span class="keyword">new</span> ArrayList();</span><br><span class="line">            dataMap.put(key, list);</span><br><span class="line">        &#125;</span><br><span class="line">        list.add(data);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterLoad</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 加载后处理</span></span><br><span class="line">        <span class="comment">// List tests = TempletService.listAll(Test.class.getSimpleName());</span></span><br><span class="line">        <span class="comment">// for (Object object : tests) &#123;</span></span><br><span class="line">        <span class="comment">// Test test = (Test)object;</span></span><br><span class="line">        <span class="comment">// System.out.print(test.getEquipLv());</span></span><br><span class="line">        <span class="comment">// System.out.print(","+test.getLv1());</span></span><br><span class="line">        <span class="comment">// System.out.print(","+test.getLv2());</span></span><br><span class="line">        <span class="comment">// System.out.print(","+test.getLv3());</span></span><br><span class="line">        <span class="comment">// System.out.print(","+test.getLv4());</span></span><br><span class="line">        <span class="comment">// System.out.print(","+test.getLv5());</span></span><br><span class="line">        <span class="comment">// System.out.print(","+test.getLv6());</span></span><br><span class="line">        <span class="comment">// System.out.print(","+test.getLv7());</span></span><br><span class="line">        <span class="comment">// System.out.print(","+test.getLv8());</span></span><br><span class="line">        <span class="comment">// System.out.print(","+test.getLv9());</span></span><br><span class="line">        <span class="comment">// System.out.println(","+test.getLv10());</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadCanShu</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 加载全局参数xml配置</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="使用静态数据"><a href="#使用静态数据" class="headerlink" title="使用静态数据"></a>使用静态数据</h3><p>在完成了添加和加载等一系列操作之后，就可以在代码中调用CSV表中加载进来的数据了，例如上文提到的卡牌数据表，加载代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 卡牌数据表</span></span><br><span class="line">List&lt;Card&gt; cardList = TempletService</span><br><span class="line">                .listAll(Card.class.getSimpleName());</span><br><span class="line">Map&lt;Integer, Card&gt; cardMap = <span class="keyword">new</span> HashMap&lt;Integer, Card&gt;();</span><br><span class="line"><span class="keyword">for</span> (Card card : cardList) &#123;</span><br><span class="line">    cardMap.put(card.getCardId(), card);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">this</span>.cardMap = cardMap;</span><br></pre></td></tr></table></figure></p>
<p>使用时只需要根据卡牌的Id，就可以取到这张卡牌的所有数据。</p>
<h2 id="Mysql存储数据"><a href="#Mysql存储数据" class="headerlink" title="Mysql存储数据"></a>Mysql存储数据</h2><p>我们使用Mysql作为冷数据的存储数据库，并使用Druid和Hibernate来创建数据库的连接以及增删改查的操作。在游戏数据中，我对游戏中的冷数据做了一个总结，如下图所示：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/Mysql%E6%95%B0%E6%8D%AE.png" alt="Mysql数据"><br>完成要存储的游戏数据的分析之后，我们就可以进行具体建模建表的工作，完成对数据的设计。由于在游戏服务器的数据存储中，数据库基本上只是一个游戏数据临时存放的地方，所以游戏数据中的关联性并不是特别强，所以不需要严密的数据库设计，只需简单的将玩家所有的数据按照一个userid进行关联即可，在使用Hibernate的时候，我们使用了Hibernate4，使用了它注解JavaBean自动建表的功能，我们只需将需要存储的Model写成JavaBean，并写上注解，在启动时，Hibernate扫描到JavaBean会自动为我们创建或更新表。</p>
<h3 id="Druid数据库连接池"><a href="#Druid数据库连接池" class="headerlink" title="Druid数据库连接池"></a>Druid数据库连接池</h3><p>游戏服务器运行中经常是多个玩家同时在线的，可想而知，如果同时进行某一项涉及数据库的操作时，也会并发请求数据库，多个数据库请求就需要我们对多个数据库连接进行有效的管理，当然，我们可以自己写一个数据库卡连接池来进行数据库管理，但好在以后前辈为我们做足了工作，有很多成型的开源数据库连接池可供我们选择，常见的有c3p0、dbcp、proxool和driud等，这里我们使用阿里巴巴公司的开源产品Druid，这是我个人认为最好用的数据库连接池，它不仅提供了数据库连接池应有的功能，更是提供了良好的数据库监控性能，这是我们作为开发人员在遇到性能瓶颈时最需要的东西，感兴趣的朋友可以参考下官方github，根据官方wiki配置一个Druid的数据监控系统，通过系统可以查看数据库的各种性能指标。<br>Druid在github中的地址是：<a href="https://github.com/alibaba/druid" target="_blank" rel="external">https://github.com/alibaba/druid</a><br>在项目中使用druid，首先我们需要导入druid所需jar包以及Mysql的驱动jar包，由于我们是maven项目，我们就直接添加pom依赖，代码如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--Mysql驱动--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--数据库连接池--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.2.26<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>在spring的xml中对druid进行配置<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"com.alibaba.druid.pool.DruidDataSource"</span></span><br><span class="line">        <span class="attr">init-method</span>=<span class="string">"init"</span> <span class="attr">destroy-method</span>=<span class="string">"close"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.url&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.user&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.password&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxActive"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.maxActive&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"initialSize"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.initialSize&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置获取连接等待超时的时间 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxWait"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.maxWait&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"timeBetweenEvictionRunsMillis"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.timeBetweenEvictionRunsMillis&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置一个连接在池中最小生存的时间，单位是毫秒 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"minEvictableIdleTimeMillis"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.minEvictableIdleTimeMillis&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--过滤 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"filters"</span> <span class="attr">value</span>=<span class="string">"config,wall,mergeStat"</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--密码加密 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- property name="connectionProperties" value="config.decrypt=true" / --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--合并多个数据源 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"useGloalDataSourceStat"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"proxyFilters"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"log-filter"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"stat-filter"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"log-filter"</span> <span class="attr">class</span>=<span class="string">"com.alibaba.druid.filter.logging.Log4jFilter"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"statementLogErrorEnabled"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"statementLogEnabled"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"stat-filter"</span> <span class="attr">class</span>=<span class="string">"com.alibaba.druid.filter.stat.StatFilter"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"slowSqlMillis"</span> <span class="attr">value</span>=<span class="string">"1000"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"logSlowSql"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>然后需要在web.xml中再对druid的filter进行配置：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>DruidWebStatFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>com.alibaba.druid.support.http.WebStatFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>exclusions<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>weburi.json,.html,.js,.gif,.jpg,.png,.css,.ico,/fonts/*,/datas/*,images/*<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>sessionStatMaxCount<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>principalSessionName<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>FRONT_USER<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>DruidWebStatFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DruidStatView<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.alibaba.druid.support.http.StatViewServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DruidStatView<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/druid/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>至此为止，Druid的配置就算是完成，启动工程之后我们还能通过/druid路径来访问Druid提供的监控系统，更多关于Druid的使用可以参照github中的wiki介绍，了解更多Druid配置及参数设置。</p>
<h3 id="Hibernate"><a href="#Hibernate" class="headerlink" title="Hibernate"></a>Hibernate</h3><p>使用Hibernate作为Mysql数据库的ORM框架，主要是因为其良好的封装，首先我个人认为Hibernate的性能是不足与和原生JDBC以及MyBatis这样的框架所匹敌的，封装的更好却带来了更多的性能损失，但我使用他也是看中他良好的封装性，因为我对性能的需求还没有达到很高的级别；其次，Hibernate很难写出复杂的SQL查询，而MyBatis却可以写出一些复杂的SQL，但在我的设计中，我不需要太复杂的查询，基本上我所有的SQL语句的where条件都是”where userid=?”，因此在性能需求上以及易用的对比上，我选择了Hibernate。<br>我使用的版本你是Hibernate4，因为Hibernate4提供了注解自动创建表的功能，Hibernate集成在spring的配置的xml代码如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 定义事务管理 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager"</span></span><br><span class="line">    <span class="attr">class</span>=<span class="string">"org.springframework.orm.hibernate4.HibernateTransactionManager"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sessionFactory"</span> <span class="attr">ref</span>=<span class="string">"sessionFactory"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">"txAdvice"</span> <span class="attr">transaction-manager</span>=<span class="string">"transactionManager"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 事务执行方式 REQUIRED：指定当前方法必需在事务环境中运行， 如果当前有事务环境就加入当前正在执行的事务环境， 如果当前没有事务，就新建一个事务。 </span><br><span class="line">            这是默认值。 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"create*"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"save*"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"add*"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"update*"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"remove*"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"del*"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"import*"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 指定当前方法以非事务方式执行操作，如果当前存在事务，就把当前事务挂起，等我以非事务的状态运行完，再继续原来的事务。 查询定义即可 </span><br><span class="line">            read-only="true" 表示只读 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"*"</span> <span class="attr">propagation</span>=<span class="string">"NOT_SUPPORTED"</span> <span class="attr">read-only</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- hibernate SessionFactory --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"sessionFactory"</span></span><br><span class="line">    <span class="attr">class</span>=<span class="string">"org.springframework.orm.hibernate4.LocalSessionFactoryBean"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 数据源 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- hibernate的相关属性配置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"hibernateProperties"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 设置数据库方言 --&gt;</span></span><br><span class="line">            hibernate.dialect=org.hibernate.dialect.MySQLDialect</span><br><span class="line">            <span class="comment">&lt;!-- 设置自动创建|更新|验证数据库表结构 --&gt;</span></span><br><span class="line">            hibernate.hbm2ddl.auto=update</span><br><span class="line">            <span class="comment">&lt;!-- 是否在控制台显示sql --&gt;</span></span><br><span class="line">            hibernate.show_sql=false</span><br><span class="line">            <span class="comment">&lt;!-- 是否格式化sql，优化显示 --&gt;</span></span><br><span class="line">            hibernate.format_sql=false</span><br><span class="line">            <span class="comment">&lt;!-- 是否开启二级缓存 --&gt;</span></span><br><span class="line">            hibernate.cache.use_second_level_cache=false</span><br><span class="line">            <span class="comment">&lt;!-- 是否开启查询缓存 --&gt;</span></span><br><span class="line">            hibernate.cache.use_query_cache=false</span><br><span class="line">            <span class="comment">&lt;!-- 数据库批量查询最大数 --&gt;</span></span><br><span class="line">            hibernate.jdbc.fetch_size=50</span><br><span class="line">            <span class="comment">&lt;!-- 数据库批量更新、添加、删除操作最大数 --&gt;</span></span><br><span class="line">            hibernate.jdbc.batch_size=50</span><br><span class="line">            <span class="comment">&lt;!-- 是否自动提交事务 --&gt;</span></span><br><span class="line">            hibernate.connection.autocommit=true</span><br><span class="line">            <span class="comment">&lt;!-- 指定hibernate在何时释放JDBC连接 --&gt;</span></span><br><span class="line">            hibernate.connection.release_mode=auto</span><br><span class="line">            <span class="comment">&lt;!-- 创建session方式 hibernate4.x 的方式 --&gt;</span></span><br><span class="line">            hibernate.current_session_context_class=thread</span><br><span class="line">            <span class="comment">&lt;!-- javax.persistence.validation.mode默认情况下是auto的，就是说如果不设置的话它是会自动去你的classpath下面找一个bean-validation**包 </span><br><span class="line">                所以把它设置为none即可 --&gt;</span></span><br><span class="line">            javax.persistence.validation.mode=none</span><br><span class="line">        <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 自动扫描实体对象 tdxy.bean的包结构中存放实体类 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"packagesToScan"</span> <span class="attr">value</span>=<span class="string">"com.kidbear._36"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>配置完了之后，我们需要对我们需要进行存储的数据进行注解，如君主信息的Model如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kidbear._36.manager.junzhu;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.Column;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Entity;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Id;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Table;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.util.cache.MCSupport;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span>(name = <span class="string">"JunZhu"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JunZhu</span> <span class="keyword">implements</span> <span class="title">MCSupport</span> </span>&#123;</span><br><span class="line">    <span class="comment">// id，用户id，用户名字，用户所属国家，用户头像（用数字表示），用户等级，用户vip等级，用户军令数，用户金宝，用户银宝，用户粮食，用户精铁，用户木材，</span></span><br><span class="line">    <span class="comment">// 用户兵数量，用户军工数，用户将魂数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">5385044598250102957L</span>;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> id;<span class="comment">// —用户id</span></span><br><span class="line">    <span class="keyword">public</span> String name;<span class="comment">// — 用户名</span></span><br><span class="line">    <span class="meta">@Column</span>(columnDefinition = <span class="string">"INT default 1"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> headImg;<span class="comment">// —用户头像</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> role;<span class="comment">// —用户角色</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> country;<span class="comment">// —用户所属国家 1表示蜀国 2表示魏国 3表示吴国</span></span><br><span class="line">    <span class="meta">@Column</span>(columnDefinition = <span class="string">"INT default 0"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> exp;<span class="comment">// —用户等级 —君主等级</span></span><br><span class="line">    <span class="meta">@Column</span>(columnDefinition = <span class="string">"INT default 1"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> level;<span class="comment">// —用户等级 —君主等级</span></span><br><span class="line">    <span class="meta">@Column</span>(columnDefinition = <span class="string">"INT default 0"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> vip;<span class="comment">// —用户vip等级</span></span><br><span class="line">    <span class="meta">@Column</span>(columnDefinition = <span class="string">"INT default 0"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> vipExp;<span class="comment">// —用户vip经验</span></span><br><span class="line">    <span class="meta">@Column</span>(columnDefinition = <span class="string">"INT default 0"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> junling;<span class="comment">// —用户军令数</span></span><br><span class="line">    <span class="meta">@Column</span>(columnDefinition = <span class="string">"INT default 0"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> coin;<span class="comment">// —用户金币</span></span><br><span class="line">    <span class="meta">@Column</span>(columnDefinition = <span class="string">"INT default 0"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> yuanbao;<span class="comment">// —用户元宝</span></span><br><span class="line">    <span class="meta">@Column</span>(columnDefinition = <span class="string">"INT default 0"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> food;<span class="comment">// —用户粮食</span></span><br><span class="line">    <span class="meta">@Column</span>(columnDefinition = <span class="string">"INT default 0"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> iron;<span class="comment">// —用户精铁</span></span><br><span class="line">    <span class="meta">@Column</span>(columnDefinition = <span class="string">"INT default 0"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> wood;<span class="comment">// —用户木材</span></span><br><span class="line">    <span class="meta">@Column</span>(columnDefinition = <span class="string">"INT default 0"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> soldierNum;<span class="comment">// —用户兵力</span></span><br><span class="line">    <span class="meta">@Column</span>(columnDefinition = <span class="string">"INT default 0"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> jungongNum;<span class="comment">// —用户军功数</span></span><br><span class="line">    <span class="meta">@Column</span>(columnDefinition = <span class="string">"INT default 0"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> jianghunNum;<span class="comment">// —将魂数量</span></span><br><span class="line">    <span class="meta">@Column</span>(columnDefinition = <span class="string">"INT default 0"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> shengwang;<span class="comment">// —声望</span></span><br><span class="line">    <span class="meta">@Column</span>(columnDefinition = <span class="string">"INT default 0"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> zxId;<span class="comment">// —阵型id</span></span><br><span class="line">    <span class="meta">@Column</span>(columnDefinition = <span class="string">"INT default 0"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> paySum;<span class="comment">// -充值总额</span></span><br><span class="line">    <span class="meta">@Column</span>(columnDefinition = <span class="string">"INT default 0"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> conduction;<span class="comment">// -新手引导</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// getter/setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上代码中，@Entity和@Table(name = “JunZhu”)就可以使Hibernate在启动时自动创建一个JunZhu表，@Id的属性即设为主键的字段。创建好Model之后，就可以使用Hibernate的session进行数据库操作，这里我将数据库的操作封装为一个工具类HibernateUtil，这个工具类大家可以拿去直接使用，具体代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kidbear._36.util.hibernate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> net.sf.json.JSONObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.hibernate.Query;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.SQLQuery;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.Session;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.SessionFactory;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.Transaction;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.annotations.Where;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.transform.Transformers;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.FileSystemXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.core.GameInit;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.card.CardInfo;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.equip.EquipInfo;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.mail.MailInfo;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.pve.PveInfo;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.zhenxing.ZhenXingInfo;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.zhenxing.ZhenxingMgr;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.task.ExecutorPool;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.util.cache.MC;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.util.cache.MCSupport;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.util.memcached.MemcachedCRUD;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HibernateUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> showMCHitLog = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Logger log = LoggerFactory.getLogger(HibernateUtil.class);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;Class&lt;?&gt;, String&gt; beanKeyMap = <span class="keyword">new</span> HashMap&lt;Class&lt;?&gt;, String&gt;();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> synDelayT = <span class="number">0</span>;<span class="comment">// 延迟同步周期</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SessionFactory sessionFactory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sessionFactory = buildSessionFactory();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SessionFactory <span class="title">getSessionFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sessionFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Throwable <span class="title">insert</span><span class="params">(Object o, <span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">        Session session = sessionFactory.getCurrentSession();</span><br><span class="line">        session.beginTransaction();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            session.save(o);</span><br><span class="line">            session.getTransaction().commit();</span><br><span class="line">            <span class="keyword">if</span> (MC.cachedList.contains(o.getClass().getSimpleName())) &#123;</span><br><span class="line">                synMC4Insert(o.getClass().getSimpleName(), o,</span><br><span class="line">                        String.valueOf(id));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            log.error(<span class="string">"0要insert的数据&#123;&#125;"</span>, o == <span class="keyword">null</span> ? <span class="string">"null"</span> : JSONObject</span><br><span class="line">                    .fromObject(o).toString());</span><br><span class="line">            log.error(<span class="string">"0保存出错"</span>, e);</span><br><span class="line">            session.getTransaction().rollback();</span><br><span class="line">            <span class="keyword">return</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * FIXME 不要这样返回异常，没人会关系返回的异常。</span><br><span class="line">     * </span><br><span class="line">     * <span class="doctag">@param</span> o</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Throwable <span class="title">save</span><span class="params">(Object o, <span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">        Session session = sessionFactory.getCurrentSession();</span><br><span class="line">        Transaction t = session.beginTransaction();</span><br><span class="line">        <span class="keyword">boolean</span> mcOk = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (o <span class="keyword">instanceof</span> MCSupport) &#123;</span><br><span class="line">                MCSupport s = (MCSupport) o;<span class="comment">// 需要对控制了的对象在第一次存库时调用MC.add</span></span><br><span class="line">                MC.update(o, String.valueOf(s.getIdentifier()));<span class="comment">// MC中控制了哪些类存缓存。</span></span><br><span class="line">                mcOk = <span class="keyword">true</span>;</span><br><span class="line">                <span class="comment">// session.update(o);</span></span><br><span class="line">                session.saveOrUpdate(o);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                session.saveOrUpdate(o);</span><br><span class="line">            &#125;</span><br><span class="line">            t.commit();</span><br><span class="line">            <span class="keyword">if</span> (o <span class="keyword">instanceof</span> MCSupport) &#123;</span><br><span class="line">                <span class="keyword">if</span> (MC.cachedList.contains(o.getClass().getSimpleName())) &#123;</span><br><span class="line">                    synMC4Save(o.getClass().getSimpleName(), o,</span><br><span class="line">                            String.valueOf(id));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            log.error(<span class="string">"1要save的数据&#123;&#125;,&#123;&#125;"</span>, o, o == <span class="keyword">null</span> ? <span class="string">"null"</span> : JSONObject</span><br><span class="line">                    .fromObject(o).toString());</span><br><span class="line">            <span class="keyword">if</span> (mcOk) &#123;</span><br><span class="line">                log.error(<span class="string">"MC保存成功后报错，可能是数据库条目丢失。"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            log.error(<span class="string">"1保存出错"</span>, e);</span><br><span class="line">            t.rollback();</span><br><span class="line">            <span class="keyword">return</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Throwable <span class="title">update</span><span class="params">(Object o, String id)</span> </span>&#123;</span><br><span class="line">        Session session = sessionFactory.getCurrentSession();</span><br><span class="line">        Transaction t = session.beginTransaction();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (o <span class="keyword">instanceof</span> MCSupport) &#123;</span><br><span class="line">                MCSupport s = (MCSupport) o;<span class="comment">// 需要对控制了的对象在第一次存库时调用MC.add</span></span><br><span class="line">                MC.update(o, String.valueOf(s.getIdentifier()));<span class="comment">// MC中控制了哪些类存缓存。</span></span><br><span class="line">                session.update(o);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                session.update(o);</span><br><span class="line">            &#125;</span><br><span class="line">            t.commit();</span><br><span class="line">            <span class="keyword">if</span> (o <span class="keyword">instanceof</span> MCSupport) &#123;</span><br><span class="line">                <span class="keyword">if</span> (MC.cachedList.contains(o.getClass().getSimpleName())) &#123;</span><br><span class="line">                    synMC4Update(o.getClass().getSimpleName(), o,</span><br><span class="line">                            String.valueOf(id));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            log.error(<span class="string">"1要update的数据&#123;&#125;,&#123;&#125;"</span>, o, o == <span class="keyword">null</span> ? <span class="string">"null"</span> : JSONObject</span><br><span class="line">                    .fromObject(o).toString());</span><br><span class="line">            log.error(<span class="string">"1保存出错"</span>, e);</span><br><span class="line">            t.rollback();</span><br><span class="line">            <span class="keyword">return</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">find</span><span class="params">(Class&lt;T&gt; t, <span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">        String keyField = getKeyField(t);</span><br><span class="line">        <span class="keyword">if</span> (keyField == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"类型"</span> + t + <span class="string">"没有标注主键"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!MC.cachedClass.contains(t)) &#123;</span><br><span class="line">            <span class="keyword">return</span> find(t, <span class="string">"where "</span> + keyField + <span class="string">"="</span> + id, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        T ret = MC.get(t, String.valueOf(id));</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (showMCHitLog)</span><br><span class="line">                log.info(<span class="string">"MC未命中&#123;&#125;#&#123;&#125;"</span>, t.getSimpleName(), id);</span><br><span class="line">            ret = find(t, <span class="string">"where "</span> + keyField + <span class="string">"="</span> + id, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (ret != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (showMCHitLog)</span><br><span class="line">                    log.info(<span class="string">"DB命中&#123;&#125;#&#123;&#125;"</span>, t.getSimpleName(), id);</span><br><span class="line">                MC.add(ret, String.valueOf(id));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (showMCHitLog)</span><br><span class="line">                    log.info(<span class="string">"DB未命中&#123;&#125;#&#123;&#125;"</span>, t.getSimpleName(), id);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (showMCHitLog)</span><br><span class="line">                log.info(<span class="string">"MC命中&#123;&#125;#&#123;&#125;"</span>, t.getSimpleName(), id);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">find</span><span class="params">(Class&lt;T&gt; t, String where)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> find(t, where, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">find</span><span class="params">(Class&lt;T&gt; t, String where, <span class="keyword">boolean</span> checkMCControl)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// if (checkMCControl &amp;&amp; MC.cachedClass.contains(t)) &#123;</span></span><br><span class="line">        <span class="comment">// // 请使用static &lt;T&gt; T find(Class&lt;T&gt; t,long id)</span></span><br><span class="line">        <span class="comment">// throw new BaseException("由MC控制的类不能直接查询DB:" + t);</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        Session session = sessionFactory.getCurrentSession();</span><br><span class="line">        Transaction tr = session.beginTransaction();</span><br><span class="line">        T ret = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// FIXME 使用 session的get方法代替。</span></span><br><span class="line">            String hql = <span class="string">"from "</span> + t.getSimpleName() + <span class="string">" "</span> + where;</span><br><span class="line">            Query query = session.createQuery(hql);</span><br><span class="line">            ret = (T) query.uniqueResult();</span><br><span class="line">            tr.commit();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            tr.rollback();</span><br><span class="line">            log.error(<span class="string">"list fail for &#123;&#125; &#123;&#125;"</span>, t, where);</span><br><span class="line">            log.error(<span class="string">"list fail"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">list</span><span class="params">(Class&lt;T&gt; t, <span class="keyword">long</span> id, String where)</span> </span>&#123;</span><br><span class="line">        String keyField = getKeyField(t);</span><br><span class="line">        <span class="keyword">if</span> (keyField == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"类型"</span> + t + <span class="string">"没有标注主键"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!MC.cachedList.contains(t.getSimpleName())) &#123;</span><br><span class="line">            <span class="keyword">return</span> list(t, where, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;T&gt; ret = MC.getList(t, String.valueOf(id), where);</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (showMCHitLog)</span><br><span class="line">                log.info(<span class="string">"MC未命中&#123;&#125;#&#123;&#125;"</span>, t.getSimpleName(), where);</span><br><span class="line">            ret = list(t, where, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (ret != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (showMCHitLog)</span><br><span class="line">                    log.info(<span class="string">"DB命中&#123;&#125;#&#123;&#125;"</span>, t.getSimpleName(), where);</span><br><span class="line">                MC.addList(ret, t.getSimpleName(), String.valueOf(id), where);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (showMCHitLog)</span><br><span class="line">                    log.info(<span class="string">"DB未命中&#123;&#125;#&#123;&#125;"</span>, t.getSimpleName(), where);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (showMCHitLog)</span><br><span class="line">                log.info(<span class="string">"MC命中&#123;&#125;#&#123;&#125;"</span>, t.getSimpleName(), where);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> t</span><br><span class="line">     * <span class="doctag">@param</span> where</span><br><span class="line">     *            例子： where uid&gt;100</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">list</span><span class="params">(Class&lt;T&gt; t, String where,</span><br><span class="line">            <span class="keyword">boolean</span> checkMCControl)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// if (checkMCControl &amp;&amp; MC.cachedList.contains(t)) &#123;</span></span><br><span class="line">        <span class="comment">// // 请使用static &lt;T&gt; T find(Class&lt;T&gt; t,long id)</span></span><br><span class="line">        <span class="comment">// throw new BaseException("由MC控制的类不能直接查询DB:" + t);</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        Session session = sessionFactory.getCurrentSession();</span><br><span class="line">        Transaction tr = session.beginTransaction();</span><br><span class="line">        List&lt;T&gt; list = Collections.EMPTY_LIST;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String hql = <span class="string">"from "</span> + t.getSimpleName() + <span class="string">" "</span> + where;</span><br><span class="line">            Query query = session.createQuery(hql);</span><br><span class="line">            list = query.list();</span><br><span class="line">            tr.commit();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            tr.rollback();</span><br><span class="line">            log.error(<span class="string">"list fail for &#123;&#125; &#123;&#125;"</span>, t, where);</span><br><span class="line">            log.error(<span class="string">"list fail"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SessionFactory <span class="title">buildSessionFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"开始构建hibernate"</span>);</span><br><span class="line">        String path = <span class="string">"classpath*:spring-conf/applicationContext.xml"</span>;</span><br><span class="line">        ApplicationContext ac = <span class="keyword">new</span> FileSystemXmlApplicationContext(path);</span><br><span class="line">        sessionFactory = (SessionFactory) ac.getBean(<span class="string">"sessionFactory"</span>);</span><br><span class="line">        log.info(<span class="string">"结束构建hibernate"</span>);</span><br><span class="line">        <span class="keyword">return</span> sessionFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Throwable <span class="title">delete</span><span class="params">(Object o, <span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Session session = sessionFactory.getCurrentSession();</span><br><span class="line">        session.beginTransaction();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            session.delete(o);</span><br><span class="line">            session.getTransaction().commit();</span><br><span class="line">            <span class="keyword">if</span> (o <span class="keyword">instanceof</span> MCSupport) &#123;</span><br><span class="line">                MCSupport s = (MCSupport) o;<span class="comment">// 需要对控制了的对象在第一次存库时调用MC.add</span></span><br><span class="line">                MC.delete(o.getClass(), String.valueOf(s.getIdentifier()));<span class="comment">// MC中控制了哪些类存缓存。</span></span><br><span class="line">                <span class="keyword">if</span> (MC.cachedList.contains(o.getClass().getSimpleName())) &#123;</span><br><span class="line">                    synMC4Delete(o.getClass().getSimpleName(), o,</span><br><span class="line">                            String.valueOf(id));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            log.error(<span class="string">"要删除的数据&#123;&#125;"</span>, o);</span><br><span class="line">            log.error(<span class="string">"出错"</span>, e);</span><br><span class="line">            session.getTransaction().rollback();</span><br><span class="line">            <span class="keyword">return</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 注意这个方法会返回大于等于1的值。数据库无记录也会返回1，而不是null</span><br><span class="line">     * </span><br><span class="line">     * <span class="doctag">@param</span> t</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Long <span class="title">getTableIDMax</span><span class="params">(Class&lt;T&gt; t)</span> </span>&#123;</span><br><span class="line">        Long id = <span class="keyword">null</span>;</span><br><span class="line">        Session session = sessionFactory.getCurrentSession();</span><br><span class="line">        Transaction tr = session.beginTransaction();</span><br><span class="line">        String hql = <span class="string">"select max(id) from "</span> + t.getSimpleName();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Query query = session.createQuery(hql);</span><br><span class="line">            Object uniqueResult = query.uniqueResult();</span><br><span class="line">            <span class="keyword">if</span> (uniqueResult == <span class="keyword">null</span>) &#123;</span><br><span class="line">                id = <span class="number">1L</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                id = Long.parseLong(uniqueResult + <span class="string">""</span>);</span><br><span class="line">                id = Math.max(<span class="number">1L</span>, id);</span><br><span class="line">            &#125;</span><br><span class="line">            tr.commit();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            tr.rollback();</span><br><span class="line">            log.error(<span class="string">"query max id fail for &#123;&#125; &#123;&#125;"</span>, t, hql);</span><br><span class="line">            log.error(<span class="string">"query max id fail"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;Map&lt;String, Object&gt;&gt; querySql(String hql) &#123;</span><br><span class="line">        Session session = sessionFactory.getCurrentSession();</span><br><span class="line">        Transaction tr = session.beginTransaction();</span><br><span class="line">        List list = Collections.emptyList();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            SQLQuery query = session.createSQLQuery(hql);</span><br><span class="line">            query.setResultTransformer(Transformers.ALIAS_TO_ENTITY_MAP);</span><br><span class="line">            list = query.list();</span><br><span class="line">            tr.commit();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            tr.rollback();</span><br><span class="line">            log.error(<span class="string">"query  failed &#123;&#125;"</span>, hql);</span><br><span class="line">            log.error(<span class="string">"query count(type) fail"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上代码中，除了调用session的数据库操作API之外，我还使用了Memcache进行结果集的缓存，具体关系Memcache和Mysql的集合使用，在下文中在进行讲解。上文代码中首先在服务器启动时，需要构建SessionFactory，然后通过操作session开始事务，通过session调用CRUD方法进行操作，之后再调用commit方法提交并结束事务，中间如果发生异常则进行rollback操作回滚事务。</p>
<h2 id="Redis存储数据"><a href="#Redis存储数据" class="headerlink" title="Redis存储数据"></a>Redis存储数据</h2><p>游戏中的热数据的存储我选用了Redis，Redis不仅是运行在内存上的内存数据库，并且它的数据存储结构也是很丰富的，包括String，Set，List，Sorted Set和Hash五种数据结构，我对游戏数据的热数据进行了分析，如下图：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/Redis%E6%95%B0%E6%8D%AE.png" alt="Redis数据"><br>使用Redis首先得了解Redis的五种基本数据类型，每一种数据类型都对应不同的Redis操作API，在Java中使用Redis可以使用官方提供的Jedis客户端，Jedis客户端中包含了各种数据类型的操作，我将所有的Redis操作都封装在了Redis类中，启动时调用init方法进行Redis连接，使用时通过getInstance获取实例，再调用相应的API即可完成相关的Redis操作，在init方法中，我是通过调用JedisSentinelPool去获取Redis的连接，因为我在服务器对Redis做了Sentinel的集群部署，大家可以直接拿这个Redis工具类去使用，Redis类的方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kidbear._36.util.redis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.beans.BeanInfo;</span><br><span class="line"><span class="keyword">import</span> java.beans.IntrospectionException;</span><br><span class="line"><span class="keyword">import</span> java.beans.Introspector;</span><br><span class="line"><span class="keyword">import</span> java.beans.PropertyDescriptor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.HostAndPort;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisSentinelPool;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Tuple;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.core.GameInit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Redis</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Redis instance;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Logger log = LoggerFactory.getLogger(Redis.class);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> GLOBAL_DB = <span class="number">0</span>;<span class="comment">// 全局</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LOGIC_DB = GameInit.serverId;<span class="comment">// 模块库</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String password = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Redis <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> Redis();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// private JedisPool pool;</span></span><br><span class="line">    <span class="keyword">private</span> JedisSentinelPool sentinelPool;</span><br><span class="line">    <span class="keyword">public</span> String host;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// public int getDB(long userid)&#123;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Jedis <span class="title">getJedis</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.sentinelPool.getResource();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">returnResource</span><span class="params">(Jedis jedis)</span> </span>&#123;</span><br><span class="line">        jedis.close();</span><br><span class="line">        <span class="comment">// this.sentinelPool.returnResource(jedis);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String redisServer = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (GameInit.cfg != <span class="keyword">null</span>) &#123;</span><br><span class="line">            redisServer = GameInit.cfg.get(<span class="string">"redisServer"</span>);</span><br><span class="line">            password = GameInit.cfg.get(<span class="string">"redisPwd"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (redisServer == <span class="keyword">null</span>) &#123;</span><br><span class="line">            redisServer = <span class="string">"127.0.0.1:6440"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        redisServer = redisServer.trim();</span><br><span class="line">        String[] tmp = redisServer.split(<span class="string">":"</span>);</span><br><span class="line">        host = tmp[<span class="number">0</span>];</span><br><span class="line">        port = Integer.parseInt(tmp[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">if</span> (tmp.length == <span class="number">2</span>) &#123;</span><br><span class="line">            port = Integer.parseInt(tmp[<span class="number">1</span>].trim());</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">"Redis sentinel at &#123;&#125;:&#123;&#125;"</span>, host, port);</span><br><span class="line">        <span class="comment">// sentinelPool = new JedisPool(host, port);</span></span><br><span class="line">        Set sentinels = <span class="keyword">new</span> HashSet();</span><br><span class="line">        sentinels.add(<span class="keyword">new</span> HostAndPort(host, port).toString());</span><br><span class="line">        sentinelPool = <span class="keyword">new</span> JedisSentinelPool(<span class="string">"master1"</span>, sentinels);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// private void init() &#123;</span></span><br><span class="line">    <span class="comment">// String redisServer = null;</span></span><br><span class="line">    <span class="comment">// if (GameInit.cfg != null) &#123;</span></span><br><span class="line">    <span class="comment">// redisServer = GameInit.cfg.get("redisServer");</span></span><br><span class="line">    <span class="comment">// password = GameInit.cfg.get("redisPwd");</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// if (redisServer == null) &#123;</span></span><br><span class="line">    <span class="comment">// redisServer = "127.0.0.1:6379";</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// redisServer = redisServer.trim();</span></span><br><span class="line">    <span class="comment">// String[] tmp = redisServer.split(":");</span></span><br><span class="line">    <span class="comment">// host = tmp[0];</span></span><br><span class="line">    <span class="comment">// port = Integer.parseInt(tmp[1]);</span></span><br><span class="line">    <span class="comment">// if (tmp.length == 2) &#123;</span></span><br><span class="line">    <span class="comment">// port = Integer.parseInt(tmp[1].trim());</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// log.info("Redis at &#123;&#125;:&#123;&#125;", host, port);</span></span><br><span class="line">    <span class="comment">// // sentinelPool = new JedisPool(host, port);</span></span><br><span class="line">    <span class="comment">// JedisPoolConfig config = new JedisPoolConfig();</span></span><br><span class="line">    <span class="comment">// sentinelPool = new JedisPool(config, host, port, 100000, password);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Jedis j = getJedis();</span><br><span class="line">        j.auth(password);</span><br><span class="line">        returnResource(j);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">select</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        Jedis j = getJedis();</span><br><span class="line">        j.auth(password);</span><br><span class="line">        j.select(index);</span><br><span class="line">        returnResource(j);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hexist</span><span class="params">(<span class="keyword">int</span> db, String key, String field)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (key == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Jedis redis = getJedis();</span><br><span class="line">        redis.auth(password);</span><br><span class="line">        redis.select(db);</span><br><span class="line">        <span class="keyword">boolean</span> ret = redis.hexists(key, field);</span><br><span class="line">        returnResource(redis);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">hdel</span><span class="params">(<span class="keyword">int</span> db, String key, String... fields)</span> </span>&#123;</span><br><span class="line">        Jedis redis = getJedis();</span><br><span class="line">        redis.auth(password);</span><br><span class="line">        redis.select(db);</span><br><span class="line">        Long cnt = redis.hdel(key, fields);</span><br><span class="line">        returnResource(redis);</span><br><span class="line">        <span class="keyword">return</span> cnt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hget</span><span class="params">(<span class="keyword">int</span> db, String key, String field)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (key == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Jedis redis = getJedis();</span><br><span class="line">        redis.auth(password);</span><br><span class="line">        redis.select(db);</span><br><span class="line">        String ret = redis.hget(key, field);</span><br><span class="line">        returnResource(redis);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">hgetAll</span><span class="params">(<span class="keyword">int</span> db, String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (key == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Jedis redis = getJedis();</span><br><span class="line">        redis.auth(password);</span><br><span class="line">        redis.select(db);</span><br><span class="line">        Map&lt;String, String&gt; ret = redis.hgetAll(key);</span><br><span class="line">        returnResource(redis);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hset</span><span class="params">(<span class="keyword">int</span> db, String key, String field, String value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (field == <span class="keyword">null</span> || field.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span> || value.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Jedis redis = getJedis();</span><br><span class="line">        redis.auth(password);</span><br><span class="line">        redis.select(db);</span><br><span class="line">        redis.hset(key, field, value);</span><br><span class="line">        returnResource(redis);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> db, String group, String key, String value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span> || key == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Jedis redis = getJedis();</span><br><span class="line">        redis.auth(password);</span><br><span class="line">        redis.select(db);</span><br><span class="line">        redis.hset(group, key, value);</span><br><span class="line">        returnResource(redis);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(<span class="keyword">int</span> db, String key, String value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span> || key == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Jedis redis = getJedis();</span><br><span class="line">        redis.auth(password);</span><br><span class="line">        redis.select(db);</span><br><span class="line">        redis.set(key, value);</span><br><span class="line">        returnResource(redis);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(<span class="keyword">int</span> db, String key)</span> </span>&#123;</span><br><span class="line">        Jedis redis = getJedis();</span><br><span class="line">        redis.auth(password);</span><br><span class="line">        redis.select(db);</span><br><span class="line">        String ret = redis.get(key);</span><br><span class="line">        returnResource(redis);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 添加元素到集合中</span><br><span class="line">     * </span><br><span class="line">     * <span class="doctag">@param</span> key</span><br><span class="line">     * <span class="doctag">@param</span> element</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">sadd</span><span class="params">(<span class="keyword">int</span> db, String key, String... element)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (element == <span class="keyword">null</span> || element.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Jedis redis = getJedis();</span><br><span class="line">        redis.auth(password);</span><br><span class="line">        redis.select(db);</span><br><span class="line">        <span class="keyword">boolean</span> success = redis.sadd(key, element) == <span class="number">1</span>;</span><br><span class="line">        returnResource(redis);</span><br><span class="line">        <span class="keyword">return</span> success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">smove</span><span class="params">(<span class="keyword">int</span> db, String oldKey, String newKey, String element)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (element == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Jedis redis = getJedis();</span><br><span class="line">        redis.auth(password);</span><br><span class="line">        redis.select(db);</span><br><span class="line">        <span class="keyword">boolean</span> success = (redis.smove(oldKey, newKey, element) == <span class="number">1</span>);</span><br><span class="line">        returnResource(redis);</span><br><span class="line">        <span class="keyword">return</span> success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        getInstance().sentinelPool.destroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 中间省略一万字：中间都是Redis的各种API的操作，需要了解的朋友可以去看看Jedis的API文档</span></span><br></pre></td></tr></table></figure></p>
<h2 id="Memcache数据结果集缓存"><a href="#Memcache数据结果集缓存" class="headerlink" title="Memcache数据结果集缓存"></a>Memcache数据结果集缓存</h2><p>上文在介绍Hibernate中说到了Memcache对Mysql结果集的缓存，Memcache作为一种内存数据库，经常用作应用系统的缓存系统，我也将Memcache引入到项目作为Mysql数据结果集的缓存系统，其实在实现Memcache对Mysql查询的缓存的过程中，我曾进行了多种尝试，具体有以下几种缓存模型：<br>1.无缓存<br>这种方式不使用Memcache缓存，游戏服务器的操作直接穿透到Mysql中，这种方式在高并发环境下容易引起Mysql服务器高负载情况，如下图所示：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B1.png" alt="缓存模型1"><br>2.查询使用缓存，更新穿透到数据库，数据库同步数据到缓存<br>这种方式在客户端表现来看可以提供一部分速度，因为查询操作都是基于缓存的，但实际上Mysql的负担反而加大了，因为每一个更新请求，都需要Mysql同步最新的查询结果集给Memcache，因为每一个更新操作都会带来一个查询操作，当然这个同步过程可以使异步，但是就算我们感受不到这个同步的过程，但在实际上也是加大了数据库的负载，如下图所示：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B2.png" alt="缓存模型2"><br>3.更新和查询都使用缓存，缓存按策略与数据库进行同步<br>这种方式是比较好的方式，因为客户端的所有操作都是被缓存给拦截下来了，所有操作均是基于缓存，不会穿透到数据库，而缓存与数据库之间可以按照一定策略进行同步，如每5分钟同步一次数据到数据库等，具体同步策略可根据情况具体调整，当然这种方式的缺陷就是一旦服务器宕机，那么在上次同步到宕机这段时间之间的数据都会丢失，如下图所示：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B3.png" alt="缓存模型3"><br>4.更新和查询都是用缓存，更新操作同时穿透到数据库，数据库同步缓存的查询<br>这种方式是我最终使用的方式，虽然更新操作穿透到数据库，但是我可以在保证查询效率的同时，也保证数据的安全稳定性，因为每一步更新操作都是要进行数据库存储的，并且所有的查询操作可以直接在缓存中进行，如下图所示：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B4.png" alt="缓存模型4"></p>
<p>需要支持缓存的类需实现MCSupport接口：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kidbear._36.util.cache;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * 实现此接口后还需要再MC类中增加cachedClass，并使用</span><br><span class="line"> * com.qx.persistent.HibernateUtil.find(Class&lt;T&gt;, long)</span><br><span class="line"> * 代替where进行查询。</span><br><span class="line"> * 需要对控制了的对象在第一次存库时调用MC.add，再调用HIbernateUtil.insert</span><br><span class="line"> * <span class="doctag">@author</span> 何金成</span><br><span class="line"> *</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MCSupport</span> <span class="keyword">extends</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getIdentifier</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Memcache的工具类MemcacheCRUD实现了Memcache的连接，以及add，update，delete等操作，具体代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kidbear._36.util.memcached;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.danga.MemCached.MemCachedClient;</span><br><span class="line"><span class="keyword">import</span> com.danga.MemCached.SockIOPool;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.core.GameInit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * <span class="doctag">@author</span> 何金成</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemcachedCRUD</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> Logger logger = LoggerFactory</span><br><span class="line">            .getLogger(MemcachedCRUD.class);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String poolName = <span class="string">"gameDBPool"</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> MemCachedClient memCachedClient;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> MemcachedCRUD memcachedCRUD = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SockIOPool sockIoPool;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">MemcachedCRUD</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sockIoPool = init(poolName, <span class="string">"cacheServer"</span>);</span><br><span class="line">        memCachedClient = <span class="keyword">new</span> MemCachedClient(poolName);</span><br><span class="line">        <span class="comment">// if true, then store all primitives as their string value.</span></span><br><span class="line">        memCachedClient.setPrimitiveAsString(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SockIOPool <span class="title">init</span><span class="params">(String poolName, String confKey)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 缓存服务器</span></span><br><span class="line">        String cacheServers = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (GameInit.cfg != <span class="keyword">null</span>) &#123;</span><br><span class="line">            cacheServers = GameInit.cfg.getServerByName(confKey);</span><br><span class="line">        &#125;</span><br><span class="line">        String server[] = &#123; <span class="string">"127.0.0.1:11211"</span> &#125;;</span><br><span class="line">        <span class="keyword">if</span> (cacheServers == <span class="keyword">null</span> || <span class="string">""</span>.equals(cacheServers)) &#123;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            server[<span class="number">0</span>] = cacheServers;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 创建一个连接池</span></span><br><span class="line">        SockIOPool pool = SockIOPool.getInstance(poolName);</span><br><span class="line">        logger.info(<span class="string">"连接池&#123;&#125;缓存配置 &#123;&#125;"</span>, poolName, Arrays.toString(server));</span><br><span class="line">        pool.setServers(server);<span class="comment">// 缓存服务器</span></span><br><span class="line">        pool.setInitConn(<span class="number">50</span>); <span class="comment">// 初始化链接数</span></span><br><span class="line">        pool.setMinConn(<span class="number">50</span>); <span class="comment">// 最小链接数</span></span><br><span class="line">        pool.setMaxConn(<span class="number">500</span>); <span class="comment">// 最大连接数</span></span><br><span class="line">        pool.setMaxIdle(<span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span>);<span class="comment">// 最大处理时间</span></span><br><span class="line">        pool.setMaintSleep(<span class="number">3000</span>);<span class="comment">// 设置主线程睡眠时,每3秒苏醒一次，维持连接池大小</span></span><br><span class="line">        pool.setNagle(<span class="keyword">false</span>);<span class="comment">// 关闭套接字缓存</span></span><br><span class="line">        pool.setSocketTO(<span class="number">3000</span>);<span class="comment">// 链接建立后超时时间</span></span><br><span class="line">        pool.setSocketConnectTO(<span class="number">0</span>);<span class="comment">// 链接建立时的超时时间</span></span><br><span class="line">        pool.initialize();</span><br><span class="line">        <span class="keyword">return</span> pool;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sockIoPool.shutDown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MemcachedCRUD <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (memcachedCRUD == <span class="keyword">null</span>) &#123;</span><br><span class="line">            memcachedCRUD = <span class="keyword">new</span> MemcachedCRUD();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> memcachedCRUD;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> INTERVAL = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">exist</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> memCachedClient.keyExists(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(String key, Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> memCachedClient.add(key, o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">update</span><span class="params">(String key, Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> memCachedClient.replace(key, o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">saveObject</span><span class="params">(String key, Object msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> o = memCachedClient.keyExists(key);</span><br><span class="line">        <span class="keyword">if</span> (o) &#123;<span class="comment">// 存在替换掉</span></span><br><span class="line">            <span class="keyword">return</span> memCachedClient.replace(key, msg);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> memCachedClient.add(key, msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">keyExist</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> memCachedClient.keyExists(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * delete</span><br><span class="line">     * </span><br><span class="line">     * <span class="doctag">@param</span> key</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">deleteObject</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> memCachedClient.delete(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        Object obj = memCachedClient.get(key);</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MemCachedClient <span class="title">getMemCachedClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> memCachedClient;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>使用Memcache进行缓存，则需要封装一个缓存的操作工具类MC，封装各种缓存操作方法，具体代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kidbear._36.util.cache;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.core.GameInit;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.bag.ItemInfo;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.building.BuildingInfo;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.card.CardInfo;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.equip.EquipInfo;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.junzhu.JunZhu;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.mail.MailInfo;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.pve.PveInfo;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.task.MainTaskInfo;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.tec.TecInfo;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.zhenxing.ZhenXingInfo;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.util.memcached.MemcachedCRUD;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MC</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 控制哪些类进行memcached缓存。 被控制的类在进行创建时，需要注意调用MC的add和hibernate的insert。</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;? extends MCSupport&gt;&gt; cachedClass = <span class="keyword">new</span> HashSet&lt;Class&lt;? extends MCSupport&gt;&gt;();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;String&gt; cachedList = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        cachedClass.add(JunZhu.class);</span><br><span class="line">        <span class="comment">// 添加需要缓存find操作的类</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        cachedList.add(CardInfo.class.getSimpleName());</span><br><span class="line">        <span class="comment">// 添加需要缓存list操作的类</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">get</span><span class="params">(Class&lt;T&gt; t, String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!cachedClass.contains(t)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuffer key = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        key.append(GameInit.serverId).append(<span class="string">"#"</span>).append(t.getSimpleName())</span><br><span class="line">                .append(<span class="string">"#"</span>).append(id);</span><br><span class="line">        Object o = MemcachedCRUD.getInstance().getObject(key.toString());</span><br><span class="line">        <span class="keyword">return</span> (T) o;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">getList</span><span class="params">(Class&lt;T&gt; t, String id, String where)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!cachedList.contains(t.getSimpleName())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuffer key = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        key.append(GameInit.serverId).append(<span class="string">"#"</span>).append(id).append(<span class="string">"#"</span>)</span><br><span class="line">                .append(t.getSimpleName()).append(<span class="string">"#"</span>).append(where);</span><br><span class="line">        Object o = MemcachedCRUD.getInstance().getObject(key.toString());</span><br><span class="line">        <span class="keyword">return</span> (List&lt;T&gt;) o;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">String <span class="title">getListKeys</span><span class="params">(String tName, String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!cachedList.contains(tName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuffer key = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        key.append(GameInit.serverId).append(<span class="string">"#"</span>).append(id).append(<span class="string">"#"</span>)</span><br><span class="line">                .append(tName);</span><br><span class="line">        Object o = MemcachedCRUD.getInstance().getObject(key.toString());</span><br><span class="line">        <span class="keyword">return</span> (String) o;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getValue</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        Object o = MemcachedCRUD.getInstance().getObject(key);</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(Object t, String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!cachedClass.contains(t.getClass())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuffer key = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        key.append(GameInit.serverId).append(<span class="string">"#"</span>)</span><br><span class="line">                .append(t.getClass().getSimpleName()).append(<span class="string">"#"</span>).append(id);</span><br><span class="line">        <span class="keyword">return</span> MemcachedCRUD.getInstance().add(key.toString(), t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">addList</span><span class="params">(List list, String tName, String id,</span><br><span class="line">            String where)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!cachedList.contains(tName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuffer key = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        key.append(GameInit.serverId).append(<span class="string">"#"</span>).append(id).append(<span class="string">"#"</span>)</span><br><span class="line">                .append(tName);</span><br><span class="line">        String c = key.toString();</span><br><span class="line">        key.append(<span class="string">"#"</span>).append(where);</span><br><span class="line">        Object tmp = MemcachedCRUD.getInstance().getObject(c);</span><br><span class="line">        String keys = tmp == <span class="keyword">null</span> ? <span class="string">""</span> : (String) tmp;</span><br><span class="line">        <span class="keyword">if</span> (keys.equals(<span class="string">""</span>)) &#123;</span><br><span class="line">            MemcachedCRUD.getInstance().add(c, key.toString());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!keys.contains(key.toString())) &#123;</span><br><span class="line">            MemcachedCRUD.getInstance().update(c, keys + <span class="string">","</span> + key.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> MemcachedCRUD.getInstance().add(key.toString(), list);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">addKeyValue</span><span class="params">(String key, Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MemcachedCRUD.getInstance().add(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Object t, String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!cachedClass.contains(t.getClass())) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuffer key = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        key.append(GameInit.serverId).append(<span class="string">"#"</span>)</span><br><span class="line">                .append(t.getClass().getSimpleName()).append(<span class="string">"#"</span>).append(id);</span><br><span class="line">        MemcachedCRUD.getInstance().update(key.toString(), t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">updateList</span><span class="params">(List list, String tName, String id,</span><br><span class="line">            String where)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!cachedList.contains(tName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuffer key = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        key.append(GameInit.serverId).append(<span class="string">"#"</span>).append(id).append(<span class="string">"#"</span>)</span><br><span class="line">                .append(tName);</span><br><span class="line">        String c = key.toString();</span><br><span class="line">        key.append(<span class="string">"#"</span>).append(where);</span><br><span class="line">        Object tmp = MemcachedCRUD.getInstance().getObject(c);</span><br><span class="line">        String keys = tmp == <span class="keyword">null</span> ? <span class="string">""</span> : (String) tmp;</span><br><span class="line">        <span class="keyword">if</span> (keys.equals(<span class="string">""</span>)) &#123;</span><br><span class="line">            MemcachedCRUD.getInstance().add(c, key.toString());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!keys.contains(key)) &#123;</span><br><span class="line">            MemcachedCRUD.getInstance().update(c, keys + <span class="string">","</span> + key.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> MemcachedCRUD.getInstance().update(key.toString(), list);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 根据主键删除缓存</span><br><span class="line">     * </span><br><span class="line">     * <span class="doctag">@param</span> obj</span><br><span class="line">     *            删除对象</span><br><span class="line">     * <span class="doctag">@param</span> id</span><br><span class="line">     *            主键id</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(Class clazz, String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!cachedClass.contains(clazz)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuffer key = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        key.append(GameInit.serverId).append(<span class="string">"#"</span>).append(clazz.getSimpleName())</span><br><span class="line">                .append(<span class="string">"#"</span>).append(id);</span><br><span class="line">        MemcachedCRUD.getInstance().deleteObject(key.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上代码中，find方法的缓存和list方法的缓存需要分别实现，find方法缓存只需要将类名和id作为key，对象作为value即可，而list的缓存不仅需要缓存所有的结果集，还需要缓存所有的where查询条件，根据类型查询出where条件，然后根据where条件分别进行缓存。<br>HibernateUtil中使用缓存部分的java代码如下，其中注释的方法为上面第二种缓存模型的实现（现已被我淘汰）：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">synMC4Insert</span><span class="params">(String tName, Object o, String id)</span> </span>&#123;</span><br><span class="line">    String keys = MC.getListKeys(tName, id);</span><br><span class="line">    <span class="keyword">if</span> (keys != <span class="keyword">null</span> &amp;&amp; keys.length() &gt; <span class="number">0</span>) &#123;<span class="comment">// 遍历所有的where缓存</span></span><br><span class="line">        String[] wheres = keys.split(<span class="string">","</span>);</span><br><span class="line">        <span class="keyword">for</span> (String where : wheres) &#123;</span><br><span class="line">            where = where.split(<span class="string">"#"</span>)[<span class="number">3</span>];</span><br><span class="line">            List list = MC.getList(o.getClass(), id, where);</span><br><span class="line">            list.add(o);</span><br><span class="line">            MC.updateList(list, tName, id, where);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">synMC4Save</span><span class="params">(String tName, Object o, String id)</span> </span>&#123;</span><br><span class="line">    String keys = MC.getListKeys(tName, id);</span><br><span class="line">    <span class="keyword">if</span> (keys != <span class="keyword">null</span> &amp;&amp; keys.length() &gt; <span class="number">0</span>) &#123;<span class="comment">// 遍历所有的where缓存</span></span><br><span class="line">        String[] wheres = keys.split(<span class="string">","</span>);</span><br><span class="line">        <span class="keyword">for</span> (String where : wheres) &#123;</span><br><span class="line">            where = where.split(<span class="string">"#"</span>)[<span class="number">3</span>];</span><br><span class="line">            List list = MC.getList(o.getClass(), id, where);</span><br><span class="line">            MCSupport mc = (MCSupport) o;</span><br><span class="line">            <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (Iterator iterator = list.iterator(); iterator.hasNext(); index++) &#123;</span><br><span class="line">                MCSupport tmpObj = (MCSupport) iterator.next();</span><br><span class="line">                <span class="keyword">if</span> (tmpObj.getIdentifier() == mc.getIdentifier()) &#123;</span><br><span class="line">                    list.set(index, o);</span><br><span class="line">                    flag = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">                list.add(o);</span><br><span class="line">            &#125;</span><br><span class="line">            MC.updateList(list, tName, id, where);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">synMC4Update</span><span class="params">(String tName, Object o, String id)</span> </span>&#123;</span><br><span class="line">    String keys = MC.getListKeys(tName, id);</span><br><span class="line">    <span class="keyword">if</span> (keys != <span class="keyword">null</span> &amp;&amp; keys.length() &gt; <span class="number">0</span>) &#123;<span class="comment">// 遍历所有的where缓存</span></span><br><span class="line">        String[] wheres = keys.split(<span class="string">","</span>);</span><br><span class="line">        <span class="keyword">for</span> (String where : wheres) &#123;</span><br><span class="line">            where = where.split(<span class="string">"#"</span>)[<span class="number">3</span>];</span><br><span class="line">            List list = MC.getList(o.getClass(), id, where);</span><br><span class="line">            MCSupport mc = (MCSupport) o;</span><br><span class="line">            <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (Iterator iterator = list.iterator(); iterator.hasNext(); index++) &#123;</span><br><span class="line">                MCSupport tmpObj = (MCSupport) iterator.next();</span><br><span class="line">                <span class="keyword">if</span> (tmpObj.getIdentifier() == mc.getIdentifier()) &#123;</span><br><span class="line">                    list.set(index, o);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            MC.updateList(list, tName, id, where);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">synMC4Delete</span><span class="params">(String tName, Object o, String id)</span> </span>&#123;</span><br><span class="line">    String keys = MC.getListKeys(tName, id);</span><br><span class="line">    <span class="keyword">if</span> (keys != <span class="keyword">null</span> &amp;&amp; keys.length() &gt; <span class="number">0</span>) &#123;<span class="comment">// 遍历所有的where缓存</span></span><br><span class="line">        String[] wheres = keys.split(<span class="string">","</span>);</span><br><span class="line">        <span class="keyword">for</span> (String where : wheres) &#123;</span><br><span class="line">            where = where.split(<span class="string">"#"</span>)[<span class="number">3</span>];</span><br><span class="line">            List list = MC.getList(o.getClass(), id, where);</span><br><span class="line">            MCSupport mc = (MCSupport) o;</span><br><span class="line">            <span class="keyword">for</span> (Iterator iterator = list.iterator(); iterator.hasNext();) &#123;</span><br><span class="line">                MCSupport tmpObj = (MCSupport) iterator.next();</span><br><span class="line">                <span class="keyword">if</span> (tmpObj.getIdentifier() == mc.getIdentifier()) &#123;</span><br><span class="line">                    iterator.remove();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            MC.updateList(list, tName, id, where);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// public static &lt;T&gt; void synchronizeDB2MemAsy(final Class&lt;T&gt; t,</span></span><br><span class="line"><span class="comment">// final String id) &#123;</span></span><br><span class="line"><span class="comment">// ExecutorPool.dbThread.execute(new Runnable() &#123;</span></span><br><span class="line"><span class="comment">// @Override</span></span><br><span class="line"><span class="comment">// public void run() &#123;</span></span><br><span class="line"><span class="comment">// String keys = MC.getListKeys(t.getSimpleName(), id);</span></span><br><span class="line"><span class="comment">// if (keys != null &amp;&amp; keys.length() &gt; 0) &#123;// 遍历所有的where缓存</span></span><br><span class="line"><span class="comment">// String[] wheres = keys.split(",");</span></span><br><span class="line"><span class="comment">// for (String where : wheres) &#123;</span></span><br><span class="line"><span class="comment">// where = where.split("#")[3];</span></span><br><span class="line"><span class="comment">// List&lt;T&gt; list = list(t, where, false);</span></span><br><span class="line"><span class="comment">// MC.updateList(list, t.getSimpleName(), id, where);</span></span><br><span class="line"><span class="comment">// if (showMCHitLog) &#123;</span></span><br><span class="line"><span class="comment">// log.info("DB 同步 MC 成功 t:&#123;&#125;,where:&#123;&#125;",</span></span><br><span class="line"><span class="comment">// t.getSimpleName(), where);</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// &#125;);</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// public static &lt;T&gt; void synchronizeDB2MemSyn(final Class&lt;T&gt; t,</span></span><br><span class="line"><span class="comment">// final String id) &#123;</span></span><br><span class="line"><span class="comment">// String keys = MC.getListKeys(t.getSimpleName(), id);</span></span><br><span class="line"><span class="comment">// if (keys != null &amp;&amp; keys.length() &gt; 0) &#123;// 遍历所有的where缓存</span></span><br><span class="line"><span class="comment">// String[] wheres = keys.split(",");</span></span><br><span class="line"><span class="comment">// for (String where : wheres) &#123;</span></span><br><span class="line"><span class="comment">// where = where.split("#")[3];</span></span><br><span class="line"><span class="comment">// List&lt;T&gt; list = list(t, where, false);</span></span><br><span class="line"><span class="comment">// MC.updateList(list, t.getSimpleName(), id, where);</span></span><br><span class="line"><span class="comment">// if (showMCHitLog) &#123;</span></span><br><span class="line"><span class="comment">// log.info("DB 同步 MC 成功 t:&#123;&#125;,where:&#123;&#125;", t.getSimpleName(),</span></span><br><span class="line"><span class="comment">// where);</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以上是本文对我们这款游戏中的数据管理的介绍，游戏服务器中的各种数据是多种多样的，我们应该根据各种数据的各种性质，合理利用进行存取，以保证不管什么类型的游戏数据，在我们的游戏服务器中都可以安全稳定的运行，数据安全，玩家才会放心！</p>
]]></content>
    
    <summary type="html">
    
      &lt;ul&gt;
&lt;li&gt;&lt;code&gt;文章版权归腾讯GAD所有，禁止匿名转载；禁止商业使用；禁止个人使用。&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;上文介绍了我们的SLG手游的服务器架构设计以及网络通信部分，本文介绍数据管理部分，在数据存储方面，我选择了Mysql、Memcache和Redis，利用这三种数据库各自的优势，各自发挥所长，在项目中有着不同的应用。&lt;br&gt;
    
    </summary>
    
      <category term="Java" scheme="http://hjcenry.github.io/categories/Java/"/>
    
    
      <category term="Java" scheme="http://hjcenry.github.io/tags/Java/"/>
    
      <category term="游戏服务器" scheme="http://hjcenry.github.io/tags/%E6%B8%B8%E6%88%8F%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    
      <category term="SLG" scheme="http://hjcenry.github.io/tags/SLG/"/>
    
  </entry>
  
  <entry>
    <title>SLG手游Java服务器的设计与开发——网络通信</title>
    <link href="http://hjcenry.github.io/2016/08/27/SLG%E6%89%8B%E6%B8%B8Java%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/"/>
    <id>http://hjcenry.github.io/2016/08/27/SLG手游Java服务器的设计与开发——网络通信/</id>
    <published>2016-08-27T11:01:00.000Z</published>
    <updated>2016-08-28T14:49:44.000Z</updated>
    
    <content type="html"><![CDATA[<ul>
<li><code>文章版权归腾讯GAD所有，禁止匿名转载；禁止商业使用；禁止个人使用。</code></li>
</ul>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>上文分析了我们这款SLG的架构，本章着重讲解我们的网络通信架构，由上文的功能分析我们可以得知，游戏的所有功能基本上属于非及时的通信机制，所以依靠HTTP短连接就能够基本满足游戏的通信需求。<br><a id="more"></a><br>当然，我们先撇开国战部分不说，因为国战部分我们正在优化开发最新版本，之前我们做的版本是想通过异步战斗的机制达到实时战斗效果，通过使用HTTP的请求机制，加上前端画面表现，让玩家感觉到即时战斗的感觉，既能在地图上能看到其他玩家的行进队列，又能进入城池多国混战。可惜的是，让异步战斗来实现实时战斗的效果，会产生很多问题，最终因为机制的问题而商议出必须优化一版再上线。所以目前所有的功能均通过HTTP实现，如果后期国战需要使用TCP长连接可以单独对国战部分使用TCP长连接实现。</p>
<h2 id="通信框架"><a href="#通信框架" class="headerlink" title="通信框架"></a>通信框架</h2><h3 id="使用Netty"><a href="#使用Netty" class="headerlink" title="使用Netty"></a>使用Netty</h3><p>在开始设计通信机制时，就需要选择合适的通信框架，当然，我们也可以自己动手写底层通信的实现，不过在前人已有成熟框架的情况下，我们大而不必重复造轮子，由于在通信方面，我们并没有太多的个性化需求，因此基本上成熟的通信框架都能满足目前所需。选择框架，无非就是看它们的底层架构是否符合需求、资料是否齐全、API文档是否详细、以及成熟案例有多少。上文提到，可以使用HTTP通信协议的框架中，有Servlet、Spring、Struts、Mina和Netty等常见的通信框架，在这其中我选择了Netty，Servlet、Spring和Struts属于同一系列，他们的底层都是Servlet的实现，在Servlet3.0以前均是BIO通信模式，而Mina和Netty均属于基于Java NIO的通信框架，由于通信机制的不同，基于NIO的通信程序比基于BIO的通信程序能承受更多的并发连接，而在后者的框架选择中，其实并没有太多的谁好与不好，Mina和Netty底层都是Java NIO的封装，并且两者的底层框架也是大致一样（其作者其实就是一个人），选择Netty更多的是因为Netty的有更多的资料可查，遇到问题可能会更容易解决，并且我个人在同时使用过Mina和Netty的情况下，认为Netty的API更友好，使用起来更方便（个人感觉哈）。综合种种原因，我选择了Netty作为我的底层通信框架。</p>
<h3 id="Netty的特点"><a href="#Netty的特点" class="headerlink" title="Netty的特点"></a>Netty的特点</h3><p>选择了Netty，我们就应该明白Netty的一些特点，Netty具有以下特点：<br>1.异步、非阻塞、基于事件驱动的NIO框架<br>2.支持多种传输层通信协议，包括TCP、UDP等<br>3.开发异步HTTP服务端和客户端应用程序<br>4.提供对多种应用层协议的支持，包括TCP私有协议、HTTP协议、WebSocket协议、文件传输等<br>5.默认提供多种编解码能力，包括Java序列化、Google的ProtoBuf、二进制编解码、Jboss marshalling、文本字符串、base64、简单XML等，这些编解码框架可以被用户直接使用<br>6.提供形式多样的编解码基础类库，可以非常方便的实现私有协议栈编解码框架的二次定制和开发<br>7.经典的ChannelFuture-listener机制，所有的异步IO操作都可以设置listener进行监听和获取操作结果<br>8.基于ChannelPipeline-ChannelHandler的责任链模式，可以方便的自定义业务拦截器用于业务逻辑定制<br>9.安全性：支持SSL、HTTPS<br>10.可靠性：流量整形、读写超时控制机制、缓冲区最大容量限制、资源的优雅释放等<br>11.简洁的API和启动辅助类，简化开发难度，减少代码量</p>
<h3 id="NIO"><a href="#NIO" class="headerlink" title="NIO"></a>NIO</h3><p>Netty是基于NIO的通信框架，为什么要使用NIO而不是用传统的BIO通信机制呢，因为在BIO的线程模型上，存在着致命缺陷，由于线程模型问题，接入用户数与服务端创造线程数是1:1的关系，也就是说每一个用户从接入断开连接，服务端都要创造一个与之对应的线程做处理，一旦并发用户数增多，再好配置的服务器也有可能会有因为线程开销问题造成服务器崩溃宕机的情况。除此之外，BIO的所有IO操作都是同步的，当IO线程处理业务逻辑时，也会出现同步阻塞，其他请求都要进入阻塞状态。<br>相反，NIO的通信机制可以很好地解决BIO的线程开销问题，NIO采用Reactor通信模式，一个Reactor线程聚合一个多路复用Selector，这个Selector可同时注册、监听、轮回上百个Channel请求，这种情况下，一个IO线程就可以处理N个客户端的同时接入，接入用户数与线程数为N:1的关系，并且IO总数有限，不会出现频繁上下文切换，提高了CPU利用率，并且所有的 IO 操作都是异步的，即使业务线程直接进行IO操作，也不会被同步阻塞，系统不再依赖外部的网络环境和外部应用程序的处理性能</p>
<h3 id="Netty架构"><a href="#Netty架构" class="headerlink" title="Netty架构"></a>Netty架构</h3><p>Netty采用经典的MVC三层架构：<br>1.第一层：Reactor通信调度层，它由一系列辅助类组成，包括Reactor线程NioEventLoop 以及其父类、NioSocketChannel/NioServerSocketChannel 以及其父类、ByteBuffer 以及由其衍生出来的各种 Buffer、Unsafe 以及其衍生出的各种内部子类等。<br>2.第二层：职责链ChannelPipeLine，它负责调度事件在职责链中的传播，支持动态的编排职责链，职责链可以选择性的拦截自己关心的事件，对于其它IO操作和事件忽略，Handler同时支持inbound和outbound事件<br>3.第三层：业务逻辑编排层，业务逻辑编排层通常有两类：一类是纯粹的业务逻辑编排，还有一类是应用层协议插件，用于协议相关的编解码和链路管理，例如CMPP协议插件</p>
<h2 id="基于Netty实现的HTTP-Server"><a href="#基于Netty实现的HTTP-Server" class="headerlink" title="基于Netty实现的HTTP Server"></a>基于Netty实现的HTTP Server</h2><p>Netty其实更适合使用创建TCP长连接的Server，但是其也提供了HTTP的实现封装，我们也可以很容易的实现基于Netty的HTTP服务器。Netty实现HTTP服务器主要通过HttpResponseEncoder和HttpRequestDecoder来进行HTTP请求的解码以及HTTP响应的编码，通过HttpRequest和HttpResponse接口来实现对请求的解析以及对响应的构造。本节先描述整个处理流程，然后通过源码进行分享。</p>
<h3 id="处理流程"><a href="#处理流程" class="headerlink" title="处理流程"></a>处理流程</h3><p>使用Netty实现的HTTP Server的处理流程如下：<br>1.HttpServer接收到客户端的HttpRequest，打开Channel连接<br>2.pipeline中的HttpInHandler调用channelRead方法读取Channel中的ChannelHandlerContext和Object<br>3.channelRead中调用实现类HttpInHandlerImp中的处理，将请求按照Get或Post方式进行解析，并将数据转为ProtoMessage，然后转交给MsgHandler处理<br>4.MsgHandler将其封装为Message类添加到userid哈希的消息处理队列中，并对队列中的消息调用handle进行游戏的逻辑处理<br>5.在逻辑处理中，调用HttpInHandler的writeJSON方法构造并返回HttpResponse响应消息<br>6.HttpOutHandler截取消息并打印log日志<br>7.HttpResponse响应消息返回给客户端并断开Channel连接<br>整个流程的流程图如下：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/%E7%BD%91%E7%BB%9C%E6%B5%81%E7%A8%8B.png" alt="网络处理流程"></p>
<h3 id="HttpServer"><a href="#HttpServer" class="headerlink" title="HttpServer"></a>HttpServer</h3><p>HttpServer中负责创造并启动Netty实例，并绑定我们的逻辑Handler到pipeline，使请求进入我们自己的逻辑处理<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kidbear._36.net.http;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.ServerBootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelPipeline;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.HttpObjectAggregator;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.HttpRequestDecoder;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.HttpResponseEncoder;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.stream.ChunkedWriteHandler;</span><br><span class="line"><span class="keyword">import</span> io.netty.util.concurrent.DefaultThreadFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.io.Reader;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpServer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Logger log = LoggerFactory.getLogger(HttpServer.class);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HttpServer inst;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Properties p;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String ip;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> port;</span><br><span class="line">    <span class="keyword">private</span> NioEventLoopGroup bossGroup = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> NioEventLoopGroup workGroup = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">HttpServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HttpServer <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (inst == <span class="keyword">null</span>) &#123;</span><br><span class="line">            inst = <span class="keyword">new</span> HttpServer();</span><br><span class="line">            inst.initData();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> inst;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            p = readProperties();</span><br><span class="line">            ip = p.getProperty(<span class="string">"ip"</span>);</span><br><span class="line">            port = Integer.parseInt(p.getProperty(<span class="string">"port"</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">"socket配置文件读取错误"</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">0</span>, Executors.newCachedThreadPool());<span class="comment">// boss线程组</span></span><br><span class="line">        workGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">0</span>, Executors.newCachedThreadPool());<span class="comment">// work线程组</span></span><br><span class="line">        ServerBootstrap bootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">        bootstrap.group(bossGroup, workGroup);</span><br><span class="line">        bootstrap.channel(NioServerSocketChannel.class);</span><br><span class="line">        bootstrap.childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                ChannelPipeline pipeline = ch.pipeline();</span><br><span class="line">                <span class="comment">/* http request解码 */</span></span><br><span class="line">                pipeline.addLast(<span class="string">"decoder"</span>, <span class="keyword">new</span> HttpRequestDecoder());</span><br><span class="line">                pipeline.addLast(<span class="string">"aggregator"</span>, <span class="keyword">new</span> HttpObjectAggregator(<span class="number">65536</span>));</span><br><span class="line">                <span class="comment">/* http response 编码 */</span></span><br><span class="line">                pipeline.addLast(<span class="string">"encoder"</span>, <span class="keyword">new</span> HttpResponseEncoder());</span><br><span class="line">                pipeline.addLast(<span class="string">"http-chunked"</span>, <span class="keyword">new</span> ChunkedWriteHandler());</span><br><span class="line">                <span class="comment">/* http response handler */</span></span><br><span class="line">                pipeline.addLast(<span class="string">"outbound"</span>, <span class="keyword">new</span> HttpOutHandler());</span><br><span class="line">                <span class="comment">/* http request handler */</span></span><br><span class="line">                pipeline.addLast(<span class="string">"inbound"</span>, <span class="keyword">new</span> HttpInHandler());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        bootstrap.bind(port);</span><br><span class="line">        log.info(<span class="string">"端口&#123;&#125;已绑定"</span>, port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (bossGroup != <span class="keyword">null</span> &amp;&amp; workGroup != <span class="keyword">null</span>) &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">"端口&#123;&#125;已解绑"</span>, port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 读配置socket文件</span><br><span class="line">     * </span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     * <span class="doctag">@throws</span> IOException</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Properties <span class="title">readProperties</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Properties p = <span class="keyword">new</span> Properties();</span><br><span class="line">        InputStream in = HttpServer.class</span><br><span class="line">                .getResourceAsStream(<span class="string">"/net.properties"</span>);</span><br><span class="line">        Reader r = <span class="keyword">new</span> InputStreamReader(in, Charset.forName(<span class="string">"UTF-8"</span>));</span><br><span class="line">        p.load(r);</span><br><span class="line">        in.close();</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>代码中首先使用NioEventLoopGroup构造boss线程和work线程，然后构造ServerBootstrap，来设置Server的一些属性，包括在pipeline中添加Http的编码解码以及逻辑处理相关类。通过调用该类的start方法即可启动此HTTP服务器，其中端口在配置文件中配置好，启动时从配置文件读取。</p>
<h3 id="HttpInHandler"><a href="#HttpInHandler" class="headerlink" title="HttpInHandler"></a>HttpInHandler</h3><p>Http请求的处理器，绑定在pipeLine中，负责请求的解析与逻辑处理，代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kidbear._36.net.http;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerAdapter;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelPromise;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.FullHttpRequest;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.HttpResponseStatus;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * <span class="doctag">@ClassName</span>: HttpServerHandler</span><br><span class="line"> * <span class="doctag">@Description</span>: netty处理器</span><br><span class="line"> * <span class="doctag">@author</span> 何金成</span><br><span class="line"> * <span class="doctag">@date</span> 2015年12月18日 下午6:27:06</span><br><span class="line"> * </span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpInHandler</span> <span class="keyword">extends</span> <span class="title">ChannelHandlerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> HttpInHandlerImp handler = <span class="keyword">new</span> HttpInHandlerImp();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span></span><br><span class="line">            <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        handler.channelRead(ctx, msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span></span><br><span class="line">            <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        handler.exceptionCaught(ctx, cause);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeJSON</span><span class="params">(ChannelHandlerContext ctx,</span><br><span class="line">            HttpResponseStatus status, Object msg)</span> </span>&#123;</span><br><span class="line">        HttpInHandlerImp.writeJSON(ctx, status, msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeJSON</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> </span>&#123;</span><br><span class="line">        HttpInHandlerImp.writeJSON(ctx, msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中的实现方法我都将其分离出来为单独的类来处理，我这样做主要为了我以后能通过JSP热修复Bug（以后会讲到，通过JSP热加载的原理实现线上项目的热修复），分离出来的实现类代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kidbear._36.net.http;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.ByteBuf;</span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.ByteBufInputStream;</span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.ByteBufOutputStream;</span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.Unpooled;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelFutureListener;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.DefaultFullHttpRequest;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.DefaultFullHttpResponse;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.FullHttpResponse;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.HttpMethod;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.HttpResponseStatus;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.HttpVersion;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.QueryStringDecoder;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.multipart.Attribute;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.multipart.DefaultHttpDataFactory;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.multipart.HttpPostRequestDecoder;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.multipart.InterfaceHttpData;</span><br><span class="line"><span class="keyword">import</span> io.netty.util.CharsetUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"><span class="keyword">import</span> java.net.URLDecoder;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Future;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.core.GameServer;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.net.MsgHandler;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.net.ProtoMessage;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.net.ResultCode;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.net.rpc.JsonRpcServers;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.util.Constants;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.util.encrypt.XXTeaCoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpInHandlerImp</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger log = LoggerFactory.getLogger(HttpInHandlerImp.class);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String DATA = <span class="string">"data"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> CODE_DEBUG = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">public</span> ConcurrentHashMap&lt;String, Future&gt; executeMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Future&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(<span class="keyword">final</span> ChannelHandlerContext ctx, <span class="keyword">final</span> Object msg)</span></span><br><span class="line">            <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">/** work线程的内容转交线程池管理类处理，缩短work线程耗时 **/</span></span><br><span class="line">        <span class="keyword">if</span> (!GameServer.shutdown) &#123;<span class="comment">// 服务器开启的情况下</span></span><br><span class="line">            DefaultFullHttpRequest req = (DefaultFullHttpRequest) msg;</span><br><span class="line">            <span class="keyword">if</span> (req.getMethod() == HttpMethod.GET) &#123; <span class="comment">// 处理get请求</span></span><br><span class="line">                getHandle(ctx, req);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (req.getMethod() == HttpMethod.POST) &#123; <span class="comment">// 处理POST请求</span></span><br><span class="line">                postHandle(ctx, req);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="comment">// 服务器已关闭</span></span><br><span class="line">            JSONObject jsonObject = <span class="keyword">new</span> JSONObject();</span><br><span class="line">            jsonObject.put(<span class="string">"errMsg"</span>, <span class="string">"server closed"</span>);</span><br><span class="line">            writeJSON(ctx, jsonObject);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(<span class="keyword">final</span> ChannelHandlerContext ctx,</span><br><span class="line">            <span class="keyword">final</span> DefaultFullHttpRequest req)</span> </span>&#123;</span><br><span class="line">        HttpPostRequestDecoder decoder = <span class="keyword">new</span> HttpPostRequestDecoder(</span><br><span class="line">                <span class="keyword">new</span> DefaultHttpDataFactory(<span class="keyword">false</span>), req);</span><br><span class="line">        <span class="comment">// 逻辑接口处理</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            InterfaceHttpData data = decoder.getBodyHttpData(DATA);</span><br><span class="line">            <span class="keyword">if</span> (data != <span class="keyword">null</span>) &#123;</span><br><span class="line">                String val = ((Attribute) data).getValue();</span><br><span class="line">                val = codeFilter(val);</span><br><span class="line">                log.info(<span class="string">"ip:&#123;&#125;,read :&#123;&#125;"</span>, ctx.channel().remoteAddress(),</span><br><span class="line">                        val);</span><br><span class="line">                ProtoMessage msg = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    msg = JSON.parseObject(val, ProtoMessage.class);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">"gameData的json格式转换错误"</span>);</span><br><span class="line">                    HttpInHandler.writeJSON(ctx,</span><br><span class="line">                            HttpResponseStatus.NOT_ACCEPTABLE,</span><br><span class="line">                            <span class="string">"not acceptable"</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                Long userid = msg.getUserid();</span><br><span class="line">                <span class="comment">// 添加到消息处理队列</span></span><br><span class="line">                <span class="comment">// MsgHandler.getInstance().addMsg(userid, msg, ctx);</span></span><br><span class="line">                <span class="comment">// 直接处理消息</span></span><br><span class="line">                <span class="comment">// MsgHandler.getInstance().handle(new Message(msg, ctx));</span></span><br><span class="line">                <span class="comment">// 处理消息队列</span></span><br><span class="line">                MsgHandler.getInstance().handleMsg(userid, msg, ctx);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// 异常日志</span></span><br><span class="line">            log.error(<span class="string">"post error msg:"</span>, e);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="comment">// Print our stack trace</span></span><br><span class="line">            StringBuffer eBuffer = <span class="keyword">new</span> StringBuffer(e.getMessage() + <span class="string">","</span>);</span><br><span class="line">            StackTraceElement[] trace = e.getStackTrace();</span><br><span class="line">            <span class="keyword">for</span> (StackTraceElement traceElement : trace) &#123;</span><br><span class="line">                eBuffer.append(<span class="string">"\r\n "</span> + traceElement);</span><br><span class="line">            &#125;</span><br><span class="line">            HttpInHandler.writeJSON(ctx, ProtoMessage.getErrorResp(</span><br><span class="line">                    ResultCode.SERVER_ERR, eBuffer.toString()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getHandle</span><span class="params">(<span class="keyword">final</span> ChannelHandlerContext ctx,</span><br><span class="line">            DefaultFullHttpRequest req)</span> </span>&#123;</span><br><span class="line">        QueryStringDecoder decoder = <span class="keyword">new</span> QueryStringDecoder(req.getUri());</span><br><span class="line">        Map&lt;String, List&lt;String&gt;&gt; params = decoder.parameters();</span><br><span class="line">        List&lt;String&gt; typeList = params.get(<span class="string">"type"</span>);</span><br><span class="line">        <span class="keyword">if</span> (Constants.MSG_LOG_DEBUG) &#123;</span><br><span class="line">            log.info(<span class="string">"ip:&#123;&#125;,read :&#123;&#125;"</span>, ctx.channel().remoteAddress(),</span><br><span class="line">                    typeList.get(<span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        writeJSON(ctx, HttpResponseStatus.NOT_IMPLEMENTED, <span class="string">"not implement"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@Title</span>: codeFilter</span><br><span class="line">     * <span class="doctag">@Description</span>: 编解码过滤</span><br><span class="line">     * <span class="doctag">@param</span> val</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     * <span class="doctag">@throws</span> UnsupportedEncodingException</span><br><span class="line">     *             String</span><br><span class="line">     * <span class="doctag">@throws</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">codeFilter</span><span class="params">(String val)</span> <span class="keyword">throws</span> UnsupportedEncodingException </span>&#123;</span><br><span class="line">        val = val.contains(<span class="string">"%"</span>) ? URLDecoder.decode(val, <span class="string">"UTF-8"</span>) : val;</span><br><span class="line">        String valTmp = val;</span><br><span class="line">        val = CODE_DEBUG ? XXTeaCoder.decryptBase64StringToString(val,</span><br><span class="line">                XXTeaCoder.key) : val;</span><br><span class="line">        <span class="keyword">if</span> (Constants.MSG_LOG_DEBUG) &#123;</span><br><span class="line">            <span class="keyword">if</span> (val == <span class="keyword">null</span>) &#123;</span><br><span class="line">                val = valTmp;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> val;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeJSON</span><span class="params">(ChannelHandlerContext ctx,</span><br><span class="line">            HttpResponseStatus status, Object msg)</span> </span>&#123;</span><br><span class="line">        String sentMsg = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            sentMsg = (String) msg;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sentMsg = JSON.toJSONString(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        sentMsg = CODE_DEBUG ? XXTeaCoder.encryptToBase64String(sentMsg,</span><br><span class="line">                XXTeaCoder.key) : sentMsg;</span><br><span class="line">        writeJSON(ctx, status,</span><br><span class="line">                Unpooled.copiedBuffer(sentMsg, CharsetUtil.UTF_8));</span><br><span class="line">        ctx.flush();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeJSON</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> </span>&#123;</span><br><span class="line">        String sentMsg = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            sentMsg = (String) msg;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sentMsg = JSON.toJSONString(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        sentMsg = CODE_DEBUG ? XXTeaCoder.encryptToBase64String(sentMsg,</span><br><span class="line">                XXTeaCoder.key) : sentMsg;</span><br><span class="line">        writeJSON(ctx, HttpResponseStatus.OK,</span><br><span class="line">                Unpooled.copiedBuffer(sentMsg, CharsetUtil.UTF_8));</span><br><span class="line">        ctx.flush();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeJSON</span><span class="params">(ChannelHandlerContext ctx,</span><br><span class="line">            HttpResponseStatus status, ByteBuf content <span class="comment">/*</span><br><span class="line">                                                         * , boolean isKeepAlive</span><br><span class="line">                                                         */</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (ctx.channel().isWritable()) &#123;</span><br><span class="line">            FullHttpResponse msg = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (content != <span class="keyword">null</span>) &#123;</span><br><span class="line">                msg = <span class="keyword">new</span> DefaultFullHttpResponse(HttpVersion.HTTP_1_1, status,</span><br><span class="line">                        content);</span><br><span class="line">                msg.headers().set(HttpHeaders.Names.CONTENT_TYPE,</span><br><span class="line">                        <span class="string">"application/json; charset=utf-8"</span>);</span><br><span class="line">                msg.headers().set(<span class="string">"userid"</span>, <span class="number">101</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                msg = <span class="keyword">new</span> DefaultFullHttpResponse(HttpVersion.HTTP_1_1, status);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (msg.content() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                msg.headers().set(HttpHeaders.Names.CONTENT_LENGTH,</span><br><span class="line">                        msg.content().readableBytes());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// not keep-alive</span></span><br><span class="line">            ctx.write(msg).addListener(ChannelFutureListener.CLOSE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span></span><br><span class="line">            <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.error(<span class="string">"netty exception:"</span>, cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上代码实现了使用Netty中封装的Http请求的解析类对消息进行Get或Post解析，并使用了Http相应的构造类对返回消息进行Http消息格式的构造。</p>
<h3 id="MsgHandler"><a href="#MsgHandler" class="headerlink" title="MsgHandler"></a>MsgHandler</h3><p>以上代码包含了Netty中的Get请求和Post请求的解析处理，请求消息以及响应消息的XXTea加密解密等。其中，服务器接受到请求后，会将请求交给一个消息处理类进行具体的消息处理，消息处理器MsgHandler的代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kidbear._36.net;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.MessageSizeEstimator.Handle;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.BlockingQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentMap;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.LinkedBlockingQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.core.GameServer;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.core.Router;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.log.LogMgr;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.net.http.HttpInHandler;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.task.ExecutorPool;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * <span class="doctag">@ClassName</span>: MsgHandler</span><br><span class="line"> * <span class="doctag">@Description</span>: 消息处理器</span><br><span class="line"> * <span class="doctag">@author</span> 何金成</span><br><span class="line"> * <span class="doctag">@date</span> 2016年8月22日 下午12:04:23</span><br><span class="line"> * </span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MsgHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(MsgHandler.class);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> MsgHandler handler;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MsgHandler <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> handler == <span class="keyword">null</span> ? <span class="keyword">new</span> MsgHandler() : handler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">MsgHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@Fields</span> msgMap : 并发消息处理map</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ConcurrentMap&lt;Long, BlockingQueue&lt;Message&gt;&gt; msgMap = <span class="keyword">new</span> ConcurrentHashMap&lt;Long, BlockingQueue&lt;Message&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMsg</span><span class="params">(Long userid, ProtoMessage msg,</span><br><span class="line">            ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// add message</span></span><br><span class="line">        Message message = <span class="keyword">new</span> Message();</span><br><span class="line">        message.msg = msg;</span><br><span class="line">        message.ctx = ctx;</span><br><span class="line">        BlockingQueue&lt;Message&gt; queue = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (msgMap.containsKey(userid)) &#123;</span><br><span class="line">            queue = msgMap.get(userid);</span><br><span class="line">            queue.put(message);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            queue = <span class="keyword">new</span> LinkedBlockingQueue&lt;Message&gt;();</span><br><span class="line">            queue.put(message);</span><br><span class="line">            msgMap.put(userid, queue);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// log</span></span><br><span class="line">        LogMgr.getInstance().concurrentLog(msgMap);</span><br><span class="line">        <span class="comment">// handle message</span></span><br><span class="line">        <span class="keyword">while</span> (!queue.isEmpty()) &#123;</span><br><span class="line">            message = queue.take();</span><br><span class="line">            <span class="keyword">if</span> (queue.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                msgMap.remove(userid);</span><br><span class="line">            &#125;</span><br><span class="line">            handle(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@Title</span>: addMsg</span><br><span class="line">     * <span class="doctag">@Description</span>: 添加消息到处理队列</span><br><span class="line">     * <span class="doctag">@param</span> userid</span><br><span class="line">     * <span class="doctag">@param</span> msg</span><br><span class="line">     * <span class="doctag">@param</span> ctx</span><br><span class="line">     * <span class="doctag">@throws</span> InterruptedException</span><br><span class="line">     *             void</span><br><span class="line">     * <span class="doctag">@throws</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addMsg</span><span class="params">(Long userid, ProtoMessage msg, ChannelHandlerContext ctx)</span></span><br><span class="line">            <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Message message = <span class="keyword">new</span> Message();</span><br><span class="line">        message.msg = msg;</span><br><span class="line">        message.ctx = ctx;</span><br><span class="line">        <span class="keyword">if</span> (msgMap.containsKey(userid)) &#123;</span><br><span class="line">            BlockingQueue&lt;Message&gt; queue = msgMap.get(userid);</span><br><span class="line">            queue.put(message);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            BlockingQueue&lt;Message&gt; queue = <span class="keyword">new</span> LinkedBlockingQueue&lt;Message&gt;();</span><br><span class="line">            queue.put(message);</span><br><span class="line">            msgMap.put(userid, queue);</span><br><span class="line">        &#125;</span><br><span class="line">        LogMgr.getInstance().concurrentLog(msgMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@Title</span>: run</span><br><span class="line">     * <span class="doctag">@Description</span>: 处理消息队列 void</span><br><span class="line">     * <span class="doctag">@throws</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ExecutorPool.msgHandleThread.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                logger.info(<span class="string">"消息处理线程开启"</span>);</span><br><span class="line">                <span class="keyword">while</span> (!GameServer.shutdown) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (Iterator&lt;Long&gt; iterator = msgMap.keySet().iterator(); iterator</span><br><span class="line">                            .hasNext();) &#123;</span><br><span class="line">                        Long userid = iterator.next();</span><br><span class="line">                        BlockingQueue&lt;Message&gt; queue = msgMap.get(userid);</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            Message msg = queue.take();</span><br><span class="line">                            <span class="keyword">if</span> (queue.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                                iterator.remove();</span><br><span class="line">                            &#125;</span><br><span class="line">                            handle(msg);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                            logger.error(<span class="string">"msg handle err:&#123;&#125;"</span>, e);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(<span class="keyword">final</span> Message message)</span> </span>&#123;</span><br><span class="line">        ExecutorPool.channelHandleThread.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                Short typeid = message.msg.getTypeid();</span><br><span class="line">                <span class="keyword">if</span> (typeid == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    logger.error(<span class="string">"没有typeid"</span>);</span><br><span class="line">                    HttpInHandler.writeJSON(message.ctx,</span><br><span class="line">                            ProtoMessage.getErrorResp(<span class="string">"没有typeid"</span>));</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                JSONObject msgData = message.msg.getData();</span><br><span class="line">                Router.getInstance().route(typeid, msgData,</span><br><span class="line">                        message.msg.getUserid(), message.ctx);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上代码包含handleMsg、handle和addMsg方法，msgMap中包含每个用户的userid哈希对应的消息处理队列，原本我的设想是在服务器启动时，调用MsgHandler的run方法启动消息处理，无限循环的遍历msgMap，来处理所有玩家的消息处理队列，请求接入时，直接添加消息到msgMap的相应玩家的消息队列，然后由这个run方法中的线程来处理所有的消息，后来考虑到效率问题，改为直接在HttpInHandler中调用handleMsg方法，直接处理消息请求。每个玩家分配一个消息队列来进行处理主要是为了考虑到单个玩家的并发请求的情况。hash使用ConcurrentMap主要是考虑到这个Map的并发使用情景，使用ConcurrentMap的桶锁机制可以让它在并发情境中有更高的处理效率。</p>
<h3 id="Message"><a href="#Message" class="headerlink" title="Message"></a>Message</h3><p>MsgHandle中使用的Message类是对消息的封装包括ProtoMessage和ChannelHandlerContext，代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kidbear._36.net;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.BlockingQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Message</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> ProtoMessage msg;</span><br><span class="line">    <span class="keyword">public</span> ChannelHandlerContext ctx;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Message</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Message</span><span class="params">(ProtoMessage msg, ChannelHandlerContext ctx)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.msg = msg;</span><br><span class="line">        <span class="keyword">this</span>.ctx = ctx;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="ProtoMessage"><a href="#ProtoMessage" class="headerlink" title="ProtoMessage"></a>ProtoMessage</h3><p>ProtoMessage是通信中对消息格式的封装，消息格式定义为：”{typeid:1,userid:1,data:{}}”，typeid代表游戏中接口的协议号，userid代表玩家id，data代表具体传输的数据，其代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kidbear._36.net;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONArray;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProtoMessage</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@Fields</span> serialVersionUID : TODO</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">3460913241121151489L</span>;</span><br><span class="line">    <span class="keyword">private</span> Short typeid;</span><br><span class="line">    <span class="keyword">private</span> Long userid;</span><br><span class="line">    <span class="keyword">public</span> JSONObject data;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProtoMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; ProtoMessage(Short typeid, T data) &#123;</span><br><span class="line">        <span class="keyword">this</span>.typeid = typeid;</span><br><span class="line">        <span class="keyword">this</span>.setData(data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; ProtoMessage(T data) &#123;</span><br><span class="line">        <span class="keyword">this</span>.setData(data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ProtoMessage <span class="title">getResp</span><span class="params">(String msg, <span class="keyword">int</span> code)</span> </span>&#123;</span><br><span class="line">        JSONObject ret = <span class="keyword">new</span> JSONObject();</span><br><span class="line">        ret.put(<span class="string">"code"</span>, code);</span><br><span class="line">        <span class="keyword">if</span> (msg != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ret.put(<span class="string">"err"</span>, msg);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ProtoMessage(ret);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ProtoMessage <span class="title">getSuccessResp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getResp(<span class="keyword">null</span>, ResultCode.SUCCESS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ProtoMessage <span class="title">getEmptyResp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ProtoMessage();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ProtoMessage <span class="title">getErrorResp</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getResp(msg, ResultCode.COMMON_ERR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ProtoMessage <span class="title">getErrorResp</span><span class="params">(<span class="keyword">short</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getResp(<span class="keyword">null</span>, ResultCode.COMMON_ERR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ProtoMessage <span class="title">getErrorResp</span><span class="params">(<span class="keyword">int</span> code)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getResp(<span class="keyword">null</span>, code);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ProtoMessage <span class="title">getErrorResp</span><span class="params">(<span class="keyword">int</span> code, String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getResp(msg, code);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JSONObject <span class="title">getData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(JSONObject data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getData</span><span class="params">(Class&lt;T&gt; t)</span> </span>&#123;<span class="comment">// 转换为对象传递</span></span><br><span class="line">        <span class="keyword">return</span> JSON.parseObject(JSON.toJSONString(data), t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">setData</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.data = JSON.parseObject(JSON.toJSONString(t), JSONObject.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Short <span class="title">getTypeid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> typeid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTypeid</span><span class="params">(Short typeid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.typeid = typeid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getUserid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserid</span><span class="params">(Long userid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userid = userid;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="HttpOutHandler"><a href="#HttpOutHandler" class="headerlink" title="HttpOutHandler"></a>HttpOutHandler</h3><p>绑定在pipeLine中，负责处理相应消息，其实响应消息的处理在HttpInHandler的writeJSON方法中已经完成，使用DefaultFullHttpResponse对响应消息进行Http格式构造，然后调用ChannelHandlerContext的write方法直接write到消息管道中，并且在完成消息传输后自动关闭管道。而HttpOutHandler则只是截取响应消息并进行log打印输出一下，然后继续调用super发送出去，其接口及实现类代码如下：<br>HttpOutHandler:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kidbear._36.net.http;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerAdapter;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelPromise;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpOutHandler</span> <span class="keyword">extends</span> <span class="title">ChannelHandlerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> HttpOutHandlerImp handler = <span class="keyword">new</span> HttpOutHandlerImp();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(ChannelHandlerContext ctx, Object msg,</span><br><span class="line">            ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.write(ctx, msg, promise);</span><br><span class="line">        handler.write(ctx, msg, promise);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>HttpOutHandlerImp:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kidbear._36.net.http;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.util.Constants;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.ByteBuf;</span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.ByteBufUtil;</span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.Unpooled;</span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.UnpooledUnsafeDirectByteBuf;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelPromise;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.DefaultFullHttpResponse;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.HttpHeaders;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpOutHandlerImp</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> Logger logger = LoggerFactory.getLogger(HttpOutHandlerImp.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(ChannelHandlerContext ctx, Object msg,</span><br><span class="line">            ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Constants.MSG_LOG_DEBUG) &#123;</span><br><span class="line">            DefaultFullHttpResponse resp = (DefaultFullHttpResponse) msg;</span><br><span class="line">            logger.info(<span class="string">"ip:&#123;&#125;,write:&#123;&#125;"</span>, ctx.channel().remoteAddress(), resp</span><br><span class="line">                    .content().toString(Charset.forName(<span class="string">"UTF-8"</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章内容介绍我们的这款游戏的网络通信的处理方式，总体来说，对目前的策划需求，以及目前的用户量来说，这个通信框架已经能满足，但客观的说，这个网络架构还是存在很多问题的，比如通信使用JSON字符串，使得通信数据的大小没有得到很好地处理，如果使用ProtoBuffer这样高效的二进制数据传输会有更小的数据传输量。另外，通信完全采用Http通信，使得游戏中一些需要实时展示的效果只能通过请求——响应式来获取最新数据，比如游戏中的邮件、战报等功能，只能通过客户端的不断请求来获取到最新消息，实时效果通过非实时通信来实现，会有很多冗余的请求，浪费带宽资源，如果以后玩家数量太多，对网络通信这块，我们肯定还会再进行优化。<br>下章内容，我们会对游戏中的数据缓存与存储进行介绍。</p>
]]></content>
    
    <summary type="html">
    
      &lt;ul&gt;
&lt;li&gt;&lt;code&gt;文章版权归腾讯GAD所有，禁止匿名转载；禁止商业使用；禁止个人使用。&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;上文分析了我们这款SLG的架构，本章着重讲解我们的网络通信架构，由上文的功能分析我们可以得知，游戏的所有功能基本上属于非及时的通信机制，所以依靠HTTP短连接就能够基本满足游戏的通信需求。&lt;br&gt;
    
    </summary>
    
      <category term="Java" scheme="http://hjcenry.github.io/categories/Java/"/>
    
    
      <category term="Java" scheme="http://hjcenry.github.io/tags/Java/"/>
    
      <category term="游戏服务器" scheme="http://hjcenry.github.io/tags/%E6%B8%B8%E6%88%8F%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    
      <category term="SLG" scheme="http://hjcenry.github.io/tags/SLG/"/>
    
  </entry>
  
  <entry>
    <title>SLG手游Java服务器的设计与开发——架构分析</title>
    <link href="http://hjcenry.github.io/2016/08/14/SLG%E6%89%8B%E6%B8%B8Java%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%9E%B6%E6%9E%84%E5%88%86%E6%9E%90/"/>
    <id>http://hjcenry.github.io/2016/08/14/SLG手游Java服务器的设计与开发——架构分析/</id>
    <published>2016-08-13T16:07:00.000Z</published>
    <updated>2016-08-13T16:08:08.000Z</updated>
    
    <content type="html"><![CDATA[<ul>
<li><code>文章版权归腾讯GAD所有，禁止匿名转载；禁止商业使用；禁止个人使用。</code></li>
</ul>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>从去年12月份开始，到现在，我全程参与了公司一款SLG手游的研发，负责整个游戏的服务端部分。这也是我第一次单独负责一款网游的服务端开发，整个研发过程，也让我的各方面技术提升了不少。目前这款游戏正在紧张的测试中，预计下周左右会在XY渠道进行一轮封测，以测试玩家对我们的游戏的反馈数据。<a id="more"></a></p>
<p>这款游戏集合市面上大多数SLG的特点，包含了卡牌、装备、科技、建筑的等养成内容，同时也在战斗系统做了创新，通过卡牌搭配，装备搭配，以及阵型搭配，再加上各方面的养成数据，能让玩家在战斗中产生不同的效果。同时，他最大的特点也是最核心的部分，就是国战，不过很遗憾的是，第一版上线不会有国战内容，因为在测试过程中，我们发现整个国战的游戏机制还存在很多漏洞，我们将会持续优化，优化出一版完整的国战内容，再呈现给玩家。</p>
<p>我经历了整个开发过程，在游戏服务器开发方面有了不少新的认识，我想通过写文章的方式把这些设计思路、技术难点、以及踩过的坑，都分享给大家，所以我们准备通过系列文章的方式一点一点把服务器的框架内容分享出来，本章首先从游戏服务器的架构分析开始。</p>
<h2 id="功能介绍"><a href="#功能介绍" class="headerlink" title="功能介绍"></a>功能介绍</h2><p>在开始设计整个游戏服务器的架构之前，我首先需要对游戏的功能有所掌握。上文已经简单提到了部分核心功能，比如卡牌、装备、阵型等，但实际上游戏的内容并不止这些。这款游戏属于SLG手游，即策略类的游戏，游戏以三国为题材，通过获得三国名将卡牌，搭配各种装备，设置战斗阵型，达到在战斗中的不同表现效果，战斗模式类似于《小小军团》的战斗，但是小小军团主要以兵种为核心，而我们的战斗以武将为核心，不同武将有不同的技能，不同的战斗属性，合理搭配，才能发挥最大的效果。围绕着这些游戏核心，设计了以下不同的功能模块。</p>
<h3 id="账号系统"><a href="#账号系统" class="headerlink" title="账号系统"></a>账号系统</h3><p>作为一款网游，最基础的，就是账号系统，一款网游一定会有账号系统，这是保证玩家能从不同终端都能进入自己的游戏数据的凭证。不过最近在手游市场，一般情况游戏都不会有自己的账号系统，而是接入第三方的账号系统，比如腾讯游戏一般会让玩家选择QQ登录或微信登录，网易一般会让玩家选择网易账号登录，还有很多渠道如XY，海马玩，快用等，都有自己的账号系统，账号系统的功能，就是保证玩家的唯一标识。</p>
<h3 id="君主模块"><a href="#君主模块" class="headerlink" title="君主模块"></a>君主模块</h3><p>进入游戏之后，玩家就需要创建一个君主，并设置君主的名字，性别，头像和国家。SLG游戏中，资源也是一个很重要的内容，所有的资源都是跟玩家直接相关的，所以资源内容也是跟君主相关，我们就可以把资源内容绑定在君主模块中，玩家在游戏中，是扮演这个君主的角色，所有游戏中的资源消耗以及资源产出，都是跟君主息息相关。在竞技场以及国战等pvp玩法中，君主也是玩家在游戏的唯一身份显示。</p>
<h3 id="卡牌模块"><a href="#卡牌模块" class="headerlink" title="卡牌模块"></a>卡牌模块</h3><p>这款游戏在SLG的基础之上加上了卡牌养成玩法，玩家需要通过收集卡牌来进行游戏的操作，卡牌包含了吕布、关羽、张飞、华雄等三国名将。卡牌分了白绿蓝紫橙红的品质分段，不同品质的卡牌有着不同的属性数值。卡牌可以通过酒馆抽卡获得，抽卡分为单次抽卡和十连抽，十连抽会必中一张橙色卡片。卡牌具有星级属性，多张相同的卡牌还可以进行升星操作，升星具有一定的失败几率，品质越高，失败率越高。如果有多余的卡牌，还可以进行分解操作，分解卡牌可以获得将魂和银两，而将魂还可以继续用于抽卡。在战斗中，上阵的卡牌将会增长经验，而卡牌的等级，就与它的经验相关。总结起来，卡牌具有等级和星级两个养成属性，其它还有统勇智以及攻击防御，技能伤害，普攻伤害等基础属性。整个卡牌模块还有很多养成点的。</p>
<h3 id="装备模块"><a href="#装备模块" class="headerlink" title="装备模块"></a>装备模块</h3><p>有了战斗的卡牌，那就必须给卡牌配备装备模块了，所有的卡牌具有6个装备位，每个装备位对应一种装备，装备也分为了白绿蓝紫橙红的几个品质阶段，不同品质的卡牌也能给卡牌加上不同的属性效果，卡牌同样具有等级和星级两个养成属性以及其他的基础属性，装备可以进行强化以强化等级，以及升星来提升装备的星级，升星消耗任意的装备作为材料。卡牌模块配合装备模块，可以有更多的养成玩法的自由发挥空间。</p>
<h3 id="道具模块"><a href="#道具模块" class="headerlink" title="道具模块"></a>道具模块</h3><p>游戏中也有常见的背包，背包中存放着各种道具，道具种类繁多，包括粮草、银两、经验丹等资源道具，也可以在背包中查看拥有的卡牌和装备。背包中可以直接使用道具，使用完道具就能增加相应的资源。</p>
<h3 id="建筑模块"><a href="#建筑模块" class="headerlink" title="建筑模块"></a>建筑模块</h3><p>玩家刚进入游戏会看到很多建筑，这些建筑都具有不同的功能，升级这些建筑会增强建筑的属性效果，建筑包括皇城、军机处、校场、仓库、招商局、兵营、酒馆、竞技场、铁匠铺、农田（6个）、民居（6个），各个建筑具有不同的功能，皇城等级限制所有建筑的最高等级，军机处可以解锁升级科技，军机处等级限制科技等级，仓库等级限制最高资源上限，招商局等级限制民居产出，兵营等级限制兵力上限，铁匠铺等级限制装备强化等级，农田和民居的等级限制资源的产出，竞技场和酒馆没有等级，竞技场是功能入口，酒馆包含抽卡，卡牌升星和卡牌分解的功能。</p>
<h3 id="科技模块"><a href="#科技模块" class="headerlink" title="科技模块"></a>科技模块</h3><p>军机处的科技收到军机处建筑的等级限制，科技一共有30个，随着军机处的等级分别开放，不同的科技能增加不同的效果，其实有部分科技是属于阵型，每解锁一种阵型，就能在战斗前设置战斗的阵型，阵型中的位置也会随着君主的等级而开放。</p>
<h3 id="关卡模块"><a href="#关卡模块" class="headerlink" title="关卡模块"></a>关卡模块</h3><p>游戏核心内容是战斗，战斗包含了普通关卡和精英关卡、以及竞技场、国战和日常副本。其中，普通关卡、精英关卡和日常副本在功能上来说是差不多的，只是战斗中的数值配置不同，精英关卡和日常副本加了挑战次数限制，日常副本还加了难度解锁限制。</p>
<h3 id="竞技场"><a href="#竞技场" class="headerlink" title="竞技场"></a>竞技场</h3><p>玩家的君主等级升级到16级时会开启竞技场，竞技场是玩家第一次感觉自己玩的不是单机的内容，竞技场的规则是打离线数据，服务器开服之后会初始化2000名机器人，玩家选择挑战前面排名的玩家，如果挑战成功，则互换位次，如果挑战失败，则位次不变，同时成功失败均会损失挑战次数，挑战次数次日刷新。</p>
<h3 id="活动模块"><a href="#活动模块" class="headerlink" title="活动模块"></a>活动模块</h3><p>国产游戏最少不了的还是活动模块了，做游戏除了卖情怀，就是卖活动，活动是一款游戏付费率最高的内容。这款游戏中包含的活动不多，只有每日签到、会员、首冲、以及豪华签到。每日签到是每9天一个轮回，每天签到送不同的奖励，其他几种活动均是需要充值人民币之后再领取到相应的奖励。</p>
<h3 id="国战模块"><a href="#国战模块" class="headerlink" title="国战模块"></a>国战模块</h3><p>国战分为两个模块，国战PVE和人国战PVP，玩家30级开启国战之后会进入一个大地图，地图上有76座城池，玩家首先需要进入国战PVE模块，把所有的城池都攻打下来才会开启国战的PVP模块，不过很遗憾的是，即将上线的版本的国战PVP模块并没有开放，打完PVE之后就会弹出提示PVP暂未开放。虽然没有开放，但实际上我们也做了一版国战，不过在测试中发现其机制有问题，便决定优化之后再上线这个模块。国战PVE同关卡部分大同小异，只不过由闯关改为了攻打城池。</p>
<h3 id="热更新"><a href="#热更新" class="headerlink" title="热更新"></a>热更新</h3><p>现在的网游大部分都会有热更新的功能，所谓热更新，就是指用户在不从应用商店更新游戏版本的情况下，直接进入游戏，在游戏中更新游戏版本。热更新的原理就是在服务端存储一个游戏版本，客户端每次进入游戏先读取服务端的版本信息，如果有最新版本，就直接从服务端进行下载，下载完在本地解压更新本地资源，然后再进入游戏，这样玩家就能看到最新版本的游戏资源。</p>
<p>以上是部分功能内容，其他还有很多边缘的系统功能没有介绍，通过这部分内容我们就可以开始对游戏的服务器框架进行分析设计了。</p>
<h2 id="网络通信"><a href="#网络通信" class="headerlink" title="网络通信"></a>网络通信</h2><p>通过功能设计，可以发现，除了国战模块，游戏整体对实时性要求都不高，与前端商议之后，决定先使用HTTP短连接，国战部分再做商议（但其实后来开发国战模块也是通过短连接实现的，因为其机制就是一个异步的机制），网络通信的数据传输也暂时采用最简单的JSON字符串。不过目前这个机制确实产生了很多问题，首先是HTTP协议，在其他模块没多大问题，但在国战模块的时候要求实时性较高，应该采用实时性更强的TCP长连接比较合适。另外就是数据传输的问题，直接采用JSON字符串确实也没问题，但是传输字符串会让传输信息量变大，这样在弱网情况下会使得游戏的体验很不好，如果采用二进制进行传输，就会好很多。这次的这方面问题没有考虑周全，下一次我还是希望采用TCP长连接加Google Protobuffer这样的二进制传输协议进行数据交互。</p>
<h2 id="数据存储"><a href="#数据存储" class="headerlink" title="数据存储"></a>数据存储</h2><p>游戏数据分为两部分：游戏数据和玩家数据，游戏数据指的是游戏中的静态数据，如果签到奖励，战斗掉落，抽卡概率等内容，这部分内容均由策划配置好静态表，服务器启动时直接读取静态表，将表中内容加载到服务器内存，使用时直接从内存读取，而玩家数据指是随着玩家的操作而变化的数据，这部分数据我又分为了冷数据和热数据，热数据即游戏中读写频繁的数据，如免费抽卡次数、君主体力恢复、国战城池状态等，这部分数据的特点就是读写都很频繁，并且数据结构各不相同，每时每刻这些数据都有可能产生变化，产生读写操作，这部分数据，数据结构各不相同，可以采用nosql数据库，而Redis不仅是nosql数据库，还是内存数据库，非常适合这部分数据的存储。冷数据，则指的是交互相对不是很频繁的数据，如君主等级，卡牌等级，卡牌星级，装备等级，装备星级等，这部分数据的特点就是读写不是很频繁，需要玩家做了一定操作才会发生变化，并且数据具有结构化的特点，这些数据可以抽象出关系型数据表，所以我采用了Mysql进行了这部分数据的存储，为了考虑数据库性能，我采用了Memcache进行Mysql结果集的缓存。后来我认为，其实游戏数据的结构应该是采用Mongo更符合需求，它多变的数据结构满足游戏中的各种数据类型，但由于确实Mongo的实际开发经验和维护经验，也没敢轻易尝试。</p>
<h2 id="架构设计"><a href="#架构设计" class="headerlink" title="架构设计"></a>架构设计</h2><p>作为后端服务器，能否对前端请求快速做出响应，是判断一个服务器性能是否良好的重要指标，对于客户端来说，服务端就是一个url地址或者一个套接字，但是对于整个服务端架构来说，暴露给客户端的或许只是其中的一个连接处理服务器。良好的服务端架构是整个服务端开发成功了一半。我个人经验并不是很丰富，所以我所设计的架构也并不是很好的架构，大多数都是我参考了网上大量的关于服务端架构的文章之后的设计，在参考别人文章的过程中，自己也有了很多感悟。<br>根据游戏的需求，可将服务器大致分为登录服务器、逻辑服务器、文件服务器、支付服务器、国战服务器和聊天服务器。在第一轮进行封测时候只有一台服务器，所以目前所有的服务器设计均部署在同一台服务器上，提前设计好架构以便在以后更多玩家进来之后进行服务器分离，以承受更多的负载。<br>总体的结构设计图如下：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/%E6%9E%B6%E6%9E%84%E5%85%B3%E7%B3%BB%E5%9B%BE.png" alt="服务器架构图"></p>
<h3 id="登录服务器"><a href="#登录服务器" class="headerlink" title="登录服务器"></a>登录服务器</h3><p>负责接入客户端的登录，选服的功能，多台登录服务器可通过Nginx配置负载均衡以承载更多玩家的连接。玩家登录选服之后，登录服务器会返回逻辑服务器的地址，此时客户端与登录服务器便没有任何关系，只需要拿着地址去连接相应的逻辑服务器，通过引导玩家去到不同的游戏服就实现了玩家流量的分流。</p>
<h3 id="逻辑服务器"><a href="#逻辑服务器" class="headerlink" title="逻辑服务器"></a>逻辑服务器</h3><p>这是游戏中最重要的用于处理玩家游戏逻辑的服务器，玩家的所有逻辑操作都将基于此服务器，如果要用到其他的服务，则采用Rpc的通信方式调用其他服务器的进程，逻辑服务器与其他服务器的通信采用Motan Rpc框架，逻辑服务器作为Motan的调用方，其他服务器均作为Motan的服务方。</p>
<h3 id="文件服务器"><a href="#文件服务器" class="headerlink" title="文件服务器"></a>文件服务器</h3><p>主要用于游戏中的热更新，进入游戏前，客户端将进行版本检查，如果发现有最新版本的内容，会提供文件服务器的最新版本下载地址，客户端请求文件服务器进行更新版本文件下载。</p>
<h3 id="支付服务器"><a href="#支付服务器" class="headerlink" title="支付服务器"></a>支付服务器</h3><p>游戏中的充值付费均由支付服务器完成，在逻辑服务器调用支付操作之后，逻辑服务器会通过Motan Rpc调用支付服务器发起支付操作，之后支付服务器会开始调用相应的支付操作，目前游戏的支付一般是众多平台的联运，会接入第三方的支付SDK，各联运商的支付接口规范各式各样，开发商必须要遵循个平台的规范。</p>
<h3 id="国战服务器"><a href="#国战服务器" class="headerlink" title="国战服务器"></a>国战服务器</h3><p>国战服务器负责处理游戏中的核心玩法——国战玩法，由于国战的同时在线人数可能较多，所以我把此部分单独分为一个服务器，来处理国战部分的内容，玩家通过逻辑服进入国战服务器之后，所有的接入将会转为国战服务器，由国战服务器来处理国战相关的内容，这样又能把一部分玩家流量分出来，承担更多的负载。</p>
<h3 id="聊天服务器"><a href="#聊天服务器" class="headerlink" title="聊天服务器"></a>聊天服务器</h3><p>游戏暂无聊天功能，但如果以后加入聊天功能，会将此功能单独分出来作为聊天服务器，处理游戏中的聊天信息。</p>
<h2 id="系统架构"><a href="#系统架构" class="headerlink" title="系统架构"></a>系统架构</h2><p>以上对服务器的部署架构进行了设计，以上设计按照功能划分，把游戏服务器分为了多个模块，以逻辑服为中心，其他服为服务提供者的方式进行的服务器划分。各个模块在承受不住玩家压力时都可以再纵向做服务器的集群扩展，个人感觉这种设计还是比较合理的。由上可见，逻辑服务器是游戏服务器整个架构的核心。</p>
<p>架构设计之后就要开始对服务器中的技术进行选型，首先开发语言是定位了Java，那么从网络层来说，常见的就有Servlet、Spring、Struts、Netty、和Mina，Servlet、Spring和Struts其实可以归为一类，因为Spring和Struts实际上就是对Servlet的一层封装，在Java Web开发来说，应该说已经是很成熟的技术了，他们其实已经对底层的链路做了良好的封装，仅支持HTTP协议，用户使用他们只需要关注核心的业务逻辑即可，但在Servlet3.0以前，Servlet的IO都是同步阻塞的IO处理（BIO），从3.0开始，才将Servlet API和NIO结合在了一起，在游戏中，玩家客户端与游戏服务端的请求处理操作是非常频繁的，从IO方式来看，显然异步的NIO机制要比同步的BIO快很多，基于NIO能构建出IO处理速度更快的服务端，而Mina和Netty都是基于NIO的网络框架。最终，在Servlet3和Netty，以及Mina中，我选择了Netty作为我的网络层框架，原因是Netty有更多的成熟案例，API开发更加简易，并且有更多的社区和资料。<br>从数据层来说，前文已经提到了，我将使用Mysql来存储玩家冷数据，用Redis存储玩家热数据，使用Mysql时结合Memcache缓存查询结果集，增加数据库的读性能。使用Redis直接使用Redis官方的Jedis API即可，Jedis不仅能直接连接Redis，也能用Sentinel进行Redis的主从集群。Mysql我使用了Hibernate做数据库ORM框架，原因是游戏中不会有太多的复杂查询，最多会有一个类似于”where userid=1”这样的查询条件，没有太复杂的SQL语句，Hibernate对JDBC做了良好的封装，如果没有很多复杂的SQL语句，则可以直接使用Hibernate即可。虽然Hibernate的性能不如MyBatis或JDBC，但有了Hibernate+Memcache的方案，相信能弥补一些性能上的不足。<br>还有其他一些技术就不再做过多的介绍，总体的架构流程如下：<br>1.游戏客户端为Cocos2d，与服务器交互采用Http通信，数据传输采用Json格式字符串<br>2.服务器端的网络层使用基于Netty实现的Http服务器<br>3.通过Netty接入客户端请求，根据请求数据中的协议号，调用服务器中相对应的逻辑模块<br>4.逻辑模块处理消息，若要处理游戏数据则调用Jedis或Hibernate处理，若触发某事件，则调用事件处理器<br>5.通过Netty的ChannelHandlerContext返回处理结果<br>6.客户端与服务器交互的数据通过XXTea+Base64进行加密处理<br>系统架构图如下：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="系统架构图"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>至此，本文对游戏的架构分析的内容就结束了，我参加工作也不久，个人经验很欠缺，文中描述的技术若有误导的部分，还请帮忙指出来，不要继续误导其他人，再次感谢大家。本系列文章是我本人参与一款SLG手游服务端开发的一些个人见解，我只是想把我学到的，我知道的东西分享给大家。下章开始，我将从各个部分，以源代码为基础进行详细介绍，下章先讲讲Netty在HTTP游戏服务器中的应用。</p>
<h2 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h2><p>从产品立项到开发，到测试，我经历了整个开发的过程，整个过程除了让我在个人技术上有了不少提升、对游戏服务器有了新的认识之外，也让我对整个游戏行业有了很多的看法。在产品的研发过程中，我们团队见证了COK的火爆，CR的兴起，ChinaJoy中也看到了中国有很多优秀的手游作品，同时我们也看到了国家在7月1日开始对游戏行业立的新规，以及苹果对中国政策的妥协。我们目前的状态，可以说是挑战与机遇并存，小型游戏CP团队，不是生，就是死。在这大半年开发中，我们的产品也是在不断调整方向，以适应残酷的游戏市场，国家出了新规之后，我们也是第一时间就去申请了文网文以及游戏版号，足以见得，我们团队的每个人，都想要在这场无声的战争中活下来。眼看产品就要上线，我们也对自己这款产品做了上线后的数据目标以及盈利目标，不管怎么样，我认为这是我们辛勤付出的东西，不管成功与否，我们都有了宝贵的经验，也算对得起努力的付出了。</p>
]]></content>
    
    <summary type="html">
    
      &lt;ul&gt;
&lt;li&gt;&lt;code&gt;文章版权归腾讯GAD所有，禁止匿名转载；禁止商业使用；禁止个人使用。&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;从去年12月份开始，到现在，我全程参与了公司一款SLG手游的研发，负责整个游戏的服务端部分。这也是我第一次单独负责一款网游的服务端开发，整个研发过程，也让我的各方面技术提升了不少。目前这款游戏正在紧张的测试中，预计下周左右会在XY渠道进行一轮封测，以测试玩家对我们的游戏的反馈数据。
    
    </summary>
    
      <category term="Java" scheme="http://hjcenry.github.io/categories/Java/"/>
    
    
      <category term="Java" scheme="http://hjcenry.github.io/tags/Java/"/>
    
      <category term="游戏服务器" scheme="http://hjcenry.github.io/tags/%E6%B8%B8%E6%88%8F%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    
      <category term="SLG" scheme="http://hjcenry.github.io/tags/SLG/"/>
    
  </entry>
  
  <entry>
    <title>Cocos2d-JS实现的打飞机</title>
    <link href="http://hjcenry.github.io/2016/07/10/Cocos2d-JS%E5%AE%9E%E7%8E%B0%E7%9A%84%E6%89%93%E9%A3%9E%E6%9C%BA/"/>
    <id>http://hjcenry.github.io/2016/07/10/Cocos2d-JS实现的打飞机/</id>
    <published>2016-07-10T10:17:00.000Z</published>
    <updated>2016-07-10T12:56:50.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>今天我们来讲一个最最最常见的一个小游戏——打飞机！是的，打飞机！还记得小时候在玩儿的雷电，应该是打飞机最早的样子了吧。直到现在，也有微信打飞机，全民飞机大战，全民打飞机等游戏的出现，这些游戏基本都是在我们小时候玩儿的打飞机的原型上增加特效音效以及更多新的玩儿法，在这基础上进行的创新。<a id="more"></a>其实作为开发者来说，仔细看这款游戏，也并不是什么高大上的游戏，其他很多元素、逻辑，都是我们常见的，比如滚动背景，定时产生敌人等。真正开发一款打飞机游戏，其实只要一天就够了，但这个游戏的经典玩法却是很难超越的，在这里，我不得不向这款游戏的原创致敬。</p>
<h3 id="游戏分析"><a href="#游戏分析" class="headerlink" title="游戏分析"></a>游戏分析</h3><p>游戏中的元素基本可以确定，有玩家，三种敌机，两种道具，子弹和滚动的背景。而游戏的场景，也就是开始场景，游戏场景，帮助场景（这个都是可有可无的），暂停场景和结束场景。游戏中的逻辑其实也很简单，无非就是灵活运用定时器，定时产生敌人，定时产生子弹，定时产生道具，再然后就是玩家与道具，玩家与敌人，子弹与敌人的碰撞检测。我们可以把以上提到的元素全部抽象成类，每个类封装自己的实现接口，在游戏场景中调用相应类的对应的方法即可。</p>
<h3 id="游戏实现"><a href="#游戏实现" class="headerlink" title="游戏实现"></a>游戏实现</h3><h4 id="全局类"><a href="#全局类" class="headerlink" title="全局类"></a>全局类</h4><p>游戏中所有用到的常量都可以放在一个全局类中，在实际开发中可根据需求动态修改，也方便管理维护。<br>代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by Henry on 16/7/6.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">var</span> Global = &#123;</span><br><span class="line">    <span class="comment">// 子弹移动速度</span></span><br><span class="line">    bulletSpeed:<span class="number">10</span>,</span><br><span class="line">    <span class="comment">// 敌机移动速度</span></span><br><span class="line">    enemySpeed:<span class="function"><span class="keyword">function</span>(<span class="params">type</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">switch</span>(type)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 敌机创造速度</span></span><br><span class="line">    createEnemySpeed:<span class="function"><span class="keyword">function</span>(<span class="params">type</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">switch</span>(type)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 敌机生命</span></span><br><span class="line">    enemyHp:<span class="function"><span class="keyword">function</span>(<span class="params">type</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">switch</span>(type)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 道具移动速度</span></span><br><span class="line">    toolSpeed:<span class="function"><span class="keyword">function</span>(<span class="params">type</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">switch</span>(type)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 道具创造速度</span></span><br><span class="line">    createToolSpeed:<span class="function"><span class="keyword">function</span>(<span class="params">type</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">switch</span>(type)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">30</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">50</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 射击速度</span></span><br><span class="line">    shootSpeed:<span class="number">0.2</span>,</span><br><span class="line">    <span class="comment">// 双倍射击时长</span></span><br><span class="line">    doubleShootTimes:<span class="number">100</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h4 id="背景类"><a href="#背景类" class="headerlink" title="背景类"></a>背景类</h4><p>游戏中用到的背景也可以提出来为一个背景类，游戏中的背景是滚动的，滚动背景的实现方式就是用两张相同的图片拼接起来，不断往下移动，当下面那张完全移出屏幕的时候，再将这张图片移动到前一张的上面，这样一直循环往复，就形成了不断滚动的背景。实现代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by Henry on 16/7/6.</span><br><span class="line"> */</span></span><br><span class="line"> <span class="keyword">var</span> Background = cc.Sprite.extend(&#123;</span><br><span class="line">     ctor: <span class="function"><span class="keyword">function</span> (<span class="params">isOver</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(isOver)&#123;</span><br><span class="line">            <span class="keyword">this</span>._super();</span><br><span class="line">            <span class="keyword">var</span> bg = <span class="keyword">new</span> cc.Sprite(cc.spriteFrameCache.getSpriteFrame(<span class="string">"gameover.png"</span>));</span><br><span class="line">            bg.setScale(<span class="number">750</span>/<span class="number">480</span>);</span><br><span class="line">            <span class="keyword">this</span>.addChild(bg);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">this</span>._super();</span><br><span class="line">            <span class="keyword">this</span>.setScale(<span class="number">750</span>/<span class="number">480</span>);</span><br><span class="line">            <span class="comment">// 滚动背景图1</span></span><br><span class="line">            <span class="keyword">var</span> menuBg1 = <span class="keyword">new</span> cc.Sprite(cc.spriteFrameCache.getSpriteFrame(<span class="string">"background.png"</span>));</span><br><span class="line">            menuBg1.setPosition(cc.winSize.width / <span class="number">2</span>, cc.winSize.height / <span class="number">2</span>);</span><br><span class="line">            menuBg1.setScale(<span class="number">750</span> / <span class="number">480</span>);</span><br><span class="line">            menuBg1.setTag(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">this</span>.addChild(menuBg1);</span><br><span class="line">            <span class="comment">// 滚动背景图2</span></span><br><span class="line">            <span class="keyword">var</span> menuBg2 = <span class="keyword">new</span> cc.Sprite(cc.spriteFrameCache.getSpriteFrame(<span class="string">"background.png"</span>));</span><br><span class="line">            menuBg2.setPosition(cc.winSize.width / <span class="number">2</span>, cc.winSize.height / <span class="number">2</span> + cc.winSize.height - <span class="number">4</span>);</span><br><span class="line">            menuBg2.setScale(<span class="number">750</span> / <span class="number">480</span>);</span><br><span class="line">            menuBg2.setTag(<span class="number">2</span>);</span><br><span class="line">            <span class="keyword">this</span>.addChild(menuBg2);</span><br><span class="line">            <span class="keyword">this</span>.schedule(<span class="keyword">this</span>.update);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">     &#125;,</span><br><span class="line">     stopMove:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.unschedule(<span class="keyword">this</span>.update);</span><br><span class="line">     &#125;,</span><br><span class="line">     update: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">         <span class="keyword">var</span> menuBg1 = <span class="keyword">this</span>.getChildByTag(<span class="number">1</span>);</span><br><span class="line">         <span class="keyword">var</span> menuBg2 = <span class="keyword">this</span>.getChildByTag(<span class="number">2</span>);</span><br><span class="line">         <span class="keyword">if</span> (menuBg1.getPositionY() &lt;= -cc.winSize.height / <span class="number">2</span> + <span class="number">20</span>) &#123;</span><br><span class="line">             menuBg1.setPositionY(cc.winSize.height / <span class="number">2</span> + cc.winSize.height);</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             menuBg1.setPositionY(menuBg1.getPositionY() - <span class="number">1</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (menuBg2.getPositionY() &lt;= -cc.winSize.height / <span class="number">2</span> + <span class="number">20</span>) &#123;</span><br><span class="line">             menuBg2.setPositionY(cc.winSize.height / <span class="number">2</span> + cc.winSize.height);</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             menuBg2.setPositionY(menuBg2.getPositionY() - <span class="number">1</span>);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure></p>
<h4 id="子弹类"><a href="#子弹类" class="headerlink" title="子弹类"></a>子弹类</h4><p>玩家不断发出子弹，子弹类需要包含移动和移除两个方法，子弹一旦被创建，就按照一个轨迹移动，直到碰撞到敌机或飞出屏幕才移除子弹，碰撞检测在游戏场景中实现，碰撞之后调用子弹类的移除方法。<br>代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by Henry on 16/7/6.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">var</span> Bullet = cc.Sprite.extend(&#123;</span><br><span class="line">    gameLayer:<span class="literal">null</span>,</span><br><span class="line">    ctor: <span class="function"><span class="keyword">function</span> (<span class="params">type,isUp,gameLayer</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.gameLayer = gameLayer;</span><br><span class="line">        <span class="keyword">this</span>._super(cc.spriteFrameCache.getSpriteFrame(<span class="string">"bullet"</span>+type+<span class="string">".png"</span>));</span><br><span class="line">        <span class="keyword">if</span>(isUp)&#123;</span><br><span class="line">            <span class="keyword">this</span>.schedule(<span class="keyword">this</span>.moveUp);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.schedule(<span class="keyword">this</span>.moveDown);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    moveUp:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setPositionY(<span class="keyword">this</span>.getPositionY() + Global.bulletSpeed);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.getPositionY()&gt;=cc.winSize.height+<span class="keyword">this</span>.height/<span class="number">2</span>)&#123;</span><br><span class="line">            <span class="comment">// 飞出屏幕删除</span></span><br><span class="line">            <span class="keyword">this</span>.remove();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    moveDown:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setPositionY(<span class="keyword">this</span>.getPositionY() - Global.bulletSpeed);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.getPositionY()&lt;=-<span class="keyword">this</span>.height/<span class="number">2</span>)&#123;</span><br><span class="line">            <span class="comment">// 飞出屏幕删除</span></span><br><span class="line">            <span class="keyword">this</span>.remove();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    remove:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> index = <span class="keyword">this</span>.gameLayer.bullets.indexOf(<span class="keyword">this</span>);  </span><br><span class="line">        <span class="keyword">if</span> (index &gt; <span class="number">-1</span>) &#123;  </span><br><span class="line">            <span class="keyword">this</span>.gameLayer.bullets.splice(index, <span class="number">1</span>);  </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.removeFromParent();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h4 id="玩家类"><a href="#玩家类" class="headerlink" title="玩家类"></a>玩家类</h4><p>游戏中的主角就是玩家类，玩家控制玩家类在屏幕中移动飞行，并不断射击子弹，玩家类中包含单行子弹射击和吃完道具之后的双行子弹射击两个方法，玩家还有移动方法，飞入屏幕方法和爆炸方法。同时飞机重复播放飞行动画。<br>代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by Henry on 16/7/6.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">var</span> Player = cc.Sprite.extend(&#123;</span><br><span class="line">    lock:<span class="literal">true</span>,</span><br><span class="line">    gameLayer:<span class="literal">null</span>,</span><br><span class="line">    doubleCount:<span class="number">0</span>,</span><br><span class="line">    ctor: <span class="function"><span class="keyword">function</span> (<span class="params">gameLayer</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super(cc.spriteFrameCache.getSpriteFrame(<span class="string">"hero1.png"</span>));</span><br><span class="line">        <span class="keyword">this</span>.gameLayer = gameLayer;</span><br><span class="line">        <span class="keyword">this</span>.doubleCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.lock = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// 飞行动画</span></span><br><span class="line">        <span class="keyword">var</span> heroHoldFrames = [</span><br><span class="line">            cc.spriteFrameCache.getSpriteFrame(<span class="string">"hero1.png"</span>),</span><br><span class="line">            cc.spriteFrameCache.getSpriteFrame(<span class="string">"hero2.png"</span>)</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">var</span> holdAnimation = <span class="keyword">new</span> cc.Animation(heroHoldFrames, <span class="number">0.1</span>);</span><br><span class="line">        <span class="keyword">this</span>.runAction(cc.repeatForever(cc.animate(holdAnimation)));</span><br><span class="line">        <span class="keyword">this</span>.moveIn();</span><br><span class="line">        <span class="keyword">this</span>.schedule(<span class="keyword">this</span>.shootSingleBullet,Global.shootSpeed);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    shootSingleBullet:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.lock) &#123;</span><br><span class="line">            <span class="keyword">var</span> bullet = <span class="keyword">new</span> Bullet(<span class="number">2</span>,<span class="literal">true</span>,<span class="keyword">this</span>.gameLayer);</span><br><span class="line">            bullet.setPosition(<span class="keyword">this</span>.getPositionX(),<span class="keyword">this</span>.getPositionY()+<span class="keyword">this</span>.height/<span class="number">2</span>);</span><br><span class="line">            <span class="keyword">this</span>.gameLayer.addChild(bullet);</span><br><span class="line">            <span class="keyword">this</span>.gameLayer.bullets.push(bullet);</span><br><span class="line">            <span class="comment">// 发射子弹音效</span></span><br><span class="line">            cc.audioEngine.playEffect(<span class="string">"res/sound/bullet.mp3"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    shootDoubleBegin:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.unschedule(<span class="keyword">this</span>.shootSingleBullet);</span><br><span class="line">        <span class="keyword">this</span>.schedule(<span class="keyword">this</span>.shootDoubleBullet,Global.shootSpeed<span class="number">-0.1</span>);</span><br><span class="line">        <span class="keyword">this</span>.doubleCount = <span class="number">0</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    shootDoubleBullet:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.lock) &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>.doubleCount&gt;=Global.doubleShootTimes)&#123;</span><br><span class="line">                <span class="keyword">this</span>.unschedule(<span class="keyword">this</span>.shootDoubleBullet);</span><br><span class="line">                <span class="keyword">this</span>.schedule(<span class="keyword">this</span>.shootSingleBullet,Global.shootSpeed);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">this</span>.doubleCount += <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">var</span> bulletLeft = <span class="keyword">new</span> Bullet(<span class="number">2</span>,<span class="literal">true</span>,<span class="keyword">this</span>.gameLayer);</span><br><span class="line">                <span class="keyword">var</span> bulletRight = <span class="keyword">new</span> Bullet(<span class="number">2</span>,<span class="literal">true</span>,<span class="keyword">this</span>.gameLayer);</span><br><span class="line">                bulletLeft.setPosition(<span class="keyword">this</span>.getPositionX()<span class="number">-35</span>,<span class="keyword">this</span>.getPositionY()+<span class="number">5</span>);</span><br><span class="line">                bulletRight.setPosition(<span class="keyword">this</span>.getPositionX()+<span class="number">35</span>,<span class="keyword">this</span>.getPositionY()+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">this</span>.gameLayer.addChild(bulletLeft);</span><br><span class="line">                <span class="keyword">this</span>.gameLayer.addChild(bulletRight);</span><br><span class="line">                <span class="keyword">this</span>.gameLayer.bullets.push(bulletLeft);</span><br><span class="line">                <span class="keyword">this</span>.gameLayer.bullets.push(bulletRight);</span><br><span class="line">                <span class="comment">// 发射子弹音效</span></span><br><span class="line">                cc.audioEngine.playEffect(<span class="string">"res/sound/bullet.mp3"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    moveIn:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.runAction(cc.sequence(</span><br><span class="line">            cc.moveTo(<span class="number">1</span>, cc.p(cc.winSize.width/<span class="number">2</span>, cc.winSize.height/<span class="number">2</span>)),</span><br><span class="line">            cc.moveBy(<span class="number">2</span>, cc.p(<span class="number">0</span>, <span class="number">-400</span>)),</span><br><span class="line">            cc.callFunc(<span class="function"><span class="keyword">function</span>(<span class="params">player</span>)</span>&#123;</span><br><span class="line">                <span class="comment">// 播完动画解锁操作</span></span><br><span class="line">                player.lock = <span class="literal">false</span>;</span><br><span class="line">            &#125;,<span class="keyword">this</span>,<span class="keyword">this</span>)</span><br><span class="line">        ));</span><br><span class="line">    &#125;,</span><br><span class="line">    moveBy:<span class="function"><span class="keyword">function</span>(<span class="params">x,y</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.lock) &#123;</span><br><span class="line">            <span class="keyword">this</span>.setPosition(<span class="keyword">this</span>.getPositionX() + x, <span class="keyword">this</span>.getPositionY() + y);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    blowUp:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.lock = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// 爆炸动画</span></span><br><span class="line">        <span class="keyword">var</span> blowUpFrames = [</span><br><span class="line">            cc.spriteFrameCache.getSpriteFrame(<span class="string">"hero_blowup_n1.png"</span>),</span><br><span class="line">            cc.spriteFrameCache.getSpriteFrame(<span class="string">"hero_blowup_n2.png"</span>),</span><br><span class="line">            cc.spriteFrameCache.getSpriteFrame(<span class="string">"hero_blowup_n3.png"</span>),</span><br><span class="line">            cc.spriteFrameCache.getSpriteFrame(<span class="string">"hero_blowup_n4.png"</span>)</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">var</span> blowUpAnimation = <span class="keyword">new</span> cc.Animation(blowUpFrames, <span class="number">0.1</span>);</span><br><span class="line">        <span class="keyword">this</span>.stopAllActions();</span><br><span class="line">        <span class="keyword">this</span>.runAction(cc.sequence(cc.animate(blowUpAnimation),cc.callFunc(<span class="function"><span class="keyword">function</span>(<span class="params">hero</span>)</span>&#123;</span><br><span class="line">            hero.removeFromParent();</span><br><span class="line">        &#125;,<span class="keyword">this</span>,<span class="keyword">this</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h4 id="敌机类"><a href="#敌机类" class="headerlink" title="敌机类"></a>敌机类</h4><p>敌机分为三种，小型飞机，中型飞机和大型飞机，三种飞机的血量，速度都不相同，其中，大型飞机还能在每三秒创建三个小型飞机。敌机同样包含移动，击中和爆炸方法。<br>代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by Henry on 16/7/6.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">var</span> Enemy = cc.Sprite.extend(&#123;</span><br><span class="line">    type:<span class="number">1</span>,</span><br><span class="line">    hp:<span class="number">0</span>,</span><br><span class="line">    gameLayer:<span class="literal">null</span>,</span><br><span class="line">    ctor: <span class="function"><span class="keyword">function</span> (<span class="params">type,gameLayer</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.type = type;</span><br><span class="line">        <span class="keyword">this</span>.hp = Global.enemyHp(type);</span><br><span class="line">        <span class="keyword">this</span>.gameLayer = gameLayer;</span><br><span class="line">        <span class="keyword">if</span>(type==<span class="number">3</span>)&#123;</span><br><span class="line">            <span class="comment">// 大型飞机的动画</span></span><br><span class="line">            <span class="keyword">this</span>._super(cc.spriteFrameCache.getSpriteFrame(<span class="string">"enemy"</span>+type+<span class="string">"_n1.png"</span>));</span><br><span class="line">            <span class="keyword">var</span> holdFrames = [</span><br><span class="line">                cc.spriteFrameCache.getSpriteFrame(<span class="string">"enemy"</span>+type+<span class="string">"_n1.png"</span>),</span><br><span class="line">                cc.spriteFrameCache.getSpriteFrame(<span class="string">"enemy"</span>+type+<span class="string">"_n2.png"</span>)</span><br><span class="line">            ];</span><br><span class="line">            <span class="keyword">var</span> holdAnimation = <span class="keyword">new</span> cc.Animation(holdFrames, <span class="number">0.1</span>);</span><br><span class="line">            <span class="keyword">this</span>.runAction(cc.repeatForever(cc.animate(holdAnimation)));</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">this</span>._super(cc.spriteFrameCache.getSpriteFrame(<span class="string">"enemy"</span>+type+<span class="string">".png"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.schedule(<span class="keyword">this</span>.moveDown);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.type==<span class="number">3</span>)&#123;</span><br><span class="line">            <span class="comment">// 大飞机每3s产生3个小飞机</span></span><br><span class="line">            <span class="keyword">this</span>.schedule(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="keyword">this</span>.createEnemy();</span><br><span class="line">            &#125;,<span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 创造三个小型飞机</span></span><br><span class="line">    createEnemy:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> enemy1 = <span class="keyword">new</span> Enemy(<span class="number">1</span>,<span class="keyword">this</span>.gameLayer);</span><br><span class="line">        <span class="keyword">var</span> enemy2 = <span class="keyword">new</span> Enemy(<span class="number">1</span>,<span class="keyword">this</span>.gameLayer);</span><br><span class="line">        <span class="keyword">var</span> enemy3 = <span class="keyword">new</span> Enemy(<span class="number">1</span>,<span class="keyword">this</span>.gameLayer);</span><br><span class="line">        <span class="keyword">var</span> x1 = <span class="keyword">this</span>.getPositionX()-<span class="keyword">this</span>.width/<span class="number">2</span>+enemy1.width/<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">var</span> x2 = <span class="keyword">this</span>.getPositionX();</span><br><span class="line">        <span class="keyword">var</span> x3 = <span class="keyword">this</span>.getPositionX()+<span class="keyword">this</span>.width/<span class="number">2</span>-enemy3.width/<span class="number">2</span>;</span><br><span class="line">        enemy1.setPosition(x1,<span class="keyword">this</span>.getPositionY());</span><br><span class="line">        enemy2.setPosition(x2,<span class="keyword">this</span>.getPositionY());</span><br><span class="line">        enemy3.setPosition(x3,<span class="keyword">this</span>.getPositionY());</span><br><span class="line">        <span class="keyword">this</span>.gameLayer.addChild(enemy1);</span><br><span class="line">        <span class="keyword">this</span>.gameLayer.addChild(enemy2);</span><br><span class="line">        <span class="keyword">this</span>.gameLayer.addChild(enemy3);</span><br><span class="line">        <span class="keyword">this</span>.gameLayer.enemies.push(enemy1);</span><br><span class="line">        <span class="keyword">this</span>.gameLayer.enemies.push(enemy2);</span><br><span class="line">        <span class="keyword">this</span>.gameLayer.enemies.push(enemy3);</span><br><span class="line">    &#125;,</span><br><span class="line">    moveDown:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setPositionY(<span class="keyword">this</span>.getPositionY() - <span class="built_in">parseInt</span>(Global.enemySpeed(<span class="keyword">this</span>.type)));</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.getPositionY()&lt;=-<span class="keyword">this</span>.height/<span class="number">2</span>)&#123;</span><br><span class="line">            <span class="comment">// 飞出屏幕删除</span></span><br><span class="line">            <span class="keyword">this</span>.remove();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    remove:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> index = <span class="keyword">this</span>.gameLayer.enemies.indexOf(<span class="keyword">this</span>);  </span><br><span class="line">        <span class="keyword">if</span> (index &gt; <span class="number">-1</span>) &#123;  </span><br><span class="line">            <span class="keyword">this</span>.gameLayer.enemies.splice(index, <span class="number">1</span>);  </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.removeFromParent();</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 击中</span></span><br><span class="line">    hit:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 击中动画</span></span><br><span class="line">        <span class="keyword">this</span>.hp -= <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.hp&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">this</span>.blowUp();</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> holdFrame = <span class="keyword">this</span>.type==<span class="number">3</span>?<span class="string">"enemy"</span>+<span class="keyword">this</span>.type+<span class="string">"_n1.png"</span>:<span class="string">"enemy"</span>+<span class="keyword">this</span>.type+<span class="string">".png"</span>;</span><br><span class="line">            <span class="keyword">var</span> hitFrames = [</span><br><span class="line">                cc.spriteFrameCache.getSpriteFrame(holdFrame),</span><br><span class="line">                cc.spriteFrameCache.getSpriteFrame(<span class="string">"enemy"</span>+<span class="keyword">this</span>.type+<span class="string">"_hit.png"</span>)</span><br><span class="line">            ];</span><br><span class="line">            <span class="keyword">var</span> hitAnimation = <span class="keyword">new</span> cc.Animation(hitFrames, <span class="number">0.1</span>);</span><br><span class="line">            <span class="keyword">this</span>.runAction(cc.sequence(cc.animate(hitAnimation),cc.callFunc(<span class="function"><span class="keyword">function</span>(<span class="params">enemy</span>)</span>&#123;</span><br><span class="line">                enemy.setSpriteFrame(cc.spriteFrameCache.getSpriteFrame(holdFrame));</span><br><span class="line">            &#125;,<span class="keyword">this</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 爆炸</span></span><br><span class="line">    blowUp:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.type==<span class="number">3</span>)&#123;</span><br><span class="line">            <span class="comment">// 大飞机爆炸产生3个小飞机</span></span><br><span class="line">            <span class="keyword">this</span>.createEnemy();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.unschedule(<span class="keyword">this</span>.moveDown);</span><br><span class="line">        <span class="keyword">var</span> index = <span class="keyword">this</span>.gameLayer.enemies.indexOf(<span class="keyword">this</span>);  </span><br><span class="line">        <span class="keyword">if</span> (index &gt; <span class="number">-1</span>) &#123;  </span><br><span class="line">            <span class="keyword">this</span>.gameLayer.enemies.splice(index, <span class="number">1</span>);  </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 爆炸动画</span></span><br><span class="line">        <span class="keyword">var</span> blowUpFrames = [</span><br><span class="line">            cc.spriteFrameCache.getSpriteFrame(<span class="string">"enemy"</span>+<span class="keyword">this</span>.type+<span class="string">"_down1.png"</span>),</span><br><span class="line">            cc.spriteFrameCache.getSpriteFrame(<span class="string">"enemy"</span>+<span class="keyword">this</span>.type+<span class="string">"_down2.png"</span>),</span><br><span class="line">            cc.spriteFrameCache.getSpriteFrame(<span class="string">"enemy"</span>+<span class="keyword">this</span>.type+<span class="string">"_down3.png"</span>),</span><br><span class="line">            cc.spriteFrameCache.getSpriteFrame(<span class="string">"enemy"</span>+<span class="keyword">this</span>.type+<span class="string">"_down4.png"</span>)</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.type==<span class="number">3</span>)&#123;</span><br><span class="line">            blowUpFrames = blowUpFrames.concat([</span><br><span class="line">                cc.spriteFrameCache.getSpriteFrame(<span class="string">"enemy"</span>+<span class="keyword">this</span>.type+<span class="string">"_down5.png"</span>),</span><br><span class="line">                cc.spriteFrameCache.getSpriteFrame(<span class="string">"enemy"</span>+<span class="keyword">this</span>.type+<span class="string">"_down6.png"</span>)</span><br><span class="line">            ]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 播放爆炸音效</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.type==<span class="number">3</span>)&#123;</span><br><span class="line">            cc.audioEngine.playEffect(<span class="string">"res/sound/enemy3_down.mp3"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            cc.audioEngine.playEffect(<span class="string">"res/sound/enemy1_down.mp3"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> blowUpAnimation = <span class="keyword">new</span> cc.Animation(blowUpFrames, <span class="number">0.1</span>);</span><br><span class="line">        <span class="keyword">this</span>.stopAllActions();</span><br><span class="line">        <span class="keyword">this</span>.runAction(cc.sequence(cc.animate(blowUpAnimation),cc.callFunc(<span class="function"><span class="keyword">function</span>(<span class="params">enemy</span>)</span>&#123;</span><br><span class="line">            enemy.removeFromParent();</span><br><span class="line">        &#125;,<span class="keyword">this</span>,<span class="keyword">this</span>)));</span><br><span class="line">        <span class="comment">// 加分</span></span><br><span class="line">        <span class="keyword">this</span>.gameLayer.addScore(<span class="keyword">this</span>.type);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h4 id="道具类"><a href="#道具类" class="headerlink" title="道具类"></a>道具类</h4><p>游戏中会定时掉落道具，道具类包含向下移动方法，移除方法和旋转方法。道具与玩家的碰撞检测在游戏场景中实现。<br>代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by Henry on 16/7/6.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">var</span> Tool = cc.Sprite.extend(&#123;</span><br><span class="line">    gameLayer:<span class="literal">null</span>,</span><br><span class="line">    type:<span class="number">0</span>,</span><br><span class="line">    ctor: <span class="function"><span class="keyword">function</span> (<span class="params">type,gameLayer</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super(cc.spriteFrameCache.getSpriteFrame(<span class="string">"ufo"</span>+type+<span class="string">".png"</span>));</span><br><span class="line">        <span class="keyword">this</span>.type = type;</span><br><span class="line">        <span class="keyword">this</span>.gameLayer = gameLayer;</span><br><span class="line">        <span class="comment">// 旋转特效</span></span><br><span class="line">        <span class="keyword">this</span>.rotate();</span><br><span class="line">        <span class="comment">// 向下移动</span></span><br><span class="line">        <span class="keyword">this</span>.schedule(<span class="keyword">this</span>.moveDown);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    moveDown:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setPositionY(<span class="keyword">this</span>.getPositionY()-Global.toolSpeed(<span class="keyword">this</span>.type));</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.getPositionY()&lt;=-<span class="keyword">this</span>.height/<span class="number">2</span>)&#123;</span><br><span class="line">            <span class="comment">// 飞出屏幕删除</span></span><br><span class="line">            <span class="keyword">this</span>.remove();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    remove:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> index = <span class="keyword">this</span>.gameLayer.tools.indexOf(<span class="keyword">this</span>);  </span><br><span class="line">        <span class="keyword">if</span> (index &gt; <span class="number">-1</span>) &#123;  </span><br><span class="line">            <span class="keyword">this</span>.gameLayer.tools.splice(index, <span class="number">1</span>);  </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.runAction(cc.sequence(cc.scaleTo(<span class="number">0.1</span>,<span class="number">0</span>),cc.callFunc(<span class="function"><span class="keyword">function</span>(<span class="params">tool</span>)</span>&#123;</span><br><span class="line">            tool.removeFromParent();</span><br><span class="line">        &#125;,<span class="keyword">this</span>,<span class="keyword">this</span>)));</span><br><span class="line">    &#125;,</span><br><span class="line">    rotate:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> rotateAction = cc.repeatForever(cc.sequence(cc.rotateTo(<span class="number">1</span>,<span class="number">30</span>),cc.sequence(cc.rotateTo(<span class="number">1</span>,<span class="number">-30</span>))));</span><br><span class="line">        <span class="keyword">this</span>.runAction(rotateAction);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h4 id="载入类"><a href="#载入类" class="headerlink" title="载入类"></a>载入类</h4><p>载入类只是在开始场景中的一个载入的循环播放的动画。<br>代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by Henry on 16/7/6.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">var</span> Loading = cc.Sprite.extend(&#123;</span><br><span class="line">    ctor: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super(cc.spriteFrameCache.getSpriteFrame(<span class="string">"game_loading1.png"</span>));</span><br><span class="line">        <span class="keyword">var</span> loadingFrames = [</span><br><span class="line">            cc.spriteFrameCache.getSpriteFrame(<span class="string">"game_loading1.png"</span>),</span><br><span class="line">            cc.spriteFrameCache.getSpriteFrame(<span class="string">"game_loading2.png"</span>),</span><br><span class="line">            cc.spriteFrameCache.getSpriteFrame(<span class="string">"game_loading3.png"</span>),</span><br><span class="line">            cc.spriteFrameCache.getSpriteFrame(<span class="string">"game_loading4.png"</span>)</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">var</span> loadingAnimation = <span class="keyword">new</span> cc.Animation(loadingFrames, <span class="number">0.5</span>);</span><br><span class="line">        <span class="keyword">this</span>.runAction(cc.repeatForever(cc.animate(loadingAnimation)));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h4 id="开始场景"><a href="#开始场景" class="headerlink" title="开始场景"></a>开始场景</h4><p>开始场景是游戏的入口场景，进入之后首先进入开始场景，开始场景包含开始游戏按钮和帮助按钮，点击帮助按钮进入帮助场景，点击开始按钮进入游戏场景。开始场景还包含一个滚动的背景图和一个载入动画。<br>开始场景的效果如下：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/MenuScene.gif" alt="开始场景"><br>代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by Henry on 16/7/6.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">var</span> MenuLayer = cc.Layer.extend(&#123;</span><br><span class="line">    loadCount: <span class="number">1</span>,</span><br><span class="line">    ctor: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">this</span>.loadCount = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 加载plist</span></span><br><span class="line">        cc.spriteFrameCache.addSpriteFrames(res.shoot_background_plist);</span><br><span class="line">        <span class="comment">// 添加背景图</span></span><br><span class="line">        <span class="keyword">var</span> bg = <span class="keyword">new</span> Background(<span class="literal">false</span>);</span><br><span class="line">        bg.setPosition(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(bg);</span><br><span class="line">        <span class="comment">// logo</span></span><br><span class="line">        <span class="keyword">var</span> copyright = <span class="keyword">new</span> cc.Sprite(cc.spriteFrameCache.getSpriteFrame(<span class="string">"shoot_copyright.png"</span>));</span><br><span class="line">        copyright.setPosition(cc.winSize.width / <span class="number">2</span>, cc.winSize.height / <span class="number">2</span> + <span class="number">270</span>);</span><br><span class="line">        copyright.runAction(cc.repeatForever(cc.sequence(cc.scaleTo(<span class="number">1</span>, <span class="number">1.5</span>), cc.scaleTo(<span class="number">1</span>, <span class="number">1</span>))));</span><br><span class="line">        <span class="keyword">this</span>.addChild(copyright);</span><br><span class="line">        <span class="comment">// 游戏按钮</span></span><br><span class="line">        <span class="keyword">var</span> startBtn = <span class="keyword">new</span> cc.MenuItemSprite(</span><br><span class="line">            <span class="keyword">new</span> cc.Sprite(<span class="string">"res/game_start.png"</span>),</span><br><span class="line">            <span class="keyword">new</span> cc.Sprite(<span class="string">"res/game_start_selected.png"</span>),</span><br><span class="line">            <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                cc.audioEngine.playEffect(<span class="string">"res/sound/button.mp3"</span>);</span><br><span class="line">                cc.director.runScene(<span class="keyword">new</span> cc.TransitionFade(<span class="number">1</span>, <span class="keyword">new</span> GameScene()));</span><br><span class="line">            &#125;, <span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">var</span> helpBtn = <span class="keyword">new</span> cc.MenuItemSprite(</span><br><span class="line">            <span class="keyword">new</span> cc.Sprite(<span class="string">"res/game_help.png"</span>),</span><br><span class="line">            <span class="keyword">new</span> cc.Sprite(<span class="string">"res/game_help_selected.png"</span>),</span><br><span class="line">            <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                cc.audioEngine.playEffect(<span class="string">"res/sound/button.mp3"</span>);</span><br><span class="line">                cc.director.runScene(<span class="keyword">new</span> cc.TransitionFade(<span class="number">1</span>, <span class="keyword">new</span> HelpScene()));</span><br><span class="line">            &#125;, <span class="keyword">this</span>);</span><br><span class="line">        helpBtn.setPositionY(startBtn.getPositionY() - startBtn.height / <span class="number">2</span> - <span class="number">100</span>);</span><br><span class="line">        <span class="keyword">var</span> menu = <span class="keyword">new</span> cc.Menu(startBtn, helpBtn);</span><br><span class="line">        <span class="keyword">this</span>.addChild(menu);</span><br><span class="line">        <span class="comment">// loading动画</span></span><br><span class="line">        <span class="keyword">var</span> loading = <span class="keyword">new</span> Loading();</span><br><span class="line">        loading.setPosition(cc.winSize.width/<span class="number">2</span>,<span class="number">200</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(loading);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> MenuScene = cc.Scene.extend(&#123;</span><br><span class="line">    onEnter: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> layer = <span class="keyword">new</span> MenuLayer();</span><br><span class="line">        <span class="keyword">this</span>.addChild(layer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h4 id="游戏场景"><a href="#游戏场景" class="headerlink" title="游戏场景"></a>游戏场景</h4><p>从开始场景点击开始游戏按钮之后进入游戏场景，游戏场景包含所有的游戏逻辑，包括滚动背景，玩家，定时产生的敌机，定时产生的道具，玩家与敌机、敌机与子弹、以及玩家与道具的碰撞检测，玩家的移动操作，使用爆炸道具等。<br>游戏开始之前有一个玩家飞入屏幕的动画，效果图如下：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/MoveIn.gif" alt="玩家飞入"><br>玩家飞入之后，就可以定时创建子弹、道具与敌机，游戏场景的效果图如下：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/GameScene.gif" alt="游戏场景"><br>掉落的道具有发射双排子弹和炸弹两种，双排子弹效果图如下：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/DoubleShoot.gif" alt="双排子弹"><br>拾取到炸弹道具会累加到左下角的计数中，点击炸弹就可以使用，炸弹可让屏幕中所有飞机全部爆炸，效果图如下：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/Bomb.gif" alt="炸弹"><br>游戏中的敌机，子弹以及道具，都用数组来存储，每一帧都要遍历数组来进行碰撞检测，但玩家与子弹碰撞，玩家与敌机碰撞，以及敌机与子弹碰撞时，调用相应的类的逻辑，代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by Henry on 16/7/6.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">var</span> GameLayer = cc.Layer.extend(&#123;</span><br><span class="line">    touchStartX:<span class="number">0</span>,</span><br><span class="line">    touchStartY:<span class="number">0</span>,</span><br><span class="line">    bullets:[],</span><br><span class="line">    enemies:[],</span><br><span class="line">    tools:[],</span><br><span class="line">    ctor: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">this</span>.touchStartX = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.touchStartY = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.bullets = [];</span><br><span class="line">        <span class="keyword">this</span>.enemies = [];</span><br><span class="line">        <span class="keyword">this</span>.tools = [];</span><br><span class="line">        <span class="comment">// 播放背景音乐</span></span><br><span class="line">        cc.audioEngine.playMusic(<span class="string">"res/sound/game_music.mp3"</span>,<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// 加载plist</span></span><br><span class="line">        cc.spriteFrameCache.addSpriteFrames(res.shoot_background_plist);</span><br><span class="line">        cc.spriteFrameCache.addSpriteFrames(res.shoot_plist);</span><br><span class="line">        <span class="comment">// 添加背景图</span></span><br><span class="line">        <span class="keyword">var</span> bg = <span class="keyword">new</span> Background(<span class="literal">false</span>);</span><br><span class="line">        bg.setPosition(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(bg);</span><br><span class="line">        <span class="comment">// 添加飞机</span></span><br><span class="line">        <span class="keyword">var</span> player = <span class="keyword">new</span> Player(<span class="keyword">this</span>);</span><br><span class="line">        player.setPosition(cc.winSize.width / <span class="number">2</span>, -player.height / <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(player);</span><br><span class="line">        player.setTag(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 产生敌机</span></span><br><span class="line">        <span class="keyword">this</span>.schedule(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.createEnemy(<span class="number">1</span>);</span><br><span class="line">        &#125;,Global.createEnemySpeed(<span class="number">1</span>));</span><br><span class="line">        <span class="keyword">this</span>.schedule(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.createEnemy(<span class="number">2</span>);</span><br><span class="line">        &#125;,Global.createEnemySpeed(<span class="number">2</span>));</span><br><span class="line">        <span class="keyword">this</span>.schedule(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.createEnemy(<span class="number">3</span>);</span><br><span class="line">        &#125;,Global.createEnemySpeed(<span class="number">3</span>));</span><br><span class="line">        <span class="comment">// 产生道具</span></span><br><span class="line">        <span class="keyword">this</span>.schedule(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.createTool(<span class="number">1</span>);</span><br><span class="line">        &#125;,Global.createToolSpeed(<span class="number">1</span>));</span><br><span class="line">        <span class="keyword">this</span>.schedule(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.createTool(<span class="number">2</span>);</span><br><span class="line">        &#125;,Global.createToolSpeed(<span class="number">2</span>));</span><br><span class="line">        <span class="comment">// 添加爆炸道具</span></span><br><span class="line">        <span class="keyword">var</span> bombNor = <span class="keyword">new</span> cc.Sprite(cc.spriteFrameCache.getSpriteFrame(<span class="string">"bomb.png"</span>));</span><br><span class="line">        <span class="keyword">var</span> bombSelected = <span class="keyword">new</span> cc.Sprite(cc.spriteFrameCache.getSpriteFrame(<span class="string">"bomb.png"</span>));</span><br><span class="line">        bombSelected.setPosition(-bombSelected.width/<span class="number">4</span>,-bombSelected.height/<span class="number">4</span>);</span><br><span class="line">        bombSelected.setScale(<span class="number">1.5</span>);</span><br><span class="line">        <span class="keyword">var</span> bombBtn = <span class="keyword">new</span> cc.MenuItemSprite(</span><br><span class="line">            bombNor,</span><br><span class="line">            bombSelected,</span><br><span class="line">            <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="keyword">var</span> bombNum = <span class="keyword">this</span>.getChildByTag(<span class="number">3</span>);</span><br><span class="line">                <span class="keyword">if</span>(<span class="built_in">parseInt</span>(bombNum.getString().slice(<span class="number">1</span>))==<span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 全屏爆炸</span></span><br><span class="line">                <span class="keyword">var</span> blowEnemy = [];</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">var</span> i <span class="keyword">in</span> <span class="keyword">this</span>.enemies)&#123;</span><br><span class="line">                    <span class="keyword">var</span> enemy = <span class="keyword">this</span>.enemies[i];</span><br><span class="line">                    blowEnemy.push(enemy);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">var</span> j <span class="keyword">in</span> blowEnemy)&#123;</span><br><span class="line">                    blowEnemy[j].blowUp();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 数量减一</span></span><br><span class="line">                bombNum.setString(<span class="string">"X"</span>+(<span class="built_in">parseInt</span>(bombNum.getString().slice(<span class="number">1</span>))<span class="number">-1</span>));</span><br><span class="line">            &#125;, <span class="keyword">this</span>);</span><br><span class="line">        bombBtn.setPosition(<span class="number">50</span>+bombBtn.width/<span class="number">2</span>,<span class="number">50</span>+bombBtn.height/<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">var</span> bombMenu = <span class="keyword">new</span> cc.Menu(bombBtn);</span><br><span class="line">        bombMenu.setPosition(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        bombMenu.setAnchorPoint(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(bombMenu);</span><br><span class="line">        <span class="comment">// 爆炸道具数量</span></span><br><span class="line">        <span class="keyword">var</span> bombNum = <span class="keyword">new</span> cc.LabelBMFont(<span class="string">"X2"</span>,res.font);</span><br><span class="line">        bombNum.setAnchorPoint(<span class="number">0</span>,<span class="number">0.5</span>);</span><br><span class="line">        bombNum.setPosition(bombBtn.getPositionX()+bombBtn.width/<span class="number">2</span>+<span class="number">50</span>,bombBtn.getPositionY());</span><br><span class="line">        bombNum.setTag(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(bombNum);</span><br><span class="line">        <span class="comment">// 暂停开始按钮</span></span><br><span class="line">        <span class="keyword">var</span> pauseBtn = <span class="keyword">new</span> cc.MenuItemSprite(</span><br><span class="line">            <span class="keyword">new</span> cc.Sprite(cc.spriteFrameCache.getSpriteFrame(<span class="string">"game_pause_nor.png"</span>)),</span><br><span class="line">            <span class="keyword">new</span> cc.Sprite(cc.spriteFrameCache.getSpriteFrame(<span class="string">"game_pause_pressed.png"</span>)),</span><br><span class="line">            <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="comment">// 暂停音乐音效</span></span><br><span class="line">                cc.audioEngine.pauseAllEffects();</span><br><span class="line">                cc.audioEngine.pauseMusic();</span><br><span class="line">                pauseBtn.setEnabled(<span class="literal">false</span>);</span><br><span class="line">                cc.director.pause();</span><br><span class="line">                <span class="keyword">this</span>.addChild(<span class="keyword">new</span> PauseLayer(pauseBtn),<span class="number">10</span>);</span><br><span class="line">            &#125;, <span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">var</span> pauseMenu = <span class="keyword">new</span> cc.Menu(pauseBtn);</span><br><span class="line">        pauseMenu.setPosition(<span class="number">20</span>+pauseBtn.width/<span class="number">2</span>,cc.winSize.height-pauseBtn.height/<span class="number">2</span><span class="number">-20</span>);</span><br><span class="line">        pauseMenu.setAnchorPoint(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(pauseMenu);</span><br><span class="line">        <span class="comment">// 分数</span></span><br><span class="line">        <span class="keyword">var</span> score = <span class="keyword">new</span> cc.LabelBMFont(<span class="string">"0"</span>,res.font);</span><br><span class="line">        score.setAnchorPoint(<span class="number">0</span>,<span class="number">0.5</span>);</span><br><span class="line">        score.setPosition(pauseMenu.getPositionX()+pauseBtn.width/<span class="number">2</span>+<span class="number">50</span>,pauseMenu.getPositionY());</span><br><span class="line">        score.setTag(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(score);</span><br><span class="line">        <span class="comment">// 碰撞检测</span></span><br><span class="line">        <span class="keyword">this</span>.schedule(<span class="keyword">this</span>.collision);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    collision:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> bullets = <span class="keyword">this</span>.bullets;</span><br><span class="line">        <span class="keyword">var</span> enemies = <span class="keyword">this</span>.enemies;</span><br><span class="line">        <span class="keyword">var</span> tools = <span class="keyword">this</span>.tools;</span><br><span class="line">        <span class="keyword">var</span> score = <span class="built_in">parseInt</span>(<span class="keyword">this</span>.getChildByTag(<span class="number">2</span>).getString());</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i <span class="keyword">in</span> enemies)&#123;</span><br><span class="line">            <span class="keyword">var</span> enemy = enemies[i];</span><br><span class="line">            <span class="comment">// 检测是否与玩家碰撞</span></span><br><span class="line">            <span class="keyword">var</span> player = <span class="keyword">this</span>.getChildByTag(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span>(cc.rectIntersectsRect(enemy.getBoundingBox(),player.getBoundingBox()))&#123;</span><br><span class="line">                <span class="comment">// 游戏结束</span></span><br><span class="line">                <span class="keyword">this</span>.unschedule(<span class="keyword">this</span>.collision);</span><br><span class="line">                player.blowUp();</span><br><span class="line">                <span class="comment">// 停止背景音乐</span></span><br><span class="line">                cc.audioEngine.stopMusic(<span class="string">"res/sound/game_music.mp3"</span>);</span><br><span class="line">                cc.audioEngine.playEffect(<span class="string">"res/sound/game_over.mp3"</span>);</span><br><span class="line">                <span class="keyword">this</span>.scheduleOnce(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                    cc.director.runScene(<span class="keyword">new</span> cc.TransitionFade(<span class="number">1</span>,<span class="keyword">new</span> OverScene(score)));</span><br><span class="line">                &#125;,<span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 检测是否吃到道具</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> m <span class="keyword">in</span> tools)&#123;</span><br><span class="line">                <span class="keyword">var</span> tool = tools[m];</span><br><span class="line">                <span class="keyword">if</span>(cc.rectIntersectsRect(tool.getBoundingBox(),player.getBoundingBox()))&#123;</span><br><span class="line">                    <span class="keyword">switch</span>(tool.type)&#123;</span><br><span class="line">                        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                            <span class="comment">// 双排子弹道具</span></span><br><span class="line">                            cc.audioEngine.playEffect(<span class="string">"res/sound/get_double_laser.mp3"</span>);</span><br><span class="line">                            player.shootDoubleBegin();</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                            <span class="comment">// 清屏道具</span></span><br><span class="line">                            cc.audioEngine.playEffect(<span class="string">"res/sound/get_bomb.mp3"</span>);</span><br><span class="line">                            <span class="keyword">var</span> bomb = <span class="keyword">this</span>.getChildByTag(<span class="number">3</span>);</span><br><span class="line">                            bomb.setString(<span class="string">"X"</span>+(<span class="built_in">parseInt</span>(bomb.getString().slice(<span class="number">1</span>))+<span class="number">1</span>));</span><br><span class="line">                            bomb.runAction(cc.sequence(cc.scaleTo(<span class="number">0.1</span>,<span class="number">1.2</span>),cc.scaleTo(<span class="number">0.1</span>,<span class="number">1</span>)));</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                    &#125;                  </span><br><span class="line">                    tool.remove();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> j <span class="keyword">in</span> bullets)&#123;</span><br><span class="line">                <span class="keyword">var</span> bullet = bullets[j];</span><br><span class="line">                <span class="comment">// 检测是否与子弹碰撞</span></span><br><span class="line">                <span class="keyword">if</span>(cc.rectIntersectsRect(enemy.getBoundingBox(),bullet.getBoundingBox()))&#123;</span><br><span class="line">                    enemy.hit();</span><br><span class="line">                    bullet.remove();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    addScore:<span class="function"><span class="keyword">function</span>(<span class="params">type</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> score = <span class="keyword">this</span>.getChildByTag(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">var</span> addScore = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">var</span> curScore = <span class="built_in">parseInt</span>(score.getString());</span><br><span class="line">        <span class="keyword">switch</span>(type)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                addScore = <span class="number">100</span> + <span class="built_in">Math</span>.ceil(<span class="built_in">Math</span>.random()*(curScore/<span class="number">1000</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                addScore = <span class="number">200</span> + <span class="built_in">Math</span>.ceil(<span class="built_in">Math</span>.random()*(curScore/<span class="number">1000</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                addScore = <span class="number">500</span> + <span class="built_in">Math</span>.ceil(<span class="built_in">Math</span>.random()*(curScore/<span class="number">1000</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        score.setString(curScore+addScore);</span><br><span class="line">    &#125;,</span><br><span class="line">    createEnemy:<span class="function"><span class="keyword">function</span>(<span class="params">type</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> enemy = <span class="keyword">new</span> Enemy(type,<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">var</span> randomX = <span class="built_in">Math</span>.random()*(cc.winSize.width-enemy.width/<span class="number">2</span>-enemy.width/<span class="number">2</span>)+enemy.width/<span class="number">2</span>;</span><br><span class="line">        enemy.setPosition(randomX,cc.winSize.height+enemy.height/<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(enemy);</span><br><span class="line">        <span class="keyword">this</span>.enemies.push(enemy);</span><br><span class="line">    &#125;,</span><br><span class="line">    createTool:<span class="function"><span class="keyword">function</span>(<span class="params">type</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> tool = <span class="keyword">new</span> Tool(type,<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">var</span> randomX = <span class="built_in">Math</span>.random()*(cc.winSize.width-tool.width/<span class="number">2</span>-tool.width/<span class="number">2</span>)+tool.width/<span class="number">2</span>;</span><br><span class="line">        tool.setPosition(randomX,cc.winSize.height+tool.height/<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(tool);</span><br><span class="line">        <span class="keyword">this</span>.tools.push(tool);</span><br><span class="line">    &#125;,</span><br><span class="line">    onEnter:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="comment">// 添加触摸事件</span></span><br><span class="line">        cc.eventManager.addListener(&#123;</span><br><span class="line">            event:cc.EventListener.TOUCH_ONE_BY_ONE,</span><br><span class="line">            swallowTouches:<span class="literal">true</span>,</span><br><span class="line">            onTouchBegan:<span class="keyword">this</span>.touchbegan,</span><br><span class="line">            onTouchMoved:<span class="keyword">this</span>.touchmoved,</span><br><span class="line">            onTouchEnded:<span class="keyword">this</span>.touchended</span><br><span class="line">        &#125;,<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    touchbegan:<span class="function"><span class="keyword">function</span>(<span class="params">touch,event</span>)</span>&#123;</span><br><span class="line">        event.getCurrentTarget().touchStartX = touch.getLocation().x;</span><br><span class="line">        event.getCurrentTarget().touchStartY = touch.getLocation().y;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    touchmoved:<span class="function"><span class="keyword">function</span>(<span class="params">touch,event</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> touchX = touch.getLocation().x;</span><br><span class="line">        <span class="keyword">var</span> touchY = touch.getLocation().y;</span><br><span class="line">        <span class="keyword">var</span> touchStartX = event.getCurrentTarget().touchStartX;</span><br><span class="line">        <span class="keyword">var</span> touchStartY = event.getCurrentTarget().touchStartY;</span><br><span class="line">        <span class="keyword">var</span> player = event.getCurrentTarget().getChildByTag(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span>(player!=<span class="literal">null</span>)&#123;</span><br><span class="line">            player.moveBy(touchX-touchStartX,touchY-touchStartY);</span><br><span class="line">            event.getCurrentTarget().touchStartX = touchX;</span><br><span class="line">            event.getCurrentTarget().touchStartY = touchY;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    touchended:<span class="function"><span class="keyword">function</span>(<span class="params">touch,event</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> GameScene = cc.Scene.extend(&#123;</span><br><span class="line">    onEnter: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> layer = <span class="keyword">new</span> GameLayer();</span><br><span class="line">        <span class="keyword">this</span>.addChild(layer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h4 id="暂停场景"><a href="#暂停场景" class="headerlink" title="暂停场景"></a>暂停场景</h4><p>在游戏场景点击暂停按钮进入暂停场景，暂停场景实际上只是一个半透明的层盖在游戏场景上，进入暂停场景后游戏暂停，暂停场景包含继续按钮，结束按钮和重新开始按钮。<br>暂停场景效果图如下：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/PauseMenu.gif" alt="暂停场景"><br>代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by Henry on 16/7/6.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">var</span> PauseLayer=cc.LayerColor.extend(&#123;</span><br><span class="line">    ctor:<span class="function"><span class="keyword">function</span> (<span class="params">pauseBtn</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 初始化为黑色</span></span><br><span class="line">        <span class="keyword">this</span>._super(cc.color(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">100</span>));</span><br><span class="line">        <span class="keyword">this</span>.width = cc.winSize.width;</span><br><span class="line">        <span class="keyword">this</span>.height = cc.winSize.height;</span><br><span class="line">        <span class="comment">// 继续按钮</span></span><br><span class="line">        <span class="keyword">var</span> resumeBtn = <span class="keyword">new</span> cc.MenuItemSprite(</span><br><span class="line">            <span class="keyword">new</span> cc.Sprite(<span class="string">"res/game_continue.png"</span>),</span><br><span class="line">            <span class="keyword">new</span> cc.Sprite(<span class="string">"res/game_continue_selected.png"</span>),</span><br><span class="line">            <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                cc.audioEngine.playEffect(<span class="string">"res/sound/button.mp3"</span>);</span><br><span class="line">                cc.audioEngine.resumeMusic();</span><br><span class="line">                cc.director.resume();</span><br><span class="line">                pauseBtn.setEnabled(<span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">this</span>.removeFromParent();</span><br><span class="line">            &#125;, <span class="keyword">this</span>);</span><br><span class="line">        resumeBtn.setPosition(<span class="number">0</span>,<span class="number">100</span>);</span><br><span class="line">        <span class="comment">// 结束游戏按钮</span></span><br><span class="line">        <span class="keyword">var</span> overBtn = <span class="keyword">new</span> cc.MenuItemSprite(</span><br><span class="line">            <span class="keyword">new</span> cc.Sprite(<span class="string">"res/game_over.png"</span>),</span><br><span class="line">            <span class="keyword">new</span> cc.Sprite(<span class="string">"res/game_over_selected.png"</span>),</span><br><span class="line">            <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                cc.audioEngine.playEffect(<span class="string">"res/sound/button.mp3"</span>);</span><br><span class="line">                cc.audioEngine.stopMusic(<span class="string">"res/sound/game_music.mp3"</span>);</span><br><span class="line">                cc.director.resume();</span><br><span class="line">                cc.director.runScene(<span class="keyword">new</span> cc.TransitionFade(<span class="number">1</span>, <span class="keyword">new</span> MenuScene()));</span><br><span class="line">            &#125;, <span class="keyword">this</span>);</span><br><span class="line">        overBtn.setPosition(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 重新开始按钮</span></span><br><span class="line">        <span class="keyword">var</span> reagainBtn = <span class="keyword">new</span> cc.MenuItemSprite(</span><br><span class="line">            <span class="keyword">new</span> cc.Sprite(<span class="string">"res/game_Reagain.png"</span>),</span><br><span class="line">            <span class="keyword">new</span> cc.Sprite(<span class="string">"res/game_Reagain_selected.png"</span>),</span><br><span class="line">            <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                cc.audioEngine.playEffect(<span class="string">"res/sound/button.mp3"</span>);</span><br><span class="line">                cc.audioEngine.stopMusic(<span class="string">"res/sound/game_music.mp3"</span>);</span><br><span class="line">                cc.director.resume();</span><br><span class="line">                cc.director.runScene(<span class="keyword">new</span> cc.TransitionFade(<span class="number">1</span>, <span class="keyword">new</span> GameScene()));</span><br><span class="line">            &#125;, <span class="keyword">this</span>);</span><br><span class="line">        reagainBtn.setPosition(<span class="number">0</span>,<span class="number">-100</span>);</span><br><span class="line">        <span class="keyword">var</span> menu = <span class="keyword">new</span> cc.Menu(resumeBtn,overBtn,reagainBtn);</span><br><span class="line">        <span class="keyword">this</span>.addChild(menu);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h4 id="结束场景"><a href="#结束场景" class="headerlink" title="结束场景"></a>结束场景</h4><p>在游戏场景中，如果在碰撞检测中检测到玩家与敌机碰撞，则游戏结束，游戏结束进入结束场景，结束场景包含玩家的最终分数，以及展示最高历史分数和保存最高历史分数。<br>结束场景的效果如下：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/OverScene.gif" alt="结束场景"><br>代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by Henry on 16/7/6.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">var</span> OverLayer=cc.Layer.extend(&#123;</span><br><span class="line">    ctor:<span class="function"><span class="keyword">function</span> (<span class="params">score</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> bg = <span class="keyword">new</span> Background(<span class="literal">true</span>);</span><br><span class="line">        bg.setPosition(cc.winSize.width/<span class="number">2</span>,cc.winSize.height/<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(bg);</span><br><span class="line">        <span class="keyword">var</span> highest = cc.sys.localStorage.getItem(<span class="string">"highest"</span>);</span><br><span class="line">        highest = highest==<span class="literal">null</span>?<span class="number">0</span>:highest;</span><br><span class="line">        <span class="comment">// 分数存储</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">parseInt</span>(score)&gt;<span class="built_in">parseInt</span>(highest))&#123;</span><br><span class="line">            cc.sys.localStorage.setItem(<span class="string">"highest"</span> ,score);</span><br><span class="line">            highest = score;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 历史最高分数</span></span><br><span class="line">        <span class="keyword">var</span> highestFnt = <span class="keyword">new</span> cc.LabelBMFont(highest.toString(),res.font);</span><br><span class="line">        highestFnt.setPosition(<span class="number">250</span>,cc.winSize.height-highestFnt.height/<span class="number">2</span><span class="number">-75</span>);</span><br><span class="line">        highestFnt.setAnchorPoint(<span class="number">0</span>,<span class="number">0.5</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(highestFnt);</span><br><span class="line">        <span class="comment">// 分数显示</span></span><br><span class="line">        <span class="keyword">var</span> scoreFnt = <span class="keyword">new</span> cc.LabelBMFont(score,res.font);</span><br><span class="line">        scoreFnt.setPosition(cc.winSize.width/<span class="number">2</span>,cc.winSize.height/<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(scoreFnt);</span><br><span class="line">        <span class="keyword">this</span>.scheduleOnce(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            cc.audioEngine.playEffect(<span class="string">"res/sound/out_porp.mp3"</span>);</span><br><span class="line">            scoreFnt.runAction(cc.sequence(cc.scaleTo(<span class="number">0.2</span>,<span class="number">1.5</span>),cc.scaleTo(<span class="number">0.2</span>,<span class="number">1</span>)));</span><br><span class="line">        &#125;,<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 菜单按钮</span></span><br><span class="line">        <span class="keyword">var</span> restartBtn = <span class="keyword">new</span> cc.MenuItemSprite(</span><br><span class="line">            <span class="keyword">new</span> cc.Sprite(<span class="string">"res/btn_finish.png"</span>),</span><br><span class="line">            <span class="keyword">new</span> cc.Sprite(<span class="string">"res/btn_finish_selected.png"</span>),</span><br><span class="line">            <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                cc.audioEngine.playEffect(<span class="string">"res/sound/button.mp3"</span>);</span><br><span class="line">                cc.director.runScene(<span class="keyword">new</span> cc.TransitionFade(<span class="number">1</span>, <span class="keyword">new</span> MenuScene()));</span><br><span class="line">            &#125;, <span class="keyword">this</span>);</span><br><span class="line">        restartBtn.setPosition(scoreFnt.getPositionX(),scoreFnt.getPositionY()-scoreFnt.height/<span class="number">2</span><span class="number">-100</span>);</span><br><span class="line">        <span class="keyword">var</span> menu = <span class="keyword">new</span> cc.Menu(restartBtn);</span><br><span class="line">        menu.setPosition(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        menu.setAnchorPoint(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(menu);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> OverScene=cc.Scene.extend(&#123;</span><br><span class="line">    ctor:<span class="function"><span class="keyword">function</span>(<span class="params">score</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> layer=<span class="keyword">new</span> OverLayer(score);</span><br><span class="line">        <span class="keyword">this</span>.addChild(layer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h4 id="帮助场景"><a href="#帮助场景" class="headerlink" title="帮助场景"></a>帮助场景</h4><p>帮助场景就是一个展示游戏帮助提示的场景，其实只有文字和返回游戏按钮。<br>帮助场景的效果如下：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/HelpScene.gif" alt="帮助场景"><br>代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by Henry on 16/7/6.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">var</span> OverLayer=cc.Layer.extend(&#123;</span><br><span class="line">    ctor:<span class="function"><span class="keyword">function</span> (<span class="params">score</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> bg = <span class="keyword">new</span> Background(<span class="literal">true</span>);</span><br><span class="line">        bg.setPosition(cc.winSize.width/<span class="number">2</span>,cc.winSize.height/<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(bg);</span><br><span class="line">        <span class="keyword">var</span> highest = cc.sys.localStorage.getItem(<span class="string">"highest"</span>);</span><br><span class="line">        highest = highest==<span class="literal">null</span>?<span class="number">0</span>:highest;</span><br><span class="line">        <span class="comment">// 分数存储</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">parseInt</span>(score)&gt;<span class="built_in">parseInt</span>(highest))&#123;</span><br><span class="line">            cc.sys.localStorage.setItem(<span class="string">"highest"</span> ,score);</span><br><span class="line">            highest = score;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 历史最高分数</span></span><br><span class="line">        <span class="keyword">var</span> highestFnt = <span class="keyword">new</span> cc.LabelBMFont(highest.toString(),res.font);</span><br><span class="line">        highestFnt.setPosition(<span class="number">250</span>,cc.winSize.height-highestFnt.height/<span class="number">2</span><span class="number">-75</span>);</span><br><span class="line">        highestFnt.setAnchorPoint(<span class="number">0</span>,<span class="number">0.5</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(highestFnt);</span><br><span class="line">        <span class="comment">// 分数显示</span></span><br><span class="line">        <span class="keyword">var</span> scoreFnt = <span class="keyword">new</span> cc.LabelBMFont(score,res.font);</span><br><span class="line">        scoreFnt.setPosition(cc.winSize.width/<span class="number">2</span>,cc.winSize.height/<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(scoreFnt);</span><br><span class="line">        <span class="keyword">this</span>.scheduleOnce(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            cc.audioEngine.playEffect(<span class="string">"res/sound/out_porp.mp3"</span>);</span><br><span class="line">            scoreFnt.runAction(cc.sequence(cc.scaleTo(<span class="number">0.2</span>,<span class="number">1.5</span>),cc.scaleTo(<span class="number">0.2</span>,<span class="number">1</span>)));</span><br><span class="line">        &#125;,<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 菜单按钮</span></span><br><span class="line">        <span class="keyword">var</span> restartBtn = <span class="keyword">new</span> cc.MenuItemSprite(</span><br><span class="line">            <span class="keyword">new</span> cc.Sprite(<span class="string">"res/btn_finish.png"</span>),</span><br><span class="line">            <span class="keyword">new</span> cc.Sprite(<span class="string">"res/btn_finish_selected.png"</span>),</span><br><span class="line">            <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                cc.audioEngine.playEffect(<span class="string">"res/sound/button.mp3"</span>);</span><br><span class="line">                cc.director.runScene(<span class="keyword">new</span> cc.TransitionFade(<span class="number">1</span>, <span class="keyword">new</span> MenuScene()));</span><br><span class="line">            &#125;, <span class="keyword">this</span>);</span><br><span class="line">        restartBtn.setPosition(scoreFnt.getPositionX(),scoreFnt.getPositionY()-scoreFnt.height/<span class="number">2</span><span class="number">-100</span>);</span><br><span class="line">        <span class="keyword">var</span> menu = <span class="keyword">new</span> cc.Menu(restartBtn);</span><br><span class="line">        menu.setPosition(<span class="number">0</span>,<span class="number">0</span>);install</span><br><span class="line">        menu.setAnchorPoint(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(menu);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> OverScene=cc.Scene.extend(&#123;</span><br><span class="line">    ctor:<span class="function"><span class="keyword">function</span>(<span class="params">score</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> layer=<span class="keyword">new</span> OverLayer(score);</span><br><span class="line">        <span class="keyword">this</span>.addChild(layer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h3 id="运行效果"><a href="#运行效果" class="headerlink" title="运行效果"></a>运行效果</h3><p>最后的运行效果如下<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/Plane.gif" alt="打飞机效果图"><br>通过CVP平台的项目托管可看到实际运行效果，地址如下：<br><a href="http://www.cocoscvp.com/usercode/3d1775ea3aea1f12e986b7d8ebbb079fca12c064/" target="_blank" rel="external">http://www.cocoscvp.com/usercode/3d1775ea3aea1f12e986b7d8ebbb079fca12c064/</a></p>
<h3 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h3><p>所有源代码均上传到github，欢迎交流学习，地址：<br><a href="https://github.com/hjcenry/plane" target="_blank" rel="external">https://github.com/hjcenry/plane</a></p>
<ul>
<li>原文博客：<a href="http://hjcenry.github.io">http://hjcenry.github.io</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;今天我们来讲一个最最最常见的一个小游戏——打飞机！是的，打飞机！还记得小时候在玩儿的雷电，应该是打飞机最早的样子了吧。直到现在，也有微信打飞机，全民飞机大战，全民打飞机等游戏的出现，这些游戏基本都是在我们小时候玩儿的打飞机的原型上增加特效音效以及更多新的玩儿法，在这基础上进行的创新。
    
    </summary>
    
      <category term="cocos2d-js" scheme="http://hjcenry.github.io/categories/cocos2d-js/"/>
    
    
      <category term="cocos2d-js" scheme="http://hjcenry.github.io/tags/cocos2d-js/"/>
    
      <category term="cvp" scheme="http://hjcenry.github.io/tags/cvp/"/>
    
      <category term="打飞机" scheme="http://hjcenry.github.io/tags/%E6%89%93%E9%A3%9E%E6%9C%BA/"/>
    
  </entry>
  
  <entry>
    <title>Cocos Creator实现的《点我+1》</title>
    <link href="http://hjcenry.github.io/2016/07/02/Cocos%20Creator%E5%AE%9E%E7%8E%B0%E7%9A%84%E3%80%8A%E7%82%B9%E6%88%91+1%E3%80%8B/"/>
    <id>http://hjcenry.github.io/2016/07/02/Cocos Creator实现的《点我+1》/</id>
    <published>2016-07-02T09:14:00.000Z</published>
    <updated>2016-07-02T17:12:23.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>在学习Cocos中，需要一些东西来练手，于是前段时间就开发仿照一款公司之前的产品《点我+1》来做，仿照过程中，所有的算法逻辑都是自己研究的，并没有参考公司代码，也没有使用公司的美术资源，所以也就不存在公司机密的内容啦，完全只是学习练习而已。<a id="more"></a><br>这是一款消除类游戏，规则和大多数三消类游戏差不多，在一个5x5的格子中，有25个方块，每个方块有一个数字，用户的操作就是点击方块，使方块的数字+1，当至少每3个相同数字的时候，这些数字相同的方块合成为一个，并且数字+1，在玩家的表现就是：除了点击的方块之外，其他的相同数字的方块全部消失，然后点击的方块再+1。这款游戏看似很简单，但实际也是蕴含很多细节以及算法，我也是用了一周时间断断续续才做出来。<br>并且在这次练习中，我也是第一次尝试使用Cocos Creator来做，使用中也是遇到了不少问题，它与Cocos2d-JS的原生API还是有一定的差别的，Cocos Creator在我看来就是Cocos在向Unity靠近的一个产物，想要像Unity那样实现一整套的工作流，将游戏中的所有元素都组件化，游戏场景可以通过拖动就能搭建，游戏逻辑的实现只需要对组件添加相应的脚本即可，让游戏开发更加的方便，更加直观可视化。</p>
<h3 id="Cocos-Creator"><a href="#Cocos-Creator" class="headerlink" title="Cocos Creator"></a>Cocos Creator</h3><p>Cocos Creator是Cocos家族又一个划时代意义的产物，前面已经提到，我个人认为这是Cocos向Unity靠近的产物，或许也可以说，游戏开发的脚本化、组件化、以及高效工作流、高度可扩展，已经成为任何一款游戏引擎的发展方向，这样的高效快速的开发的工具，才是开发者的首选工具。了解Cocos家族历史的人应该都知道，Cocos从各种语言版本，到2dx跨平台版本，到Cocos Stuio、Cocos IDE、Cocos Builder，再到Cocos Creator，这一切都是在使开发者越来越方便，使得游戏开发的门槛越来越低，任何人，只要你有心，有游戏梦，你都可以通过自身的努力来造梦，而Cocos Creator，就是我们造梦的工具。<br>不过说实话，Cocos Creator目前是1.1版本，在使用仍然还有许多bug，比如我打包Web版本之后，直接在本地无法运行，查看控制台输出应该是跨域的问题，而发布到服务器就能正常运行，再比如游戏的开发者，开发者还是需要考虑很多各种型号手机屏幕兼容的问题，希望Cocos Creator还能有一套成熟的兼容适配的方案，还有一些我个人的问题或许只是我还不熟悉Cocos的组件化开发而已，需要等到我真正熟悉这款工具，才能用好它，所谓工欲善其事必先利其器，工具用好了，你的造梦之路才会更加顺畅！<br>Cocos Creator的用户手册：<a href="http://www.cocos.com/docs/creator/index.html" target="_blank" rel="external">http://www.cocos.com/docs/creator/index.html</a><br>Cocos Creator的API：<a href="http://www.cocos.com/docs/creator/api/index.html" target="_blank" rel="external">http://www.cocos.com/docs/creator/api/index.html</a></p>
<h3 id="游戏分析"><a href="#游戏分析" class="headerlink" title="游戏分析"></a>游戏分析</h3><p>这款游戏是比较常见的三消类游戏，不过它也有着自己的特色，将数字类游戏玩法与消除类游戏玩法相结合，游戏过程也比较具有挑战性，让人产生挑战的欲望，游戏的玩法在上文已有描述，没有玩过这款消除类游戏的朋友可以通过以下地址进行下载：<br>安卓版地址：<a href="http://app.mi.com/detail/231892?ref=search" target="_blank" rel="external">http://app.mi.com/detail/231892?ref=search</a><br>iOS版地址：<a href="https://itunes.apple.com/cn/app/dian-wo+1/id1012314214?mt=8" target="_blank" rel="external">https://itunes.apple.com/cn/app/dian-wo+1/id1012314214?mt=8</a><br>没玩过的朋友可以通过以上地址下载下来玩一下，体验下游戏玩法，然后仔细分析其中的游戏逻辑运算过程。<br>通过游戏玩法的分析我们至少可以分析出以下几点：<br>1.点击游戏方块，方块数字+1<br>2.在至少3个相同数字的方块彼此相邻时，可以合成一个+1的数<br>3.生成5x5的地图时，最多只能有两个相同数字方块相邻<br>4.每完成一次方块合成之后，所有方块向下填补空缺的位置<br>5.在填补完空缺位置之后，再生成新的方块<br>在Cocos Creator中，我们要熟悉组件化开发，因此我们需要开始场景、游戏场景、结束场景、以及方块预制资源、能量条预制资源，以及各种脚本和音效等。分别用scene、script和voice三个文件夹来存放场景组件，脚本组件和音效组件，另外将预制资源放在根目录下，如下图资源目录：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/projstruct.png" alt="资源结构图"></p>
<h3 id="游戏实现"><a href="#游戏实现" class="headerlink" title="游戏实现"></a>游戏实现</h3><p>如之前一篇文章对2048游戏的分析一样，我们首先需要一个数组来存放所有的方块，并将方块单独提出来为一个对象，在这里，我们将方块做成预制资源，在需要的时候直接创建方块预制资源，同样，能量条也可以做成预制资源。另外我们需要开始场景、游戏场景和结束场景三个场景，并对这三个场景组件编写脚本。<br>在开发写代码之前，我们经过如上的分析，知道了我们大致要实现的几个核心算法：<br>1.扫描某一个位置的上下左右四个方向所有相邻的相同数字的点，并得到这些点的个数<br>2.所有方块向下移动，填补所有的空缺<br>核心的就这两个算法，其他的都是一些简单的逻辑，下面先对这两个算法进行分析</p>
<h4 id="扫描算法"><a href="#扫描算法" class="headerlink" title="扫描算法"></a>扫描算法</h4><p>扫描算法实质上就是对指定的点得四周进行扫描，扫描是否有数字相同的点，如果有数字相同的点，那么还需要进一步对这个数字相同的点再进行扫描，直到扫描的点四周都没有数字相同的点，才能确认最终相邻点的个数，实际上就是对指定的点向四周扩散扫描。<br>我的实现方式是这样的，写一个函数，传入两个数组，一个用来记录扫描到的数字相同的点，一个用来记录扫描过得点，以便于下次扫描不再扫描已经扫描过的点，除此之外，还需要传入行，列，上次扫描的行，上次扫描的列（在下次扫描时，不用再对上次的那个方向进行扫描），以及扫描要比对的数字。通过指定的点，我向上、下、左、右四个方向进行扫描，如果数字相同，我就将这个点加入到记录数字相同的点得数组中，并对这个点再递归调用这个函数，在四个方向全都递归扫描完毕后，我得到的这个扫描过的点的数组，就是所有与指定点的数字相同且彼此相邻的点的集合。可能我描述不是太清楚，我直接将代码贴出来，我的算法基础不是太好，可能这不是最优的算法，希望有朋友能为我提供更好更快的算法。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line"> * 核心扫描逻辑</span><br><span class="line"> * @param row 指定行</span><br><span class="line"> * @param col 指定列</span><br><span class="line"> * @param lastRow 上次扫描的行</span><br><span class="line"> * @param lastCol 上次扫描的列</span><br><span class="line"> * @param num 扫描要比对的数字</span><br><span class="line"> * @param arr 记录数字相同且彼此相邻的数组</span><br><span class="line"> * @param scanArr 记录扫描过的点的数组</span><br><span class="line"> */</span></span><br><span class="line">scanAround:<span class="function"><span class="keyword">function</span>(<span class="params">row,col,lastRow,lastCol,num,arr,scanArr</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// cc.log("row:",row,",col:",col,",lastRow:",lastRow,",lastCol:",lastCol,",num:",num,",arr:",arr,",scanArr:",scanArr);</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.tiles[row][col]==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> isClear = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span>(scanArr==<span class="literal">undefined</span>)&#123;</span><br><span class="line">        scanArr = <span class="keyword">new</span> <span class="built_in">Array</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 扫描过的节点不再扫描</span></span><br><span class="line">    <span class="keyword">if</span>(scanArr.indexOf(row+<span class="string">"#"</span>+col)==<span class="number">-1</span>)&#123;</span><br><span class="line">        scanArr.push(row+<span class="string">"#"</span>+col);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 扫描上</span></span><br><span class="line">    <span class="keyword">if</span>(row&lt;<span class="number">4</span>&amp;&amp;(lastRow!=(row+<span class="number">1</span>)||lastCol!=col)&amp;&amp;<span class="keyword">this</span>.tiles[row+<span class="number">1</span>][col]!=<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> nextNum = <span class="built_in">parseInt</span>(<span class="keyword">this</span>.tiles[row+<span class="number">1</span>][col].getComponent(<span class="string">"Tile"</span>).numLabel.string);</span><br><span class="line">        <span class="keyword">if</span>(nextNum==num)&#123;</span><br><span class="line">            <span class="keyword">if</span>(arr.indexOf(row+<span class="string">"#"</span>+col)==<span class="number">-1</span>)&#123;</span><br><span class="line">                arr.push(row+<span class="string">"#"</span>+col);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.scanAround(row+<span class="number">1</span>,col,row,col,num,arr,scanArr);</span><br><span class="line">            isClear = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 扫描下</span></span><br><span class="line">    <span class="keyword">if</span>(row&gt;<span class="number">0</span>&amp;&amp;(lastRow!=(row<span class="number">-1</span>)||lastCol!=col)&amp;&amp;<span class="keyword">this</span>.tiles[row<span class="number">-1</span>][col]!=<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> nextNum = <span class="built_in">parseInt</span>(<span class="keyword">this</span>.tiles[row<span class="number">-1</span>][col].getComponent(<span class="string">"Tile"</span>).numLabel.string);</span><br><span class="line">        <span class="keyword">if</span>(nextNum==num)&#123;</span><br><span class="line">            <span class="keyword">if</span>(arr.indexOf(row+<span class="string">"#"</span>+col)==<span class="number">-1</span>)&#123;</span><br><span class="line">                arr.push(row+<span class="string">"#"</span>+col);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.scanAround(row<span class="number">-1</span>,col,row,col,num,arr,scanArr);</span><br><span class="line">            isClear = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 扫描左</span></span><br><span class="line">    <span class="keyword">if</span>(col&gt;<span class="number">0</span>&amp;&amp;(lastRow!=row||lastCol!=(col<span class="number">-1</span>))&amp;&amp;<span class="keyword">this</span>.tiles[row][col<span class="number">-1</span>]!=<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> nextNum = <span class="built_in">parseInt</span>(<span class="keyword">this</span>.tiles[row][col<span class="number">-1</span>].getComponent(<span class="string">"Tile"</span>).numLabel.string);</span><br><span class="line">        <span class="keyword">if</span>(nextNum==num)&#123;</span><br><span class="line">            <span class="keyword">if</span>(arr.indexOf(row+<span class="string">"#"</span>+col)==<span class="number">-1</span>)&#123;</span><br><span class="line">                arr.push(row+<span class="string">"#"</span>+col);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.scanAround(row,col<span class="number">-1</span>,row,col,num,arr,scanArr);</span><br><span class="line">            isClear = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 扫描右</span></span><br><span class="line">    <span class="keyword">if</span>(col&lt;<span class="number">4</span>&amp;&amp;(lastRow!=row||lastCol!=(col+<span class="number">1</span>))&amp;&amp;<span class="keyword">this</span>.tiles[row][col+<span class="number">1</span>]!=<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> nextNum = <span class="built_in">parseInt</span>(<span class="keyword">this</span>.tiles[row][col+<span class="number">1</span>].getComponent(<span class="string">"Tile"</span>).numLabel.string);</span><br><span class="line">        <span class="keyword">if</span>(nextNum==num)&#123;</span><br><span class="line">            <span class="keyword">if</span>(arr.indexOf(row+<span class="string">"#"</span>+col)==<span class="number">-1</span>)&#123;</span><br><span class="line">                arr.push(row+<span class="string">"#"</span>+col);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.scanAround(row,col+<span class="number">1</span>,row,col,num,arr,scanArr);</span><br><span class="line">            isClear = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 四周都不通，但不是出发遍历点，并且数字相同，也加入到数组</span></span><br><span class="line">    <span class="keyword">if</span>(!isClear&amp;&amp;(lastRow!=<span class="number">-1</span>&amp;&amp;lastCol!=<span class="number">-1</span>))&#123;</span><br><span class="line">        <span class="keyword">var</span> curNum = <span class="built_in">parseInt</span>(<span class="keyword">this</span>.tiles[row][col].getComponent(<span class="string">"Tile"</span>).numLabel.string)</span><br><span class="line">        <span class="keyword">if</span>(curNum==num)&#123;</span><br><span class="line">            <span class="keyword">if</span>(arr.indexOf(row+<span class="string">"#"</span>+col)==<span class="number">-1</span>)&#123;</span><br><span class="line">                arr.push(row+<span class="string">"#"</span>+col);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="移动算法"><a href="#移动算法" class="headerlink" title="移动算法"></a>移动算法</h4><p>移动算法相对就比较简单了，我只需要对每一列从下往上遍历，当遍历中发现方块不为null时（即这个点有方块），我们就以这个方块为起点，对这一列往下遍历，在子循环中，如果下方为null时（即下方没有方块），这个方块就向下移动一个单位，一直循环到下方见底，或者下方遇到方块，才会停止。这个算法相对简单，代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> col = <span class="number">0</span>; col &lt; <span class="number">5</span>; col++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> row = <span class="number">0</span>; row &lt; <span class="number">5</span>; row++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.tiles[row][col] != <span class="literal">null</span>) &#123;<span class="comment">// 有方块</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> row1 = row; row1 &gt; <span class="number">0</span>; row1--) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.tiles[row1 - <span class="number">1</span>][col] == <span class="literal">null</span>)&#123;</span><br><span class="line">                    <span class="comment">//如果没有向下移动</span></span><br><span class="line">                    <span class="keyword">this</span>.tiles[row1 - <span class="number">1</span>][col] = <span class="keyword">this</span>.tiles[row1][col];</span><br><span class="line">                    <span class="keyword">this</span>.tiles[row1][col] = <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">this</span>.tiles[row1 - <span class="number">1</span>][col].getComponent(<span class="string">"Tile"</span>).moveTo(row1 - <span class="number">1</span>, col);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="方块类"><a href="#方块类" class="headerlink" title="方块类"></a>方块类</h4><p>方块类我们通过Creator的预制资源来制作，如下图所示：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/tile.png" alt="tile图"><br>在Tile预制资源中，我们只需要一个背景层，和一个显示数字的Label即可，其背景层的颜色和数字显示都通过脚本来控制，方块需要包含以下几个方法：<br>1.产生新方块的初始化及特效<br>2.移动到指定点的逻辑及特效<br>3.方块销毁的逻辑及特效<br>4.设置方块数字以及动态改变其背景色<br>5.在方块的初始化onLoad函数中，需要对方块添加TOUCH_START事件，事件中绑定上面提到的4方法，方块类的具体实现代码如下：<br>1.方块初始化函数<br>添加触摸点击事件，绑定设置数字函数，清空combo次数（combo次数记录放在全局组件Global中）<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">onLoad: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">this</span>.node.on(cc.Node.EventType.TOUCH_START,<span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!self.game.isCal)&#123;</span><br><span class="line">            cc.audioEngine.playEffect(self.clickEffect);</span><br><span class="line">            self.game.isCal = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">// 连击次数归零</span></span><br><span class="line">            Global.combo = <span class="number">0</span>;</span><br><span class="line">            cc.audioEngine.playEffect(<span class="keyword">this</span>.addCoin);</span><br><span class="line">            self.setNum(<span class="built_in">parseInt</span>(self.numLabel.string)+<span class="number">1</span>,<span class="literal">true</span>,<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="keyword">this</span>.node);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.产生新方块<br>执行从小变大的动画，设置数组中的行列到属性中<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">newTile:<span class="function"><span class="keyword">function</span>(<span class="params">row,col</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.node.setPosition(<span class="number">5</span>+(<span class="number">5</span>+<span class="keyword">this</span>.node.width)*col+<span class="keyword">this</span>.node.width/<span class="number">2</span>,<span class="number">5</span>+(<span class="number">5</span>+<span class="keyword">this</span>.node.height)*row+<span class="keyword">this</span>.node.height/<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">this</span>.node.setScale(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">this</span>.node.runAction(cc.scaleTo(<span class="number">0.1</span>,<span class="number">1</span>));</span><br><span class="line">    <span class="keyword">this</span>.setArrPosition(row,col);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>3.移动到指定点<br>执行移动动画，设置数组中行列到属性中<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">moveTo:<span class="function"><span class="keyword">function</span>(<span class="params">row,col</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.row = row;</span><br><span class="line">    <span class="keyword">this</span>.col = col;</span><br><span class="line">    <span class="keyword">this</span>.node.stopActionByTag(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">var</span> action = cc.moveTo(<span class="number">0.2</span>,cc.p(<span class="number">5</span>+(<span class="number">5</span>+<span class="keyword">this</span>.node.width)*col+<span class="keyword">this</span>.node.width/<span class="number">2</span>,<span class="number">5</span>+(<span class="number">5</span>+<span class="keyword">this</span>.node.height)*row+<span class="keyword">this</span>.node.height/<span class="number">2</span>));</span><br><span class="line">    <span class="keyword">this</span>.node.runAction(action);</span><br><span class="line">    action.setTag(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>4.方块销毁<br>执行从大变小的动画，执行完动画之后调用destory方法销毁方块<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">destoryTile:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> action = cc.sequence(cc.scaleTo(<span class="number">0.1</span>,<span class="number">0</span>),cc.callFunc(<span class="function"><span class="keyword">function</span>(<span class="params">node</span>)</span>&#123;</span><br><span class="line">        node.destroy();</span><br><span class="line">    &#125;,<span class="keyword">this</span>.node,<span class="keyword">this</span>.node));</span><br><span class="line">    <span class="keyword">this</span>.node.runAction(action);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>5.设置方块数字<br>设置方块的显示数字，并动态改变相应数字对应的颜色，颜色存在全局组件变量Colors中，通过参数exeLogic判断是否需要执行游戏的消除逻辑，通过playEffect判断是否需要播放音效<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">setNum:<span class="function"><span class="keyword">function</span>(<span class="params">num,exeLogic,playEffect</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.game.maxNum = num&gt;<span class="keyword">this</span>.game.maxNum?num:<span class="keyword">this</span>.game.maxNum;</span><br><span class="line">    <span class="keyword">this</span>.numLabel.string = num;</span><br><span class="line">    <span class="keyword">switch</span>(num)&#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">this</span>.node.color = Colors.num1;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">this</span>.node.color = Colors.num2;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">this</span>.node.color = Colors.num3;</span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">            <span class="keyword">this</span>.node.color = Colors.num4;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">            <span class="keyword">this</span>.node.color = Colors.num5;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">            <span class="keyword">this</span>.node.color = Colors.num6;</span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">        <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">            <span class="keyword">this</span>.node.color = Colors.num7;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">            <span class="keyword">this</span>.node.color = Colors.num8;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">            <span class="keyword">this</span>.node.color = Colors.num9;</span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">        <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">            <span class="keyword">this</span>.node.color = Colors.num10;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">            <span class="keyword">this</span>.node.color = Colors.num11;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">12</span>:</span><br><span class="line">            <span class="keyword">this</span>.node.color = Colors.num12;</span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">        <span class="keyword">case</span> <span class="number">13</span>:</span><br><span class="line">            <span class="keyword">this</span>.node.color = Colors.num13;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">14</span>:</span><br><span class="line">            <span class="keyword">this</span>.node.color = Colors.num14;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">15</span>:</span><br><span class="line">            <span class="keyword">this</span>.node.color = Colors.num15;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">16</span>:</span><br><span class="line">            <span class="keyword">this</span>.node.color = Colors.num16;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">17</span>:</span><br><span class="line">            <span class="keyword">this</span>.node.color = Colors.num17;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">18</span>:</span><br><span class="line">            <span class="keyword">this</span>.node.color = Colors.num18;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">19</span>:</span><br><span class="line">            <span class="keyword">this</span>.node.color = Colors.num19;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">20</span>:</span><br><span class="line">            <span class="keyword">this</span>.node.color = Colors.num20;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">this</span>.node.color = Colors.nums;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 播放特效</span></span><br><span class="line">    <span class="keyword">if</span>(playEffect)&#123;</span><br><span class="line">        <span class="keyword">this</span>.node.runAction(cc.sequence(cc.scaleTo(<span class="number">0.15</span>,<span class="number">1.5</span>),cc.scaleTo(<span class="number">0.15</span>,<span class="number">1</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 消除逻辑</span></span><br><span class="line">    <span class="keyword">if</span>(exeLogic)&#123;</span><br><span class="line">        <span class="comment">// 执行逻辑</span></span><br><span class="line">        <span class="keyword">var</span> isMove = <span class="keyword">this</span>.game.operateLogic(<span class="keyword">this</span>.row,<span class="keyword">this</span>.col,<span class="built_in">parseInt</span>(<span class="keyword">this</span>.numLabel.string),<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">var</span> powers = <span class="keyword">this</span>.game.powers;</span><br><span class="line">        <span class="comment">// 能量条-1</span></span><br><span class="line">        <span class="keyword">if</span>(!isMove)&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = powers.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                <span class="keyword">if</span>(powers[i]!=<span class="literal">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">var</span> costBarAction = cc.sequence(cc.scaleTo(<span class="number">0.1</span>,<span class="number">0</span>),cc.callFunc(<span class="function"><span class="keyword">function</span>(<span class="params">power</span>)</span>&#123;</span><br><span class="line">                        power.destroy();</span><br><span class="line">                    &#125;,<span class="literal">null</span>,powers[i]));</span><br><span class="line">                    powers[i].runAction(costBarAction);</span><br><span class="line">                    powers[i] = <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="comment">// 游戏结束逻辑判断：能量条为空</span></span><br><span class="line">            <span class="keyword">if</span>(powers[<span class="number">0</span>]==<span class="literal">null</span>)&#123;</span><br><span class="line">                Global.score = <span class="keyword">this</span>.game.scoreNum.string;</span><br><span class="line">                <span class="comment">// Game Over</span></span><br><span class="line">                cc.director.loadScene(<span class="string">"overScene"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="能量类"><a href="#能量类" class="headerlink" title="能量类"></a>能量类</h4><p>同方块类，我们将游戏场景中的能量条也做成预制资源，其中只需要添加一个背景层就可以，背景层也是通过代码动态控制颜色，能量条不需要任何脚本文件。</p>
<h4 id="开始场景"><a href="#开始场景" class="headerlink" title="开始场景"></a>开始场景</h4><p>做好了预制资源之后，我们就可以先做开始场景了，效果图如下：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/startScene.png" alt="startScene图"><br>开始场景中有三个元素，游戏文字，开始按钮，和背景层，其中游戏文字呈现一个变大变小循环播放的动画，点击开始游戏按钮即可转入游戏场景。具体代码如下：<br>1.onLoad加载<br>动态设置元素的位置及宽高，以适配各种型号手机屏幕<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">onLoad: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 背景铺平</span></span><br><span class="line">    <span class="keyword">this</span>.bg.width = cc.winSize.width;</span><br><span class="line">    <span class="keyword">this</span>.bg.height = cc.winSize.height;</span><br><span class="line">    <span class="keyword">this</span>.bg.setPosition(<span class="keyword">this</span>.bg.width/<span class="number">2</span>,<span class="keyword">this</span>.bg.height/<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">this</span>.bg.color = Colors.startBg;</span><br><span class="line">    <span class="comment">// 设置文字</span></span><br><span class="line">    <span class="keyword">var</span> action = cc.repeatForever(cc.sequence(cc.scaleTo(<span class="number">1</span>, <span class="number">1.5</span>),cc.scaleTo(<span class="number">1</span>,<span class="number">1</span>)));</span><br><span class="line">    <span class="keyword">this</span>.gameName.runAction(action);</span><br><span class="line">    <span class="keyword">this</span>.gameName.setPosition(cc.winSize.width/<span class="number">2</span>,cc.winSize.height/<span class="number">2</span>);</span><br><span class="line">    <span class="comment">// 设置按钮</span></span><br><span class="line">    <span class="keyword">this</span>.startBtn.setPosition(<span class="keyword">this</span>.gameName.getPositionX(),<span class="keyword">this</span>.gameName.getPositionY()<span class="number">-210</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.开始游戏按钮回调<br>点击进入游戏场景<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">startGame:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    cc.audioEngine.playEffect(<span class="keyword">this</span>.btnEffect);</span><br><span class="line">    cc.director.loadScene(<span class="string">"gameScene"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="结束场景"><a href="#结束场景" class="headerlink" title="结束场景"></a>结束场景</h4><p>结束场景与开始场景差不多，相比之下，结束场景主要是提供游戏分数特效呈现的功能，效果图如下：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/overScene.png" alt="overScene图"><br>结束场景也是几个Label，一个背景层和一个Button按钮组成，其中最重要的是分数特效，通过从0一直往上加，加到实际分数的特效，来使玩家获得成就感，具体代码如下：<br>1.加载函数<br>动态设置场景中元素的宽高及位置，播放分数计算特效，绑定TOUCH_START事件，使特效立即播放完成<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">onLoad: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 背景层</span></span><br><span class="line">    <span class="keyword">this</span>.bg.width = cc.winSize.width;</span><br><span class="line">    <span class="keyword">this</span>.bg.height = cc.winSize.height;</span><br><span class="line">    <span class="keyword">this</span>.bg.setPosition(<span class="keyword">this</span>.bg.width/<span class="number">2</span>,<span class="keyword">this</span>.bg.height/<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">this</span>.bg.color = Colors.overBg;</span><br><span class="line">    <span class="comment">// 文字层</span></span><br><span class="line">    <span class="keyword">this</span>.gameText.setPosition(cc.winSize.width/<span class="number">2</span>,cc.winSize.height/<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">var</span> action = cc.repeatForever(cc.sequence(cc.scaleTo(<span class="number">1</span>, <span class="number">1.5</span>),cc.scaleTo(<span class="number">1</span>,<span class="number">1</span>)));</span><br><span class="line">    <span class="keyword">this</span>.gameText.runAction(action);</span><br><span class="line">    <span class="comment">// 播放结束音效</span></span><br><span class="line">    cc.audioEngine.playEffect(<span class="keyword">this</span>.overEffect);</span><br><span class="line">    <span class="comment">// 分数</span></span><br><span class="line">    <span class="keyword">this</span>.scoreText.setPosition(<span class="keyword">this</span>.gameText.getPositionX(),<span class="keyword">this</span>.gameText.getPositionY()+<span class="number">200</span>);</span><br><span class="line">    <span class="keyword">this</span>.score = Global.score;</span><br><span class="line">    <span class="keyword">this</span>.schedule(<span class="keyword">this</span>.updateScore,<span class="number">0.1</span>,cc.REPEAT_FOREVER,<span class="number">2</span>);</span><br><span class="line">    <span class="comment">// 点击分数立即加到最高分数</span></span><br><span class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">this</span>.bg.on(cc.Node.EventType.TOUCH_START,<span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">        cc.log(<span class="string">"score text touch"</span>);</span><br><span class="line">        cc.audioEngine.playEffect(self.addCoin);</span><br><span class="line">        self.changeScore = self.score;</span><br><span class="line">        self.scoreLabel.string = <span class="string">"最终分数："</span>+self.changeScore;</span><br><span class="line">    &#125;, <span class="keyword">this</span>.bg);</span><br><span class="line">    <span class="comment">// 返回按钮</span></span><br><span class="line">    <span class="keyword">this</span>.backBtn.setPosition(<span class="keyword">this</span>.gameText.getPositionX(),<span class="keyword">this</span>.gameText.getPositionY()<span class="number">-200</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.更新分数回调<br>每一次更新分数回调，将特效分数增加20，直到加满到游戏得分，并将这一过程显示在场景的Label中<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">updateScore()&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.score&lt;=<span class="keyword">this</span>.changeScore)&#123;</span><br><span class="line">        <span class="keyword">this</span>.unschedule(<span class="keyword">this</span>.updateScore);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.changeScore += <span class="number">20</span>;</span><br><span class="line">    <span class="keyword">this</span>.changeScore = <span class="keyword">this</span>.changeScore&gt;<span class="keyword">this</span>.score?<span class="keyword">this</span>.score:<span class="keyword">this</span>.changeScore;</span><br><span class="line">    <span class="comment">// 添加音效</span></span><br><span class="line">    cc.audioEngine.playEffect(<span class="keyword">this</span>.addCoin);</span><br><span class="line">    <span class="keyword">this</span>.scoreLabel.string = <span class="string">"最终分数："</span>+<span class="keyword">this</span>.changeScore;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>3.返回按钮回调<br>游戏分数的全局变量归零，切换加载开始游戏的场景<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">back:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Global.score = <span class="number">0</span>;</span><br><span class="line">    cc.audioEngine.playEffect(<span class="keyword">this</span>.btnEffect);</span><br><span class="line">    cc.director.loadScene(<span class="string">"startScene"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="游戏场景"><a href="#游戏场景" class="headerlink" title="游戏场景"></a>游戏场景</h4><p>最主要的还是游戏场景，在游戏场景中，我们进行所有的游戏逻辑的运算，包括前面提到的两个核心算法，游戏场景的效果图如下：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/gameScene.png" alt="gameScene图"><br>在游戏主场景中，我们主要需要在onLoad加载时，初始化25个方块，并放在地图中，使他们之间相邻个数小于3个，然后我们需要提供一个主要逻辑判断函数，这个函数中判断游戏中方块的消除逻辑，再前面的Tile的setNum函数中进行调用，代码如下：<br>1.场景加载<br>在场景加载中，我们需要初始化25个互相相邻小于3个的方块，与5个能量条，并且动态设置所有元素的宽高与位置。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">onLoad: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 播放背景音乐</span></span><br><span class="line">    cc.audioEngine.playMusic(<span class="keyword">this</span>.bgMusic,<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// 初始化方块数组</span></span><br><span class="line">    <span class="keyword">this</span>.tiles = [</span><br><span class="line">        [<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>],</span><br><span class="line">        [<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>],</span><br><span class="line">        [<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>],</span><br><span class="line">        [<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>],</span><br><span class="line">        [<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>]</span><br><span class="line">    ];</span><br><span class="line">    <span class="keyword">this</span>.powers = [<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span>];</span><br><span class="line">    <span class="comment">// 背景层</span></span><br><span class="line">    <span class="keyword">this</span>.bg.width = cc.winSize.width;</span><br><span class="line">    <span class="keyword">this</span>.bg.height = cc.winSize.height;</span><br><span class="line">    <span class="keyword">this</span>.bg.setPosition(-cc.winSize.width/<span class="number">2</span>,-cc.winSize.height/<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">this</span>.bg.color = Colors.gameBg;</span><br><span class="line">    <span class="comment">// 顶部背景层</span></span><br><span class="line">    <span class="keyword">this</span>.topBg.width = cc.winSize.width<span class="number">-30</span>;</span><br><span class="line">    <span class="keyword">this</span>.topBg.height = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">this</span>.topBg.setPosition(-cc.winSize.width/<span class="number">2</span>+<span class="number">15</span>,(cc.winSize.width<span class="number">-30</span>)/<span class="number">2</span>);</span><br><span class="line">    <span class="comment">// 能量条背景层</span></span><br><span class="line">    <span class="keyword">this</span>.powerBarBg.width = cc.winSize.width<span class="number">-30</span>;</span><br><span class="line">    <span class="keyword">this</span>.powerBarBg.height = <span class="keyword">this</span>.powerBarBg.width/<span class="number">5</span>/<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">this</span>.powerBarBg.setPosition(<span class="number">15</span>-cc.winSize.width/<span class="number">2</span>,<span class="keyword">this</span>.topBg.getPositionY()<span class="number">-200</span>);</span><br><span class="line">    <span class="keyword">this</span>.powerBarBg.color = Colors.powerBarBg;</span><br><span class="line">    <span class="comment">// 方块背景层</span></span><br><span class="line">    <span class="keyword">this</span>.tileBg.width = cc.winSize.width<span class="number">-30</span>;</span><br><span class="line">    <span class="keyword">this</span>.tileBg.height = <span class="keyword">this</span>.tileBg.width;</span><br><span class="line">    <span class="keyword">this</span>.tileBg.setPosition(<span class="number">15</span>-cc.winSize.width/<span class="number">2</span>,<span class="keyword">this</span>.powerBarBg.getPositionY()<span class="number">-10</span>-<span class="keyword">this</span>.tileBg.height);</span><br><span class="line">    <span class="keyword">this</span>.tileBg.color = Colors.tileBg;</span><br><span class="line">    <span class="comment">// 生成能量条</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> power = cc.instantiate(<span class="keyword">this</span>.powerPre);</span><br><span class="line">        power.width = (<span class="keyword">this</span>.powerBarBg.width<span class="number">-30</span>)/<span class="number">5</span>;</span><br><span class="line">        power.height = <span class="keyword">this</span>.powerBarBg.height<span class="number">-10</span>;</span><br><span class="line">        <span class="keyword">this</span>.powerBarBg.addChild(power);</span><br><span class="line">        power.setPosition(<span class="number">5</span>+(<span class="number">5</span>+power.width)*i+power.width/<span class="number">2</span>,<span class="number">5</span>+power.height/<span class="number">2</span>);</span><br><span class="line">        power.color = Colors.power;</span><br><span class="line">        <span class="keyword">this</span>.powers[i] = power;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 生成初始方块</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> row=<span class="number">0</span>;row&lt;<span class="number">5</span>;row++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> col = <span class="number">0</span>;col&lt;<span class="number">5</span>;col++)&#123;</span><br><span class="line">            <span class="keyword">var</span> tile = cc.instantiate(<span class="keyword">this</span>.tilePre);</span><br><span class="line">            tile.getComponent(<span class="string">"Tile"</span>).game = <span class="keyword">this</span>;</span><br><span class="line">            tile.width = (<span class="keyword">this</span>.tileBg.width<span class="number">-30</span>)/<span class="number">5</span>;</span><br><span class="line">            tile.height = (<span class="keyword">this</span>.tileBg.height<span class="number">-30</span>)/<span class="number">5</span>;</span><br><span class="line">            <span class="keyword">var</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">var</span> maxRandom = <span class="number">5</span>;</span><br><span class="line">            <span class="keyword">var</span> randomNum = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">                count++;</span><br><span class="line">                <span class="keyword">var</span> arr = <span class="keyword">new</span> <span class="built_in">Array</span>();</span><br><span class="line">                <span class="keyword">var</span> scanArr = <span class="keyword">new</span> <span class="built_in">Array</span>();</span><br><span class="line">                <span class="keyword">if</span>(count&gt;<span class="number">10</span>)&#123;</span><br><span class="line">                    maxRandom++;</span><br><span class="line">                &#125;</span><br><span class="line">                randomNum = <span class="built_in">Math</span>.ceil(<span class="built_in">Math</span>.random()*maxRandom);</span><br><span class="line">                tile.getComponent(<span class="string">"Tile"</span>).setNum(randomNum,<span class="literal">false</span>,<span class="literal">false</span>);</span><br><span class="line">                tile.setPosition(<span class="number">5</span>+(<span class="number">5</span>+tile.width)*col+tile.width/<span class="number">2</span>,<span class="number">5</span>+(<span class="number">5</span>+tile.height)*row+tile.height/<span class="number">2</span>);</span><br><span class="line">                <span class="keyword">this</span>.tiles[row][col] = tile;</span><br><span class="line">                <span class="keyword">this</span>.scanAround(row,col,<span class="number">-1</span>,<span class="number">-1</span>,randomNum,arr,scanArr);</span><br><span class="line">                <span class="keyword">if</span>(arr.length&lt;<span class="number">3</span>)&#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            tile.getComponent(<span class="string">"Tile"</span>).setArrPosition(row,col);</span><br><span class="line">            <span class="keyword">this</span>.tileBg.addChild(tile);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.扫描逻辑<br>前面已经讲过<br>3.主要操作逻辑<br>在这个函数中，我们需要对指定的点进行扫描，如果相邻数超过三个，则进行合成动作，然后更新分数，将所有的方块向下移动填补，并补充一条能量条，增加连击次数<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">operateLogic:<span class="function"><span class="keyword">function</span>(<span class="params">touchRow,touchCol,curNum,isFirstCall</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> arr = <span class="keyword">new</span> <span class="built_in">Array</span>();</span><br><span class="line">    <span class="keyword">var</span> scanArr = <span class="keyword">new</span> <span class="built_in">Array</span>();</span><br><span class="line">    <span class="keyword">this</span>.scanAround(touchRow,touchCol,<span class="number">-1</span>,<span class="number">-1</span>,curNum,arr,scanArr);</span><br><span class="line">    <span class="keyword">if</span>(arr.length&gt;=<span class="number">3</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> addScore = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> index <span class="keyword">in</span> arr)&#123;</span><br><span class="line">            <span class="keyword">var</span> row = arr[index].split(<span class="string">"#"</span>)[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">var</span> col = arr[index].split(<span class="string">"#"</span>)[<span class="number">1</span>];</span><br><span class="line">            addScore += <span class="built_in">parseInt</span>(<span class="keyword">this</span>.tiles[row][col].getComponent(<span class="string">"Tile"</span>).numLabel.string*<span class="number">10</span>);</span><br><span class="line">            <span class="keyword">if</span>(row!=touchRow||col!=touchCol)&#123;</span><br><span class="line">                <span class="comment">// 执行销毁动作                    </span></span><br><span class="line">                <span class="keyword">this</span>.tiles[row][col].getComponent(<span class="string">"Tile"</span>).destoryTile();</span><br><span class="line">                <span class="keyword">this</span>.tiles[row][col] = <span class="literal">null</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">this</span>.tiles[row][col].getComponent(<span class="string">"Tile"</span>).setNum(curNum+<span class="number">1</span>,<span class="literal">false</span>,<span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">this</span>.maxNum = curNum+<span class="number">1</span>&gt;<span class="keyword">this</span>.maxNum?curNum+<span class="number">1</span>:<span class="keyword">this</span>.maxNum;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 更新分数</span></span><br><span class="line">        <span class="keyword">this</span>.scoreNum.string = <span class="built_in">parseInt</span>(<span class="keyword">this</span>.scoreNum.string)+addScore;</span><br><span class="line">        <span class="keyword">this</span>.scheduleOnce(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 0.1s后所有方块向下移动</span></span><br><span class="line">            <span class="keyword">this</span>.moveAllTileDown();</span><br><span class="line">        &#125;,<span class="number">0.1</span>);</span><br><span class="line">        <span class="keyword">if</span>(!isFirstCall)&#123;</span><br><span class="line">            <span class="comment">// 能量条补充一格</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">this</span>.powers[i]==<span class="literal">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">var</span> power = cc.instantiate(<span class="keyword">this</span>.powerPre);</span><br><span class="line">                    power.width = (<span class="keyword">this</span>.powerBarBg.width<span class="number">-30</span>)/<span class="number">5</span>;</span><br><span class="line">                    power.height = <span class="keyword">this</span>.powerBarBg.height<span class="number">-10</span>;</span><br><span class="line">                    <span class="keyword">this</span>.powerBarBg.addChild(power);</span><br><span class="line">                    power.setPosition(<span class="number">5</span>+(<span class="number">5</span>+power.width)*i+power.width/<span class="number">2</span>,<span class="number">5</span>+power.height/<span class="number">2</span>);</span><br><span class="line">                    power.color = Colors.power;</span><br><span class="line">                    power.setScale(<span class="number">0</span>);</span><br><span class="line">                    power.runAction(cc.scaleTo(<span class="number">0.1</span>,<span class="number">1</span>));</span><br><span class="line">                    <span class="keyword">this</span>.powers[i] = power;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 连击次数+1</span></span><br><span class="line">        Global.combo++;</span><br><span class="line">        <span class="comment">// cc.log("连击次数："+Global.combo);</span></span><br><span class="line">        <span class="comment">// 播放音效</span></span><br><span class="line">        <span class="keyword">switch</span>(Global.combo)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                cc.audioEngine.playEffect(<span class="keyword">this</span>.star1);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                cc.audioEngine.playEffect(<span class="keyword">this</span>.star2);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                cc.audioEngine.playEffect(<span class="keyword">this</span>.star3);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                cc.audioEngine.playEffect(<span class="keyword">this</span>.star4);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                cc.audioEngine.playEffect(<span class="keyword">this</span>.star5);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">                cc.audioEngine.playEffect(<span class="keyword">this</span>.star6);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">                cc.audioEngine.playEffect(<span class="keyword">this</span>.star7);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                cc.audioEngine.playEffect(<span class="keyword">this</span>.star7);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.isCal = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>4.所有方块向下移动<br>除了上文提到所有方块的移动算法之外，在移动完成之后，还需要进行新产生一批方块，并再次判断消除逻辑的操作<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">moveAllTileDown:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> col = <span class="number">0</span>; col &lt; <span class="number">5</span>; col++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> row = <span class="number">0</span>; row &lt; <span class="number">5</span>; row++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.tiles[row][col] != <span class="literal">null</span>) &#123;<span class="comment">// 有方块</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> row1 = row; row1 &gt; <span class="number">0</span>; row1--) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.tiles[row1 - <span class="number">1</span>][col] == <span class="literal">null</span>)&#123;</span><br><span class="line">                        <span class="comment">//如果没有向下移动</span></span><br><span class="line">                        <span class="keyword">this</span>.tiles[row1 - <span class="number">1</span>][col] = <span class="keyword">this</span>.tiles[row1][col];</span><br><span class="line">                        <span class="keyword">this</span>.tiles[row1][col] = <span class="literal">null</span>;</span><br><span class="line">                        <span class="keyword">this</span>.tiles[row1 - <span class="number">1</span>][col].getComponent(<span class="string">"Tile"</span>).moveTo(row1 - <span class="number">1</span>, col);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.scheduleOnce(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 0.3s后生成新方块</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> col = <span class="number">0</span>; col &lt; <span class="number">5</span>; col++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> row = <span class="number">0</span>; row &lt; <span class="number">5</span>; row++) &#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">this</span>.tiles[row][col]==<span class="literal">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">var</span> tile = cc.instantiate(<span class="keyword">this</span>.tilePre);</span><br><span class="line">                    tile.getComponent(<span class="string">"Tile"</span>).game = <span class="keyword">this</span>;</span><br><span class="line">                    tile.width = (<span class="keyword">this</span>.tileBg.width<span class="number">-30</span>)/<span class="number">5</span>;</span><br><span class="line">                    tile.height = (<span class="keyword">this</span>.tileBg.height<span class="number">-30</span>)/<span class="number">5</span>;</span><br><span class="line">                    <span class="keyword">var</span> maxRandom = <span class="keyword">this</span>.maxNum;</span><br><span class="line">                    <span class="keyword">var</span> randomNum = <span class="built_in">Math</span>.ceil(<span class="built_in">Math</span>.random()*maxRandom);</span><br><span class="line">                    tile.getComponent(<span class="string">"Tile"</span>).setNum(randomNum,<span class="literal">false</span>,<span class="literal">false</span>);</span><br><span class="line">                    tile.getComponent(<span class="string">"Tile"</span>).newTile(row,col);</span><br><span class="line">                    <span class="keyword">this</span>.tiles[row][col] = tile;</span><br><span class="line">                    <span class="keyword">this</span>.tileBg.addChild(tile);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 0.5s后遍历执行逻辑</span></span><br><span class="line">        <span class="keyword">this</span>.scheduleOnce(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> isSearch = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> col = <span class="number">0</span>; col &lt; <span class="number">5</span>; col++) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> row = <span class="number">0</span>; row &lt; <span class="number">5</span>; row++) &#123;</span><br><span class="line">                    <span class="keyword">if</span>(!isSearch)&#123;</span><br><span class="line">                        isSearch = <span class="keyword">this</span>.tiles[row][col]!=<span class="literal">null</span>&amp;&amp;<span class="keyword">this</span>.operateLogic(row,col,<span class="built_in">parseInt</span>(<span class="keyword">this</span>.tiles[row][col].getComponent(<span class="string">"Tile"</span>).numLabel.string),<span class="literal">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">0.5</span>);        </span><br><span class="line">     &#125;, <span class="number">0.3</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="运行效果"><a href="#运行效果" class="headerlink" title="运行效果"></a>运行效果</h3><p>最后的运行效果如下<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/addone.gif" alt="点我+1效果图"><br>通过CVP平台的项目托管可看到实际运行效果，地址如下：</p>
<ul>
<li>由于个人对Cocos Creator的适配还不大了解，在pc上运行时，需要使用chrome的手机调试预览（或者将chrome窗口调至手机屏幕大小），但是如果直接用手机打开，loadScene似乎又有不兼容的问题，至今无法理解，还请大神指点，而我无论是开发时的预览，还是通过xcode打包到我的iPhone6s Plus手机运行，都是完全没有问题。不知道是不是Creator的h5兼容还没有做好，又或者我哪里的技术没有掌握全面。<br><a href="http://www.cocoscvp.com/usercode/946fc5fd5d2c77331cc344ea1e4bfdd04630cf85/" target="_blank" rel="external">http://www.cocoscvp.com/usercode/946fc5fd5d2c77331cc344ea1e4bfdd04630cf85/</a></li>
</ul>
<h3 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h3><p>所有源代码均上传到github，欢迎交流学习，地址：<br><a href="https://github.com/hjcenry/addone" target="_blank" rel="external">https://github.com/hjcenry/addone</a></p>
<ul>
<li>原文博客：<a href="http://hjcenry.github.io">http://hjcenry.github.io</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;在学习Cocos中，需要一些东西来练手，于是前段时间就开发仿照一款公司之前的产品《点我+1》来做，仿照过程中，所有的算法逻辑都是自己研究的，并没有参考公司代码，也没有使用公司的美术资源，所以也就不存在公司机密的内容啦，完全只是学习练习而已。
    
    </summary>
    
      <category term="cocos2d-js" scheme="http://hjcenry.github.io/categories/cocos2d-js/"/>
    
    
      <category term="cocos2d-js" scheme="http://hjcenry.github.io/tags/cocos2d-js/"/>
    
      <category term="cvp" scheme="http://hjcenry.github.io/tags/cvp/"/>
    
      <category term="点我+1" scheme="http://hjcenry.github.io/tags/%E7%82%B9%E6%88%91-1/"/>
    
  </entry>
  
  <entry>
    <title>Cocos2d-JS实现的2048</title>
    <link href="http://hjcenry.github.io/2016/06/19/Cocos2d-JS%E5%AE%9E%E7%8E%B0%E7%9A%842048/"/>
    <id>http://hjcenry.github.io/2016/06/19/Cocos2d-JS实现的2048/</id>
    <published>2016-06-19T14:29:00.000Z</published>
    <updated>2016-06-19T14:58:09.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>2048是之前火过一段时间的休闲数字消除类游戏，它的玩法很简单，上手很容易，可是想到要得到高分却很难，看似简单的游戏却有着很多得分的技巧，想当初这个游戏也曾是陪伴我大学课堂的游戏之一。<a id="more"></a>虽然在得分上有着很多的技巧，但对于开发来说，这其实是一件相当容易的事情，仔细分析之后就可能大概理清楚这种消除游戏的逻辑。</p>
<h3 id="游戏分析"><a href="#游戏分析" class="headerlink" title="游戏分析"></a>游戏分析</h3><p>这款游戏仔细想想就差不多清楚它的大致的思路，游戏中只有方块这一个我们操作的对象，这个对象包含了所在行，所在列，以及方块显示的数字三个属性，这三个属性足以表达游戏中的所有效果。除了方块，其他的就是游戏中必不可少的背景图层，开始及结束场景等。由于游戏中需要将4x4的方块们整齐排列，因此还需要一个四行四列的表格，来呈现我们的游戏效果。</p>
<h3 id="滑动逻辑"><a href="#滑动逻辑" class="headerlink" title="滑动逻辑"></a>滑动逻辑</h3><p>游戏中最主要的操作就是通过手指触摸屏幕进行滑屏操作，带动场景中的方块整体移动，并且遇到相同数字的方块进行合并。滑动的逻辑就是遍历场景中所有的方块，每一个方块在滑动方向进行移动，如果前方没有方块，方块就一直滑动，如果前方有方块，判断自己的数字与这个方块的数字是否相同，相同进行合并操作，不相同则停在当前位置。</p>
<h3 id="游戏实现"><a href="#游戏实现" class="headerlink" title="游戏实现"></a>游戏实现</h3><p>在对游戏逻辑进行了分析之后，就可以用代码进行实现了，编码，其实就是一个将游戏逻辑转换为机器语言的过程而已。</p>
<h4 id="方块类"><a href="#方块类" class="headerlink" title="方块类"></a>方块类</h4><p>首先，我们需要一个类来存储方块的长度和宽度，代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 保存方块长度方块</span></span><br><span class="line"><span class="keyword">var</span> tile = &#123;</span><br><span class="line">    width: <span class="number">0</span>,</span><br><span class="line">    height: <span class="number">0</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>方块类是对场景中可操的方块的封装，包括所在行，所在列，显示数字三个属性，代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Tiled = cc.Node.extend(&#123;</span><br><span class="line">    num: <span class="number">0</span>,</span><br><span class="line">    col: <span class="number">0</span>,</span><br><span class="line">    row: <span class="number">0</span>,</span><br><span class="line">    ctor: <span class="function"><span class="keyword">function</span> (<span class="params">num</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当然仅仅有以上三个属性是不够的，我们还需要在方块的构造函数中绘制方块的背景、绘制方块显示的数字、以及随机设定方块的行列坐标。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Tiled = cc.Node.extend(&#123;</span><br><span class="line">    num: <span class="number">0</span>,</span><br><span class="line">    col: <span class="number">0</span>,</span><br><span class="line">    row: <span class="number">0</span>,</span><br><span class="line">    ctor: <span class="function"><span class="keyword">function</span> (<span class="params">num</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">this</span>.num = num;</span><br><span class="line">        <span class="keyword">var</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            count++;</span><br><span class="line">            <span class="keyword">this</span>.row = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">4</span>);</span><br><span class="line">            <span class="keyword">this</span>.col = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">4</span>);</span><br><span class="line">            <span class="keyword">if</span> (tiles[<span class="keyword">this</span>.row][<span class="keyword">this</span>.col] == <span class="literal">null</span>) &#123;</span><br><span class="line">                tiles[<span class="keyword">this</span>.row][<span class="keyword">this</span>.col] = <span class="keyword">this</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (count &gt;= <span class="number">16</span>) &#123;<span class="comment">// 格子满了</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 绘制背景</span></span><br><span class="line">        <span class="keyword">var</span> bg = <span class="keyword">new</span> cc.DrawNode();</span><br><span class="line">        bg.drawRect(cc.p(<span class="number">5</span>, <span class="number">5</span>), cc.p(tile.width - <span class="number">5</span>, tile.height - <span class="number">5</span>), cc.color(<span class="number">255</span>, <span class="number">209</span>, <span class="number">145</span>, <span class="number">255</span>), <span class="number">1</span>, cc.color(<span class="number">255</span>, <span class="number">209</span>, <span class="number">145</span>, <span class="number">255</span>));</span><br><span class="line">        <span class="keyword">this</span>.addChild(bg);</span><br><span class="line">        bg.setTag(<span class="number">2</span>);</span><br><span class="line">        <span class="comment">// 绘制数字</span></span><br><span class="line">        <span class="keyword">var</span> labelNum = <span class="keyword">new</span> cc.LabelTTF();</span><br><span class="line">        labelNum.setString(<span class="string">""</span> + <span class="keyword">this</span>.num);</span><br><span class="line">        labelNum.setFontSize(<span class="number">60</span>);</span><br><span class="line">        <span class="comment">// 字体描边效果</span></span><br><span class="line">        <span class="comment">// labelNum.enableStroke(cc.color.BLACK, 0);</span></span><br><span class="line">        <span class="keyword">this</span>.addChild(labelNum);</span><br><span class="line">        labelNum.setTag(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 设定字体和坐标</span></span><br><span class="line">        labelNum.setPosition(tile.width / <span class="number">2</span>, tile.height / <span class="number">2</span>);</span><br><span class="line">        <span class="comment">// 移动块</span></span><br><span class="line">        <span class="keyword">this</span>.newTile(<span class="keyword">this</span>.row, <span class="keyword">this</span>.col);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>除此之外，每个方块应该还要包含一个newTile方法、moveTo方法和updateNum方法，分别封装随机创建方块、移动方块和更新方块数字三个功能。<br>在updateNum方法中，我们主要做两件事，更新方块显示数字和更新方块背景颜色（在方块的背景色上，我还专门上网搜了几种颜色搭配，恩，感觉很有艺术美，哈哈），代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">updateNum: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.getChildByTag(<span class="number">1</span>).setString(<span class="string">""</span> + <span class="keyword">this</span>.num);</span><br><span class="line">    <span class="keyword">var</span> bg = <span class="keyword">this</span>.getChildByTag(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">switch</span> (<span class="keyword">this</span>.num) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            bg.drawRect(cc.p(<span class="number">5</span>, <span class="number">5</span>), cc.p(tile.width - <span class="number">5</span>, tile.height - <span class="number">5</span>), cc.color(<span class="number">235</span>, <span class="number">245</span>, <span class="number">223</span>, <span class="number">255</span>), <span class="number">1</span>, cc.color(<span class="number">235</span>, <span class="number">245</span>, <span class="number">223</span>, <span class="number">255</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">            bg.drawRect(cc.p(<span class="number">5</span>, <span class="number">5</span>), cc.p(tile.width - <span class="number">5</span>, tile.height - <span class="number">5</span>), cc.color(<span class="number">186</span>, <span class="number">212</span>, <span class="number">170</span>, <span class="number">255</span>), <span class="number">1</span>, cc.color(<span class="number">186</span>, <span class="number">212</span>, <span class="number">170</span>, <span class="number">255</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">            bg.drawRect(cc.p(<span class="number">5</span>, <span class="number">5</span>), cc.p(tile.width - <span class="number">5</span>, tile.height - <span class="number">5</span>), cc.color(<span class="number">212</span>, <span class="number">212</span>, <span class="number">170</span>, <span class="number">255</span>), <span class="number">1</span>, cc.color(<span class="number">212</span>, <span class="number">212</span>, <span class="number">170</span>, <span class="number">255</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">16</span>:</span><br><span class="line">            bg.drawRect(cc.p(<span class="number">5</span>, <span class="number">5</span>), cc.p(tile.width - <span class="number">5</span>, tile.height - <span class="number">5</span>), cc.color(<span class="number">193</span>, <span class="number">160</span>, <span class="number">117</span>, <span class="number">255</span>), <span class="number">1</span>, cc.color(<span class="number">193</span>, <span class="number">160</span>, <span class="number">117</span>, <span class="number">255</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">32</span>:</span><br><span class="line">            bg.drawRect(cc.p(<span class="number">5</span>, <span class="number">5</span>), cc.p(tile.width - <span class="number">5</span>, tile.height - <span class="number">5</span>), cc.color(<span class="number">124</span>, <span class="number">99</span>, <span class="number">84</span>, <span class="number">255</span>), <span class="number">1</span>, cc.color(<span class="number">124</span>, <span class="number">99</span>, <span class="number">84</span>, <span class="number">255</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">64</span>:</span><br><span class="line">            bg.drawRect(cc.p(<span class="number">5</span>, <span class="number">5</span>), cc.p(tile.width - <span class="number">5</span>, tile.height - <span class="number">5</span>), cc.color(<span class="number">218</span>, <span class="number">227</span>, <span class="number">224</span>, <span class="number">255</span>), <span class="number">1</span>, cc.color(<span class="number">218</span>, <span class="number">227</span>, <span class="number">224</span>, <span class="number">255</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">128</span>:</span><br><span class="line">            bg.drawRect(cc.p(<span class="number">5</span>, <span class="number">5</span>), cc.p(tile.width - <span class="number">5</span>, tile.height - <span class="number">5</span>), cc.color(<span class="number">64</span>, <span class="number">125</span>, <span class="number">148</span>, <span class="number">255</span>), <span class="number">1</span>, cc.color(<span class="number">64</span>, <span class="number">125</span>, <span class="number">148</span>, <span class="number">255</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">256</span>:</span><br><span class="line">            bg.drawRect(cc.p(<span class="number">5</span>, <span class="number">5</span>), cc.p(tile.width - <span class="number">5</span>, tile.height - <span class="number">5</span>), cc.color(<span class="number">123</span>, <span class="number">118</span>, <span class="number">135</span>, <span class="number">255</span>), <span class="number">1</span>, cc.color(<span class="number">123</span>, <span class="number">118</span>, <span class="number">135</span>, <span class="number">255</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">512</span>:</span><br><span class="line">            bg.drawRect(cc.p(<span class="number">5</span>, <span class="number">5</span>), cc.p(tile.width - <span class="number">5</span>, tile.height - <span class="number">5</span>), cc.color(<span class="number">172</span>, <span class="number">173</span>, <span class="number">172</span>, <span class="number">255</span>), <span class="number">1</span>, cc.color(<span class="number">172</span>, <span class="number">173</span>, <span class="number">172</span>, <span class="number">255</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1024</span>:</span><br><span class="line">            bg.drawRect(cc.p(<span class="number">5</span>, <span class="number">5</span>), cc.p(tile.width - <span class="number">5</span>, tile.height - <span class="number">5</span>), cc.color(<span class="number">204</span>, <span class="number">196</span>, <span class="number">194</span>, <span class="number">255</span>), <span class="number">1</span>, cc.color(<span class="number">204</span>, <span class="number">196</span>, <span class="number">194</span>, <span class="number">255</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2048</span>:</span><br><span class="line">            bg.drawRect(cc.p(<span class="number">5</span>, <span class="number">5</span>), cc.p(tile.width - <span class="number">5</span>, tile.height - <span class="number">5</span>), cc.color(<span class="number">199</span>, <span class="number">225</span>, <span class="number">240</span>, <span class="number">255</span>), <span class="number">1</span>, cc.color(<span class="number">199</span>, <span class="number">225</span>, <span class="number">240</span>, <span class="number">255</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4096</span>:</span><br><span class="line">            bg.drawRect(cc.p(<span class="number">5</span>, <span class="number">5</span>), cc.p(tile.width - <span class="number">5</span>, tile.height - <span class="number">5</span>), cc.color(<span class="number">150</span>, <span class="number">196</span>, <span class="number">230</span>, <span class="number">255</span>), <span class="number">1</span>, cc.color(<span class="number">150</span>, <span class="number">196</span>, <span class="number">230</span>, <span class="number">255</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">8192</span>:</span><br><span class="line">            bg.drawRect(cc.p(<span class="number">5</span>, <span class="number">5</span>), cc.p(tile.width - <span class="number">5</span>, tile.height - <span class="number">5</span>), cc.color(<span class="number">25</span>, <span class="number">77</span>, <span class="number">91</span>, <span class="number">255</span>), <span class="number">1</span>, cc.color(<span class="number">25</span>, <span class="number">77</span>, <span class="number">91</span>, <span class="number">255</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">16384</span>:</span><br><span class="line">            bg.drawRect(cc.p(<span class="number">5</span>, <span class="number">5</span>), cc.p(tile.width - <span class="number">5</span>, tile.height - <span class="number">5</span>), cc.color(<span class="number">229</span>, <span class="number">96</span>, <span class="number">205</span>, <span class="number">255</span>), <span class="number">1</span>, cc.color(<span class="number">229</span>, <span class="number">96</span>, <span class="number">205</span>, <span class="number">255</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">32768</span>:</span><br><span class="line">            bg.drawRect(cc.p(<span class="number">5</span>, <span class="number">5</span>), cc.p(tile.width - <span class="number">5</span>, tile.height - <span class="number">5</span>), cc.color(<span class="number">250</span>, <span class="number">174</span>, <span class="number">78</span>, <span class="number">255</span>), <span class="number">1</span>, cc.color(<span class="number">250</span>, <span class="number">174</span>, <span class="number">78</span>, <span class="number">255</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">65536</span>:</span><br><span class="line">            bg.drawRect(cc.p(<span class="number">5</span>, <span class="number">5</span>), cc.p(tile.width - <span class="number">5</span>, tile.height - <span class="number">5</span>), cc.color(<span class="number">255</span>, <span class="number">241</span>, <span class="number">222</span>, <span class="number">255</span>), <span class="number">1</span>, cc.color(<span class="number">255</span>, <span class="number">241</span>, <span class="number">222</span>, <span class="number">255</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            bg.drawRect(cc.p(<span class="number">5</span>, <span class="number">5</span>), cc.p(tile.width - <span class="number">5</span>, tile.height - <span class="number">5</span>), cc.color(<span class="number">255</span>, <span class="number">209</span>, <span class="number">145</span>, <span class="number">255</span>), <span class="number">1</span>, cc.color(<span class="number">255</span>, <span class="number">209</span>, <span class="number">145</span>, <span class="number">255</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>方块的移动方法和创建方法，我在这里先写成一样，因为还没有对方块的创建和移动做区别，如果要做优化，可以在移动时加入移动的动画，在创建加入创建的动画，代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">moveTo: <span class="function"><span class="keyword">function</span> (<span class="params">row, col</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.row = row;</span><br><span class="line">    <span class="keyword">this</span>.col = col;</span><br><span class="line">    <span class="keyword">this</span>.setPositionX((cc.winSize.width - tile.width * <span class="number">4</span>) / <span class="number">2</span> + tile.width * <span class="keyword">this</span>.col);</span><br><span class="line">    <span class="keyword">this</span>.setPositionY((cc.winSize.height - tile.height * <span class="number">4</span>) / <span class="number">2</span> + tile.height * <span class="keyword">this</span>.row);</span><br><span class="line">&#125;,</span><br><span class="line">newTile: <span class="function"><span class="keyword">function</span> (<span class="params">row, col</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.row = row;</span><br><span class="line">    <span class="keyword">this</span>.col = col;</span><br><span class="line">    <span class="keyword">this</span>.setPositionX((cc.winSize.width - tile.width * <span class="number">4</span>) / <span class="number">2</span> + tile.width * <span class="keyword">this</span>.col);</span><br><span class="line">    <span class="keyword">this</span>.setPositionY((cc.winSize.height - tile.height * <span class="number">4</span>) / <span class="number">2</span> + tile.height * <span class="keyword">this</span>.row);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="游戏场景类"><a href="#游戏场景类" class="headerlink" title="游戏场景类"></a>游戏场景类</h4><p>所有的游戏操作及操作反馈都在游戏场景类中进行，游戏场景类将封装好的方块类放到游戏逻辑中，通过玩家操作给予一定的操作反馈。游戏场景类中主要接受玩家的滑动操作，并在接收到滑动操作后将所有的方块类进行移动或合并。<br>游戏场景类中需要isMove，startX，startY，以及tiles四个属性：第一个是控制玩家触摸操作的标识变量，避免重复调用移动方法；中间两个为记录玩家手指滑动的距离，当距离查过一定的长度之后，才判断玩家进行了滑动操作；最后一个变量是一个数组，用于存储在4x4的表格中的方块的信息。<br>有了以上四个属性之后，就可以在构造函数中进行初始化了，代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> tiles = <span class="literal">null</span>;<span class="comment">// 存储方块信息</span></span><br><span class="line"><span class="keyword">var</span> GameLayer = cc.Layer.extend(&#123;</span><br><span class="line">    isMove: <span class="literal">false</span>,</span><br><span class="line">    startX: <span class="number">0</span>,</span><br><span class="line">    startY: <span class="number">0</span>,</span><br><span class="line">    ctor: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">this</span>.isMove = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.startX = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.startY = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//设置块的宽高</span></span><br><span class="line">        <span class="keyword">if</span> (cc.winSize.width &lt; cc.winSize.height) &#123;</span><br><span class="line">            <span class="comment">// 竖屏</span></span><br><span class="line">            tile.width = cc.winSize.width / <span class="number">5</span>;</span><br><span class="line">            tile.height = cc.winSize.width / <span class="number">5</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 横屏</span></span><br><span class="line">            tile.width = cc.winSize.height / <span class="number">5</span>;</span><br><span class="line">            tile.height = cc.winSize.height / <span class="number">5</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 初始化数组</span></span><br><span class="line">        tiles = [</span><br><span class="line">            [<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>],</span><br><span class="line">            [<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>],</span><br><span class="line">            [<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>],</span><br><span class="line">            [<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>]</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在初始化完之后，我们就可以在场景的onEnter方法中绘制场景了，绘制的内容包括游戏背景以及随机初始化两个方块，代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">onEnter: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>._super();</span><br><span class="line">    <span class="comment">// 绘制背景</span></span><br><span class="line">    <span class="keyword">this</span>.drawBg();</span><br><span class="line">    <span class="comment">// 绘制块</span></span><br><span class="line">    <span class="keyword">var</span> tile1 = <span class="keyword">new</span> Tiled(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">var</span> tile2 = <span class="keyword">new</span> Tiled(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">this</span>.addChild(tile1);</span><br><span class="line">    <span class="keyword">this</span>.addChild(tile2);</span><br><span class="line">    <span class="comment">//处理事件</span></span><br><span class="line">    cc.eventManager.addListener(&#123;</span><br><span class="line">        event: cc.EventListener.TOUCH_ONE_BY_ONE,</span><br><span class="line">        swallowTouches: <span class="literal">true</span>,</span><br><span class="line">        onTouchBegan: <span class="keyword">this</span>.touchbegan,</span><br><span class="line">        onTouchMoved: <span class="keyword">this</span>.touchmoved</span><br><span class="line">    &#125;, <span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中drawBg方法中，绘制了五条垂直直线以及五条水平直线，来作为方块所在的4x4的表格，代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">drawBg: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">//绘制背景</span></span><br><span class="line">    <span class="keyword">var</span> bgRect = <span class="keyword">new</span> cc.DrawNode();</span><br><span class="line">    bgRect.drawRect(cc.p(<span class="number">0</span>, <span class="number">0</span>), cc.p(cc.winSize.width, cc.winSize.height), cc.color(<span class="number">173</span>, <span class="number">140</span>, <span class="number">61</span>, <span class="number">255</span>), <span class="number">1</span>, cc.color(<span class="number">173</span>, <span class="number">140</span>, <span class="number">61</span>, <span class="number">255</span>));</span><br><span class="line">    <span class="keyword">this</span>.addChild(bgRect);</span><br><span class="line">    <span class="keyword">var</span> bg = <span class="keyword">new</span> cc.DrawNode();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> n = <span class="number">0</span>; n &lt; <span class="number">5</span>; n++) &#123;</span><br><span class="line">        bg.drawSegment(cc.p((cc.winSize.width - tile.width * <span class="number">4</span>) / <span class="number">2</span>, (cc.winSize.height - tile.height * <span class="number">4</span>) / <span class="number">2</span> + n * tile.width), cc.p(cc.winSize.width / <span class="number">2</span> + tile.width * <span class="number">2</span>, (cc.winSize.height - tile.height * <span class="number">4</span>) / <span class="number">2</span> + n * tile.width), <span class="number">5</span>,</span><br><span class="line">            cc.color(<span class="number">55</span>, <span class="number">62</span>, <span class="number">64</span>, <span class="number">255</span>));</span><br><span class="line">        bg.drawSegment(cc.p((cc.winSize.width - tile.width * <span class="number">4</span>) / <span class="number">2</span> + n * tile.width, (cc.winSize.height - tile.height * <span class="number">4</span>) / <span class="number">2</span>), cc.p((cc.winSize.width - tile.width * <span class="number">4</span>) / <span class="number">2</span> + n * tile.width, (cc.winSize.height - tile.height * <span class="number">4</span>) / <span class="number">2</span> + tile.width * <span class="number">4</span>), <span class="number">5</span>,</span><br><span class="line">            cc.color(<span class="number">55</span>, <span class="number">62</span>, <span class="number">64</span>, <span class="number">255</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.addChild(bg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，在onEnter中，注册了触摸事件，这个触摸事件就用于接受玩家的操作，在TouchBegan事件中记录触摸开始时的点，在TouchMoved中记录当前移动到的点，当触摸距离超过一定长度时，判定玩家进行了滑动操作，并通过触摸点来判断玩家滑动的举例，代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">touchbegan: <span class="function"><span class="keyword">function</span> (<span class="params">touch, event</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.isMove = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">this</span>.startX = touch.getLocationX();</span><br><span class="line">    <span class="keyword">this</span>.startY = touch.getLocationY();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;,</span><br><span class="line">touchmoved: <span class="function"><span class="keyword">function</span> (<span class="params">touch, event</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.isMove) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> endX = touch.getLocation().x;</span><br><span class="line">    <span class="keyword">var</span> endY = touch.getLocation().y;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Math</span>.abs(endX - <span class="keyword">this</span>.startX) &gt; <span class="number">20</span> ||</span><br><span class="line">        <span class="built_in">Math</span>.abs(endY - <span class="keyword">this</span>.startY) &gt; <span class="number">20</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> dir = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">Math</span>.abs(endX - <span class="keyword">this</span>.startX) &gt; <span class="built_in">Math</span>.abs(endY - <span class="keyword">this</span>.startY)) &#123;<span class="comment">//左右</span></span><br><span class="line">            <span class="keyword">if</span> (endX &gt; <span class="keyword">this</span>.startX) &#123;</span><br><span class="line">                dir = <span class="string">"right"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                dir = <span class="string">"left"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//上下</span></span><br><span class="line">            <span class="keyword">if</span> (endY &gt; <span class="keyword">this</span>.startY) &#123;</span><br><span class="line">                dir = <span class="string">"up"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                dir = <span class="string">"down"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.isMove = <span class="literal">false</span>;</span><br><span class="line">        event.getCurrentTarget().moveAllTiled(dir);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;,</span><br><span class="line">moveAllTiled: <span class="function"><span class="keyword">function</span> (<span class="params">dir</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> isMoved = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">switch</span> (dir) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"up"</span>:</span><br><span class="line">            isMoved = <span class="keyword">this</span>.moveUp();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"down"</span>:</span><br><span class="line">            isMoved = <span class="keyword">this</span>.moveDown();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"left"</span>:</span><br><span class="line">            isMoved = <span class="keyword">this</span>.moveLeft();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"right"</span>:</span><br><span class="line">            isMoved = <span class="keyword">this</span>.moveRight();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isMoved) &#123;</span><br><span class="line">        <span class="comment">//每次移动产生一个新块</span></span><br><span class="line">        <span class="keyword">this</span>.newTiled();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>触动滑动操作后，开始执行滑动逻辑，每次滑动之后，会随机创建一个新的方块，在newTiled方法中，除了创建新方块之外，还需要判断游戏是否结束，代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">newTiled: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> tile = <span class="keyword">new</span> Tiled(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">this</span>.addChild(tile);</span><br><span class="line">    <span class="comment">// 判断游戏是否结束</span></span><br><span class="line">    <span class="keyword">var</span> isOver = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// 判断是否有空余位置</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> row = <span class="number">0</span>; row &lt; <span class="number">4</span>; row++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> col = <span class="number">0</span>; col &lt; <span class="number">4</span>; col++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (tiles[row][col] == <span class="literal">null</span>) &#123;</span><br><span class="line">                isOver = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isOver) &#123;</span><br><span class="line">        <span class="comment">// 判断四周是否有数字相同方块</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> row = <span class="number">0</span>; row &lt; <span class="number">4</span>; row++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> col = <span class="number">0</span>; col &lt; <span class="number">4</span>; col++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (row &lt; <span class="number">3</span> &amp;&amp; tiles[row + <span class="number">1</span>][col].num == tiles[row][col].num) &#123;</span><br><span class="line">                    isOver = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (row &gt; <span class="number">0</span> &amp;&amp; tiles[row - <span class="number">1</span>][col].num == tiles[row][col].num) &#123;</span><br><span class="line">                    isOver = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (col &lt; <span class="number">3</span> &amp;&amp; tiles[row][col + <span class="number">1</span>].num == tiles[row][col].num) &#123;</span><br><span class="line">                    isOver = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (col &gt; <span class="number">0</span> &amp;&amp; tiles[row][col - <span class="number">1</span>].num == tiles[row][col].num) &#123;</span><br><span class="line">                    isOver = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isOver) &#123;</span><br><span class="line">        cc.director.runScene(<span class="keyword">new</span> cc.TransitionFade(<span class="number">1</span>, <span class="keyword">new</span> OverScene()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>方块的滑动，就是2048这款游戏最主要的逻辑了，我们在滑动的时候，需要遍历tiles数组所有不是null的元素，并将这个元素按照滑动方向进行移动，一直遍历到数组的最大长度，也就是将滑动到表格的边缘，如果中途遇到了方块，并且数字与自己相同，就进行合并，合并是将自己删除，将遇到的方块数字乘以2，如果中途遇到的方块的数字与自己不同，此方块的滑动就停止，使其停在当前的位置，滑动分为上下左右四个逻辑，代码分别如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">moveUp: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> isMoved = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> col = <span class="number">0</span>; col &lt; <span class="number">4</span>; col++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> row = <span class="number">3</span>; row &gt;= <span class="number">0</span>; row--) &#123;</span><br><span class="line">            <span class="keyword">if</span> (tiles[row][col] != <span class="literal">null</span>) &#123;<span class="comment">// 有方块</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> row1 = row; row1 &lt; <span class="number">3</span>; row1++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (tiles[row1 + <span class="number">1</span>][col] == <span class="literal">null</span>)<span class="comment">//如果没有向上移动</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        tiles[row1 + <span class="number">1</span>][col] = tiles[row1][col];</span><br><span class="line">                        tiles[row1][col] = <span class="literal">null</span>;</span><br><span class="line">                        tiles[row1 + <span class="number">1</span>][col].moveTo(row1 + <span class="number">1</span>, col);</span><br><span class="line">                        isMoved = <span class="literal">true</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tiles[row1 + <span class="number">1</span>][col].num == tiles[row1][col].num) &#123;<span class="comment">// 合并</span></span><br><span class="line">                        tiles[row1 + <span class="number">1</span>][col].num = <span class="built_in">parseInt</span>(tiles[row1][col].num) * <span class="number">2</span>;</span><br><span class="line">                        tiles[row1 + <span class="number">1</span>][col].updateNum();</span><br><span class="line">                        tiles[row1][col].removeFromParent();</span><br><span class="line">                        tiles[row1][col] = <span class="literal">null</span>;</span><br><span class="line">                        isMoved = <span class="literal">true</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> isMoved;</span><br><span class="line">&#125;,</span><br><span class="line">moveDown: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> isMoved = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> col = <span class="number">0</span>; col &lt; <span class="number">4</span>; col++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> row = <span class="number">0</span>; row &lt; <span class="number">4</span>; row++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (tiles[row][col] != <span class="literal">null</span>) &#123;<span class="comment">// 有方块</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> row1 = row; row1 &gt; <span class="number">0</span>; row1--) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (tiles[row1 - <span class="number">1</span>][col] == <span class="literal">null</span>)<span class="comment">//如果没有向下移动</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        tiles[row1 - <span class="number">1</span>][col] = tiles[row1][col];</span><br><span class="line">                        tiles[row1][col] = <span class="literal">null</span>;</span><br><span class="line">                        tiles[row1 - <span class="number">1</span>][col].moveTo(row1 - <span class="number">1</span>, col);</span><br><span class="line">                        isMoved = <span class="literal">true</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tiles[row1 - <span class="number">1</span>][col].num == tiles[row1][col].num) &#123;<span class="comment">// 合并</span></span><br><span class="line">                        tiles[row1 - <span class="number">1</span>][col].num = <span class="built_in">parseInt</span>(tiles[row1][col].num) * <span class="number">2</span>;</span><br><span class="line">                        tiles[row1 - <span class="number">1</span>][col].updateNum();</span><br><span class="line">                        tiles[row1][col].removeFromParent();</span><br><span class="line">                        tiles[row1][col] = <span class="literal">null</span>;</span><br><span class="line">                        isMoved = <span class="literal">true</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> isMoved;</span><br><span class="line">&#125;,</span><br><span class="line">moveLeft: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> isMoved = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> row = <span class="number">0</span>; row &lt; <span class="number">4</span>; row++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> col = <span class="number">0</span>; col &lt; <span class="number">4</span>; col++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (tiles[row][col] != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> col1 = col; col1 &gt; <span class="number">0</span>; col1--) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (tiles[row][col1 - <span class="number">1</span>] == <span class="literal">null</span>) &#123;</span><br><span class="line">                        tiles[row][col1 - <span class="number">1</span>] = tiles[row][col1];</span><br><span class="line">                        tiles[row][col1] = <span class="literal">null</span>;</span><br><span class="line">                        tiles[row][col1 - <span class="number">1</span>].moveTo(row, col1 - <span class="number">1</span>);</span><br><span class="line">                        isMoved = <span class="literal">true</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tiles[row][col1 - <span class="number">1</span>].num == tiles[row][col1].num) &#123;<span class="comment">// 合并</span></span><br><span class="line">                        tiles[row][col1 - <span class="number">1</span>].num = <span class="built_in">parseInt</span>(tiles[row][col1].num) * <span class="number">2</span>;</span><br><span class="line">                        tiles[row][col1 - <span class="number">1</span>].updateNum();</span><br><span class="line">                        tiles[row][col1].removeFromParent();</span><br><span class="line">                        tiles[row][col1] = <span class="literal">null</span>;</span><br><span class="line">                        isMoved = <span class="literal">true</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> isMoved;</span><br><span class="line">&#125;,</span><br><span class="line">moveRight: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> isMoved = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> row = <span class="number">0</span>; row &lt; <span class="number">4</span>; row++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> col = <span class="number">3</span>; col &gt;= <span class="number">0</span>; col--) &#123;</span><br><span class="line">            <span class="keyword">if</span> (tiles[row][col] != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> col1 = col; col1 &lt; <span class="number">3</span>; col1++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (tiles[row][col1 + <span class="number">1</span>] == <span class="literal">null</span>) &#123;</span><br><span class="line">                        tiles[row][col1 + <span class="number">1</span>] = tiles[row][col1];</span><br><span class="line">                        tiles[row][col1] = <span class="literal">null</span>;</span><br><span class="line">                        tiles[row][col1 + <span class="number">1</span>].moveTo(row, col1 + <span class="number">1</span>);</span><br><span class="line">                        isMoved = <span class="literal">true</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tiles[row][col1 + <span class="number">1</span>].num == tiles[row][col1].num) &#123;<span class="comment">// 合并</span></span><br><span class="line">                        tiles[row][col1 + <span class="number">1</span>].num = <span class="built_in">parseInt</span>(tiles[row][col1].num) * <span class="number">2</span>;</span><br><span class="line">                        tiles[row][col1 + <span class="number">1</span>].updateNum();</span><br><span class="line">                        tiles[row][col1].removeFromParent();</span><br><span class="line">                        tiles[row][col1] = <span class="literal">null</span>;</span><br><span class="line">                        isMoved = <span class="literal">true</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> isMoved;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>至此，我们就基本实现了2048游戏的主要逻辑。</p>
<h4 id="开始-结束场景类"><a href="#开始-结束场景类" class="headerlink" title="开始/结束场景类"></a>开始/结束场景类</h4><p>为了游戏框架的完整，我们还是创建一个开始场景类和结束场景类，代码分别如下：<br>开始场景类<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> HelloWorldLayer = cc.Layer.extend(&#123;</span><br><span class="line">    sprite:<span class="literal">null</span>,</span><br><span class="line">    ctor:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">//////////////////////////////</span></span><br><span class="line">        <span class="comment">// 1. super init first</span></span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/////////////////////////////</span></span><br><span class="line">        <span class="comment">// 2. add a menu item with "X" image, which is clicked to quit the program</span></span><br><span class="line">        <span class="comment">//    you may modify it.</span></span><br><span class="line">        <span class="comment">// ask the window size</span></span><br><span class="line">        <span class="keyword">var</span> size = cc.winSize;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/////////////////////////////</span></span><br><span class="line">        <span class="comment">// 3. add your codes below...</span></span><br><span class="line">        <span class="comment">// add a label shows "Hello World"</span></span><br><span class="line">        <span class="comment">// create and initialize a label</span></span><br><span class="line">        <span class="keyword">var</span> helloLabel = <span class="keyword">new</span> cc.LabelTTF(<span class="string">"2048"</span>, <span class="string">"Arial"</span>, <span class="number">38</span>);</span><br><span class="line">        <span class="comment">// position the label on the center of the screen</span></span><br><span class="line">        helloLabel.x = size.width / <span class="number">2</span>;</span><br><span class="line">        helloLabel.y = size.height / <span class="number">2</span> + <span class="number">200</span>;</span><br><span class="line">        <span class="comment">// add the label as a child to this layer</span></span><br><span class="line">        <span class="keyword">this</span>.addChild(helloLabel, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// add "HelloWorld" splash screen"</span></span><br><span class="line">        <span class="comment">// this.sprite = new cc.Sprite(res.HelloWorld_png);</span></span><br><span class="line">        <span class="comment">// this.sprite.attr(&#123;</span></span><br><span class="line">        <span class="comment">//     x: size.width / 2,</span></span><br><span class="line">        <span class="comment">//     y: size.height / 2</span></span><br><span class="line">        <span class="comment">// &#125;);</span></span><br><span class="line">        <span class="comment">// this.addChild(this.sprite, 0);</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> start = <span class="keyword">new</span> cc.MenuItemFont(<span class="string">"开始游戏"</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            cc.director.runScene(<span class="keyword">new</span> cc.TransitionFade(<span class="number">1</span>,<span class="keyword">new</span> GameScene()));</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">var</span> menu = <span class="keyword">new</span> cc.Menu(start);</span><br><span class="line">        <span class="keyword">this</span>.addChild(menu);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> HelloWorldScene = cc.Scene.extend(&#123;</span><br><span class="line">    onEnter:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> layer = <span class="keyword">new</span> HelloWorldLayer();</span><br><span class="line">        <span class="keyword">this</span>.addChild(layer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>结束场景类<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by Henry on 16/6/19.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">var</span> OverLayer = cc.Layer.extend(&#123;</span><br><span class="line">    ctor: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> overText = <span class="keyword">new</span> cc.LabelTTF(<span class="string">"Game Over"</span>, <span class="string">""</span>, <span class="number">50</span>);</span><br><span class="line">        overText.setPosition(cc.winSize.width / <span class="number">2</span>, cc.winSize.height / <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">var</span> back = <span class="keyword">new</span> cc.MenuItemFont(<span class="string">"再来一次"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            cc.director.runScene(<span class="keyword">new</span> cc.TransitionFade(<span class="number">1</span>, <span class="keyword">new</span> HelloWorldScene()));</span><br><span class="line">        &#125;, <span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">var</span> menu = <span class="keyword">new</span> cc.Menu(back);</span><br><span class="line">        <span class="keyword">this</span>.addChild(menu);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> OverScene = cc.Scene.extend(&#123;</span><br><span class="line">    ctor: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> layer = <span class="keyword">new</span> OverLayer();</span><br><span class="line">        <span class="keyword">this</span>.addChild(layer);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h3 id="运行效果"><a href="#运行效果" class="headerlink" title="运行效果"></a>运行效果</h3><p>最后的运行效果如下<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/2048.gif" alt="2048效果图"><br>通过CVP平台的项目托管可看到实际运行效果，地址如下：<br><a href="http://www.cocoscvp.com/usercode/ea72822aeed0546b537b4226954a11be87a7f152/" target="_blank" rel="external">http://www.cocoscvp.com/usercode/ea72822aeed0546b537b4226954a11be87a7f152/</a></p>
<h3 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h3><p>所有源代码均上传到github，欢迎交流学习，地址：<br><a href="https://github.com/hjcenry/2048" target="_blank" rel="external">https://github.com/hjcenry/2048</a></p>
<ul>
<li>原文博客：<a href="http://hjcenry.github.io">http://hjcenry.github.io</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;2048是之前火过一段时间的休闲数字消除类游戏，它的玩法很简单，上手很容易，可是想到要得到高分却很难，看似简单的游戏却有着很多得分的技巧，想当初这个游戏也曾是陪伴我大学课堂的游戏之一。
    
    </summary>
    
      <category term="cocos2d-js" scheme="http://hjcenry.github.io/categories/cocos2d-js/"/>
    
    
      <category term="cocos2d-js" scheme="http://hjcenry.github.io/tags/cocos2d-js/"/>
    
      <category term="cvp" scheme="http://hjcenry.github.io/tags/cvp/"/>
    
      <category term="2048" scheme="http://hjcenry.github.io/tags/2048/"/>
    
  </entry>
  
  <entry>
    <title>CVP认证学习笔记--(何小成)027--纹理缓存的管理</title>
    <link href="http://hjcenry.github.io/2016/06/02/CVP%E8%AE%A4%E8%AF%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0--(%E4%BD%95%E5%B0%8F%E6%88%90)027--%E7%BA%B9%E7%90%86%E7%BC%93%E5%AD%98%E7%9A%84%E7%AE%A1%E7%90%86/"/>
    <id>http://hjcenry.github.io/2016/06/02/CVP认证学习笔记--(何小成)027--纹理缓存的管理/</id>
    <published>2016-06-02T15:39:00.000Z</published>
    <updated>2016-06-02T16:09:44.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>本节内容主要讲解两个知识点，纹理缓存的管理和cocos的场景加载动画。纹理缓存管理可以通过cc.TextureCache来进行管理，而场景加载动画则在源码中的/frameworks/cocos2d-html5/cocos2d/core/scenes/CCLoaderScene.js中<a id="more"></a>，在CCLoaderScene中定义了场景加载的相关方法。</p>
<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><p>cc.TextureCache的使用API在官网的文档地址是：<a href="http://www.cocos.com/doc/jsdoc/symbols/cc.textureCache.html" target="_blank" rel="external">http://www.cocos.com/doc/jsdoc/symbols/cc.textureCache.html</a><br>其主要API如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">addImage(path);<span class="comment">// 添加一个纹理到缓存</span></span><br><span class="line">dumpCachedTextureInfo();<span class="comment">// 把当前TextureCache的内容输出到cc.log,它会计算每个贴图的大小和贴图总共占用的内存</span></span><br><span class="line">getTextureForKey(textureKeyName);<span class="comment">// 返回创建好的贴图。如果贴图不存在，返回空。</span></span><br><span class="line">removeAllTextures();<span class="comment">// 清空加载贴图的字典，如果你收到“内存警告”时请调用此方法短期来看:释放某些资源，防止app出现闪退,在中期:会分配更多的资源,长远来看:没有什么区别</span></span><br><span class="line">removeTexture(texture);<span class="comment">// 从缓存中删除指定的贴图</span></span><br><span class="line">removeTextureForKey(textureKeyName);<span class="comment">// 从缓存中根据给定的key删除贴图textureForKey(textureKeyName);// 返回创建好的贴图。如果贴图不存在，返回空。</span></span><br></pre></td></tr></table></figure></p>
<h3 id="loading场景"><a href="#loading场景" class="headerlink" title="loading场景"></a>loading场景</h3><p>cocos本身的loading场景在/frameworks/cocos2d-html5/cocos2d/core/scenes/CCLoaderScene.js中，而如果我们想要自己实现loading场景，要么在这个类的基础上直接改，要么写一个自己的loading场景，然后在main.js中把加载系统的loading场景改为加载我们自己的loading场景，仔细研究这个CCLoaderScene，其实发现它也没有做多么伟大的事情，其实也就是比普通的场景多做一件事而已，那就是加载资源，通过init的函数，加载一些变量，如loading文本，百分数的进度等，然后调用一个定时任务，定期更新进度文本，定时任务中通过调用cc.loader函数检查资源加载的进度，加载完成之后，再进入主场景。</p>
<h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h3><p>本节作业：<br>本节作业要求<br>// 本节课介绍了loading 的原理和系统源码<br>// 并深入介绍了cc.textureCache的核心用法<br>// 作业要求<br>// 实现一个自定义 loading效果（如果需要图片可以通过提交项目方式完成）<br>// 当loading 完成之后<br>// 清除loading界面的所有纹理<br>我在代码中实现了自建loading场景，写在了app.js中，并在loading场景中添加了一个移动的npc来模拟加载进度条，并且npc的纹理通过textureCache来管理，进度条加载完之后，通过textureCache移除场景中所有的纹理（其实只有npc的纹理）<br>作业代码实现如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> HelloWorldLayer = cc.Layer.extend(&#123;</span><br><span class="line">    sprite:<span class="literal">null</span>,</span><br><span class="line">    ctor:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">//////////////////////////////</span></span><br><span class="line">        <span class="comment">// 1. super init first</span></span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="comment">//这时候，在src/resource.js中定义的图片数组都已经保存到了</span></span><br><span class="line">        <span class="comment">//cc.TextureCache中，因此我们可以直接从这里获取纹理</span></span><br><span class="line">        cc.textureCache.addImage(<span class="string">"res/32636-2.png"</span>);</span><br><span class="line">        <span class="keyword">var</span> texture1=cc.textureCache.getTextureForKey(<span class="string">"res/32636-2.png"</span>);</span><br><span class="line">        cc.textureCache.dumpCachedTextureInfo();</span><br><span class="line">        <span class="keyword">var</span> sp=<span class="keyword">new</span> cc.Sprite(texture1);</span><br><span class="line">        <span class="keyword">this</span>.addChild(sp);</span><br><span class="line">        sp.setPosition(cc.winSize.width/<span class="number">2</span>,cc.winSize.height/<span class="number">2</span>);</span><br><span class="line">        <span class="comment">// 本节课介绍了loading 的原理和系统源码</span></span><br><span class="line">        <span class="comment">// 并深入介绍了cc.textureCache的核心用法</span></span><br><span class="line">        <span class="comment">// 作业要求</span></span><br><span class="line">        <span class="comment">// 实现一个自定义 loading效果（如果需要图片可以通过提交项目方式完成）</span></span><br><span class="line">        <span class="comment">// 当loading 完成之后</span></span><br><span class="line">        <span class="comment">// 清除loading界面的所有纹理        </span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> HelloWorldScene = cc.Scene.extend(&#123;</span><br><span class="line">    onEnter:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> layer = <span class="keyword">new</span> HelloWorldLayer();</span><br><span class="line">        <span class="keyword">this</span>.addChild(layer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义loading界面</span></span><br><span class="line"><span class="keyword">var</span> MyLoadScene = cc.Scene.extend(&#123;</span><br><span class="line">    _interval : <span class="literal">null</span>,</span><br><span class="line">    _label : <span class="literal">null</span>,</span><br><span class="line">    _npc:<span class="literal">null</span>,</span><br><span class="line">    _className:<span class="string">"LoaderScene"</span>,</span><br><span class="line">    cb: <span class="literal">null</span>,</span><br><span class="line">    target: <span class="literal">null</span>,</span><br><span class="line">    npc:<span class="literal">null</span>,</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Contructor of cc.LoaderScene</span><br><span class="line">     * @returns &#123;boolean&#125;</span><br><span class="line">     */</span></span><br><span class="line">    init : <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//logo</span></span><br><span class="line">        <span class="keyword">var</span> logoWidth = <span class="number">160</span>;</span><br><span class="line">        <span class="keyword">var</span> logoHeight = <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// bg</span></span><br><span class="line">        <span class="keyword">var</span> bgLayer = self._bgLayer = <span class="keyword">new</span> cc.LayerColor(cc.color(<span class="number">32</span>, <span class="number">255</span>, <span class="number">32</span>, <span class="number">255</span>));</span><br><span class="line">        self.addChild(bgLayer, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//image move to CCSceneFile.js</span></span><br><span class="line">        <span class="keyword">var</span> fontSize = <span class="number">24</span>, lblHeight =  -logoHeight / <span class="number">2</span> + <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">if</span>(cc._loaderImage)&#123;<span class="comment">//这个图片在Base64Image中保存，我们可以替换</span></span><br><span class="line">            <span class="comment">//loading logo</span></span><br><span class="line">            cc.loader.loadImg(cc._loaderImage, &#123;isCrossOrigin : <span class="literal">false</span> &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, img</span>)</span>&#123;</span><br><span class="line">                logoWidth = img.width;</span><br><span class="line">                logoHeight = img.height;</span><br><span class="line">                self._initStage(img, cc.visibleRect.center);</span><br><span class="line">            &#125;);</span><br><span class="line">            fontSize = <span class="number">14</span>;</span><br><span class="line">            lblHeight = -logoHeight / <span class="number">2</span> - <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//loading percent 加载进度</span></span><br><span class="line">        <span class="keyword">var</span> label = self._label = <span class="keyword">new</span> cc.LabelTTF(<span class="string">"Loading... 0%"</span>, <span class="string">"Arial"</span>, fontSize);</span><br><span class="line">        label.setPosition(cc.pAdd(cc.visibleRect.center, cc.p(<span class="number">0</span>, lblHeight)));</span><br><span class="line">        label.setColor(cc.color(<span class="number">180</span>, <span class="number">180</span>, <span class="number">180</span>));</span><br><span class="line">        bgLayer.addChild(<span class="keyword">this</span>._label, <span class="number">10</span>);</span><br><span class="line">        <span class="comment">// 自定义npc</span></span><br><span class="line">        cc.textureCache.addImage(<span class="string">"res/32636-2.png"</span>);</span><br><span class="line">        cc.textureCache.dumpCachedTextureInfo();</span><br><span class="line">        cc.log(<span class="string">"loading界面添加纹理32636-2"</span>);</span><br><span class="line">        <span class="keyword">var</span> npcTexture = cc.textureCache.getTextureForKey(<span class="string">"res/32636-2.png"</span>);</span><br><span class="line">        <span class="keyword">var</span> npc = self._npc = <span class="keyword">new</span> cc.Sprite(npcTexture);</span><br><span class="line">        npc.setPosition(npc.width/<span class="number">2</span>,<span class="number">150</span>);</span><br><span class="line">        npc.setScale(<span class="number">0.5</span>);</span><br><span class="line">        <span class="keyword">this</span>._bgLayer.addChild(<span class="keyword">this</span>._npc,<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">      _initStage: <span class="function"><span class="keyword">function</span> (<span class="params">img, centerPos</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">var</span> texture2d = self._texture2d = <span class="keyword">new</span> cc.Texture2D();</span><br><span class="line">        texture2d.initWithElement(img);</span><br><span class="line">        texture2d.handleLoadedTexture();</span><br><span class="line">        <span class="keyword">var</span> logo = self._logo = <span class="keyword">new</span> cc.Sprite(texture2d);</span><br><span class="line">        logo.setScale(cc.contentScaleFactor());</span><br><span class="line">        logo.x = centerPos.x;</span><br><span class="line">        logo.y = centerPos.y;</span><br><span class="line">        self._bgLayer.addChild(logo, <span class="number">10</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * custom onEnter</span><br><span class="line">     */</span></span><br><span class="line">    onEnter: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">        cc.Node.prototype.onEnter.call(self);</span><br><span class="line">        self.schedule(self._startLoading, <span class="number">0.3</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * custom onExit</span><br><span class="line">     */</span></span><br><span class="line">    onExit: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        cc.Node.prototype.onExit.call(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">var</span> tmpStr = <span class="string">"Loading... 100%"</span>;</span><br><span class="line">        <span class="keyword">this</span>._label.setString(tmpStr);</span><br><span class="line">        <span class="comment">// 清理缓存</span></span><br><span class="line">        cc.textureCache.removeAllTextures();</span><br><span class="line">        cc.textureCache.dumpCachedTextureInfo();</span><br><span class="line">        cc.log(<span class="string">"loading界面结束，清理纹理缓存"</span>);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * init with resources</span><br><span class="line">     * @param &#123;Array&#125; resources</span><br><span class="line">     * @param &#123;Function|String&#125; cb</span><br><span class="line">     * @param &#123;Object&#125; target</span><br><span class="line">     */</span></span><br><span class="line">    initWithResources: <span class="function"><span class="keyword">function</span> (<span class="params">resources, cb, target</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(cc.isString(resources))</span><br><span class="line">            resources = [resources];</span><br><span class="line">        <span class="keyword">this</span>.resources = resources || [];</span><br><span class="line">        <span class="keyword">this</span>.cb = cb;</span><br><span class="line">        <span class="keyword">this</span>.target = target;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    _startLoading: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">        self.unschedule(self._startLoading);</span><br><span class="line">        <span class="keyword">var</span> res = self.resources;</span><br><span class="line">        cc.loader.load(res,</span><br><span class="line">            <span class="function"><span class="keyword">function</span> (<span class="params">result, count, loadedCount</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">var</span> percent = (loadedCount / count * <span class="number">100</span>) | <span class="number">0</span>;</span><br><span class="line">                percent = <span class="built_in">Math</span>.min(percent, <span class="number">100</span>);</span><br><span class="line">                self._label.setString(<span class="string">"Loading... "</span> + percent + <span class="string">"%"</span>);</span><br><span class="line">                self._npc.setPositionX(self._npc.width/<span class="number">2</span>+cc.winSize.width*(percent/<span class="number">100</span>));</span><br><span class="line">                cc.log(<span class="string">"loading界面npc走到了"</span>+percent+<span class="string">",横坐标"</span>+(self._npc.width/<span class="number">2</span>+cc.winSize.width*(percent/<span class="number">100</span>))+<span class="string">""</span>);</span><br><span class="line">            &#125;, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (self.cb)</span><br><span class="line">                    self.cb.call(self.target);</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    _updateTransform: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._renderCmd.setDirtyFlag(cc.Node._dirtyFlags.transformDirty);</span><br><span class="line">        <span class="keyword">this</span>._bgLayer._renderCmd.setDirtyFlag(cc.Node._dirtyFlags.transformDirty);</span><br><span class="line">        <span class="keyword">this</span>._label._renderCmd.setDirtyFlag(cc.Node._dirtyFlags.transformDirty);</span><br><span class="line">        <span class="keyword">this</span>._logo._renderCmd.setDirtyFlag(cc.Node._dirtyFlags.transformDirty);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">MyLoadScene.preload = <span class="function"><span class="keyword">function</span>(<span class="params">resources, cb, target</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> _cc = cc;</span><br><span class="line">    <span class="keyword">if</span>(!_cc.loaderScene) &#123;</span><br><span class="line">        _cc.loaderScene = <span class="keyword">new</span> MyLoadScene();</span><br><span class="line">        _cc.loaderScene.init();</span><br><span class="line">        cc.eventManager.addCustomListener(cc.Director.EVENT_PROJECTION_CHANGED, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            _cc.loaderScene._updateTransform();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//调用initWithResources来实现纹理加载</span></span><br><span class="line">    _cc.loaderScene.initWithResources(resources, cb, target);</span><br><span class="line">    cc.director.runScene(_cc.loaderScene);</span><br><span class="line">    <span class="keyword">return</span> _cc.loaderScene;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>其中main.js加载场景的代码修改如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//load resources</span></span><br><span class="line"><span class="comment">// cc.LoaderScene.preload(g_resources, function () &#123;</span></span><br><span class="line"><span class="comment">//     cc.director.runScene(new HelloWorldScene());</span></span><br><span class="line"><span class="comment">// &#125;, this);</span></span><br><span class="line">MyLoadScene.preload(g_resources, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    cc.director.runScene(<span class="keyword">new</span> HelloWorldScene());</span><br><span class="line">&#125;, <span class="keyword">this</span>);</span><br></pre></td></tr></table></figure></p>
<h3 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h3><p><a href="http://www.cocoscvp.com/usercode/2016_05_20/55df2e8d114fce1f48d1151065951e865d56b92c/" target="_blank" rel="external">http://www.cocoscvp.com/usercode/2016_05_20/55df2e8d114fce1f48d1151065951e865d56b92c/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;概念&quot;&gt;&lt;a href=&quot;#概念&quot; class=&quot;headerlink&quot; title=&quot;概念&quot;&gt;&lt;/a&gt;概念&lt;/h3&gt;&lt;p&gt;本节内容主要讲解两个知识点，纹理缓存的管理和cocos的场景加载动画。纹理缓存管理可以通过cc.TextureCache来进行管理，而场景加载动画则在源码中的/frameworks/cocos2d-html5/cocos2d/core/scenes/CCLoaderScene.js中
    
    </summary>
    
      <category term="cocos2d-js" scheme="http://hjcenry.github.io/categories/cocos2d-js/"/>
    
    
      <category term="cocos2d-js" scheme="http://hjcenry.github.io/tags/cocos2d-js/"/>
    
      <category term="cvp" scheme="http://hjcenry.github.io/tags/cvp/"/>
    
  </entry>
  
  <entry>
    <title>CVP认证学习笔记--(何小成)026--数组的使用</title>
    <link href="http://hjcenry.github.io/2016/05/29/CVP%E8%AE%A4%E8%AF%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0--(%E4%BD%95%E5%B0%8F%E6%88%90)026--%E6%95%B0%E7%BB%84%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
    <id>http://hjcenry.github.io/2016/05/29/CVP认证学习笔记--(何小成)026--数组的使用/</id>
    <published>2016-05-29T02:35:00.000Z</published>
    <updated>2016-05-29T02:35:10.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>本节讲解cocos2d-js中数组的使用，其实数组不是cocos特有的，这是js中的一种数据结构，与Java，C中的数组稍有不同，js中的数组能存储任意类型的元素，并且在声明时无需指定长度，与Java中的List的用法更相似。<a id="more"></a>不过js中数组的强大，有时候也会为开发调试带来不少烦恼，使用时还是要注意符合规范。在cocos中，数组经常被用来存储渲染的Node对象，以方便管理，如前面我写到的打飞机，子弹就可以用数组来管理，每一帧的逻辑，都可以通过遍历子弹数组，来判断是否有子弹飞出屏幕或击中玩家飞机。</p>
<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><p>数组常用的使用方法如下<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// shift:删除原数组第一项，并返回删除元素的值；如果数组为空则返回undefined </span></span><br><span class="line"><span class="keyword">var</span> a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>];   </span><br><span class="line"><span class="keyword">var</span> b = a.shift(); <span class="comment">//a:[2,3,4,5] b:1</span></span><br><span class="line"><span class="comment">// unshift:将参数添加到原数组开头，并返回数组的长度 </span></span><br><span class="line"><span class="keyword">var</span> a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>];   </span><br><span class="line"><span class="keyword">var</span> b = a.unshift(<span class="number">-2</span>,<span class="number">-1</span>); <span class="comment">//a:[-2,-1,1,2,3,4,5] b:7   </span></span><br><span class="line"><span class="comment">// pop:删除原数组最后一项，并返回删除元素的值；如果数组为空则返回undefined </span></span><br><span class="line"><span class="keyword">var</span> a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>];   </span><br><span class="line"><span class="keyword">var</span> b = a.pop(); <span class="comment">//a:[1,2,3,4] b:5  </span></span><br><span class="line"><span class="comment">// push:将参数添加到原数组末尾，并返回数组的长度 </span></span><br><span class="line"><span class="keyword">var</span> a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>];   </span><br><span class="line"><span class="keyword">var</span> b = a.push(<span class="number">6</span>,<span class="number">7</span>); <span class="comment">//a:[1,2,3,4,5,6,7] b:7  </span></span><br><span class="line"><span class="comment">// concat:返回一个新数组，是将参数添加到原数组中构成的 </span></span><br><span class="line"><span class="keyword">var</span> a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>];   </span><br><span class="line"><span class="keyword">var</span> b = a.concat(<span class="number">6</span>,<span class="number">7</span>); <span class="comment">//a:[1,2,3,4,5] b:[1,2,3,4,5,6,7]  </span></span><br><span class="line"><span class="comment">// splice(start,deleteCount,val1,val2,...):从start位置开始删除deleteCount项，并从该位置起插入val1,val2,... </span></span><br><span class="line"><span class="keyword">var</span> a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>];   </span><br><span class="line"><span class="keyword">var</span> b = a.splice(<span class="number">2</span>,<span class="number">2</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>); <span class="comment">//a:[1,2,7,8,9,5] b:[3,4]   </span></span><br><span class="line"><span class="keyword">var</span> b = a.splice(<span class="number">0</span>,<span class="number">1</span>); <span class="comment">//同shift   </span></span><br><span class="line">a.splice(<span class="number">0</span>,<span class="number">0</span>,<span class="number">-2</span>,<span class="number">-1</span>); <span class="keyword">var</span> b = a.length; <span class="comment">//同unshift   </span></span><br><span class="line"><span class="keyword">var</span> b = a.splice(a.length<span class="number">-1</span>,<span class="number">1</span>); <span class="comment">//同pop   </span></span><br><span class="line">a.splice(a.length,<span class="number">0</span>,<span class="number">6</span>,<span class="number">7</span>); <span class="keyword">var</span> b = a.length; <span class="comment">//同push  </span></span><br><span class="line"><span class="comment">// reverse:将数组反序 </span></span><br><span class="line"><span class="keyword">var</span> a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>];   </span><br><span class="line"><span class="keyword">var</span> b = a.reverse(); <span class="comment">//a:[5,4,3,2,1] b:[5,4,3,2,1]  </span></span><br><span class="line"><span class="comment">// sort(orderfunction):按指定的参数对数组进行排序 </span></span><br><span class="line"><span class="keyword">var</span> a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>];   </span><br><span class="line"><span class="keyword">var</span> b = a.sort(); <span class="comment">//a:[1,2,3,4,5] b:[1,2,3,4,5]  </span></span><br><span class="line"><span class="comment">// slice(start,end):返回从原数组中指定开始下标到结束下标之间的项组成的新数组 </span></span><br><span class="line"><span class="keyword">var</span> a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>];   </span><br><span class="line"><span class="keyword">var</span> b = a.slice(<span class="number">2</span>,<span class="number">5</span>); <span class="comment">//a:[1,2,3,4,5] b:[3,4,5]  </span></span><br><span class="line"><span class="comment">// join(separator):将数组的元素组起一个字符串，以separator为分隔符，省略的话则用默认用逗号为分隔符 </span></span><br><span class="line"><span class="keyword">var</span> a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>];   </span><br><span class="line"><span class="keyword">var</span> b = a.join(<span class="string">"|"</span>); <span class="comment">//a:[1,2,3,4,5] b:"1|2|3|4|5"</span></span><br></pre></td></tr></table></figure></p>
<h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h3><p>本节作业：<br>本节要求掌握js中数组的使用，在作业中完成通过数组动态管理node对象<br>作业代码实现如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> allnpc=<span class="keyword">new</span> <span class="built_in">Array</span>();<span class="comment">//定义数组</span></span><br><span class="line"><span class="keyword">var</span> HelloWorldLayer = cc.Layer.extend(&#123;</span><br><span class="line">    sprite:<span class="literal">null</span>,</span><br><span class="line">    ctor:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">//////////////////////////////</span></span><br><span class="line">        <span class="comment">// 1. super init first</span></span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> item01=<span class="keyword">new</span> cc.MenuItemFont(<span class="string">"添加元素"</span>,<span class="keyword">this</span>.callback,<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">var</span> item02=<span class="keyword">new</span> cc.MenuItemFont(<span class="string">"删除元素"</span>,<span class="keyword">this</span>.callback,<span class="keyword">this</span>);</span><br><span class="line">        item01.setPositionY(<span class="number">200</span>);</span><br><span class="line">        item02.setPositionY(<span class="number">160</span>);</span><br><span class="line">        item01.setTag(<span class="number">11</span>);</span><br><span class="line">        item02.setTag(<span class="number">12</span>);</span><br><span class="line">        <span class="keyword">var</span> menu=<span class="keyword">new</span> cc.Menu(item01,item02);</span><br><span class="line">        <span class="keyword">this</span>.addChild(menu);</span><br><span class="line">        <span class="comment">//         本章介绍了数组的使用</span></span><br><span class="line">        <span class="comment">// 通过数组可以动态管理一组对象</span></span><br><span class="line">        <span class="comment">// 作业要求</span></span><br><span class="line">        <span class="comment">//   将这5个按钮对应于添加一个Node后将node显示</span></span><br><span class="line">        <span class="comment">//      这是第N个节点</span></span><br><span class="line">        <span class="comment">// 当删除某个Node后，将这个Node从屏幕移除     </span></span><br><span class="line">        <span class="keyword">var</span> count = <span class="keyword">new</span> cc.LabelTTF(<span class="string">"数组共0个Node"</span>,<span class="string">""</span>,<span class="number">30</span>);</span><br><span class="line">        count.setPosition(menu.getPositionX(),menu.getPositionY()+<span class="number">20</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(count);</span><br><span class="line">        count.setTag(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    callback:<span class="function"><span class="keyword">function</span>(<span class="params">obj</span>)</span><br><span class="line">    </span>&#123;  </span><br><span class="line">        <span class="keyword">var</span> newobj=<span class="keyword">new</span> cc.Sprite(<span class="string">"res/logo.png"</span>);</span><br><span class="line">        newobj.setPosition(<span class="built_in">Math</span>.random()*cc.winSize.width,<span class="built_in">Math</span>.random()*cc.winSize.height);</span><br><span class="line">        newobj.tag=allnpc.length+<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">switch</span>(obj.getTag())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">                allnpc.push(newobj);</span><br><span class="line">                <span class="keyword">this</span>.addChild(newobj);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">12</span>:</span><br><span class="line">                <span class="keyword">var</span> oldobj = allnpc.pop();</span><br><span class="line">                <span class="keyword">this</span>.removeChild(oldobj);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.getChildByTag(<span class="number">3</span>).setString(<span class="string">"数组共"</span>+allnpc.length+<span class="string">"个Node"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> HelloWorldScene = cc.Scene.extend(&#123;</span><br><span class="line">    onEnter:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> layer = <span class="keyword">new</span> HelloWorldLayer();</span><br><span class="line">        <span class="keyword">this</span>.addChild(layer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h3 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h3><p><a href="http://www.cocoscvp.com/usercode/2016_05_20/694a9a04efbc2d25a7a879cf2ac399a0e7ec46a2/" target="_blank" rel="external">http://www.cocoscvp.com/usercode/2016_05_20/694a9a04efbc2d25a7a879cf2ac399a0e7ec46a2/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;概念&quot;&gt;&lt;a href=&quot;#概念&quot; class=&quot;headerlink&quot; title=&quot;概念&quot;&gt;&lt;/a&gt;概念&lt;/h3&gt;&lt;p&gt;本节讲解cocos2d-js中数组的使用，其实数组不是cocos特有的，这是js中的一种数据结构，与Java，C中的数组稍有不同，js中的数组能存储任意类型的元素，并且在声明时无需指定长度，与Java中的List的用法更相似。
    
    </summary>
    
      <category term="cocos2d-js" scheme="http://hjcenry.github.io/categories/cocos2d-js/"/>
    
    
      <category term="cocos2d-js" scheme="http://hjcenry.github.io/tags/cocos2d-js/"/>
    
      <category term="cvp" scheme="http://hjcenry.github.io/tags/cvp/"/>
    
  </entry>
  
  <entry>
    <title>Cocos2d-JS实现的贪吃蛇</title>
    <link href="http://hjcenry.github.io/2016/05/16/Cocos2d-JS%E5%AE%9E%E7%8E%B0%E7%9A%84%E8%B4%AA%E5%90%83%E8%9B%87/"/>
    <id>http://hjcenry.github.io/2016/05/16/Cocos2d-JS实现的贪吃蛇/</id>
    <published>2016-05-16T07:38:00.000Z</published>
    <updated>2016-08-03T13:14:14.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>相信贪吃蛇大家都玩儿过，我对贪吃蛇的印象就是在电子词典上，一只像素蛇在屏幕游走，饥渴难耐，看着豆子就要去吃，吃到豆子就会长一节，当蛇的身体越来越长的时候，它才发现这个世界变了，每走一步，都是寸步难行。<a id="more"></a>当它的蛇头触碰到任意的物体，无论是屏幕边界还是自己的身体，游戏都将结束。这款游戏应该是比较经典的一个童年记忆。刚接触游戏开发的人可能比较喜欢以这款游戏入手，因为贪吃蛇包含了很多游戏开发中的原理，并且难度也不大，而我刚好在学习Cocos CVP的课程，学习在一个中间阶段，我也来拿这个练练手，以下就把我做贪吃蛇的过程分享出来。</p>
<h3 id="游戏分析"><a href="#游戏分析" class="headerlink" title="游戏分析"></a>游戏分析</h3><h4 id="身体关节"><a href="#身体关节" class="headerlink" title="身体关节"></a>身体关节</h4><p>贪吃蛇的实现可能有多种方法，但今天，我想用面向对象的思想来对游戏进行设计，到今天，任何的程序开发都离不开面向对象的思想，通过面向对象的思想我们能把很多抽象的问题具象化，方便我们解决很多问题。而在贪吃蛇中，面向对象的思想依然实用。<br>在贪吃蛇中，我们可以把一条游走的蛇的每个关节当做是一个对象，而蛇本身是由多个关节组成的整体，当每个关节在移动时，我们就能看到整个蛇的移动，每个关节的位置以及移动方向都跟它的上一个关节息息相关，那么我们就可以把关节与它的上一个关节关联起来，实现如下结构：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/snake1.png" alt="蛇关节关系图"></p>
<h4 id="移动方向"><a href="#移动方向" class="headerlink" title="移动方向"></a>移动方向</h4><p>如上文所说，按照上面的关节关系来实现，那么蛇的移动方向就是与父节点的移动方向相关联，每一个关节应该有一个当前移动方向和下次移动方向，每一步的移动，都是跟着当前移动方向走的，而父关节的当前移动的方向即为子关节的下次移动方向，这样，只需要调整蛇头关节的下次移动方向，整条蛇就能顺着各自的父关节方向移动，蛇的移动方向图如下：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/snakemove.png" alt="蛇的移动方向图"></p>
<h3 id="开发设计"><a href="#开发设计" class="headerlink" title="开发设计"></a>开发设计</h3><h4 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h4><p>按照前面的设计，我们可以大致可以划分出游戏场景类和关节类，进入游戏场景类，再将一些全局的变量单独存在一个类中，项目结构可划分如下图：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/snake%E7%BB%93%E6%9E%84%E5%9B%BE.png" alt="项目结构图"></p>
<h4 id="全局变量类"><a href="#全局变量类" class="headerlink" title="全局变量类"></a>全局变量类</h4><p>游戏中的全局变量，提炼为一个全局变量类，其中参数可以根据需求灵活变动配置<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Constants = &#123;</span><br><span class="line">    frequency: <span class="number">0.2</span>,<span class="comment">// 刷新频率</span></span><br><span class="line">    speed: <span class="number">31</span>,<span class="comment">// 每帧移动距离,身体节点大小+1像素间隔</span></span><br><span class="line">    errDistance: <span class="number">10</span>,<span class="comment">// 偏差举例</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="关节类"><a href="#关节类" class="headerlink" title="关节类"></a>关节类</h4><p>按照以上设计的结构，每一个关节对象都应该包含蛇的当前方向、下次方向和蛇的父节点三个属性，代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> SnakeBody = cc.Sprite.extend(&#123;</span><br><span class="line">    frontBody: <span class="literal">null</span>,<span class="comment">//上一个身体关节,没有则为头部</span></span><br><span class="line">    nextDirection: <span class="number">0</span>,<span class="comment">// 1-上,2-下,3-左,4-右</span></span><br><span class="line">    direction: <span class="number">0</span>,<span class="comment">// 1-上,2-下,3-左,4-右</span></span><br><span class="line">    ctor: <span class="function"><span class="keyword">function</span> (<span class="params">frontBody, direction</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">this</span>.frontBody = frontBody;</span><br><span class="line">        <span class="keyword">this</span>.direction = direction;</span><br><span class="line">        <span class="keyword">this</span>.nextDirection = direction;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面说的，关节的位置跟它的福关节的位置是息息相关的，那么初始化的时候，我们就需要根据父关节的移动方向来进行次关节的位置设置，这部分代码，我们可以放在onEnter方法中，代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">onEnter: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>._super();</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.frontBody == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 蛇头部关节,设置头部纹理</span></span><br><span class="line">      <span class="keyword">switch</span> (<span class="keyword">this</span>.direction) &#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">              <span class="keyword">this</span>.setTexture(res.head_up);</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">              <span class="keyword">this</span>.setTexture(res.head_down);</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">              <span class="keyword">this</span>.setTexture(res.head_left);</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">              <span class="keyword">this</span>.setTexture(res.head_right);</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 蛇身体关节</span></span><br><span class="line">      <span class="comment">// 设置纹理</span></span><br><span class="line">      <span class="keyword">this</span>.setTexture(res.body);</span><br><span class="line">      <span class="comment">// 设置关节位置</span></span><br><span class="line">      <span class="keyword">var</span> frontX = <span class="keyword">this</span>.frontBody.getPositionX();</span><br><span class="line">      <span class="keyword">var</span> frontY = <span class="keyword">this</span>.frontBody.getPositionY();</span><br><span class="line">      <span class="keyword">var</span> frontWidth = <span class="keyword">this</span>.frontBody.width;</span><br><span class="line">      <span class="keyword">var</span> frontHeight = <span class="keyword">this</span>.frontBody.height;</span><br><span class="line">      <span class="keyword">var</span> width = <span class="keyword">this</span>.width;</span><br><span class="line">      <span class="keyword">var</span> height = <span class="keyword">this</span>.height;</span><br><span class="line">      <span class="keyword">switch</span> (<span class="keyword">this</span>.frontBody.direction) &#123;</span><br><span class="line">          <span class="comment">// 根据父关节的当前移动方向,决定此关节的位置</span></span><br><span class="line">          <span class="keyword">case</span> <span class="number">1</span>:<span class="comment">// 上</span></span><br><span class="line">              <span class="keyword">this</span>.setPosition(frontX, frontY - frontHeight / <span class="number">2</span> - height / <span class="number">2</span> - <span class="number">1</span>);</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">2</span>:<span class="comment">// 下</span></span><br><span class="line">              <span class="keyword">this</span>.setPosition(frontX, frontY + frontHeight / <span class="number">2</span> + height / <span class="number">2</span> + <span class="number">1</span>);</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">3</span>:<span class="comment">// 左</span></span><br><span class="line">              <span class="keyword">this</span>.setPosition(frontX + frontWidth / <span class="number">2</span> + width / <span class="number">2</span> + <span class="number">1</span>, frontY);</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">4</span>:<span class="comment">// 右</span></span><br><span class="line">              <span class="keyword">this</span>.setPosition(frontX - frontWidth / <span class="number">2</span> - width / <span class="number">2</span> - <span class="number">1</span>, frontY);</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>有了这三个属性，每一个节点还应该有最重要的游戏逻辑——move方法，每一个关节分别调用move方法，从游戏场景中就能看到整条蛇按照预定方向进行移动，而整条蛇的运动方向就是跟着头部关节的方向走，头部关节的方向则通过点击屏幕区域控制。<br>在move方法中，我们需要做以下事情：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.按照关节的下次移动方向移动本身长度的像素的距离</span><br><span class="line">2.如果是头部关节，需要改变关节纹理</span><br></pre></td></tr></table></figure></p>
<p>同时，如果是头部关节，我们还需要判断以下三个临界条件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.头部关节是否触碰到屏幕边界</span><br><span class="line">2.头部关节是否吃到屏幕中的豆子</span><br><span class="line">3.头部关节是否触碰到自身关节</span><br></pre></td></tr></table></figure></p>
<p>其中1、3条件达成，则判定游戏结束，2条件达成，则能增加游戏分数，并且游戏继续。<br>move方法代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 关节移动方法</span></span><br><span class="line">move: <span class="function"><span class="keyword">function</span> (<span class="params">layer</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> star = layer.star;</span><br><span class="line">    <span class="keyword">var</span> direct;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.frontBody == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 头部关节按照自身的下次方向行走</span></span><br><span class="line">        direct = <span class="keyword">this</span>.nextDirection;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 身体关节按照父关节的当前方向行走,并将福关节的当前方向设置为自身的下次方向</span></span><br><span class="line">        <span class="keyword">this</span>.nextDirection = direct = <span class="keyword">this</span>.frontBody.direction;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> (direct) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:<span class="comment">// 上</span></span><br><span class="line">            <span class="keyword">this</span>.setPosition(<span class="keyword">this</span>.getPositionX(), <span class="keyword">this</span>.getPositionY() + Constants.speed);</span><br><span class="line">            <span class="comment">// this.runAction(cc.moveBy(Constants.frequency, cc.p(0, Constants.speed), 0))</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:<span class="comment">// 下</span></span><br><span class="line">            <span class="keyword">this</span>.setPosition(<span class="keyword">this</span>.getPositionX(), <span class="keyword">this</span>.getPositionY() - Constants.speed);</span><br><span class="line">            <span class="comment">// this.runAction(cc.moveBy(Constants.frequency, cc.p(0, -Constants.speed), 0))</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:<span class="comment">// 左</span></span><br><span class="line">            <span class="keyword">this</span>.setPosition(<span class="keyword">this</span>.getPositionX() - Constants.speed, <span class="keyword">this</span>.getPositionY());</span><br><span class="line">            <span class="comment">// this.runAction(cc.moveBy(Constants.frequency, cc.p(-Constants.speed, 0), 0))</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:<span class="comment">// 右</span></span><br><span class="line">            <span class="keyword">this</span>.setPosition(<span class="keyword">this</span>.getPositionX() + Constants.speed, <span class="keyword">this</span>.getPositionY());</span><br><span class="line">            <span class="comment">// this.runAction(cc.moveBy(Constants.frequency, cc.p(Constants.speed, 0), 0))</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.frontBody == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="keyword">this</span>.nextDirection) &#123;</span><br><span class="line">            <span class="comment">// 头部关节需要设置头部不同方向的纹理</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:<span class="comment">// 上</span></span><br><span class="line">                <span class="keyword">this</span>.setTexture(res.head_up);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:<span class="comment">// 下</span></span><br><span class="line">                <span class="keyword">this</span>.setTexture(res.head_down);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:<span class="comment">// 左</span></span><br><span class="line">                <span class="keyword">this</span>.setTexture(res.head_left);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:<span class="comment">// 右</span></span><br><span class="line">                <span class="keyword">this</span>.setTexture(res.head_right);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 头部关节判断是否触碰到边界</span></span><br><span class="line">        <span class="keyword">var</span> size = cc.winSize;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">this</span>.getPositionX() &gt; size.width - <span class="keyword">this</span>.width / <span class="number">2</span>)</span><br><span class="line">            || (<span class="keyword">this</span>.getPositionX() &lt; <span class="keyword">this</span>.width / <span class="number">2</span>)</span><br><span class="line">            || (<span class="keyword">this</span>.getPositionY() &gt; size.height - <span class="keyword">this</span>.height / <span class="number">2</span>)</span><br><span class="line">            || (<span class="keyword">this</span>.getPositionY() &lt; <span class="keyword">this</span>.height / <span class="number">2</span>)) &#123;</span><br><span class="line">            <span class="comment">// 判断触碰边界</span></span><br><span class="line">            cc.log(<span class="string">"game over"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 判断是否触碰到自己身体关节</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> index <span class="keyword">in</span> layer.bodys) &#123;</span><br><span class="line">            <span class="keyword">if</span> (layer.bodys[index] != <span class="keyword">this</span> &amp;&amp; cc.rectIntersectsRect(<span class="keyword">this</span>.getBoundingBox(), layer.bodys[index].getBoundingBox())) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 判断是否吃到星星</span></span><br><span class="line">        <span class="keyword">if</span> (star != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cc.rectIntersectsRect(<span class="keyword">this</span>.getBoundingBox(), star.getBoundingBox())) &#123;</span><br><span class="line">                star.runAction(</span><br><span class="line">                    cc.sequence(cc.spawn(</span><br><span class="line">                        cc.scaleTo(<span class="number">0.2</span>, <span class="number">3</span>),</span><br><span class="line">                        cc.fadeOut(<span class="number">0.2</span>)</span><br><span class="line">                    ), cc.callFunc(<span class="function"><span class="keyword">function</span> (<span class="params">star</span>) </span>&#123;</span><br><span class="line">                        star.removeFromParent();</span><br><span class="line">                    &#125;, star))</span><br><span class="line">                );</span><br><span class="line">                <span class="comment">// 清除星星</span></span><br><span class="line">                layer.star = <span class="literal">null</span>;</span><br><span class="line">                <span class="comment">// 添加身体</span></span><br><span class="line">                layer.canNewBody = <span class="number">1</span>;</span><br><span class="line">                <span class="comment">// 改变分数</span></span><br><span class="line">                layer.score.setString(<span class="string">""</span> + (<span class="built_in">Number</span>(layer.score.getString()) + <span class="built_in">Math</span>.round(<span class="built_in">Math</span>.random() * <span class="number">3</span> + <span class="number">1</span>)));</span><br><span class="line">                layer.score.runAction(cc.sequence(cc.scaleTo(<span class="number">0.1</span>, <span class="number">2</span>), cc.scaleTo(<span class="number">0.1</span>, <span class="number">0.5</span>), cc.scaleTo(<span class="number">0.1</span>, <span class="number">1</span>)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="游戏场景类"><a href="#游戏场景类" class="headerlink" title="游戏场景类"></a>游戏场景类</h4><p>在游戏场景中我们需要以下几个变量：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. 贪吃蛇数组：用于存储贪吃蛇所有的关节节点</span><br><span class="line">2. 贪吃蛇尾部：每添加一个关节节点 ，都将此变量指向这个新加的节点，以便下次继续再尾部节点添加</span><br><span class="line">3. 吃的星星：屏幕中随机产生的星星，用于判断头部关节是否与它产生碰撞</span><br><span class="line">4. 是否添加节点：如果在定时任务中判断到吃到星星，那么可以次变量为1，代表可以添加一个节点</span><br><span class="line">5. 分数：存储游戏中累加的分数</span><br></pre></td></tr></table></figure></p>
<p>在cc.Layer的构造函数中对以上变量进行初始化，代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> GameLayer = cc.Layer.extend(&#123;</span><br><span class="line">  bodys: [],<span class="comment">// snake body</span></span><br><span class="line">  tail: <span class="literal">null</span>,<span class="comment">// snake tail</span></span><br><span class="line">  star: <span class="literal">null</span>,<span class="comment">// star</span></span><br><span class="line">  canNewBody: <span class="number">0</span>,<span class="comment">// 0-无,1-有</span></span><br><span class="line">  score: <span class="literal">null</span>,<span class="comment">// 分数Label</span></span><br><span class="line">  ctor: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 初始化全局参数</span></span><br><span class="line">      <span class="keyword">this</span>._super();</span><br><span class="line">      <span class="keyword">this</span>.bodys = [];</span><br><span class="line">      <span class="keyword">this</span>.canNewBody = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">this</span>.star = <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">this</span>.tail = <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">this</span>.score = <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>之后，我们首先需要在场景中绘制出一条蛇，初始化定义为1个头部关节，5个身体关节，由于我们对关节类做了很好的封装，所以初始化一条蛇的代码很简单，我们在onEnter方法中进行初始化，如下所示：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化一条蛇</span></span><br><span class="line"><span class="comment">// 初始化头部</span></span><br><span class="line"><span class="keyword">var</span> head = <span class="keyword">new</span> SnakeBody(<span class="literal">null</span>, <span class="number">4</span>);</span><br><span class="line">head.setPosition(<span class="number">300</span>, <span class="number">300</span>);</span><br><span class="line"><span class="keyword">this</span>.addChild(head);</span><br><span class="line"><span class="keyword">this</span>.bodys.push(head);</span><br><span class="line">head.setTag(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">this</span>.tail = head;</span><br><span class="line"><span class="comment">// 循环添加5个身体</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> node = <span class="keyword">new</span> SnakeBody(<span class="keyword">this</span>.tail, <span class="keyword">this</span>.tail.direction);</span><br><span class="line">    <span class="keyword">this</span>.addChild(node);</span><br><span class="line">    <span class="keyword">this</span>.bodys.push(node);</span><br><span class="line">    <span class="keyword">this</span>.tail = node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>初始化完了之后蛇是不会动的，如何让它动起来呢，我们就要用到在关节类中封装的move方法了，我们每隔一个时间，对所有的关节类执行一次move方法，就能实现蛇的移动，首先在onEnter中添加定时任务：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 蛇移动的定时任务</span></span><br><span class="line"><span class="keyword">this</span>.schedule(<span class="keyword">this</span>.snakeMove, Constants.frequency);</span><br></pre></td></tr></table></figure></p>
<p>在这个snakeMove定时调用的方法中，我们要写出所有关节移动的逻辑，在这个方法中，我们需要完成以下几件事：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. 遍历蛇的所有关节，每个关节执行一遍move方法，并在move完了之后，将下次移动方法变为本次移动方向</span><br><span class="line">2. 如果需要新增关节，在遍历完成之后，新增一个关节类，并将其父节点指向之前的蛇尾节点，并把蛇尾指向新加的这个关节</span><br></pre></td></tr></table></figure></p>
<p>代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 蛇关节移动方法</span></span><br><span class="line">snakeMove: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> index <span class="keyword">in</span> <span class="keyword">this</span>.bodys) &#123;</span><br><span class="line">        <span class="comment">// 循环执行移动方法,并返回移动结果,false即视为游戏结束</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.bodys[index].move(<span class="keyword">this</span>)) &#123;</span><br><span class="line">            <span class="comment">// 执行移动方法,移动失败,游戏结束</span></span><br><span class="line">            <span class="keyword">this</span>.unschedule(<span class="keyword">this</span>.snakeMove);</span><br><span class="line">            <span class="keyword">this</span>.unschedule(<span class="keyword">this</span>.updateStar);</span><br><span class="line">            <span class="keyword">var</span> overScene = <span class="keyword">new</span> OverScene(<span class="built_in">Number</span>(<span class="keyword">this</span>.score.getString()), <span class="literal">false</span>);</span><br><span class="line">            cc.director.runScene(<span class="keyword">new</span> cc.TransitionFade(<span class="number">1</span>, overScene));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> index <span class="keyword">in</span> <span class="keyword">this</span>.bodys) &#123;</span><br><span class="line">        <span class="comment">// 本轮所有关节移动结束,所有节点的当前方向赋值为下一次的方向</span></span><br><span class="line">        <span class="keyword">this</span>.bodys[index].direction = <span class="keyword">this</span>.bodys[index].nextDirection;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.canNewBody == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果新增关节为1,增加关节</span></span><br><span class="line">        <span class="keyword">var</span> node = <span class="keyword">new</span> SnakeBody(<span class="keyword">this</span>.tail, <span class="keyword">this</span>.tail.direction);</span><br><span class="line">        <span class="keyword">this</span>.addChild(node);</span><br><span class="line">        <span class="keyword">this</span>.bodys.push(node);</span><br><span class="line">        <span class="keyword">this</span>.tail = node;</span><br><span class="line">        <span class="keyword">this</span>.canNewBody = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>目前为止这条蛇是只会按照我们初始化的方向一直走到碰壁，然后游戏结束的，如何改变蛇的运动轨迹呢？前面说到了，蛇头部节点的下次移动方向的改变，即可对整个蛇的移动轨迹进行改变，这里我们可以通过点击屏幕实现蛇头的下次移动方向的改变。<br>首先在onEnter方法中添加触摸事件监听：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加屏幕触摸事件</span></span><br><span class="line">cc.eventManager.addListener(&#123;</span><br><span class="line">    event: cc.EventListener.TOUCH_ONE_BY_ONE,</span><br><span class="line">    swallowTouches: <span class="literal">true</span>,</span><br><span class="line">    onTouchBegan: <span class="keyword">this</span>.touchbegan,</span><br><span class="line">    onTouchMoved: <span class="keyword">this</span>.touchmoved,</span><br><span class="line">    onTouchEnded: <span class="keyword">this</span>.touchended</span><br><span class="line">&#125;, <span class="keyword">this</span>);</span><br></pre></td></tr></table></figure></p>
<p>然后在onTouchBegan方法中实现点击事件，我们可以允许点击有一个10像素的误差：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 点击转向</span></span><br><span class="line">touchbegan: <span class="function"><span class="keyword">function</span> (<span class="params">touch, event</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> x = touch.getLocation().x;</span><br><span class="line">    <span class="keyword">var</span> y = touch.getLocation().y;</span><br><span class="line">    <span class="keyword">var</span> head = event.getCurrentTarget().getChildByTag(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">var</span> headX = head.getPositionX();</span><br><span class="line">    <span class="keyword">var</span> headY = head.getPositionY();</span><br><span class="line">    <span class="keyword">switch</span> (head.direction) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:<span class="comment">// 上</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:<span class="comment">// 下</span></span><br><span class="line">            <span class="keyword">if</span> (x &lt;= headX - Constants.errDistance) &#123;<span class="comment">// 转左</span></span><br><span class="line">                head.nextDirection = <span class="number">3</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x &gt;= headX + Constants.errDistance) &#123;<span class="comment">// 转右</span></span><br><span class="line">                head.nextDirection = <span class="number">4</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:<span class="comment">// 左</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:<span class="comment">// 右</span></span><br><span class="line">            <span class="keyword">if</span> (y &lt;= headY - Constants.errDistance) &#123;<span class="comment">// 转下</span></span><br><span class="line">                head.nextDirection = <span class="number">2</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (y &gt;= headY + Constants.errDistance) &#123;<span class="comment">// 转上</span></span><br><span class="line">                head.nextDirection = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后我们只差最后一步，就是蛇要吃的星星，我们可以在屏幕中任意位置随机产生一颗星星（又或者叫豆子，这都无所谓），只要这个星星满足以下条件，那么它就可以被绘制出来，否则我们需要重新随机这个星星的位置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. 星星在游戏场景的屏幕范围内</span><br><span class="line">2. 星星不能与蛇的身体部分重叠</span><br></pre></td></tr></table></figure></p>
<p>代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新星星</span></span><br><span class="line">updateStar: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.star == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.star = <span class="keyword">new</span> cc.Sprite(res.bean);</span><br><span class="line">        <span class="keyword">var</span> randomX = <span class="built_in">Math</span>.random() * (cc.winSize.width - <span class="keyword">this</span>.star.width) + <span class="keyword">this</span>.star.width;</span><br><span class="line">        <span class="keyword">var</span> randomY = <span class="built_in">Math</span>.random() * (cc.winSize.height - <span class="keyword">this</span>.star.width) + <span class="keyword">this</span>.star.height;</span><br><span class="line">        <span class="keyword">this</span>.star.setPosition(randomX, randomY);</span><br><span class="line">        <span class="keyword">this</span>.addChild(<span class="keyword">this</span>.star);</span><br><span class="line">        <span class="comment">// 产生的星星只要在屏幕外,或与蛇的身体部分重叠,则本次任务不产生</span></span><br><span class="line">        <span class="keyword">if</span> ((randomX &gt; cc.winSize.width - <span class="keyword">this</span>.star.width / <span class="number">2</span>)</span><br><span class="line">            || (randomX &lt; <span class="keyword">this</span>.star.width / <span class="number">2</span>)</span><br><span class="line">            || (randomY &gt; cc.winSize.height - <span class="keyword">this</span>.star.height / <span class="number">2</span>)</span><br><span class="line">            || (randomY &lt; <span class="keyword">this</span>.star.height / <span class="number">2</span>)) &#123;</span><br><span class="line">            cc.log(<span class="string">"update star:out of screen"</span>);</span><br><span class="line">            <span class="keyword">this</span>.removeChild(<span class="keyword">this</span>.star);</span><br><span class="line">            <span class="keyword">this</span>.star = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> index <span class="keyword">in</span> <span class="keyword">this</span>.bodys) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cc.rectIntersectsRect(<span class="keyword">this</span>.bodys[index].getBoundingBox(), <span class="keyword">this</span>.star.getBoundingBox())) &#123;</span><br><span class="line">                cc.log(<span class="string">"update star:intersect with self"</span>);</span><br><span class="line">                <span class="keyword">this</span>.removeChild(<span class="keyword">this</span>.star);</span><br><span class="line">                <span class="keyword">this</span>.star = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>至此，游戏的主要逻辑就大功告成了！贪吃蛇不仅能在屏幕中游走，还能吃星星，并且碰到自身或边缘都会GameOver！</p>
<h4 id="开始-结束场景类"><a href="#开始-结束场景类" class="headerlink" title="开始/结束场景类"></a>开始/结束场景类</h4><p>说到GameOver，那么就必须要有一个Over的场景类了，毕竟有了开始场景，游戏场景和结束场景，才算得上一个完成的游戏流程嘛，结束场景类的实现很简单，只需要把游戏场景中获得的分数传递进来，然后在Label中展示即可，代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> OverLayer = cc.Layer.extend(&#123;</span><br><span class="line">    sprite: <span class="literal">null</span>,</span><br><span class="line">    score: <span class="number">0</span>,</span><br><span class="line">    ctor: <span class="function"><span class="keyword">function</span> (<span class="params">score</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">this</span>.score = score;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    onEnter: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> size = cc.winSize;</span><br><span class="line">        <span class="keyword">var</span> over = <span class="keyword">new</span> cc.LabelTTF(<span class="string">"Game Over,你的分数是:"</span> + <span class="keyword">this</span>.score, <span class="string">"Arial"</span>, <span class="number">38</span>);</span><br><span class="line">        over.setPosition(size.width / <span class="number">2</span>, size.height / <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(over);</span><br><span class="line">        over.runAction(cc.sequence(cc.scaleTo(<span class="number">0.2</span>, <span class="number">2</span>), cc.scaleTo(<span class="number">0.2</span>, <span class="number">0.5</span>), cc.scaleTo(<span class="number">0.2</span>, <span class="number">1</span>)));</span><br><span class="line">        <span class="keyword">var</span> start = <span class="keyword">new</span> cc.MenuItemFont(<span class="string">"再来一次"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            cc.director.runScene(<span class="keyword">new</span> cc.TransitionFade(<span class="number">1</span>, <span class="keyword">new</span> HelloWorldScene()));</span><br><span class="line">        &#125;, <span class="keyword">this</span>);</span><br><span class="line">        start.setPosition(over.getPositionX(), over.getPositionY() - over.height / <span class="number">2</span> - <span class="number">50</span>);</span><br><span class="line">        <span class="keyword">var</span> menu = <span class="keyword">new</span> cc.Menu(start);</span><br><span class="line">        <span class="keyword">this</span>.addChild(menu);</span><br><span class="line">        menu.setPosition(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> OverScene = cc.Scene.extend(&#123;</span><br><span class="line">    score: <span class="number">0</span>,</span><br><span class="line">    ctor: <span class="function"><span class="keyword">function</span> (<span class="params">score</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">this</span>.score = score;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    onEnter: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> layer = <span class="keyword">new</span> OverLayer(<span class="keyword">this</span>.score);</span><br><span class="line">        <span class="keyword">this</span>.addChild(layer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>与结束场景一样，开始场景也只需一个Label一个Menu即可，代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> HelloWorldLayer = cc.Layer.extend(&#123;</span><br><span class="line">    sprite: <span class="literal">null</span>,</span><br><span class="line">    ctor: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> size = cc.winSize;</span><br><span class="line">        <span class="keyword">var</span> helloLabel = <span class="keyword">new</span> cc.LabelTTF(<span class="string">"贪吃蛇"</span>, <span class="string">"Arial"</span>, <span class="number">38</span>);</span><br><span class="line">        helloLabel.x = size.width / <span class="number">2</span>;</span><br><span class="line">        helloLabel.y = size.height / <span class="number">2</span> + <span class="number">200</span>;</span><br><span class="line">        <span class="keyword">this</span>.addChild(helloLabel, <span class="number">5</span>);</span><br><span class="line">        <span class="keyword">var</span> start = <span class="keyword">new</span> cc.MenuItemFont(<span class="string">"开始游戏"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            cc.director.runScene(<span class="keyword">new</span> cc.TransitionFade(<span class="number">1</span>, <span class="keyword">new</span> GameScene()));</span><br><span class="line">        &#125;, <span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">var</span> menu = <span class="keyword">new</span> cc.Menu(start);</span><br><span class="line">        <span class="keyword">this</span>.addChild(menu);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> HelloWorldScene = cc.Scene.extend(&#123;</span><br><span class="line">    onEnter: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> layer = <span class="keyword">new</span> HelloWorldLayer();</span><br><span class="line">        <span class="keyword">this</span>.addChild(layer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>这样，我们就能形成一个完成游戏流程了，游戏加载进入游戏开始场景，点击开始游戏进行如主游戏场景，游戏结束后进入结束场景，结束场景点击“再来一次”又可以回到开始场景。</p>
<h3 id="运行效果"><a href="#运行效果" class="headerlink" title="运行效果"></a>运行效果</h3><p>最后的运行效果如下<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/snake.gif" alt="贪吃蛇效果图"><br>通过CVP平台的项目托管可看到实际运行效果，地址如下：<br><a href="http://www.cocoscvp.com/usercode/2e17b3cd9586a574140e0bb765bad21673fc7686/" target="_blank" rel="external">http://www.cocoscvp.com/usercode/2e17b3cd9586a574140e0bb765bad21673fc7686/</a></p>
<h3 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h3><p>所有源代码均上传到github，欢迎交流学习，地址：<br><a href="https://github.com/hjcenry/snake" target="_blank" rel="external">https://github.com/hjcenry/snake</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;相信贪吃蛇大家都玩儿过，我对贪吃蛇的印象就是在电子词典上，一只像素蛇在屏幕游走，饥渴难耐，看着豆子就要去吃，吃到豆子就会长一节，当蛇的身体越来越长的时候，它才发现这个世界变了，每走一步，都是寸步难行。
    
    </summary>
    
      <category term="cocos2d-js" scheme="http://hjcenry.github.io/categories/cocos2d-js/"/>
    
    
      <category term="cocos2d-js" scheme="http://hjcenry.github.io/tags/cocos2d-js/"/>
    
      <category term="贪吃蛇" scheme="http://hjcenry.github.io/tags/%E8%B4%AA%E5%90%83%E8%9B%87/"/>
    
  </entry>
  
  <entry>
    <title>CVP认证学习笔记--(何小成)骨骼动画的制作</title>
    <link href="http://hjcenry.github.io/2016/05/10/CVP%E8%AE%A4%E8%AF%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0--(%E4%BD%95%E5%B0%8F%E6%88%90)%E9%AA%A8%E9%AA%BC%E5%8A%A8%E7%94%BB%E7%9A%84%E5%88%B6%E4%BD%9C/"/>
    <id>http://hjcenry.github.io/2016/05/10/CVP认证学习笔记--(何小成)骨骼动画的制作/</id>
    <published>2016-05-10T14:44:00.000Z</published>
    <updated>2016-05-10T15:20:13.000Z</updated>
    
    <content type="html"><![CDATA[<p>本文主要复习下骨骼动画的制作过程，<a href="http://hjcenry.github.io/2016/05/06/CVP%E8%AE%A4%E8%AF%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0--(%E4%BD%95%E5%B0%8F%E6%88%90)023--%E5%8A%A0%E8%BD%BD%E9%AA%A8%E9%AA%BC%E5%8A%A8%E7%94%BB/">上一篇文章</a>简单介绍了cocos中对于骨骼动画的使用，本文主要从骨骼动画制作的角度来讲解。<a id="more"></a></p>
<h3 id="导入资源"><a href="#导入资源" class="headerlink" title="导入资源"></a>导入资源</h3><p>制作之前准备好所需要的图片资源，然后倒入到cocos studio中，如下图：<br><img src="http://cdn.cocimg.com/bbs/attachment/Fid_72/72_319828_1a202fb1ffd1025.png" alt="导入资源"></p>
<h3 id="添加皮肤"><a href="#添加皮肤" class="headerlink" title="添加皮肤"></a>添加皮肤</h3><p>资源中的皮肤一个一个拖放到场景中，使小图片大致能拼出来一个完整的图片，如下图：<br><img src="http://cdn.cocimg.com/bbs/attachment/Fid_72/72_319828_55529c9535d5bb4.png" alt="添加皮肤"></p>
<h3 id="添加骨骼"><a href="#添加骨骼" class="headerlink" title="添加骨骼"></a>添加骨骼</h3><p>根据人物的骨骼特征，为皮肤添加骨骼，如下图：<br><img src="http://cdn.cocimg.com/bbs/attachment/Fid_72/72_319828_3ad23acff07741b.png" alt="添加骨骼"></p>
<h3 id="绑定父关系"><a href="#绑定父关系" class="headerlink" title="绑定父关系"></a>绑定父关系</h3><p>把具有相互关系的骨骼绑定起来，使骨骼之间能够作为整体进行动画，如头部应该绑定身体为父关系，而手腕应该绑定手臂为父关系，如下图：<br><img src="http://cdn.cocimg.com/bbs/attachment/Fid_72/72_319828_a02834c9d8347ca.png" alt="绑定父关系"></p>
<h3 id="制作动画"><a href="#制作动画" class="headerlink" title="制作动画"></a>制作动画</h3><p>骨骼绑定之后，就可以编辑动画，动画编辑即选择选择动画模式，然后选择相应的图层，在下面时间轴上的关键帧上进行改变，中间的补间动画cocos studio会自动创建，如下图：<br><img src="http://cdn.cocimg.com/bbs/attachment/Fid_72/72_319828_40c0db20e072450.png" alt="制作动画"></p>
<h3 id="导出资源"><a href="#导出资源" class="headerlink" title="导出资源"></a>导出资源</h3><p>确定制作完成，并经过了精细的调整之后，就可以导出动画了，导出的操作很简单，即选择文件，然后选择导出项目，如下图：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/daochu.png" alt="导出资源"><br>导出之后可以看到相应的文件夹下有png，plist和json三个文件，即上一篇文章中说到的cocos中需要使用到的骨骼动画资源，至此，骨骼动画制作完成！ 整个过程感觉是一个挺细心的活，作为一个程序来说，做了一个骨骼动画之后，我真心佩服美术，那些游戏中无论活灵活现的主人公，还是酷炫吊炸天特效，都是美术们这样一帧一帧调出来的，真的是我心目中的艺术家，衷心的点个赞！</p>
<h3 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h3><p>制作完之后，我加在了上一节课的作业的开始界面和帮助界面中，如下图：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/1111.gif" alt="效果图"><br>作业地址：<a href="http://www.cocoscvp.com/usercode/b09ecc9894fe6ab8a1ba17f5d5348b9a215038a6/" target="_blank" rel="external">http://www.cocoscvp.com/usercode/b09ecc9894fe6ab8a1ba17f5d5348b9a215038a6/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文主要复习下骨骼动画的制作过程，&lt;a href=&quot;http://hjcenry.github.io/2016/05/06/CVP%E8%AE%A4%E8%AF%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0--(%E4%BD%95%E5%B0%8F%E6%88%90)023--%E5%8A%A0%E8%BD%BD%E9%AA%A8%E9%AA%BC%E5%8A%A8%E7%94%BB/&quot;&gt;上一篇文章&lt;/a&gt;简单介绍了cocos中对于骨骼动画的使用，本文主要从骨骼动画制作的角度来讲解。
    
    </summary>
    
      <category term="cocos2d-js" scheme="http://hjcenry.github.io/categories/cocos2d-js/"/>
    
    
      <category term="cocos2d-js" scheme="http://hjcenry.github.io/tags/cocos2d-js/"/>
    
      <category term="cvp" scheme="http://hjcenry.github.io/tags/cvp/"/>
    
  </entry>
  
  <entry>
    <title>CVP认证学习笔记--(何小成)025--音乐和音效</title>
    <link href="http://hjcenry.github.io/2016/05/07/CVP%E8%AE%A4%E8%AF%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0--(%E4%BD%95%E5%B0%8F%E6%88%90)025--%E9%9F%B3%E4%B9%90%E5%92%8C%E9%9F%B3%E6%95%88/"/>
    <id>http://hjcenry.github.io/2016/05/07/CVP认证学习笔记--(何小成)025--音乐和音效/</id>
    <published>2016-05-07T07:51:00.000Z</published>
    <updated>2016-05-29T02:34:50.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>本节课内容是cocos中音乐和音效的使用，游戏中经常会有游戏音乐和游戏音效，并且好的音乐音效也是一款游戏的一个卖点，在cocos中，对音乐和音效做了良好的封装，使用起来只需一两句代码就能实现，本节课介绍了cocos中音乐音效的开始暂停。<a id="more"></a></p>
<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><p>cocos中的音乐音效处理被封装在了audioEngine中，通过使用audioEngine就可以调用相应的音乐音效API，API文档地址是：<a href="http://www.cocos.com/doc/jsdoc/symbols/cc.audioEngine.html" target="_blank" rel="external">http://www.cocos.com/doc/jsdoc/symbols/cc.audioEngine.html</a><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 结束音乐和音效</span></span><br><span class="line">cc.audioEngine.end()</span><br><span class="line"><span class="comment">// 音效音量最大是1.0，最小是0.0</span></span><br><span class="line">cc.audioEngine.getEffectsVolume()</span><br><span class="line"><span class="comment">// 音乐的最大音量是1.0，最小音量是0.0  </span></span><br><span class="line">cc.audioEngine.getMusicVolume()</span><br><span class="line"><span class="comment">// 判断音乐是否在播放</span></span><br><span class="line">cc.audioEngine.isMusicPlaying()</span><br><span class="line"><span class="comment">// 暂停播放所有音效</span></span><br><span class="line">cc.audioEngine.pauseAllEffects()</span><br><span class="line"><span class="comment">// 暂停播放音效   </span></span><br><span class="line">cc.audioEngine.pauseEffect()</span><br><span class="line"><span class="comment">// 暂停播放音乐  </span></span><br><span class="line">cc.audioEngine.pauseMusic()</span><br><span class="line"><span class="comment">// 播放音效  </span></span><br><span class="line">cc.audioEngine.playEffect(url, loop)</span><br><span class="line"><span class="comment">// 播放音乐  </span></span><br><span class="line">cc.audioEngine.playMusic(url, loop)</span><br><span class="line"><span class="comment">// 重新播放所有音效 </span></span><br><span class="line">cc.audioEngine.resumeAllEffects()</span><br><span class="line"><span class="comment">// 重新播放音效  </span></span><br><span class="line">cc.audioEngine.resumeEffect()</span><br><span class="line"><span class="comment">// 重新播放音乐   </span></span><br><span class="line">cc.audioEngine.resumeMusic()</span><br><span class="line"><span class="comment">// 回放播放的音乐  </span></span><br><span class="line">cc.audioEngine.rewindMusic()</span><br><span class="line"><span class="comment">// 设置音效的音量    </span></span><br><span class="line">cc.audioEngine.setEffectsVolume(volume)</span><br><span class="line"><span class="comment">// 设置音乐的音量</span></span><br><span class="line">cc.audioEngine.setMusicVolume(volume)</span><br><span class="line"><span class="comment">// 停止播放所有音效  </span></span><br><span class="line">cc.audioEngine.stopAllEffects()</span><br><span class="line"><span class="comment">// 停止播放音效</span></span><br><span class="line">cc.audioEngine.stopEffect()</span><br><span class="line"><span class="comment">// 停止播放音乐 </span></span><br><span class="line">cc.audioEngine.stopMusic(releaseData)</span><br><span class="line"><span class="comment">// 从内部缓冲区释放预加载的音效   </span></span><br><span class="line">cc.audioEngine.unloadEffect(url)</span><br><span class="line"><span class="comment">// 标示背景音乐是否可以播放   </span></span><br><span class="line">cc.audioEngine.willPlayMusic()</span><br></pre></td></tr></table></figure></p>
<h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h3><p>本节作业：<br>本节课作业要求实现点击屏幕播放音效，我进行了扩展，综合前面所学，做了一个打飞机的小demo，由于不是一个完整demo，所有有很多bug也没去处理，其中也实现了游戏中的音乐音效播放。<br>作业代码实现如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> soundID=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> HelloWorldLayer = cc.Layer.extend(&#123;</span><br><span class="line">    sprite:<span class="literal">null</span>,</span><br><span class="line">    music:<span class="number">1</span>,<span class="comment">// 0停止，1播放</span></span><br><span class="line">    state:<span class="number">0</span>,<span class="comment">//0静止，1攻击</span></span><br><span class="line">    npcs:[],<span class="comment">// 敌机数组</span></span><br><span class="line">    bullets:[],<span class="comment">// 子弹数组</span></span><br><span class="line">    game:<span class="number">0</span>,<span class="comment">// 0进行中,1lose</span></span><br><span class="line">    score:<span class="literal">null</span>,<span class="comment">// 分数控件</span></span><br><span class="line">    ctor:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">//////////////////////////////</span></span><br><span class="line">        <span class="comment">// 1. super init first</span></span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> itemstartbg=<span class="keyword">new</span> cc.MenuItemFont(<span class="string">"🚫"</span>,<span class="keyword">this</span>.callback,<span class="keyword">this</span>);</span><br><span class="line">        itemstartbg.setTag(<span class="number">10</span>);</span><br><span class="line">        itemstartbg.setPositionY(cc.winSize.height-itemstartbg.height/<span class="number">2</span>);</span><br><span class="line">        itemstartbg.setPositionX(itemstartbg.width/<span class="number">2</span>+<span class="number">20</span>);</span><br><span class="line">        <span class="keyword">var</span> menu=<span class="keyword">new</span> cc.Menu(itemstartbg);</span><br><span class="line">        menu.setPosition(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(menu);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> plane = <span class="keyword">new</span> cc.Sprite(<span class="string">"res/HelloWorld.png"</span>);</span><br><span class="line">        plane.setPosition(cc.winSize.width/<span class="number">2</span>,<span class="number">80</span>);</span><br><span class="line">        plane.setScale(<span class="number">0.5</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(plane);</span><br><span class="line">        plane.setTag(<span class="number">1</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">this</span>.schedule(<span class="keyword">this</span>.createBullet,<span class="number">0.2</span>);</span><br><span class="line">        <span class="keyword">this</span>.schedule(<span class="keyword">this</span>.createNpc,<span class="number">0.5</span>);</span><br><span class="line">        <span class="keyword">this</span>.schedule(<span class="keyword">this</span>.collision);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    callback:<span class="function"><span class="keyword">function</span>(<span class="params">obj</span>)</span><br><span class="line">    </span>&#123;<span class="comment">// 背景音乐按钮</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.music==<span class="number">0</span>)&#123;</span><br><span class="line">            cc.log(<span class="string">"playMusic"</span>);</span><br><span class="line">            <span class="keyword">this</span>.music=<span class="number">1</span>;</span><br><span class="line">            cc.audioEngine.playMusic(<span class="string">"res/bg.mp3"</span>,<span class="literal">true</span>);<span class="comment">//循环播放</span></span><br><span class="line">            obj.setString(<span class="string">"🚫"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            cc.log(<span class="string">"stopMusic"</span>);</span><br><span class="line">            <span class="keyword">this</span>.music=<span class="number">0</span>;</span><br><span class="line">            cc.audioEngine.stopMusic();<span class="comment">//停止音乐</span></span><br><span class="line">            obj.setString(<span class="string">"🎵"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 游戏逻辑判断</span></span><br><span class="line">    collision:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.game==<span class="number">1</span>)&#123;</span><br><span class="line">            cc.audioEngine.stopMusic();</span><br><span class="line">            cc.director.runScene(<span class="keyword">new</span> OverScene());</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> j <span class="keyword">in</span> <span class="keyword">this</span>.npcs)&#123;</span><br><span class="line">            <span class="keyword">var</span> npc = <span class="keyword">this</span>.npcs[j];</span><br><span class="line">            <span class="comment">//  判断游戏是否结束</span></span><br><span class="line">            <span class="keyword">var</span> plane = <span class="keyword">this</span>.getChildByTag(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span>(cc.rectIntersectsRect(npc.getBoundingBox(),plane.getBoundingBox()))&#123;</span><br><span class="line">                cc.log(<span class="string">"over"</span>);</span><br><span class="line">                <span class="keyword">this</span>.game=<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i <span class="keyword">in</span> <span class="keyword">this</span>.bullets)&#123;</span><br><span class="line">                <span class="keyword">var</span> bullet = <span class="keyword">this</span>.bullets[i];</span><br><span class="line">                <span class="comment">// 判断是否击中敌机，通过rectIntersectsRect进行矩形碰撞判断</span></span><br><span class="line">                <span class="keyword">if</span>(cc.rectIntersectsRect(bullet.getBoundingBox(),npc.getBoundingBox()))&#123;</span><br><span class="line">                    cc.log(<span class="string">"crash"</span>);</span><br><span class="line">                    bullet.removeFromParent();</span><br><span class="line">                    <span class="keyword">this</span>.npcs.splice(j,<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">this</span>.bullets.splice(i,<span class="number">1</span>);</span><br><span class="line">                    npc.runAction(</span><br><span class="line">                        cc.sequence(</span><br><span class="line">                            cc.scaleTo(<span class="number">0.2</span>,<span class="number">0.5</span>),</span><br><span class="line">                            cc.spawn(</span><br><span class="line">                                cc.rotateBy(<span class="number">0.5</span>,<span class="number">720</span>),</span><br><span class="line">                                cc.scaleTo(<span class="number">0.5</span>,<span class="number">0</span>)</span><br><span class="line">                            ),</span><br><span class="line">                            cc.callFunc(<span class="function"><span class="keyword">function</span>(<span class="params">npc</span>)</span>&#123;</span><br><span class="line">                                npc.removeFromParent();</span><br><span class="line">                            &#125;,npc)</span><br><span class="line">                        )</span><br><span class="line">                    );</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    createNpc:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> plane = <span class="keyword">new</span> cc.Sprite(<span class="string">"res/HelloWorld.png"</span>);</span><br><span class="line">        <span class="keyword">var</span> x = <span class="built_in">Math</span>.round(<span class="built_in">Math</span>.random()*cc.winSize.width);</span><br><span class="line">        plane.setPosition(x,cc.winSize.height+plane.height/<span class="number">2</span>);</span><br><span class="line">        plane.setScale(<span class="number">0.2</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(plane);</span><br><span class="line">        <span class="keyword">var</span> time = <span class="built_in">Math</span>.round(<span class="built_in">Math</span>.sqrt(<span class="built_in">Math</span>.pow(x-x,<span class="number">2</span>)+<span class="built_in">Math</span>.pow(<span class="number">0</span>-plane.height/<span class="number">2</span>-cc.winSize.height+plane.height/<span class="number">2</span>,<span class="number">2</span>)))/<span class="number">100</span>;</span><br><span class="line">        plane.runAction(</span><br><span class="line">            cc.sequence(</span><br><span class="line">                cc.moveTo(time,x,<span class="number">0</span>-plane.height/<span class="number">2</span>),</span><br><span class="line">                cc.callFunc(<span class="function"><span class="keyword">function</span>(<span class="params">plane</span>)</span>&#123;</span><br><span class="line">                    plane.removeFromParent();</span><br><span class="line">                &#125;,plane)</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">this</span>.npcs.push(plane);</span><br><span class="line">    &#125;,</span><br><span class="line">    createBullet:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.state==<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> sp = <span class="keyword">new</span> cc.Sprite(<span class="string">"res/logo.png"</span>);</span><br><span class="line">            cc.audioEngine.playEffect(<span class="string">"res/click.wav"</span>);</span><br><span class="line">            <span class="keyword">var</span> x = <span class="keyword">this</span>.getChildByTag(<span class="number">1</span>).getPositionX();</span><br><span class="line">            <span class="keyword">var</span> y = <span class="keyword">this</span>.getChildByTag(<span class="number">1</span>).getPositionY()+<span class="keyword">this</span>.getChildByTag(<span class="number">1</span>).height/<span class="number">2</span>;</span><br><span class="line">            sp.setPosition(x,y);</span><br><span class="line">            <span class="keyword">this</span>.addChild(sp);</span><br><span class="line">            sp.setScale(<span class="number">0.3</span>);</span><br><span class="line">            <span class="keyword">var</span> time = <span class="built_in">Math</span>.round(<span class="built_in">Math</span>.sqrt(<span class="built_in">Math</span>.pow(x-x,<span class="number">2</span>)+<span class="built_in">Math</span>.pow(cc.winSize.height+sp.height/<span class="number">2</span>-y,<span class="number">2</span>)))/<span class="number">100</span>;</span><br><span class="line">            sp.runAction(</span><br><span class="line">                cc.spawn(</span><br><span class="line">                    cc.rotateBy(time,<span class="number">720</span>).repeatForever(),</span><br><span class="line">                    cc.sequence(</span><br><span class="line">                        cc.moveTo(time,x,cc.winSize.height+sp.height/<span class="number">2</span>),</span><br><span class="line">                        cc.callFunc(<span class="function"><span class="keyword">function</span>(<span class="params">sp</span>)</span>&#123;</span><br><span class="line">                            sp.removeFromParent();</span><br><span class="line">                        &#125;,sp)</span><br><span class="line">                    )</span><br><span class="line">                )</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">this</span>.bullets.push(sp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    onEnter:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        cc.eventManager.addListener(&#123;</span><br><span class="line">            event:cc.EventListener.TOUCH_ONE_BY_ONE,</span><br><span class="line">            swallowTouches:<span class="literal">true</span>,</span><br><span class="line">            onTouchBegan:<span class="keyword">this</span>.touchbegan,</span><br><span class="line">            onTouchMoved:<span class="keyword">this</span>.touchMoved,</span><br><span class="line">            onTouchEnded:<span class="keyword">this</span>.touchEnded</span><br><span class="line">        &#125;,<span class="keyword">this</span>);</span><br><span class="line">        cc.audioEngine.playMusic(<span class="string">"res/bg.mp3"</span>,<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    touchbegan:<span class="function"><span class="keyword">function</span>(<span class="params">touch,event</span>)</span>&#123;</span><br><span class="line">        event.getCurrentTarget().state=<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">var</span> x = touch.getLocationX();</span><br><span class="line">        <span class="keyword">var</span> y = touch.getLocationY();</span><br><span class="line">        <span class="keyword">var</span> plane = event.getCurrentTarget().getChildByTag(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">var</span> time = <span class="built_in">Math</span>.round(<span class="built_in">Math</span>.sqrt(<span class="built_in">Math</span>.pow(x-plane.getPositionX(),<span class="number">2</span>)+<span class="built_in">Math</span>.pow(y-plane.getPositionY(),<span class="number">2</span>)))/<span class="number">1000</span>;</span><br><span class="line">        plane.stopAllActions(); </span><br><span class="line">        plane.runAction(cc.moveTo(time,cc.p(x,y)));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    touchMoved:<span class="function"><span class="keyword">function</span>(<span class="params">touch,event</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> x = touch.getLocationX();</span><br><span class="line">        <span class="keyword">var</span> y = touch.getLocationY();</span><br><span class="line">        <span class="keyword">var</span> plane = event.getCurrentTarget().getChildByTag(<span class="number">1</span>);</span><br><span class="line">        plane.stopAllActions(); </span><br><span class="line">        plane.setPosition(x,y);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    touchEnded:<span class="function"><span class="keyword">function</span>(<span class="params">touch,event</span>)</span>&#123;</span><br><span class="line">        event.getCurrentTarget().state=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> OverScene = cc.Scene.extend(&#123;</span><br><span class="line">    onEnter:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> overTxt = <span class="keyword">new</span> cc.LabelTTF(<span class="string">"Game Over"</span>,<span class="string">""</span>,<span class="number">100</span>);</span><br><span class="line">        overTxt.setPosition(cc.winSize.width/<span class="number">2</span>,cc.winSize.height/<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(overTxt);</span><br><span class="line">        overTxt.runAction(</span><br><span class="line">            cc.sequence(cc.scaleTo(<span class="number">0.2</span>,<span class="number">1.2</span>),cc.scaleTo(<span class="number">0.2</span>,<span class="number">0.9</span>),cc.scaleTo(<span class="number">0.2</span>,<span class="number">1</span>))    </span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">var</span> backMenu = <span class="keyword">new</span> cc.MenuItemFont(<span class="string">"再来一次"</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            cc.director.runScene(<span class="keyword">new</span> HelloWorldScene());</span><br><span class="line">        &#125;,<span class="keyword">this</span>);</span><br><span class="line">        backMenu.setPosition(overTxt.getPositionX(),overTxt.getPositionY()<span class="number">-50</span>-backMenu.height/<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">var</span> menu = <span class="keyword">new</span> cc.Menu(backMenu);</span><br><span class="line">        menu.setPosition(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(menu);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> HelloWorldScene = cc.Scene.extend(&#123;</span><br><span class="line">    onEnter:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> layer = <span class="keyword">new</span> HelloWorldLayer();</span><br><span class="line">        <span class="keyword">this</span>.addChild(layer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h3 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h3><p><a href="http://www.cocoscvp.com/usercode/2016_05_03/066a65bf1bf65dcd589d18a33ad67990822843c1/" target="_blank" rel="external">http://www.cocoscvp.com/usercode/2016_05_03/066a65bf1bf65dcd589d18a33ad67990822843c1/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;概念&quot;&gt;&lt;a href=&quot;#概念&quot; class=&quot;headerlink&quot; title=&quot;概念&quot;&gt;&lt;/a&gt;概念&lt;/h3&gt;&lt;p&gt;本节课内容是cocos中音乐和音效的使用，游戏中经常会有游戏音乐和游戏音效，并且好的音乐音效也是一款游戏的一个卖点，在cocos中，对音乐和音效做了良好的封装，使用起来只需一两句代码就能实现，本节课介绍了cocos中音乐音效的开始暂停。
    
    </summary>
    
      <category term="cocos2d-js" scheme="http://hjcenry.github.io/categories/cocos2d-js/"/>
    
    
      <category term="cocos2d-js" scheme="http://hjcenry.github.io/tags/cocos2d-js/"/>
    
      <category term="cvp" scheme="http://hjcenry.github.io/tags/cvp/"/>
    
  </entry>
  
  <entry>
    <title>CVP认证学习笔记--(何小成)024--粒子动画</title>
    <link href="http://hjcenry.github.io/2016/05/07/CVP%E8%AE%A4%E8%AF%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0--(%E4%BD%95%E5%B0%8F%E6%88%90)024--%E7%B2%92%E5%AD%90%E5%8A%A8%E7%94%BB/"/>
    <id>http://hjcenry.github.io/2016/05/07/CVP认证学习笔记--(何小成)024--粒子动画/</id>
    <published>2016-05-06T16:58:00.000Z</published>
    <updated>2016-05-06T17:04:05.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>本节课介绍如何使用在cocos中使用粒子动画，其中可以使用cocos中包含的11种系统定义好的粒子动画，也可以使用粒子编辑器自定义粒子动画，然后在cocos代码中使用自己定义的粒子动画。<a id="more"></a>系统的11种默认粒子动画我分别截了图，不过粒子动画由于是动画，我截图是静态图，可能效果还是不大明显，大家还是用实际代码来看效果比较好</p>
<h4 id="爆炸粒子效果"><a href="#爆炸粒子效果" class="headerlink" title="爆炸粒子效果"></a>爆炸粒子效果</h4><p>ParticleExplosion。属于半径模式。<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/QQ20160507-12@2x.png" alt="爆炸粒子效果"></p>
<h4 id="火焰粒子效果"><a href="#火焰粒子效果" class="headerlink" title="火焰粒子效果"></a>火焰粒子效果</h4><p>ParticleFire。属于重力径模式。<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/QQ20160507-2@2x.png" alt="火焰粒子效果"></p>
<h4 id="烟花粒子效果"><a href="#烟花粒子效果" class="headerlink" title="烟花粒子效果"></a>烟花粒子效果</h4><p>ParticleFireworks。属于重力模式。<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/QQ20160507-3@2x.png" alt="烟花粒子效果"></p>
<h4 id="花粒子效果"><a href="#花粒子效果" class="headerlink" title="花粒子效果"></a>花粒子效果</h4><p>ParticleFlower。属于重力模式。<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/QQ20160507-4@2x.png" alt="花粒子效果"></p>
<h4 id="星系粒子效果"><a href="#星系粒子效果" class="headerlink" title="星系粒子效果"></a>星系粒子效果</h4><p>ParticleGalaxy。属于半径模式。<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/QQ20160507-5@2x.png" alt="星系粒子效果"></p>
<h4 id="流星粒子效果"><a href="#流星粒子效果" class="headerlink" title="流星粒子效果"></a>流星粒子效果</h4><p>ParticleMeteor。属于重力模式。<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/QQ20160507-6@2x.png" alt="流星粒子效果"></p>
<h4 id="漩涡粒子效果"><a href="#漩涡粒子效果" class="headerlink" title="漩涡粒子效果"></a>漩涡粒子效果</h4><p>ParticleSpiral。属于半径模式。<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/QQ20160507-7@2x.png" alt="漩涡粒子效果"></p>
<h4 id="雪粒子效果"><a href="#雪粒子效果" class="headerlink" title="雪粒子效果"></a>雪粒子效果</h4><p>ParticleSnow。属于重力模式。<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/QQ20160507-8@2x.png" alt="雪粒子效果"></p>
<h4 id="烟粒子效果"><a href="#烟粒子效果" class="headerlink" title="烟粒子效果"></a>烟粒子效果</h4><p>ParticleSmoke。属于重力模式。<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/QQ20160507-9@2x.png" alt="烟粒子效果"></p>
<h4 id="太阳粒子效果"><a href="#太阳粒子效果" class="headerlink" title="太阳粒子效果"></a>太阳粒子效果</h4><p>ParticleSun。属于重力模式。<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/QQ20160507-10@2x.png" alt="太阳粒子效果"></p>
<h4 id="雨粒子效果"><a href="#雨粒子效果" class="headerlink" title="雨粒子效果"></a>雨粒子效果</h4><p>ParticleRain。属于重力模式<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/QQ20160507-11@2x.png" alt="雨粒子效果"></p>
<h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><h4 id="制作粒子动画"><a href="#制作粒子动画" class="headerlink" title="制作粒子动画"></a>制作粒子动画</h4><p>如果需要系统的粒子动画不能满足需求，可以使用粒子编辑器自己编辑一个粒子动画，我在mac系统使用的是ParticleDesigner，打开之后，有多种模板可以进行选择，选择完模板之后，再对各种细节进行调整，知道调整出满意的粒子动画，如下图：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/QQ20160507-1@2x.png" alt="ParticleDesigner"><br>其中包括了调整面板以及预览面板，当调整结果满意之后，点击导出即可在相应的文件夹下导出程序中所需要的plist文件和png图片。</p>
<h4 id="创建粒子"><a href="#创建粒子" class="headerlink" title="创建粒子"></a>创建粒子</h4><p>无论是使用系统提供的动画还是自定义的动画，首先需要创建相应的对象<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用自定义粒子动画</span></span><br><span class="line"><span class="keyword">var</span> myp = <span class="keyword">new</span> cc.ParticleSystem(<span class="string">"res/lizi.plist"</span>);</span><br><span class="line"><span class="comment">// 使用系统提供的粒子动画</span></span><br><span class="line"><span class="keyword">var</span> fire = <span class="keyword">new</span> cc.ParticleFire();</span><br></pre></td></tr></table></figure></p>
<h4 id="设置纹理"><a href="#设置纹理" class="headerlink" title="设置纹理"></a>设置纹理</h4><p>系统粒子动画需要为动画设置纹理，自定义粒子动画一般会将粒子动画使用的纹理写在plist中<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fire.texture = cc.textureCache.addImage(<span class="string">"res/lizi.plist.png"</span>);</span><br></pre></td></tr></table></figure></p>
<h4 id="添加动画到图层"><a href="#添加动画到图层" class="headerlink" title="添加动画到图层"></a>添加动画到图层</h4><p>最后将粒子动画添加到图层，就能看见粒子动画在屏幕中播放<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.addChild(fire);</span><br><span class="line">fire.setPosition(<span class="number">200</span>, <span class="number">200</span>);</span><br></pre></td></tr></table></figure></p>
<h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h3><p>本节作业：<br>主要了解所有的系统粒子动画以及掌握自定义粒子动画并加载到程序中。我在作业中实现了通过菜单选择查看不同的粒子动画，并且通过点击屏幕或在屏幕上滑动，粒子会跟着坐标移动。<br>作业代码实现如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> HelloWorldLayer = cc.Layer.extend(&#123;</span><br><span class="line">    sprite:<span class="literal">null</span>,</span><br><span class="line">    ctor:<span class="function"><span class="keyword">function</span> (<span class="params">index</span>) </span>&#123;</span><br><span class="line">        <span class="comment">//////////////////////////////</span></span><br><span class="line">        <span class="comment">// 1. super init first</span></span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> backMenu = <span class="keyword">new</span> cc.MenuItemFont(<span class="string">"返回"</span>,<span class="keyword">this</span>.backCall,<span class="keyword">this</span>);</span><br><span class="line">        backMenu.setPosition(backMenu.width/<span class="number">2</span>,cc.winSize.height-backMenu.height/<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">var</span> menu = <span class="keyword">new</span> cc.Menu(backMenu);</span><br><span class="line">        <span class="keyword">this</span>.addChild(menu);</span><br><span class="line">        menu.setPosition(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="comment">//添加系统内置粒子效果</span></span><br><span class="line">        <span class="keyword">var</span> lizi;</span><br><span class="line">        <span class="keyword">switch</span>(index)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                lizi = <span class="keyword">new</span> cc.ParticleFire();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                lizi = <span class="keyword">new</span> cc.ParticleFireworks();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                lizi = <span class="keyword">new</span> cc.ParticleFlower();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                lizi = <span class="keyword">new</span> cc.ParticleGalaxy();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                lizi = <span class="keyword">new</span> cc.ParticleMeteor();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">                lizi = <span class="keyword">new</span> cc.ParticleSpiral();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">                lizi = <span class="keyword">new</span> cc.ParticleSnow();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">                lizi = <span class="keyword">new</span> cc.ParticleSmoke();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">                lizi = <span class="keyword">new</span> cc.ParticleSun();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">                lizi = <span class="keyword">new</span> cc.ParticleRain();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">                lizi = <span class="keyword">new</span> cc.ParticleExplosion();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        lizi.texture=cc.textureCache.addImage(<span class="string">"res/ballfire.plist.png"</span>);</span><br><span class="line">        lizi.setPosition(<span class="number">200</span>,<span class="number">200</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(lizi);</span><br><span class="line">        lizi.setTag(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    backCall:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        cc.director.runScene(<span class="keyword">new</span> MenuLayer());</span><br><span class="line">    &#125;,</span><br><span class="line">    onEnter:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        cc.eventManager.addListener(&#123;</span><br><span class="line">            event:cc.EventListener.TOUCH_ONE_BY_ONE ,</span><br><span class="line">            swallowTouches:<span class="literal">true</span>,</span><br><span class="line">            onTouchBegan:<span class="keyword">this</span>.touchbegan,</span><br><span class="line">            onTouchMoved:<span class="keyword">this</span>.touchmoved,</span><br><span class="line">            onTouchEnded:<span class="keyword">this</span>.touchended</span><br><span class="line">        &#125;,<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    touchbegan:<span class="function"><span class="keyword">function</span> (<span class="params">touch,event</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> x = touch.getLocationX();</span><br><span class="line">        <span class="keyword">var</span> y = touch.getLocationY();</span><br><span class="line">        event.getCurrentTarget().getChildByTag(<span class="number">1</span>).setPosition(x,y);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    touchmoved:<span class="function"><span class="keyword">function</span> (<span class="params">touch,event</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> x = touch.getLocationX();</span><br><span class="line">        <span class="keyword">var</span> y = touch.getLocationY();</span><br><span class="line">        event.getCurrentTarget().getChildByTag(<span class="number">1</span>).setPosition(x,y);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    touchended:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> MenuLayer = cc.Layer.extend(&#123;</span><br><span class="line">    onEnter:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> size = cc.winSize;</span><br><span class="line">        <span class="comment">// cocos中的各种系统粒子</span></span><br><span class="line">        <span class="keyword">var</span> file = <span class="keyword">new</span> cc.MenuItemFont(<span class="string">"火焰粒子"</span>,<span class="keyword">this</span>.enterLayer,<span class="keyword">this</span>);</span><br><span class="line">        file.setPosition(size.width/<span class="number">2</span>,size.height-file.height/<span class="number">2</span><span class="number">-20</span>);</span><br><span class="line">        file.setTag(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">var</span> yanhua = <span class="keyword">new</span> cc.MenuItemFont(<span class="string">"烟花粒子"</span>,<span class="keyword">this</span>.enterLayer,<span class="keyword">this</span>);</span><br><span class="line">        yanhua.setPosition(size.width/<span class="number">2</span>,file.getPositionY()-yanhua.height/<span class="number">2</span><span class="number">-20</span>);</span><br><span class="line">        yanhua.setTag(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">var</span> flower = <span class="keyword">new</span> cc.MenuItemFont(<span class="string">"花粒子"</span>,<span class="keyword">this</span>.enterLayer,<span class="keyword">this</span>);</span><br><span class="line">        flower.setPosition(size.width/<span class="number">2</span>,yanhua.getPositionY()-flower.height/<span class="number">2</span><span class="number">-20</span>);</span><br><span class="line">        flower.setTag(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">var</span> star = <span class="keyword">new</span> cc.MenuItemFont(<span class="string">"星系粒子"</span>,<span class="keyword">this</span>.enterLayer,<span class="keyword">this</span>);</span><br><span class="line">        star.setPosition(size.width/<span class="number">2</span>,flower.getPositionY()-star.height/<span class="number">2</span><span class="number">-20</span>);</span><br><span class="line">        star.setTag(<span class="number">4</span>);</span><br><span class="line">        <span class="keyword">var</span> flowerStar = <span class="keyword">new</span> cc.MenuItemFont(<span class="string">"流星粒子"</span>,<span class="keyword">this</span>.enterLayer,<span class="keyword">this</span>);</span><br><span class="line">        flowerStar.setPosition(size.width/<span class="number">2</span>,star.getPositionY()-flowerStar.height/<span class="number">2</span><span class="number">-20</span>);</span><br><span class="line">        flowerStar.setTag(<span class="number">5</span>);</span><br><span class="line">        <span class="keyword">var</span> rotation = <span class="keyword">new</span> cc.MenuItemFont(<span class="string">"漩涡粒子"</span>,<span class="keyword">this</span>.enterLayer,<span class="keyword">this</span>);</span><br><span class="line">        rotation.setPosition(size.width/<span class="number">2</span>,flowerStar.getPositionY()-rotation.height/<span class="number">2</span><span class="number">-20</span>);</span><br><span class="line">        rotation.setTag(<span class="number">6</span>);</span><br><span class="line">        <span class="keyword">var</span> snow = <span class="keyword">new</span> cc.MenuItemFont(<span class="string">"雪粒子"</span>,<span class="keyword">this</span>.enterLayer,<span class="keyword">this</span>);</span><br><span class="line">        snow.setPosition(size.width/<span class="number">2</span>,rotation.getPositionY()-snow.height/<span class="number">2</span><span class="number">-20</span>);</span><br><span class="line">        snow.setTag(<span class="number">7</span>);</span><br><span class="line">        <span class="keyword">var</span> smoke = <span class="keyword">new</span> cc.MenuItemFont(<span class="string">"烟粒子"</span>,<span class="keyword">this</span>.enterLayer,<span class="keyword">this</span>);</span><br><span class="line">        smoke.setPosition(size.width/<span class="number">2</span>,snow.getPositionY()-smoke.height/<span class="number">2</span><span class="number">-20</span>);</span><br><span class="line">        smoke.setTag(<span class="number">8</span>);</span><br><span class="line">        <span class="keyword">var</span> sun = <span class="keyword">new</span> cc.MenuItemFont(<span class="string">"太阳粒子"</span>,<span class="keyword">this</span>.enterLayer,<span class="keyword">this</span>);</span><br><span class="line">        sun.setPosition(size.width/<span class="number">2</span>,smoke.getPositionY()-sun.height/<span class="number">2</span><span class="number">-20</span>);</span><br><span class="line">        sun.setTag(<span class="number">9</span>);</span><br><span class="line">        <span class="keyword">var</span> rain = <span class="keyword">new</span> cc.MenuItemFont(<span class="string">"雨粒子"</span>,<span class="keyword">this</span>.enterLayer,<span class="keyword">this</span>);</span><br><span class="line">        rain.setPosition(size.width/<span class="number">2</span>,sun.getPositionY()-rain.height/<span class="number">2</span><span class="number">-20</span>);</span><br><span class="line">        rain.setTag(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">var</span> explosion = <span class="keyword">new</span> cc.MenuItemFont(<span class="string">"爆炸粒子"</span>,<span class="keyword">this</span>.enterLayer,<span class="keyword">this</span>);</span><br><span class="line">        explosion.setPosition(size.width/<span class="number">2</span>,rain.getPositionY()-explosion.height/<span class="number">2</span><span class="number">-20</span>);</span><br><span class="line">        explosion.setTag(<span class="number">11</span>);</span><br><span class="line">        <span class="keyword">var</span> menu = <span class="keyword">new</span> cc.Menu(file,yanhua,flower,star,flowerStar,rotation,snow,smoke,sun,rain,menu,explosion);</span><br><span class="line">        menu.setPosition(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(menu);</span><br><span class="line">    &#125;,</span><br><span class="line">    enterLayer:<span class="function"><span class="keyword">function</span>(<span class="params">obj</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> layer = <span class="keyword">new</span> HelloWorldLayer(obj.tag);</span><br><span class="line">        cc.director.runScene(layer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> HelloWorldScene = cc.Scene.extend(&#123;</span><br><span class="line">    onEnter:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> layer = <span class="keyword">new</span> MenuLayer();</span><br><span class="line">        <span class="keyword">this</span>.addChild(layer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h3 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h3><p><a href="http://www.cocoscvp.com/usercode/2016_05_03/6766355ed49af56b6c56f001bfac96ae65823c8e/" target="_blank" rel="external">http://www.cocoscvp.com/usercode/2016_05_03/6766355ed49af56b6c56f001bfac96ae65823c8e/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;概念&quot;&gt;&lt;a href=&quot;#概念&quot; class=&quot;headerlink&quot; title=&quot;概念&quot;&gt;&lt;/a&gt;概念&lt;/h3&gt;&lt;p&gt;本节课介绍如何使用在cocos中使用粒子动画，其中可以使用cocos中包含的11种系统定义好的粒子动画，也可以使用粒子编辑器自定义粒子动画，然后在cocos代码中使用自己定义的粒子动画。
    
    </summary>
    
      <category term="cocos2d-js" scheme="http://hjcenry.github.io/categories/cocos2d-js/"/>
    
    
      <category term="cocos2d-js" scheme="http://hjcenry.github.io/tags/cocos2d-js/"/>
    
      <category term="cvp" scheme="http://hjcenry.github.io/tags/cvp/"/>
    
  </entry>
  
  <entry>
    <title>CVP认证学习笔记--(何小成)023--加载骨骼动画</title>
    <link href="http://hjcenry.github.io/2016/05/06/CVP%E8%AE%A4%E8%AF%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0--(%E4%BD%95%E5%B0%8F%E6%88%90)023--%E5%8A%A0%E8%BD%BD%E9%AA%A8%E9%AA%BC%E5%8A%A8%E7%94%BB/"/>
    <id>http://hjcenry.github.io/2016/05/06/CVP认证学习笔记--(何小成)023--加载骨骼动画/</id>
    <published>2016-05-05T16:49:00.000Z</published>
    <updated>2016-05-06T16:58:31.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>本节课介绍如何使用Animation Editor创建骨骼动画，通过骨骼动画，可以让人物形象更加的生动，学习使用Animation Editor编辑骨骼动画，并在游戏场景中加载骨骼动画<a id="more"></a></p>
<h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><p>首先需要用到的还是上节课下载好的动画编辑器Animation Editor。</p>
<h4 id="制作帧动画"><a href="#制作帧动画" class="headerlink" title="制作帧动画"></a>制作帧动画</h4><p>制作骨骼动画的过程相对于制作帧动画来说要麻烦很多，需要在Animation Editor中对每一个骨骼都进行细微的调整，调整完了同帧动画一样，导出资源，，就会有png、plist和json三个文件。</p>
<h4 id="添加文件"><a href="#添加文件" class="headerlink" title="添加文件"></a>添加文件</h4><p>同帧动画一样，先将json文件导入到armatureDataManager中<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加文件</span></span><br><span class="line">ccs.armatureDataManager.addArmatureFileInfo(res.ani_json);</span><br></pre></td></tr></table></figure></p>
<h4 id="创建动画层"><a href="#创建动画层" class="headerlink" title="创建动画层"></a>创建动画层</h4><p>通过Armature创建动画层，创建船长的动画<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ani=<span class="keyword">new</span> ccs.Armature(<span class="string">"chuanzhang"</span>);</span><br></pre></td></tr></table></figure></p>
<h4 id="播放站立动画"><a href="#播放站立动画" class="headerlink" title="播放站立动画"></a>播放站立动画</h4><p>添加后的船长站立不动<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ani.getAnimation().play(<span class="string">"hold"</span>);</span><br><span class="line"><span class="keyword">this</span>.addChild(ani);</span><br><span class="line">ani.setPosition(<span class="number">200</span>,<span class="number">200</span>);</span><br><span class="line">ani.setTag(<span class="number">1</span>);</span><br></pre></td></tr></table></figure></p>
<h4 id="动画事件监听"><a href="#动画事件监听" class="headerlink" title="动画事件监听"></a>动画事件监听</h4><p>动画播放之后的回调函数<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置动画的事件侦听</span></span><br><span class="line">ani.getAnimation().setMovementEventCallFunc(<span class="keyword">this</span>.anievent);</span><br><span class="line"><span class="comment">// 动作结束时执行相关回调</span></span><br><span class="line">anievent:<span class="function"><span class="keyword">function</span> (<span class="params">armature, movementType, movementID</span>) </span>&#123;   </span><br><span class="line">    <span class="comment">// TODO</span></span><br><span class="line">    <span class="comment">// movementType有如下几种类型：</span></span><br><span class="line">    <span class="comment">// 1.boneFrameEvent</span></span><br><span class="line">    <span class="comment">// 2.complete</span></span><br><span class="line">    <span class="comment">// 3.loopComplete</span></span><br><span class="line">    <span class="comment">// 4.movementChange</span></span><br><span class="line">    <span class="comment">// 5.movementFameEvent</span></span><br><span class="line">    <span class="comment">// 6.start</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h3><p>本节作业：<br>// 作业要求，实现一个点击英雄<br>// 点击屏幕让船长播放攻击的动画1-3次随机<br>// 然后继续走路<br>与上节课作业差不多，我实现了点击屏幕船长会走到这个位置，点击攻击会进行攻击，同时，场景会有一个敌人npc，npc会随机游走，相遇时，会不停攻击自己，自己也可以攻击npc，双方血量会减少，谁先杀死对方，谁将获得胜利。<br>作业代码实现如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> HelloWorldLayer = cc.Layer.extend(&#123;</span><br><span class="line">    sprite:<span class="literal">null</span>,</span><br><span class="line">    gameState:<span class="number">1</span>,<span class="comment">// 1游戏中，0结束</span></span><br><span class="line">    direction:<span class="number">1</span>,<span class="comment">// 0左，1右</span></span><br><span class="line">    state:<span class="number">0</span>,</span><br><span class="line">    npcDirection:<span class="number">1</span>,</span><br><span class="line">    npcState:<span class="number">0</span>,<span class="comment">//0移动，1攻击</span></span><br><span class="line">    selfHp:<span class="number">100</span>,</span><br><span class="line">    npcHp:<span class="number">100</span>,</span><br><span class="line">    selfHpTxt:<span class="literal">null</span>,</span><br><span class="line">    npcHpTxt:<span class="literal">null</span>,</span><br><span class="line">    ctor:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">//////////////////////////////</span></span><br><span class="line">        <span class="comment">// 1. super init first</span></span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 攻击按钮</span></span><br><span class="line">        <span class="keyword">var</span> attackMenu = <span class="keyword">new</span> cc.MenuItemFont(<span class="string">"打"</span>,<span class="keyword">this</span>.attackCall,<span class="keyword">this</span>);</span><br><span class="line">        attackMenu.setPosition(cc.winSize.width<span class="number">-150</span>,<span class="number">100</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> menu = <span class="keyword">new</span> cc.Menu(attackMenu);</span><br><span class="line">        menu.setPosition(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(menu);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 血量</span></span><br><span class="line">        <span class="keyword">this</span>.selfHpTxt = <span class="keyword">new</span> cc.LabelTTF(<span class="string">"我方血量:100"</span>,<span class="string">""</span>,<span class="number">25</span>);</span><br><span class="line">        <span class="keyword">this</span>.npcHpTxt = <span class="keyword">new</span> cc.LabelTTF(<span class="string">"敌方血量:100"</span>,<span class="string">""</span>,<span class="number">25</span>);</span><br><span class="line">        <span class="keyword">this</span>.selfHpTxt.setPosition(cc.winSize.width<span class="number">-150</span>,cc.winSize.height<span class="number">-50</span>);</span><br><span class="line">        <span class="keyword">this</span>.npcHpTxt.setPosition(<span class="number">150</span>,cc.winSize.height<span class="number">-50</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(<span class="keyword">this</span>.selfHpTxt);</span><br><span class="line">        <span class="keyword">this</span>.addChild(<span class="keyword">this</span>.npcHpTxt);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//加载动画</span></span><br><span class="line">        ccs.armatureDataManager.addArmatureFileInfo(res.ani_json);</span><br><span class="line">        <span class="comment">//创建动画层</span></span><br><span class="line">        <span class="keyword">var</span> ani=<span class="keyword">new</span> ccs.Armature(<span class="string">"chuanzhang"</span>);</span><br><span class="line">        <span class="comment">//播放站立动画</span></span><br><span class="line">        ani.getAnimation().play(<span class="string">"hold"</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(ani);</span><br><span class="line">        ani.setPosition(<span class="number">200</span>,<span class="number">200</span>);</span><br><span class="line">        ani.setTag(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//设置动画的事件侦听</span></span><br><span class="line">        ani.getAnimation().setMovementEventCallFunc(<span class="keyword">this</span>.anievent);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 敌人npc</span></span><br><span class="line">        <span class="comment">//加载动画</span></span><br><span class="line">        ccs.armatureDataManager.addArmatureFileInfo(res.ani_json);</span><br><span class="line">        <span class="comment">//创建动画层</span></span><br><span class="line">        <span class="keyword">var</span> npc=<span class="keyword">new</span> ccs.Armature(<span class="string">"chuanzhang"</span>);</span><br><span class="line">        <span class="comment">//播放站立动画</span></span><br><span class="line">        npc.getAnimation().play(<span class="string">"hold"</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(npc);</span><br><span class="line">        npc.setPosition(<span class="number">400</span>,<span class="number">200</span>);</span><br><span class="line">        npc.setTag(<span class="number">2</span>);</span><br><span class="line">        <span class="comment">//设置动画的事件侦听</span></span><br><span class="line">        npc.getAnimation().setMovementEventCallFunc(<span class="keyword">this</span>.npcevent);</span><br><span class="line">        <span class="keyword">this</span>.npcMove();</span><br><span class="line">        <span class="keyword">this</span>.schedule(<span class="keyword">this</span>.update);</span><br><span class="line">        <span class="keyword">this</span>.npcState = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 作业要求，实现一个点击英雄</span></span><br><span class="line">        <span class="comment">// 点击屏幕让船长播放攻击的动画1-3次随机</span></span><br><span class="line">        <span class="comment">// 然后继续走路</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 返回按钮</span></span><br><span class="line">    back:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        cc.director.runScene(<span class="keyword">new</span> startLayer());</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 计划任务，写敌人npc的ai</span></span><br><span class="line">    update:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> bn=<span class="keyword">this</span>.getChildByTag(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">var</span> npc=<span class="keyword">this</span>.getChildByTag(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.gameState==<span class="number">0</span>&amp;&amp;<span class="keyword">this</span>.getChildByTag(<span class="number">111</span>)==<span class="literal">null</span>)&#123;<span class="comment">// 游戏结束，判断胜利还是失败</span></span><br><span class="line">            <span class="keyword">var</span> text = <span class="string">""</span>;</span><br><span class="line">            <span class="keyword">if</span>(npc==<span class="literal">null</span>)&#123;<span class="comment">// 赢了</span></span><br><span class="line">                text = <span class="string">"You Win"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(bn==<span class="literal">null</span>)&#123;<span class="comment">// 输了</span></span><br><span class="line">                text = <span class="string">"You Lose"</span>;            </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.removeAllChildren();</span><br><span class="line">            <span class="keyword">var</span> over = <span class="keyword">new</span> cc.LabelTTF(text,<span class="string">""</span>,<span class="number">50</span>);</span><br><span class="line">            over.setPosition(cc.winSize.width/<span class="number">2</span>,cc.winSize.height/<span class="number">2</span>);</span><br><span class="line">            <span class="keyword">this</span>.addChild(over);</span><br><span class="line">            over.setTag(<span class="number">111</span>);</span><br><span class="line">            over.runAction(cc.sequence(cc.scaleTo(<span class="number">0.2</span>,<span class="number">2</span>),cc.scaleTo(<span class="number">0.2</span>,<span class="number">0.5</span>),cc.scaleTo(<span class="number">0.2</span>,<span class="number">1</span>)));</span><br><span class="line">            <span class="comment">// 按钮</span></span><br><span class="line">            <span class="keyword">var</span> back = <span class="keyword">new</span> cc.MenuItemFont(<span class="string">"返回"</span>,<span class="keyword">this</span>.back,<span class="keyword">this</span>);</span><br><span class="line">            back.setPosition(cc.winSize.width/<span class="number">2</span>,over.height+<span class="number">50</span>);</span><br><span class="line">            <span class="keyword">var</span> menu = <span class="keyword">new</span> cc.Menu(back);</span><br><span class="line">            menu.setPosition(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">this</span>.addChild(menu);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.gameState==<span class="number">1</span>)&#123;<span class="comment">// 游戏运行中</span></span><br><span class="line">            <span class="keyword">if</span>(</span><br><span class="line">                (<span class="built_in">Math</span>.abs(npc.getPositionX()-bn.getPositionX()))&lt;=bn.width/<span class="number">2</span></span><br><span class="line">                &amp;&amp;(<span class="built_in">Math</span>.abs(npc.getPositionY()-bn.getPositionY())&lt;=bn.height/<span class="number">4</span>)</span><br><span class="line">            )&#123;<span class="comment">// 主角出现在npc的攻击范围内</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">this</span>.npcState==<span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="keyword">this</span>.npcState = <span class="number">1</span>;</span><br><span class="line">                    npc.stopAllActions();</span><br><span class="line">                    npc.getAnimation().play(<span class="string">"attack"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">this</span>.npcState==<span class="number">1</span>)&#123;</span><br><span class="line">                    <span class="keyword">this</span>.npcState = <span class="number">0</span>;</span><br><span class="line">                    npc.getAnimation().play(<span class="string">"walk"</span>);</span><br><span class="line">                    <span class="keyword">this</span>.npcMove();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 敌人移动动画</span></span><br><span class="line">    npcMove:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> npcDirection = <span class="keyword">this</span>.npcDirection;</span><br><span class="line">        <span class="keyword">var</span> npc=<span class="keyword">this</span>.getChildByTag(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">var</span> randomX = <span class="built_in">Math</span>.round(<span class="built_in">Math</span>.random()*(cc.winSize.width-npc.width)+npc.width/<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">var</span> randomY = <span class="built_in">Math</span>.round(<span class="built_in">Math</span>.random()*(cc.winSize.height-npc.height)+npc.height/<span class="number">2</span>);</span><br><span class="line">        <span class="comment">// 走路时间</span></span><br><span class="line">        <span class="keyword">var</span> time = <span class="built_in">Math</span>.round(<span class="built_in">Math</span>.sqrt(<span class="built_in">Math</span>.pow(randomX-npc.getPositionX(),<span class="number">2</span>)+<span class="built_in">Math</span>.pow(randomY-npc.getPositionY(),<span class="number">2</span>)))/<span class="number">100</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(randomX&lt;npc.getPositionX()&amp;&amp;npcDirection==<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="comment">// 左转</span></span><br><span class="line">            npc.runAction(cc.scaleTo(<span class="number">0</span>,<span class="number">-1</span>,<span class="number">1</span>));</span><br><span class="line">            <span class="keyword">this</span>.npcDirection = <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(randomX&gt;npc.getPositionX()&amp;&amp;npcDirection==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">// 右转</span></span><br><span class="line">            npc.runAction(cc.scaleTo(<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>));</span><br><span class="line">            <span class="keyword">this</span>.npcDirection = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        npc.getAnimation().play(<span class="string">"walk"</span>);</span><br><span class="line">        npc.runAction(cc.sequence(cc.moveTo(time,cc.p(randomX,randomY)),cc.callFunc(<span class="function"><span class="keyword">function</span>(<span class="params">npc</span>)</span>&#123;</span><br><span class="line">            npc.parent.npcMove();</span><br><span class="line">        &#125;,npc)));</span><br><span class="line">    &#125;,</span><br><span class="line">    onEnter:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        cc.eventManager.addListener(&#123;</span><br><span class="line">            event:cc.EventListener.TOUCH_ONE_BY_ONE,</span><br><span class="line">            swallowTouches:<span class="literal">true</span>,</span><br><span class="line">            onTouchBegan:<span class="keyword">this</span>.touchbegan,</span><br><span class="line">            onTouchMoved:<span class="keyword">this</span>.touchmoved,</span><br><span class="line">            onTouchEnded:<span class="keyword">this</span>.touchended</span><br><span class="line">        &#125;,<span class="keyword">this</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    touchbegan:<span class="function"><span class="keyword">function</span>(<span class="params">touch,event</span>)</span>&#123;</span><br><span class="line">        event.getCurrentTarget().state = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(event.getCurrentTarget().gameState==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> x = touch.getLocation().x;</span><br><span class="line">        <span class="keyword">var</span> y = touch.getLocation().y;</span><br><span class="line">        <span class="keyword">var</span> direction = event.getCurrentTarget().direction;</span><br><span class="line">        <span class="keyword">var</span> bn = event.getCurrentTarget().getChildByTag(<span class="number">1</span>);</span><br><span class="line">        bn.stopAllActions();</span><br><span class="line">        <span class="comment">// 走路时间</span></span><br><span class="line">        <span class="keyword">var</span> time = <span class="built_in">Math</span>.round(<span class="built_in">Math</span>.sqrt(<span class="built_in">Math</span>.pow(x-bn.getPositionX(),<span class="number">2</span>)+<span class="built_in">Math</span>.pow(y-bn.getPositionY(),<span class="number">2</span>)))/<span class="number">100</span>;</span><br><span class="line">        <span class="keyword">if</span>(x&lt;bn.getPositionX()&amp;&amp;direction==<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="comment">// 左转</span></span><br><span class="line">            bn.runAction(cc.scaleTo(<span class="number">0</span>,<span class="number">-1</span>,<span class="number">1</span>));</span><br><span class="line">            event.getCurrentTarget().direction = <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(x&gt;bn.getPositionX()&amp;&amp;direction==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">// 右转</span></span><br><span class="line">            bn.runAction(cc.scaleTo(<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>));</span><br><span class="line">            event.getCurrentTarget().direction = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        bn.getAnimation().play(<span class="string">"walk"</span>);</span><br><span class="line">        <span class="keyword">var</span> walkTo = <span class="keyword">new</span> cc.sequence(cc.moveTo(time,cc.p(x,y)),cc.callFunc(<span class="function"><span class="keyword">function</span>(<span class="params">bn</span>)</span>&#123;</span><br><span class="line">            bn.getAnimation().play(<span class="string">"hold"</span>);</span><br><span class="line">        &#125;,bn));</span><br><span class="line">        bn.runAction(walkTo);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    touchmoved:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;,</span><br><span class="line">    touchended:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 攻击按钮回调</span></span><br><span class="line">    attackCall:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.state==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">this</span>.state=<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">this</span>.getChildByTag(<span class="number">1</span>).stopAllActions();</span><br><span class="line">            <span class="comment">// 攻击动画</span></span><br><span class="line">            <span class="keyword">this</span>.getChildByTag(<span class="number">1</span>).getAnimation().play(<span class="string">"attack"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 攻击npc血量</span></span><br><span class="line">    anievent:<span class="function"><span class="keyword">function</span>(<span class="params">armature,movementtype,movementID</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(movementtype==<span class="number">2</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(movementID==<span class="string">"attack"</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                armature.parent.stopAllActions();</span><br><span class="line">                <span class="keyword">if</span>(</span><br><span class="line">                    <span class="built_in">Math</span>.abs(armature.parent.getChildByTag(<span class="number">2</span>).getPositionX()-armature.parent.getChildByTag(<span class="number">1</span>).getPositionX())&lt;=armature.parent.getChildByTag(<span class="number">1</span>).width/<span class="number">2</span></span><br><span class="line">                    &amp;&amp;<span class="built_in">Math</span>.abs(armature.parent.getChildByTag(<span class="number">2</span>).getPositionY()-armature.parent.getChildByTag(<span class="number">1</span>).getPositionY())&lt;=armature.parent.getChildByTag(<span class="number">1</span>).height/<span class="number">4</span></span><br><span class="line">                )&#123;</span><br><span class="line">                    armature.parent.state=<span class="number">1</span>;</span><br><span class="line">                    armature.parent.npcHp-=<span class="number">4</span>+<span class="built_in">Math</span>.round(<span class="built_in">Math</span>.random()*<span class="number">2</span>);</span><br><span class="line">                    armature.parent.npcHpTxt.runAction(</span><br><span class="line">                        cc.sequence(</span><br><span class="line">                            cc.scaleTo(<span class="number">0.2</span>,<span class="number">1.2</span>),</span><br><span class="line">                            cc.scaleTo(<span class="number">0.1</span>,<span class="number">0.9</span>),</span><br><span class="line">                            cc.scaleTo(<span class="number">0.1</span>,<span class="number">1</span>),</span><br><span class="line">                            cc.callFunc(<span class="function"><span class="keyword">function</span>(<span class="params">armature</span>)</span>&#123;</span><br><span class="line">                                armature.parent.npcHpTxt.setString(<span class="string">"敌方血量:"</span>+armature.parent.npcHp);</span><br><span class="line">                            &#125;,armature)));</span><br><span class="line">                    <span class="keyword">if</span>(armature.parent.npcHp&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">                        armature.parent.getChildByTag(<span class="number">2</span>).removeFromParent();</span><br><span class="line">                        armature.parent.gameState=<span class="number">0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                armature.parent.state = <span class="number">0</span>;</span><br><span class="line">                armature.getAnimation().play(<span class="string">"hold"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// npc攻击我方血量</span></span><br><span class="line">    npcevent:<span class="function"><span class="keyword">function</span>(<span class="params">armature,movementtype,movementID</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(movementtype==<span class="number">2</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(movementID==<span class="string">"attack"</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                armature.parent.selfHp-=<span class="number">2</span>+<span class="built_in">Math</span>.round(<span class="built_in">Math</span>.random()*<span class="number">2</span>);</span><br><span class="line">                armature.parent.selfHpTxt.runAction(</span><br><span class="line">                    cc.sequence(</span><br><span class="line">                        cc.scaleTo(<span class="number">0.2</span>,<span class="number">1.2</span>),</span><br><span class="line">                        cc.scaleTo(<span class="number">0.1</span>,<span class="number">0.9</span>),</span><br><span class="line">                        cc.scaleTo(<span class="number">0.1</span>,<span class="number">1</span>),</span><br><span class="line">                        cc.callFunc(<span class="function"><span class="keyword">function</span>(<span class="params">armature</span>)</span>&#123;</span><br><span class="line">                            armature.parent.selfHpTxt.setString(<span class="string">"我方血量:"</span>+armature.parent.selfHp);</span><br><span class="line">                        &#125;,armature)));</span><br><span class="line">                <span class="keyword">if</span>(armature.parent.selfHp&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">                    armature.parent.getChildByTag(<span class="number">1</span>).removeFromParent();</span><br><span class="line">                    armature.getAnimation().play(<span class="string">"hold"</span>);</span><br><span class="line">                    armature.parent.gameState=<span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> startLayer = cc.Layer.extend(&#123;</span><br><span class="line">    ctor:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> size = cc.winSize;</span><br><span class="line">        <span class="comment">// 标题</span></span><br><span class="line">        <span class="keyword">var</span> title = <span class="keyword">new</span> cc.LabelTTF(<span class="string">"真假船长大战"</span>,<span class="string">""</span>,<span class="number">100</span>);</span><br><span class="line">        title.setPosition(size.width/<span class="number">2</span>,size.height<span class="number">-100</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(title);</span><br><span class="line">        <span class="comment">// 按钮</span></span><br><span class="line">        <span class="keyword">var</span> startMenu = <span class="keyword">new</span> cc.MenuItemFont(<span class="string">"开始游戏"</span>,<span class="keyword">this</span>.start,<span class="keyword">this</span>);</span><br><span class="line">        startMenu.setPosition(size.width/<span class="number">2</span>,size.height/<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">var</span> helpMenu = <span class="keyword">new</span> cc.MenuItemFont(<span class="string">"帮助"</span>,<span class="keyword">this</span>.help,<span class="keyword">this</span>);</span><br><span class="line">        helpMenu.setPosition(size.width/<span class="number">2</span>,startMenu.height+<span class="number">50</span>);</span><br><span class="line">        <span class="keyword">var</span> menu = <span class="keyword">new</span> cc.Menu(startMenu,helpMenu);</span><br><span class="line">        menu.setPosition(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(menu);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    start:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        cc.director.runScene(<span class="keyword">new</span> HelloWorldLayer());</span><br><span class="line">    &#125;,</span><br><span class="line">    help:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        cc.director.runScene(<span class="keyword">new</span> helpLayer());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> helpLayer = cc.Layer.extend(&#123;</span><br><span class="line">    ctor:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> size = cc.winSize;</span><br><span class="line">        <span class="comment">// 标题</span></span><br><span class="line">        <span class="keyword">var</span> title = <span class="keyword">new</span> cc.LabelTTF(<span class="string">"游戏中有一个假船长四处游走，\r\n当你们靠的很近时，它会攻击你，你也可以攻击它，\r\n谁先打倒对方谁将获得胜利！"</span>,<span class="string">""</span>,<span class="number">30</span>);</span><br><span class="line">        title.setPosition(size.width/<span class="number">2</span>,size.height<span class="number">-100</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(title);</span><br><span class="line">        <span class="comment">// 按钮</span></span><br><span class="line">        <span class="keyword">var</span> back = <span class="keyword">new</span> cc.MenuItemFont(<span class="string">"返回"</span>,<span class="keyword">this</span>.help,<span class="keyword">this</span>);</span><br><span class="line">        back.setPosition(size.width/<span class="number">2</span>,size.height/<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">var</span> menu = <span class="keyword">new</span> cc.Menu(back);</span><br><span class="line">        menu.setPosition(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(menu);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    help:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        cc.director.runScene(<span class="keyword">new</span> startLayer());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> HelloWorldScene = cc.Scene.extend(&#123;</span><br><span class="line">    onEnter:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> layer = <span class="keyword">new</span> startLayer();</span><br><span class="line">        <span class="keyword">this</span>.addChild(layer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h3 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h3><p><a href="http://www.cocoscvp.com/usercode/2016_05_03/59d170f1dd8aec6a65cf900f6759098d960ab296/" target="_blank" rel="external">http://www.cocoscvp.com/usercode/2016_05_03/59d170f1dd8aec6a65cf900f6759098d960ab296/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;概念&quot;&gt;&lt;a href=&quot;#概念&quot; class=&quot;headerlink&quot; title=&quot;概念&quot;&gt;&lt;/a&gt;概念&lt;/h3&gt;&lt;p&gt;本节课介绍如何使用Animation Editor创建骨骼动画，通过骨骼动画，可以让人物形象更加的生动，学习使用Animation Editor编辑骨骼动画，并在游戏场景中加载骨骼动画
    
    </summary>
    
      <category term="cocos2d-js" scheme="http://hjcenry.github.io/categories/cocos2d-js/"/>
    
    
      <category term="cocos2d-js" scheme="http://hjcenry.github.io/tags/cocos2d-js/"/>
    
      <category term="cvp" scheme="http://hjcenry.github.io/tags/cvp/"/>
    
  </entry>
  
  <entry>
    <title>CVP认证学习笔记--(何小成)022--加载帧动画</title>
    <link href="http://hjcenry.github.io/2016/05/05/CVP%E8%AE%A4%E8%AF%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0--(%E4%BD%95%E5%B0%8F%E6%88%90)022--%E5%8A%A0%E8%BD%BD%E5%B8%A7%E5%8A%A8%E7%94%BB/"/>
    <id>http://hjcenry.github.io/2016/05/05/CVP认证学习笔记--(何小成)022--加载帧动画/</id>
    <published>2016-05-04T16:05:00.000Z</published>
    <updated>2016-05-06T16:58:39.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>本节课介绍如何使用Animation Editor创建帧动画，然后在cocos中加载编辑好的动画，通过一些动画编辑器如Animation Editor能使我们在开发动画的时候更加方便，在cocos中，可以通过ArmatureDataManager加载自定义好的帧动画。<a id="more"></a></p>
<h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><p>首先需要下载Animation Editor（从大海老师网盘中取win版的），网上没找到mac版的，我只能找了一个win的电脑装了Animation Editor，并且将网盘中的图片资源做了四个动画，分别是stand、walk、punch、kick，代表robert的四个状态，最好之后由酋长上传到了作业资源中。然后再根据作业要求在程序中加载我制作好的帧动画。实际上，也有别的动画编辑器，包括现在Animation Editor也继承到了Cocos Studio中，本节课就Animation Editor为例进行讲解。</p>
<h4 id="制作帧动画"><a href="#制作帧动画" class="headerlink" title="制作帧动画"></a>制作帧动画</h4><p>制作帧动画的过程很简单，通过Animation Editor使得动画编辑非常简单，只需要把需要的资源拖进资源中，然后选择形体模式，将第一张图片放在屏幕中心，如下图：<br>![Animation editor形体模式](<a href="http://7xnnwn.com1.z0.glb.clouddn.com/2.pic.jpg）" target="_blank" rel="external">http://7xnnwn.com1.z0.glb.clouddn.com/2.pic.jpg）</a><br>选择动画模式，将剩下的四张图片拖放到左下角眼睛的地方，然后就能根据多张图片自动创建一个帧动画，如下图：<br>![Animation editor动画模式](<a href="http://7xnnwn.com1.z0.glb.clouddn.com/1.pic.jpg）" target="_blank" rel="external">http://7xnnwn.com1.z0.glb.clouddn.com/1.pic.jpg）</a><br>创建完动画之后，可以预览，确定没有问题就可以导出做好的动画，导出的文件有png、plist和ExportJson三个文件。</p>
<h4 id="添加文件"><a href="#添加文件" class="headerlink" title="添加文件"></a>添加文件</h4><p>先将json文件导入到armatureDataManager中<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加文件</span></span><br><span class="line">ccs.armatureDataManager.addArmatureFileInfo(res.punch_json);</span><br></pre></td></tr></table></figure></p>
<h4 id="创建动画层"><a href="#创建动画层" class="headerlink" title="创建动画层"></a>创建动画层</h4><p>通过Armature创建动画层，并设置播放第几个动画，设置坐标之后添加到图层中，就可以看到一个播放着动画的Robert<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> punch=<span class="keyword">new</span> ccs.Armature(<span class="string">"punch"</span>);</span><br><span class="line">punch.getAnimation().playWithIndex(<span class="number">0</span>);<span class="comment">//通过0 1 2可以切换不同的动画</span></span><br><span class="line">punch.setPosition(<span class="keyword">this</span>.npcX,<span class="keyword">this</span>.npcY);</span><br><span class="line"><span class="keyword">this</span>.addChild(punch);</span><br></pre></td></tr></table></figure></p>
<h4 id="动画回调函数"><a href="#动画回调函数" class="headerlink" title="动画回调函数"></a>动画回调函数</h4><p>如果需要动画播放之后回调某个函数<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置动画回调函数</span></span><br><span class="line">punch.getAnimation().setMovementEventCallFunc(<span class="keyword">this</span>.animationEvent,<span class="keyword">this</span>); </span><br><span class="line"><span class="comment">// 动作结束时执行相关回调</span></span><br><span class="line">animationEvent:<span class="function"><span class="keyword">function</span> (<span class="params">armature, movementType, movementID</span>) </span>&#123;   </span><br><span class="line">    <span class="comment">// TODO</span></span><br><span class="line">    <span class="comment">// movementType有如下几种类型：</span></span><br><span class="line">    <span class="comment">// 1.boneFrameEvent</span></span><br><span class="line">    <span class="comment">// 2.complete</span></span><br><span class="line">    <span class="comment">// 3.loopComplete</span></span><br><span class="line">    <span class="comment">// 4.movementChange</span></span><br><span class="line">    <span class="comment">// 5.movementFameEvent</span></span><br><span class="line">    <span class="comment">// 6.start</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h3><p>本节作业：<br>// 实现罗伯特走路和攻击的动画，然后保存<br>// 发到limu@h5edu.cn<br>// 让老师协助上传到服务器<br>// 然后在代码中加载自己编辑的动画<br>// 当用户点击屏幕则播放攻击动画动画播放完成则继续播放走路动画<br>我实现了点击屏幕，Robert可以播放行走动画，并走到该点，走到目的地时播放stand动画，右边提供踢和打两个按钮，点击分别会播放kick和punch动画<br>作业代码实现如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> HelloWorldLayer = cc.Layer.extend(&#123;</span><br><span class="line">    sprite:<span class="literal">null</span>,</span><br><span class="line">    direction:<span class="string">"right"</span>,</span><br><span class="line">    npcX:<span class="number">100</span>,</span><br><span class="line">    npcY:<span class="number">100</span>,</span><br><span class="line">    isStand:<span class="literal">true</span>,</span><br><span class="line">    ctor:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">//////////////////////////////</span></span><br><span class="line">        <span class="comment">// 1. super init first</span></span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实现罗伯特走路和攻击的动画，然后保存</span></span><br><span class="line">        <span class="comment">// 发到limu@h5edu.cn</span></span><br><span class="line">        <span class="comment">// 让老师协助上传到服务器</span></span><br><span class="line">        <span class="comment">// 然后在代码中加载自己编辑的动画</span></span><br><span class="line">        <span class="comment">// 当用户点击屏幕则播放攻击动画动画播放完成则继续播放走路动画</span></span><br><span class="line">        <span class="keyword">var</span> size = cc.winSize;</span><br><span class="line">        <span class="comment">// 拳击按钮</span></span><br><span class="line">        <span class="keyword">var</span> punch = <span class="keyword">new</span> cc.MenuItemFont(<span class="string">"打"</span>,<span class="keyword">this</span>.punchCall,<span class="keyword">this</span>);</span><br><span class="line">        punch.setPosition(size.width<span class="number">-100</span>,<span class="number">100</span>);</span><br><span class="line">        <span class="comment">// 脚踢按钮</span></span><br><span class="line">        <span class="keyword">var</span> kick = <span class="keyword">new</span> cc.MenuItemFont(<span class="string">"踢"</span>,<span class="keyword">this</span>.kickCall,<span class="keyword">this</span>);</span><br><span class="line">        kick.setPosition(size.width<span class="number">-100</span>,<span class="number">150</span>);</span><br><span class="line">        <span class="keyword">var</span> menu=<span class="keyword">new</span> cc.Menu(punch,kick);</span><br><span class="line">        menu.setPosition(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">this</span>.addChild(menu);</span><br><span class="line">        <span class="comment">//添加文件</span></span><br><span class="line">        ccs.armatureDataManager.addArmatureFileInfo(res.stand_json);</span><br><span class="line">        <span class="comment">//创建动画层</span></span><br><span class="line">        <span class="keyword">var</span> stand=<span class="keyword">new</span> ccs.Armature(<span class="string">"stand"</span>);</span><br><span class="line">        stand.getAnimation().playWithIndex(<span class="number">0</span>);<span class="comment">//通过0 1 2可以切换不同的动画</span></span><br><span class="line">        stand.setPosition(<span class="keyword">this</span>.npcX,<span class="keyword">this</span>.npcY);</span><br><span class="line">        <span class="keyword">this</span>.addChild(stand);</span><br><span class="line">        stand.setTag(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 拳击动画</span></span><br><span class="line">    punchCall:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.npcX = <span class="keyword">this</span>.getChildByTag(<span class="number">1</span>).getPositionX();</span><br><span class="line">        <span class="comment">//移除当前动画</span></span><br><span class="line">        <span class="keyword">this</span>.removeChildByTag(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//添加文件</span></span><br><span class="line">        ccs.armatureDataManager.addArmatureFileInfo(res.punch_json);</span><br><span class="line">        <span class="comment">//创建动画层</span></span><br><span class="line">        <span class="keyword">var</span> punch=<span class="keyword">new</span> ccs.Armature(<span class="string">"punch"</span>);</span><br><span class="line">        punch.getAnimation().playWithIndex(<span class="number">0</span>);<span class="comment">//通过0 1 2可以切换不同的动画</span></span><br><span class="line">        punch.setPosition(<span class="keyword">this</span>.npcX,<span class="keyword">this</span>.npcY);</span><br><span class="line">        <span class="keyword">this</span>.addChild(punch);</span><br><span class="line">        punch.setTag(<span class="number">1</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">this</span>.isStand = <span class="literal">false</span>;</span><br><span class="line">        punch.getAnimation().setMovementEventCallFunc(<span class="keyword">this</span>.animationEvent,<span class="keyword">this</span>);  <span class="comment">//为Armature添加一个事件监听</span></span><br><span class="line">        </span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 踢腿动画</span></span><br><span class="line">    kickCall:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.npcX = <span class="keyword">this</span>.getChildByTag(<span class="number">1</span>).getPositionX();</span><br><span class="line">        <span class="comment">//移除当前动画</span></span><br><span class="line">        <span class="keyword">this</span>.removeChildByTag(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//添加文件</span></span><br><span class="line">        ccs.armatureDataManager.addArmatureFileInfo(res.kick_json);</span><br><span class="line">        <span class="comment">//创建动画层</span></span><br><span class="line">        <span class="keyword">var</span> kick=<span class="keyword">new</span> ccs.Armature(<span class="string">"kick"</span>);</span><br><span class="line">        kick.getAnimation().playWithIndex(<span class="number">0</span>);<span class="comment">//通过0 1 2可以切换不同的动画</span></span><br><span class="line">        kick.setPosition(<span class="keyword">this</span>.npcX,<span class="keyword">this</span>.npcY);</span><br><span class="line">        <span class="keyword">this</span>.addChild(kick);</span><br><span class="line">        kick.setTag(<span class="number">1</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">this</span>.isStand = <span class="literal">false</span>;</span><br><span class="line">        kick.getAnimation().setMovementEventCallFunc(<span class="keyword">this</span>.animationEvent,<span class="keyword">this</span>);  <span class="comment">//为Armature添加一个事件监听</span></span><br><span class="line">        </span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 动作结束时播放stand动画</span></span><br><span class="line">    animationEvent:<span class="function"><span class="keyword">function</span> (<span class="params">armature, movementType, movementID</span>) </span>&#123;   <span class="comment">//当事件loopComplete发生时触发下一个动作；</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">this</span>.isStand)&#123;</span><br><span class="line">            <span class="comment">//移除当前动画</span></span><br><span class="line">            <span class="keyword">this</span>.removeChildByTag(<span class="number">1</span>);</span><br><span class="line">            <span class="comment">//添加文件</span></span><br><span class="line">            ccs.armatureDataManager.addArmatureFileInfo(res.stand_json);</span><br><span class="line">            <span class="comment">//创建动画层</span></span><br><span class="line">            <span class="keyword">var</span> stand=<span class="keyword">new</span> ccs.Armature(<span class="string">"stand"</span>);</span><br><span class="line">            stand.getAnimation().playWithIndex(<span class="number">0</span>);<span class="comment">//通过0 1 2可以切换不同的动画</span></span><br><span class="line">            stand.setPosition(<span class="keyword">this</span>.npcX,<span class="keyword">this</span>.npcY);</span><br><span class="line">            <span class="keyword">this</span>.addChild(stand);</span><br><span class="line">            stand.setTag(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">this</span>.isStand = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    onEnter:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        cc.eventManager.addListener(&#123;</span><br><span class="line">            event:cc.EventListener.TOUCH_ONE_BY_ONE,</span><br><span class="line">            swallowTouches:<span class="literal">true</span>,</span><br><span class="line">            onTouchBegan:<span class="keyword">this</span>.touchbegan,</span><br><span class="line">            onTouchMoved:<span class="keyword">this</span>.touchmoved,</span><br><span class="line">            onTouchEnded:<span class="keyword">this</span>.touchended</span><br><span class="line">        &#125;,<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    touchbegan:<span class="function"><span class="keyword">function</span>(<span class="params">touch,event</span>)</span>&#123;</span><br><span class="line">        event.getCurrentTarget().npcX = event.getCurrentTarget().getChildByTag(<span class="number">1</span>).getPositionX();</span><br><span class="line">        <span class="comment">// 走路动画</span></span><br><span class="line">        <span class="comment">//移除当前动画</span></span><br><span class="line">        event.getCurrentTarget().removeChildByTag(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//添加文件</span></span><br><span class="line">        ccs.armatureDataManager.addArmatureFileInfo(res.walk_json);</span><br><span class="line">        <span class="comment">//创建动画层</span></span><br><span class="line">        <span class="keyword">var</span> walk=<span class="keyword">new</span> ccs.Armature(<span class="string">"walk"</span>);</span><br><span class="line">        walk.getAnimation().playWithIndex(<span class="number">0</span>);<span class="comment">//通过0 1 2可以切换不同的动画</span></span><br><span class="line">        walk.setPosition(event.getCurrentTarget().npcX,event.getCurrentTarget().npcY);</span><br><span class="line">        event.getCurrentTarget().addChild(walk);</span><br><span class="line">        walk.setTag(<span class="number">1</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> x = touch.getLocation().x;</span><br><span class="line">        <span class="keyword">var</span> y = event.getCurrentTarget().npcY;</span><br><span class="line">        <span class="keyword">var</span> bn = event.getCurrentTarget().getChildByTag(<span class="number">1</span>);</span><br><span class="line">        bn.stopAllActions();</span><br><span class="line">        <span class="comment">// 走路时间</span></span><br><span class="line">        <span class="keyword">var</span> time = <span class="built_in">Math</span>.round(<span class="built_in">Math</span>.sqrt(<span class="built_in">Math</span>.pow(x-bn.getPositionX(),<span class="number">2</span>)+<span class="built_in">Math</span>.pow(y-bn.getPositionY(),<span class="number">2</span>)))/<span class="number">100</span>;</span><br><span class="line">        bn.runAction(cc.sequence(cc.moveTo(time,cc.p(x,y)),cc.callFunc(<span class="function"><span class="keyword">function</span>(<span class="params">bn</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> layer = bn.parent;</span><br><span class="line">            <span class="comment">//移除当前动画</span></span><br><span class="line">            bn.removeFromParent();</span><br><span class="line">            <span class="comment">//添加文件</span></span><br><span class="line">            ccs.armatureDataManager.addArmatureFileInfo(res.stand_json);</span><br><span class="line">            <span class="comment">//创建动画层</span></span><br><span class="line">            <span class="keyword">var</span> stand=<span class="keyword">new</span> ccs.Armature(<span class="string">"stand"</span>);</span><br><span class="line">            stand.getAnimation().playWithIndex(<span class="number">0</span>);<span class="comment">//通过0 1 2可以切换不同的动画</span></span><br><span class="line">            stand.setPosition(bn.getPositionX(),bn.getPositionY());</span><br><span class="line">            layer.npcX = bn.getPositionX();</span><br><span class="line">            layer.npcY = bn.getPositionY();</span><br><span class="line">            layer.addChild(stand);</span><br><span class="line">            stand.setTag(<span class="number">1</span>);</span><br><span class="line">            layer.isStand = <span class="literal">true</span>;</span><br><span class="line">        &#125;,bn)));   </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    touchmoved:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    &#125;,</span><br><span class="line">    touchended:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> HelloWorldScene = cc.Scene.extend(&#123;</span><br><span class="line">    onEnter:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> layer = <span class="keyword">new</span> HelloWorldLayer();</span><br><span class="line">        <span class="keyword">this</span>.addChild(layer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h3 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h3><p><a href="http://www.cocoscvp.com/usercode/2016_04_30/785bc6b6db98a170b123a8151f7e965d4132ba3c/" target="_blank" rel="external">http://www.cocoscvp.com/usercode/2016_04_30/785bc6b6db98a170b123a8151f7e965d4132ba3c/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;概念&quot;&gt;&lt;a href=&quot;#概念&quot; class=&quot;headerlink&quot; title=&quot;概念&quot;&gt;&lt;/a&gt;概念&lt;/h3&gt;&lt;p&gt;本节课介绍如何使用Animation Editor创建帧动画，然后在cocos中加载编辑好的动画，通过一些动画编辑器如Animation Editor能使我们在开发动画的时候更加方便，在cocos中，可以通过ArmatureDataManager加载自定义好的帧动画。
    
    </summary>
    
      <category term="cocos2d-js" scheme="http://hjcenry.github.io/categories/cocos2d-js/"/>
    
    
      <category term="cocos2d-js" scheme="http://hjcenry.github.io/tags/cocos2d-js/"/>
    
      <category term="cvp" scheme="http://hjcenry.github.io/tags/cvp/"/>
    
  </entry>
  
  <entry>
    <title>CVP认证学习笔记--(何小成)021--纹理打包文件读取</title>
    <link href="http://hjcenry.github.io/2016/04/30/CVP%E8%AE%A4%E8%AF%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0--(%E4%BD%95%E5%B0%8F%E6%88%90)021--%E7%BA%B9%E7%90%86%E6%89%93%E5%8C%85%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/"/>
    <id>http://hjcenry.github.io/2016/04/30/CVP认证学习笔记--(何小成)021--纹理打包文件读取/</id>
    <published>2016-04-30T07:46:00.000Z</published>
    <updated>2016-04-30T11:18:17.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>本节课内容介绍了如何将多张小图打包成一张大图，以及纹理打包文件的读取，在正式项目中，一个精灵动画的多帧图片通常是通过TexturePacker打包成一张png及一个plist文件使用，在cocos中使用其中的纹理图片时，直接通过解析plist文件就能读取到打包的png的各个需要的帧图片的部分<a id="more"></a></p>
<h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><h4 id="打包纹理图片"><a href="#打包纹理图片" class="headerlink" title="打包纹理图片"></a>打包纹理图片</h4><p>上一节直接使用了打包好的纹理大图，这一节介绍打包这张大图的一个工具————TexturePacker，同时又mac版和win版，使用Texture，将要打包的图片拖进去，设置好图片大小，然后发布，就能在对应目录下生成一个png文件一个plist文件，其中png文件就是打包好的大图，plist是一个xml文件，对这张png图片的详细描述。plist文件具体内容如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="meta">&lt;!DOCTYPE plist PUBLIC "-//Apple Computer//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plist</span> <span class="attr">version</span>=<span class="string">"1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">key</span>&gt;</span>frames<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">key</span>&gt;</span>kick01.png<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>frame<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;&#123;2,164&#125;,&#123;42,106&#125;&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>offset<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;-36,-3&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>rotated<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">true</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>sourceColorRect<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;&#123;15,10&#125;,&#123;42,106&#125;&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>sourceSize<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;144,120&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">key</span>&gt;</span>kick02.png<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>frame<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;&#123;194,262&#125;,&#123;56,84&#125;&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>offset<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;-36,-14&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>rotated<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">false</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>sourceColorRect<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;&#123;8,32&#125;,&#123;56,84&#125;&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>sourceSize<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;144,120&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">key</span>&gt;</span>kick03.png<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>frame<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;&#123;100,262&#125;,&#123;64,92&#125;&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>offset<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;-36,-10&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>rotated<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">true</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>sourceColorRect<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;&#123;4,24&#125;,&#123;64,92&#125;&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>sourceSize<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;144,120&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">key</span>&gt;</span>kick04.png<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>frame<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;&#123;2,208&#125;,&#123;72,96&#125;&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>offset<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;-23,-8&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>rotated<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">true</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>sourceColorRect<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;&#123;13,20&#125;,&#123;72,96&#125;&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>sourceSize<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;144,120&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">key</span>&gt;</span>kick05.png<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>frame<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;&#123;2,282&#125;,&#123;54,90&#125;&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>offset<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;-29,-11&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>rotated<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">true</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>sourceColorRect<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;&#123;16,26&#125;,&#123;54,90&#125;&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>sourceSize<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;144,120&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">key</span>&gt;</span>kick06.png<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>frame<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;&#123;2,2&#125;,&#123;122,102&#125;&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>offset<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;8,-5&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>rotated<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">false</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>sourceColorRect<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;&#123;19,14&#125;,&#123;122,102&#125;&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>sourceSize<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;144,120&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">key</span>&gt;</span>kick07.png<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>frame<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;&#123;126,2&#125;,&#123;118,102&#125;&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>offset<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;8,-5&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>rotated<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">false</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>sourceColorRect<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;&#123;21,14&#125;,&#123;118,102&#125;&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>sourceSize<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;144,120&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">key</span>&gt;</span>kick08.png<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>frame<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;&#123;110,168&#125;,&#123;92,100&#125;&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>offset<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;6,-6&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>rotated<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">true</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>sourceColorRect<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;&#123;32,16&#125;,&#123;92,100&#125;&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>sourceSize<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;144,120&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">key</span>&gt;</span>kick09.png<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>frame<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;&#123;118,106&#125;,&#123;60,112&#125;&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>offset<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;-11,0&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>rotated<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">true</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>sourceColorRect<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;&#123;31,4&#125;,&#123;60,112&#125;&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>sourceSize<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;144,120&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">key</span>&gt;</span>kick10.png<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>frame<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;&#123;2,106&#125;,&#123;56,114&#125;&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>offset<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;-12,1&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>rotated<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">true</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>sourceColorRect<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;&#123;32,2&#125;,&#123;56,114&#125;&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key</span>&gt;</span>sourceSize<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;144,120&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">key</span>&gt;</span>metadata<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">key</span>&gt;</span>format<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">integer</span>&gt;</span>2<span class="tag">&lt;/<span class="name">integer</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">key</span>&gt;</span>realTextureFileName<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">string</span>&gt;</span>npc.png<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">key</span>&gt;</span>size<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">string</span>&gt;</span>&#123;256,512&#125;<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">key</span>&gt;</span>smartupdate<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">string</span>&gt;</span>$TexturePacker:SmartUpdate:e4480d70d3c21807e7e1537afdfcd8a8$<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">key</span>&gt;</span>textureFileName<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">string</span>&gt;</span>npc.png<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plist</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>可以看到，在plist中，对png中的每个小图片的位置，名字等都有详细描述，在cocos中通过SpriteFrameCache就可以对plist中的信息进行读取，然后从png中切出这张小图。</p>
<h4 id="加载纹理图片"><a href="#加载纹理图片" class="headerlink" title="加载纹理图片"></a>加载纹理图片</h4><p>一次性加载纹理图片并解析所有的帧<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cc.spriteFrameCache.addSpriteFrames(res.npc_plist);</span><br></pre></td></tr></table></figure></p>
<h4 id="使用帧缓存创建Sprite"><a href="#使用帧缓存创建Sprite" class="headerlink" title="使用帧缓存创建Sprite"></a>使用帧缓存创建Sprite</h4><p>根据帧缓存就可以创建sprite<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sp=<span class="keyword">new</span> cc.Sprite(cc.spriteFrameCache.getSpriteFrame(<span class="string">"kick01.png"</span>));</span><br><span class="line"><span class="keyword">this</span>.addChild(sp);</span><br></pre></td></tr></table></figure></p>
<h4 id="使用帧缓存创建动画"><a href="#使用帧缓存创建动画" class="headerlink" title="使用帧缓存创建动画"></a>使用帧缓存创建动画</h4><p>也可以使用帧缓存创建动画<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> frames=[];</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> n=<span class="number">1</span>;n&lt;<span class="number">10</span>;n++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> sf=cc.spriteFrameCache.getSpriteFrame(<span class="string">"kick0"</span>+n+<span class="string">".png"</span>);</span><br><span class="line">    frames.push(sf);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> animation=<span class="keyword">new</span> cc.Animation(frames,<span class="number">0.2</span>);</span><br><span class="line"><span class="keyword">var</span> animate=<span class="keyword">new</span> cc.animate(animation);</span><br></pre></td></tr></table></figure></p>
<h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h3><p>本节作业：实现对spriteBachNode的动画创建，让动画播放添加到一个spriteBachNode父节点上。作业代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> HelloWorldLayer = cc.Layer.extend(&#123;</span><br><span class="line">    sprite:<span class="literal">null</span>,</span><br><span class="line">    ctor:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">//////////////////////////////</span></span><br><span class="line">        <span class="comment">// 1. super init first</span></span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//一次加载纹理图片和解析所有的帧</span></span><br><span class="line">        cc.spriteFrameCache.addSpriteFrames(res.npc_plist);</span><br><span class="line">        <span class="comment">//根据帧缓存来创建sprite</span></span><br><span class="line">        <span class="keyword">var</span> sp=<span class="keyword">new</span> cc.Sprite(cc.spriteFrameCache.getSpriteFrame(<span class="string">"kick01.png"</span>));</span><br><span class="line">        <span class="comment">// this.addChild(sp);</span></span><br><span class="line">        sp.setPosition(<span class="number">200</span>,<span class="number">200</span>);</span><br><span class="line">        <span class="comment">//使用帧缓存创建动画</span></span><br><span class="line">        <span class="keyword">var</span> frames=[];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> n=<span class="number">1</span>;n&lt;<span class="number">10</span>;n++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> sf=cc.spriteFrameCache.getSpriteFrame(<span class="string">"kick0"</span>+n+<span class="string">".png"</span>);</span><br><span class="line">            frames.push(sf);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> animation=<span class="keyword">new</span> cc.Animation(frames,<span class="number">0.2</span>);</span><br><span class="line">        <span class="keyword">var</span> animate1=<span class="keyword">new</span> cc.animate(animation);</span><br><span class="line">        <span class="keyword">var</span> animate2=<span class="keyword">new</span> cc.animate(animation);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 本节作业，实现对spriteBachNode的动画创建</span></span><br><span class="line">        <span class="comment">// 让动画播放添加到一个spriteBachNode父节点上</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 读取和plist文件同名的png文件，这个文件其实已经被读取到纹理内存里了的</span></span><br><span class="line">        <span class="keyword">var</span> spBatch = <span class="keyword">new</span> cc.SpriteBatchNode(res.npc_png);</span><br><span class="line">        <span class="keyword">this</span>.addChild(spBatch,<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 为SpriteBatchNode添加第一个Sprite</span></span><br><span class="line">        <span class="keyword">var</span> sp1 = <span class="keyword">new</span> cc.Sprite.create(cc.spriteFrameCache.getSpriteFrame(<span class="string">"kick01.png"</span>));</span><br><span class="line">        sp1.setPosition(<span class="number">300</span>,<span class="number">300</span>);</span><br><span class="line">        spBatch.addChild(sp1,<span class="number">3</span>);</span><br><span class="line">        sp1.runAction(animate1.repeatForever());</span><br><span class="line">        <span class="comment">// 为SpriteBatchNode添加第二个Sprite</span></span><br><span class="line">        <span class="keyword">var</span> sp2 = <span class="keyword">new</span> cc.Sprite.create(cc.spriteFrameCache.getSpriteFrame(<span class="string">"kick01.png"</span>));</span><br><span class="line">        sp2.setPosition(<span class="number">500</span>,<span class="number">300</span>);</span><br><span class="line">        spBatch.addChild(sp2,<span class="number">3</span>);</span><br><span class="line">        sp2.runAction(animate2.repeatForever());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> HelloWorldScene = cc.Scene.extend(&#123;</span><br><span class="line">    onEnter:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> layer = <span class="keyword">new</span> HelloWorldLayer();</span><br><span class="line">        <span class="keyword">this</span>.addChild(layer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h3 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h3><p><a href="http://www.cocoscvp.com/usercode/2016_04_30/810eec0b33a2c2d59f828dda9204f341d0d9a585/" target="_blank" rel="external">http://www.cocoscvp.com/usercode/2016_04_30/810eec0b33a2c2d59f828dda9204f341d0d9a585/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;概念&quot;&gt;&lt;a href=&quot;#概念&quot; class=&quot;headerlink&quot; title=&quot;概念&quot;&gt;&lt;/a&gt;概念&lt;/h3&gt;&lt;p&gt;本节课内容介绍了如何将多张小图打包成一张大图，以及纹理打包文件的读取，在正式项目中，一个精灵动画的多帧图片通常是通过TexturePacker打包成一张png及一个plist文件使用，在cocos中使用其中的纹理图片时，直接通过解析plist文件就能读取到打包的png的各个需要的帧图片的部分
    
    </summary>
    
      <category term="cocos2d-js" scheme="http://hjcenry.github.io/categories/cocos2d-js/"/>
    
    
      <category term="cocos2d-js" scheme="http://hjcenry.github.io/tags/cocos2d-js/"/>
    
      <category term="cvp" scheme="http://hjcenry.github.io/tags/cvp/"/>
    
  </entry>
  
  <entry>
    <title>微博开源框架Motan初体验</title>
    <link href="http://hjcenry.github.io/2016/04/26/%E5%BE%AE%E5%8D%9A%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6Motan%E5%88%9D%E4%BD%93%E9%AA%8C/"/>
    <id>http://hjcenry.github.io/2016/04/26/微博开源框架Motan初体验/</id>
    <published>2016-04-26T09:44:00.000Z</published>
    <updated>2016-04-26T14:21:11.000Z</updated>
    
    <content type="html"><![CDATA[<p>前两天，我在开源中国的微信公众号看到新浪微博的轻量Rpc框架——Motan开源了。上网查了下，才得知这个Motan来头不小，支撑着新浪微博的千亿调用，曾经在2014年的春晚中有着千亿次的调用，对抗了春晚的最高峰值。<a id="more"></a></p>
<h3 id="什么是Motan"><a href="#什么是Motan" class="headerlink" title="什么是Motan"></a>什么是Motan</h3><p><em>2013 年微博 RPC 框架 Motan 在前辈大师们（福林、fishermen、小麦、王喆等）的精心设计和辛勤工作中诞生，向各位大师们致敬，也得到了微博各个技术团队的鼎力支持及不断完善，如今 Motan 在微博平台中已经广泛应用，每天为数百个服务完成近千亿次的调用。” —— 张雷</em></p>
<p>微博的Motan RPC服务，底层通讯引擎采用了Netty网络框架，序列化协议支持Hessian和Java序列化，通讯协议支持Motan、http、tcp、mc等，Motan框架在内部大量使用，在系统的健壮性和服务治理方面，有较为成熟的技术解决方案，健壮性上，基于Config配置管理服务实现了High Availability与Load Balance策略（支持灵活的FailOver和FailFast HA策略，以及Round Robin、LRU、Consistent Hash等Load Balance策略），服务治理方面，生成完整的服务调用链数据，服务请求性能数据，响应时间（Response Time）、QPS以及标准化Error、Exception日志信息。</p>
<p>Motan 属于服务治理类型，是一个基于 Java 开发的高性能的轻量级 RPC 框架，Motan 提供了实用的服务治理功能和优秀的 RPC 协议扩展能力。<br>Motan 提供的主要功能包括：<br><strong>服务发现</strong> ：服务发布、订阅、通知<br><strong>高可用策略</strong> ：失败重试（Failover）、快速失败（Failfast）、异常隔离（Server 连续失败超过指定次数置为不可用，然后定期进行心跳探测）<br><strong>负载均衡</strong> ：支持低并发优先、一致性 Hash、随机请求、轮询等<br><strong>扩展性</strong> ：支持 SPI 扩展（service provider interface）<br><strong>其他</strong> ：调用统计、访问日志等</p>
<p>Motan 可以支持不同的 RPC 协议、传输协议。Motan 能够无缝支持 Spring 配置方式使用 RPC 服务，通过简单、灵活的配置就可以提供或使用 RPC 服务。通过使用 Motan 框架，可以十分方便的进行服务拆分、分布式服务部署。</p>
<p>关于Motan的更多内容可参考：<a href="http://h2ex.com/820" target="_blank" rel="external">http://h2ex.com/820</a><br>以及Motan的源码：<a href="https://github.com/weibocom/motan" target="_blank" rel="external">https://github.com/weibocom/motan</a></p>
<h3 id="简单调用示例"><a href="#简单调用示例" class="headerlink" title="简单调用示例"></a>简单调用示例</h3><p>参照github中wiki，可以快速的跑一跑motan，提前感受一下，由于Motan刚开源，很多东西还不完整，我个人在这中间也遇到很多坑，后面一一介绍。我按照wiki介绍，先创建maven项目motandemo，</p>
<h4 id="添加pom依赖"><a href="#添加pom依赖" class="headerlink" title="添加pom依赖"></a>添加pom依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="line">	<span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.hjc.demo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>motandemo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">packaging</span>&gt;</span>war<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">name</span>&gt;</span>motandemo<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">id</span>&gt;</span>spy<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">name</span>&gt;</span>36<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">layout</span>&gt;</span>default<span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">url</span>&gt;</span>http://repo1.maven.org/maven2<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.weibo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>motan-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.weibo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>motan-transport-netty<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 集群相关 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.weibo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>motan-registry-consul<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.weibo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>motan-registry-zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- dependencies blow were only needed for spring-based features --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.weibo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>motan-springsupport<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">finalName</span>&gt;</span>motan<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>注意如果maven下载不下来可以去仓库直接搜，然后下载jar包，我在搭建的过程就遇到了jar包下载不下来的情况，可能是网络原因吧。<br>仓库地址：<a href="http://mvnrepository.com/" target="_blank" rel="external">http://mvnrepository.com/</a><br>下载下来后使用maven进行本地安装，安装命令如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn install:install-file -Dfile=&lt;path-to-file&gt; -DgroupId=&lt;group-id&gt; -DartifactId=&lt;artifact-id&gt; -Dversion=&lt;version&gt; -Dpackaging=&lt;packaging&gt;</span><br></pre></td></tr></table></figure></p>
<p>确定pom.xml不报错之后再进行下面的步骤</p>
<h4 id="为服务方和调用方创建接口"><a href="#为服务方和调用方创建接口" class="headerlink" title="为服务方和调用方创建接口"></a>为服务方和调用方创建接口</h4><p>创建接口，服务方和调用方都使用这个接口FooService<br>FooService:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hjc.motan.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.hjc.motan.DemoBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FooService</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">(String name)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">helloInt</span><span class="params">(<span class="keyword">int</span> number1)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">helloDouble</span><span class="params">(<span class="keyword">double</span> number2)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">helloList</span><span class="params">(List&lt;String&gt; list)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Map&lt;String, List&lt;String&gt;&gt; helloMap(Map&lt;String, List&lt;String&gt;&gt; map);</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> DemoBean <span class="title">helloJavabean</span><span class="params">(DemoBean bean)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>服务方来实现这个接口的逻辑<br>FooServiceImpl:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hjc.motan.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.hjc.motan.DemoBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FooServiceImpl</span> <span class="keyword">implements</span> <span class="title">FooService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">		ApplicationContext applicationContext = <span class="keyword">new</span> ClassPathXmlApplicationContext(</span><br><span class="line">				<span class="string">"classpath:motan_server.xml"</span>);</span><br><span class="line">		System.out.println(<span class="string">"server start..."</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"invoked rpc service "</span> + name);</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"hello "</span> + name;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">helloInt</span><span class="params">(<span class="keyword">int</span> number1)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"invoked rpc service "</span> + number1);</span><br><span class="line">		<span class="keyword">return</span> number1;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">helloDouble</span><span class="params">(<span class="keyword">double</span> number2)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"invoked rpc service "</span> + number2);</span><br><span class="line">		<span class="keyword">return</span> number2;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">helloList</span><span class="params">(List&lt;String&gt; list)</span> </span>&#123;</span><br><span class="line">		System.out.print(<span class="string">"invoked rpc service "</span>);</span><br><span class="line">		<span class="keyword">for</span> (String string : list) &#123;</span><br><span class="line">			System.out.print(string + <span class="string">","</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println();</span><br><span class="line">		<span class="keyword">return</span> list;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Map&lt;String, List&lt;String&gt;&gt; helloMap(Map&lt;String, List&lt;String&gt;&gt; map) &#123;</span><br><span class="line">		System.out.print(<span class="string">"invoked rpc service "</span>);</span><br><span class="line">		<span class="keyword">for</span> (String key : map.keySet()) &#123;</span><br><span class="line">			System.out.print(key + <span class="string">":["</span>);</span><br><span class="line">			<span class="keyword">for</span> (String list : map.get(key)) &#123;</span><br><span class="line">				System.out.print(list + <span class="string">","</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			System.out.print(<span class="string">"],"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println();</span><br><span class="line">		<span class="keyword">return</span> map;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> DemoBean <span class="title">helloJavabean</span><span class="params">(DemoBean bean)</span> </span>&#123;</span><br><span class="line">		System.out.print(<span class="string">"invoked rpc service "</span> + bean);</span><br><span class="line">		System.out.print(<span class="string">","</span> + bean.getId());</span><br><span class="line">		System.out.print(<span class="string">","</span> + bean.getName());</span><br><span class="line">		System.out.print(<span class="string">","</span> + bean.getScore());</span><br><span class="line">		System.out.println();</span><br><span class="line">		<span class="keyword">return</span> bean;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="配置服务方暴露接口"><a href="#配置服务方暴露接口" class="headerlink" title="配置服务方暴露接口"></a>配置服务方暴露接口</h4><p>在项目根目录（src/main/datasource）创建motan_server.xml，如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span><br><span class="line">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="line">    <span class="attr">xmlns:motan</span>=<span class="string">"http://api.weibo.com/schema/motan"</span></span><br><span class="line">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd</span><br><span class="line">   http://api.weibo.com/schema/motan http://api.weibo.com/schema/motan.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- service implemention bean --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"serviceImpl"</span> <span class="attr">class</span>=<span class="string">"com.hjc.motan.server.FooServiceImpl"</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- exporting service by motan --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">motan:service</span> <span class="attr">interface</span>=<span class="string">"com.hjc.motan.server.FooService"</span> <span class="attr">ref</span>=<span class="string">"serviceImpl"</span> <span class="attr">export</span>=<span class="string">"8002"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>在这个过程中，我发现我的eclipse不能自动下载motan.xsd，这时候我只能手动配置，从motan-core的jar包中，找到这个schema文件，复制到任意位置，然后eclipse中，选择Window-&gt;Preferences-&gt;XML-&gt;XML Catalog-&gt;User Specified Entries，点击Add，输入Location和Key，按照如下图所示：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1472037-84987d6df57493e1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="手动添加schema"></p>
<p>以上步骤完成之后，就可以启动Motan Rpc的服务方了，在FooServiceImpl中已经写好了main方法，右键run即可</p>
<h4 id="配置调用方调用接口"><a href="#配置调用方调用接口" class="headerlink" title="配置调用方调用接口"></a>配置调用方调用接口</h4><p> 在项目根目录（src/main/datasource）创建motan_server.xml，如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span><br><span class="line"><span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="line"><span class="attr">xmlns:motan</span>=<span class="string">"http://api.weibo.com/schema/motan"</span></span><br><span class="line"><span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd</span><br><span class="line">   http://api.weibo.com/schema/motan http://api.weibo.com/schema/motan.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- reference to the remote service --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">motan:referer</span> <span class="attr">id</span>=<span class="string">"remoteService"</span> <span class="attr">interface</span>=<span class="string">"com.hjc.motan.server.FooService"</span> <span class="attr">directUrl</span>=<span class="string">"localhost:8002"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h4 id="调用方调用"><a href="#调用方调用" class="headerlink" title="调用方调用"></a>调用方调用</h4><p>创建Client类调用服务方的接口并输出<br>Client：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hjc.motan.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.hjc.motan.DemoBean;</span><br><span class="line"><span class="keyword">import</span> com.hjc.motan.server.FooService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">		ApplicationContext ctx = <span class="keyword">new</span> ClassPathXmlApplicationContext(</span><br><span class="line">				<span class="string">"classpath:motan_client.xml"</span>);</span><br><span class="line">		<span class="comment">// 获取到service</span></span><br><span class="line">		FooService service = (FooService) ctx.getBean(<span class="string">"remoteService"</span>);</span><br><span class="line">		<span class="comment">// rpc调用</span></span><br><span class="line">		<span class="comment">/** String **/</span></span><br><span class="line">		String ret1 = service.hello(<span class="string">"motan"</span>);</span><br><span class="line">		System.out.println(ret1);</span><br><span class="line">		<span class="comment">/** int **/</span></span><br><span class="line">		<span class="keyword">int</span> ret2 = service.helloInt(<span class="number">110</span>);</span><br><span class="line">		System.out.println(ret2);</span><br><span class="line">		<span class="comment">/** double **/</span></span><br><span class="line">		<span class="keyword">double</span> ret3 = service.helloDouble(<span class="number">11.2</span>);</span><br><span class="line">		System.out.println(ret3);</span><br><span class="line">		<span class="comment">/** list **/</span></span><br><span class="line">		List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">		list.add(<span class="string">"hello"</span>);</span><br><span class="line">		list.add(<span class="string">"motan"</span>);</span><br><span class="line">		List&lt;String&gt; ret4 = service.helloList(list);</span><br><span class="line">		<span class="keyword">for</span> (String string : ret4) &#123;</span><br><span class="line">			System.out.print(string + <span class="string">","</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println();</span><br><span class="line">		<span class="comment">/** map **/</span></span><br><span class="line">		Map&lt;String, List&lt;String&gt;&gt; map = <span class="keyword">new</span> HashMap&lt;String, List&lt;String&gt;&gt;();</span><br><span class="line">		map.put(<span class="string">"key1"</span>, Arrays.asList(<span class="keyword">new</span> String[] &#123; <span class="string">"val1"</span>,<span class="string">"val2"</span> &#125;));</span><br><span class="line">		map.put(<span class="string">"key2"</span>, Arrays.asList(<span class="keyword">new</span> String[] &#123; <span class="string">"val1"</span>,<span class="string">"val2"</span>,<span class="string">"val3"</span> &#125;));</span><br><span class="line">		map.put(<span class="string">"key3"</span>, Arrays.asList(<span class="keyword">new</span> String[] &#123; <span class="string">"val1"</span>,<span class="string">"val2"</span>,<span class="string">"val3"</span>,<span class="string">"val4"</span> &#125;));</span><br><span class="line">		Map&lt;String, List&lt;String&gt;&gt; ret5 = service.helloMap(map);</span><br><span class="line">		<span class="keyword">for</span> (String key : ret5.keySet()) &#123;</span><br><span class="line">			System.out.print(key + <span class="string">":["</span>);</span><br><span class="line">			<span class="keyword">for</span> (String tmp : map.get(key)) &#123;</span><br><span class="line">				System.out.print(tmp + <span class="string">","</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			System.out.print(<span class="string">"],"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println();</span><br><span class="line">		<span class="comment">/** javabean **/</span></span><br><span class="line">		DemoBean bean = <span class="keyword">new</span> DemoBean();</span><br><span class="line">		bean.setId(<span class="number">1001l</span>);</span><br><span class="line">		bean.setName(<span class="string">"motan bean"</span>);</span><br><span class="line">		bean.setScore(<span class="number">99.998</span>);</span><br><span class="line">		DemoBean ret6 = service.helloJavabean(bean);</span><br><span class="line">		System.out.print(ret6.getId());</span><br><span class="line">		System.out.print(<span class="string">","</span> + ret6.getName());</span><br><span class="line">		System.out.print(<span class="string">","</span> + ret6.getScore());</span><br><span class="line">		System.out.println();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>启动Client的main方法开始调用</p>
<h4 id="输出结果"><a href="#输出结果" class="headerlink" title="输出结果"></a>输出结果</h4><p>通过以上demo创建了server端和client端，分别启动服务方和调用方之后，查看控制台输出如下：<br>服务方：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server start...</span><br><span class="line">invoked rpc service motan</span><br><span class="line">invoked rpc service 110</span><br><span class="line">invoked rpc service 11.2</span><br><span class="line">invoked rpc service hello,motan,</span><br><span class="line">invoked rpc service key3:[val1,val2,val3,val4,],key2:[val1,val2,val3,],key1:[val1,val2,],</span><br><span class="line">invoked rpc service com.hjc.motan.DemoBean@2cf3e1fd,1001,motan bean,99.998</span><br></pre></td></tr></table></figure></p>
<p>调用方：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">hello motan</span><br><span class="line">110</span><br><span class="line">11.2</span><br><span class="line">hello,motan,</span><br><span class="line">key3:[val1,val2,val3,val4,],key2:[val1,val2,val3,],key1:[val1,val2,],</span><br><span class="line">1001,motan bean,99.998</span><br></pre></td></tr></table></figure></p>
<h3 id="集群调用示例"><a href="#集群调用示例" class="headerlink" title="集群调用示例"></a>集群调用示例</h3><p>实现集群使用只需要在上面的基础做一点稍稍的改变就可以，motan的集群与阿里的dubbo的原理类似，通过注册方、服务方、调用方三方来实现，三者关系图如下：</p>
<p><img src="https://github.com/weibocom/motan/wiki/media/14612349319195.jpg" alt="集群关系图"></p>
<ol>
<li>Server 向 Registry 注册服务，并向注册中心发送心跳汇报状态。</li>
<li>Client 需要向注册中心订阅 RPC 服务，Client 根据 Registry 返回的服务列表，对具体的 Sever 进行 RPC 调用。</li>
<li>当 Server 发生变更时，Registry 会同步变更，Client 感知后会对本地的服务列表作相应调整。</li>
</ol>
<p>目前按照wiki说明，motan支持Consul和Zookeeper两种外部服务发现组件<br>以下我们再上面实现的基础之上进行更改（两种组件分别有介绍）</p>
<h4 id="添加pom依赖-1"><a href="#添加pom依赖-1" class="headerlink" title="添加pom依赖"></a>添加pom依赖</h4><p>在最上面，其实已经写出来了<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- consul --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.weibo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>motan-registry-consul<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- zookeeper --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.weibo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>motan-registry-zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h4 id="在server和client的配置文件中分别增加registry定义"><a href="#在server和client的配置文件中分别增加registry定义" class="headerlink" title="在server和client的配置文件中分别增加registry定义"></a>在server和client的配置文件中分别增加registry定义</h4><p>consul<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">motan:registry</span> <span class="attr">regProtocol</span>=<span class="string">"consul"</span> <span class="attr">name</span>=<span class="string">"my_consul"</span> <span class="attr">address</span>=<span class="string">"127.0.0.1:8500"</span>/&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>zookeeper单节点<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">motan:registry</span> <span class="attr">regProtocol</span>=<span class="string">"zookeeper"</span> <span class="attr">name</span>=<span class="string">"my_zookeeper"</span> <span class="attr">address</span>=<span class="string">"127.0.0.1:2181"</span>/&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>zookeeper多节点集群<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">motan:registry</span> <span class="attr">regProtocol</span>=<span class="string">"zookeeper"</span> <span class="attr">name</span>=<span class="string">"my_zookeeper"</span> <span class="attr">address</span>=<span class="string">"127.0.0.1:2181,127.0.0.1:2182,127.0.0.1:2183"</span>/&gt;</span></span><br></pre></td></tr></table></figure></p>
<h4 id="在motan-client及server配置改为通过registry服务发现"><a href="#在motan-client及server配置改为通过registry服务发现" class="headerlink" title="在motan client及server配置改为通过registry服务发现"></a>在motan client及server配置改为通过registry服务发现</h4><p>consul client<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">motan:referer</span> <span class="attr">id</span>=<span class="string">"remoteService"</span> <span class="attr">interface</span>=<span class="string">"quickstart.FooService"</span> <span class="attr">registry</span>=<span class="string">"my_consul"</span>/&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>consul server<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">motan:service</span> <span class="attr">interface</span>=<span class="string">"quickstart.FooService"</span> <span class="attr">ref</span>=<span class="string">"serviceImpl"</span> <span class="attr">registry</span>=<span class="string">"my_consul"</span> <span class="attr">export</span>=<span class="string">"8002"</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>zookeeper client<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">motan:referer</span> <span class="attr">id</span>=<span class="string">"remoteService"</span> <span class="attr">interface</span>=<span class="string">"quickstart.FooService"</span> <span class="attr">registry</span>=<span class="string">"my_zookeeper"</span>/&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>zookeeper server<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">motan:service</span> <span class="attr">interface</span>=<span class="string">"quickstart.FooService"</span> <span class="attr">ref</span>=<span class="string">"serviceImpl"</span> <span class="attr">registry</span>=<span class="string">"my_zookeeper"</span> <span class="attr">export</span>=<span class="string">"8002"</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>
<h4 id="调用方调用服务"><a href="#调用方调用服务" class="headerlink" title="调用方调用服务"></a>调用方调用服务</h4><p>consul需要显示调用心跳开关注册到consul（zookeeper不需要）<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MotanSwitcherUtil.setSwitcher(ConsulConstants.NAMING_PROCESS_HEARTBEAT_SWITCHER, <span class="keyword">true</span>)</span><br></pre></td></tr></table></figure></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>我也是正好最近项目空闲，刚好又看到这么一则新闻，于是就动手了解了下，当然，我所做的只是浅层次的使用，至于更深层次的内容（如，跟dubbo等其他rpc框架的对比，集群上下线对zookeeper的影响等）还没来得及去研究，不过既然它曾经支撑过千亿的调用，那一定是经过实际运营检验的，作为搞技术的，也应该多去了解了解开源的东西，这里我想说一句，开源真好！<br>另外，以上demo代码我也传到了我的github上，欢迎交流学习：<br><a href="https://github.com/hjcenry/motan-demo" target="_blank" rel="external">https://github.com/hjcenry/motan-demo</a></p>
<hr>
<p><em>我的个人博客开通啦，每一篇文章都在简书跟个人博客同步，地址是：<a href="http://hjcenry.github.io">http://hjcenry.github.io</a></em></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;前两天，我在开源中国的微信公众号看到新浪微博的轻量Rpc框架——Motan开源了。上网查了下，才得知这个Motan来头不小，支撑着新浪微博的千亿调用，曾经在2014年的春晚中有着千亿次的调用，对抗了春晚的最高峰值。
    
    </summary>
    
      <category term="Java" scheme="http://hjcenry.github.io/categories/Java/"/>
    
    
      <category term="Java" scheme="http://hjcenry.github.io/tags/Java/"/>
    
      <category term="rpc" scheme="http://hjcenry.github.io/tags/rpc/"/>
    
      <category term="Motan" scheme="http://hjcenry.github.io/tags/Motan/"/>
    
      <category term="开源" scheme="http://hjcenry.github.io/tags/%E5%BC%80%E6%BA%90/"/>
    
  </entry>
  
  <entry>
    <title>CVP认证学习笔记--(何小成)020--实现切图帧动画</title>
    <link href="http://hjcenry.github.io/2016/04/25/CVP%E8%AE%A4%E8%AF%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0--(%E4%BD%95%E5%B0%8F%E6%88%90)020--%E5%AE%9E%E7%8E%B0%E5%88%87%E5%9B%BE%E5%B8%A7%E5%8A%A8%E7%94%BB/"/>
    <id>http://hjcenry.github.io/2016/04/25/CVP认证学习笔记--(何小成)020--实现切图帧动画/</id>
    <published>2016-04-25T15:30:00.000Z</published>
    <updated>2016-04-30T07:46:44.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>本节内容是掌握cocos中的动画缓存，通过cc.animationCache.addAnimation，可以将预先写好的一组动画放入动画缓存，当一些事件触发时，如触摸点击屏幕精灵时，便可以通过cc.animationCache.getAnimation获取到先前缓存的动画。<a id="more"></a></p>
<h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><h4 id="添加帧序列"><a href="#添加帧序列" class="headerlink" title="添加帧序列"></a>添加帧序列</h4><p>事先准备好的帧序列图片放在一张大图中，通过截取矩形区域来获得所需要的帧序列图片<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> n=<span class="number">0</span>;n&lt;<span class="number">4</span>;n++) &#123;</span><br><span class="line">    <span class="keyword">var</span> sp1Nowframedown=<span class="keyword">new</span> cc.SpriteFrame(sp1Texture,cc.rect(<span class="number">32</span>*n,<span class="number">0</span>,<span class="number">32</span>,<span class="number">48</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="创建动画"><a href="#创建动画" class="headerlink" title="创建动画"></a>创建动画</h4><p>使用帧序列创建一个动画，动画播放0.1s<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sp1AnimationDown=<span class="keyword">new</span> cc.Animation(sp1FrameDown,<span class="number">0.1</span>);</span><br></pre></td></tr></table></figure></p>
<h4 id="添加精灵到缓存"><a href="#添加精灵到缓存" class="headerlink" title="添加精灵到缓存"></a>添加精灵到缓存</h4><p>把精灵帧动画添加到动画缓存中<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cc.animationCache.addAnimation(sp1AnimationDown,<span class="string">"sp1down"</span>);</span><br></pre></td></tr></table></figure></p>
<h4 id="获取并运行动画"><a href="#获取并运行动画" class="headerlink" title="获取并运行动画"></a>获取并运行动画</h4><p>以上步骤完成后，就可以在事件中使用动画<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cc.animate(cc.animationCache.getAnimation(<span class="string">"sp1down"</span>)).repeatForever();</span><br></pre></td></tr></table></figure></p>
<h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h3><p>作业内容是点击屏幕，英雄移动到该位置并且播放动画，跟上节课作业差不多，只不过这节课的动画通过动画缓存来获得，而上节课使用的是固定的动画。我在作业中实现了点击按钮可以切换精灵，在行走方向的判断上，我把屏幕在以人物为中心的坐标轴上，画两条对角线，根据分为四个区域，分别判断这四个区域为上下左右。点击相应区域实现人物相应的动画播放。由于是作业，所以代码也就不是那么规范了，看起来是有点乱的，在正式项目中，应该对这些方法进行良好的封装。作业代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> HelloWorldLayer = cc.Layer.extend(&#123;</span><br><span class="line">    sprite:<span class="literal">null</span>,</span><br><span class="line">    chooseRole:<span class="number">0</span>,</span><br><span class="line">    ctor:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">//////////////////////////////</span></span><br><span class="line">        <span class="comment">// 1. super init first</span></span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="comment">//添加背景</span></span><br><span class="line">        <span class="keyword">var</span> bg=<span class="keyword">new</span> cc.Sprite(res.bg_jpg);</span><br><span class="line">        <span class="keyword">this</span>.addChild(bg);</span><br><span class="line">        bg.setPosition(cc.winSize.width/<span class="number">2</span>,cc.winSize.height/<span class="number">2</span>);</span><br><span class="line">        sp1Texture=cc.textureCache.addImage(<span class="string">"res/1.png"</span>);</span><br><span class="line">        sp2Texture=cc.textureCache.addImage(<span class="string">"res/2.png"</span>);</span><br><span class="line">        <span class="comment">// 精灵1</span></span><br><span class="line">        <span class="keyword">var</span> sp1FrameUp=[];</span><br><span class="line">        <span class="keyword">var</span> sp1FrameDown=[];</span><br><span class="line">        <span class="keyword">var</span> sp1FrameLeft=[];</span><br><span class="line">        <span class="keyword">var</span> sp1FrameRight=[];</span><br><span class="line">        <span class="comment">// 精灵2</span></span><br><span class="line">        <span class="keyword">var</span> sp2FrameUp=[];</span><br><span class="line">        <span class="keyword">var</span> sp2FrameDown=[];</span><br><span class="line">        <span class="keyword">var</span> sp2FrameLeft=[];</span><br><span class="line">        <span class="keyword">var</span> sp2FrameRight=[];</span><br><span class="line">         <span class="comment">//添加帧序列</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> n=<span class="number">0</span>;n&lt;<span class="number">4</span>;n++) &#123;</span><br><span class="line">            <span class="comment">// 精灵1</span></span><br><span class="line">          <span class="keyword">var</span> sp1Nowframedown=<span class="keyword">new</span> cc.SpriteFrame(sp1Texture,cc.rect(<span class="number">32</span>*n,<span class="number">0</span>,<span class="number">32</span>,<span class="number">48</span>));</span><br><span class="line">          <span class="keyword">var</span> sp1Nowframeleft=<span class="keyword">new</span> cc.SpriteFrame(sp1Texture,cc.rect(<span class="number">32</span>*n,<span class="number">48</span>,<span class="number">32</span>,<span class="number">48</span>));</span><br><span class="line">          <span class="keyword">var</span> sp1Nowframeright=<span class="keyword">new</span> cc.SpriteFrame(sp1Texture,cc.rect(<span class="number">32</span>*n,<span class="number">48</span>*<span class="number">2</span>,<span class="number">32</span>,<span class="number">48</span>));</span><br><span class="line">          <span class="keyword">var</span> sp1Nowframeup=<span class="keyword">new</span> cc.SpriteFrame(sp1Texture,cc.rect(<span class="number">32</span>*n,<span class="number">48</span>*<span class="number">3</span>,<span class="number">32</span>,<span class="number">48</span>));</span><br><span class="line">          sp1FrameDown.push(sp1Nowframedown);</span><br><span class="line">          sp1FrameLeft.push(sp1Nowframeleft);</span><br><span class="line">          sp1FrameRight.push(sp1Nowframeright);</span><br><span class="line">          sp1FrameUp.push(sp1Nowframeup);</span><br><span class="line">          <span class="comment">// 精灵2</span></span><br><span class="line">          <span class="keyword">var</span> sp2Nowframedown=<span class="keyword">new</span> cc.SpriteFrame(sp2Texture,cc.rect(<span class="number">32</span>*n,<span class="number">0</span>,<span class="number">32</span>,<span class="number">48</span>));</span><br><span class="line">          <span class="keyword">var</span> sp2Nowframeleft=<span class="keyword">new</span> cc.SpriteFrame(sp2Texture,cc.rect(<span class="number">32</span>*n,<span class="number">48</span>*<span class="number">1</span>,<span class="number">32</span>,<span class="number">48</span>));</span><br><span class="line">          <span class="keyword">var</span> sp2Nowframeright=<span class="keyword">new</span> cc.SpriteFrame(sp2Texture,cc.rect(<span class="number">32</span>*n,<span class="number">48</span>*<span class="number">2</span>,<span class="number">32</span>,<span class="number">48</span>));</span><br><span class="line">          <span class="keyword">var</span> sp2Nowframeup=<span class="keyword">new</span> cc.SpriteFrame(sp2Texture,cc.rect(<span class="number">32</span>*n,<span class="number">48</span>*<span class="number">3</span>,<span class="number">32</span>,<span class="number">48</span>));</span><br><span class="line">          sp2FrameUp.push(sp2Nowframeup); </span><br><span class="line">          sp2FrameDown.push(sp2Nowframedown);</span><br><span class="line">          sp2FrameLeft.push(sp2Nowframeleft);</span><br><span class="line">          sp2FrameRight.push(sp2Nowframeright);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//创建动画</span></span><br><span class="line">        <span class="comment">// 精灵1</span></span><br><span class="line">        <span class="keyword">var</span> sp1AnimationUp=<span class="keyword">new</span> cc.Animation(sp1FrameUp,<span class="number">0.1</span>);</span><br><span class="line">        <span class="keyword">var</span> sp1AnimationDown=<span class="keyword">new</span> cc.Animation(sp1FrameDown,<span class="number">0.1</span>);</span><br><span class="line">        <span class="keyword">var</span> sp1AnimationLeft=<span class="keyword">new</span> cc.Animation(sp1FrameLeft,<span class="number">0.1</span>);</span><br><span class="line">        <span class="keyword">var</span> sp1AnimationRight=<span class="keyword">new</span> cc.Animation(sp1FrameRight,<span class="number">0.1</span>);</span><br><span class="line">         <span class="comment">// 精灵2</span></span><br><span class="line">        <span class="keyword">var</span> sp2AnimationUp=<span class="keyword">new</span> cc.Animation(sp2FrameUp,<span class="number">0.1</span>);</span><br><span class="line">        <span class="keyword">var</span> sp2AnimationDown=<span class="keyword">new</span> cc.Animation(sp2FrameDown,<span class="number">0.1</span>);</span><br><span class="line">        <span class="keyword">var</span> sp2AnimationLeft=<span class="keyword">new</span> cc.Animation(sp2FrameLeft,<span class="number">0.1</span>);</span><br><span class="line">        <span class="keyword">var</span> sp2AnimationRight=<span class="keyword">new</span> cc.Animation(sp2FrameRight,<span class="number">0.1</span>);</span><br><span class="line">        <span class="comment">//添加到缓存里</span></span><br><span class="line">        <span class="comment">// 精灵1</span></span><br><span class="line">        cc.animationCache.addAnimation(sp1AnimationUp,<span class="string">"sp1up"</span>);</span><br><span class="line">        cc.animationCache.addAnimation(sp1AnimationDown,<span class="string">"sp1down"</span>);</span><br><span class="line">        cc.animationCache.addAnimation(sp1AnimationLeft,<span class="string">"sp1left"</span>);</span><br><span class="line">        cc.animationCache.addAnimation(sp1AnimationRight,<span class="string">"sp1right"</span>);</span><br><span class="line">        <span class="comment">// 精灵2</span></span><br><span class="line">        cc.animationCache.addAnimation(sp2AnimationUp,<span class="string">"sp2up"</span>);</span><br><span class="line">        cc.animationCache.addAnimation(sp2AnimationDown,<span class="string">"sp2down"</span>);</span><br><span class="line">        cc.animationCache.addAnimation(sp2AnimationLeft,<span class="string">"sp2left"</span>);</span><br><span class="line">        cc.animationCache.addAnimation(sp2AnimationRight,<span class="string">"sp2right"</span>);</span><br><span class="line">        <span class="comment">//创建animate并运行</span></span><br><span class="line">        <span class="keyword">this</span>.sprite=<span class="keyword">new</span> cc.Sprite(sp1Texture,cc.rect(<span class="number">32</span>,<span class="number">0</span>,<span class="number">32</span>,<span class="number">48</span>));</span><br><span class="line">        <span class="keyword">this</span>.chooseRole=<span class="number">1</span>;<span class="comment">// 默认选择鸣人</span></span><br><span class="line">        <span class="keyword">this</span>.addChild(<span class="keyword">this</span>.sprite);</span><br><span class="line">        <span class="keyword">this</span>.sprite.setTag(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">this</span>.sprite.setScale(<span class="number">4</span>);</span><br><span class="line">        <span class="keyword">this</span>.sprite.setPosition(<span class="number">200</span>,<span class="number">200</span>);</span><br><span class="line">        <span class="comment">//添加按钮改变精灵</span></span><br><span class="line">        <span class="keyword">var</span> sp1=<span class="keyword">new</span> cc.MenuItemFont(<span class="string">"选鸣人"</span>,<span class="keyword">this</span>.callback,<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">var</span> sp2=<span class="keyword">new</span> cc.MenuItemFont(<span class="string">"选小樱"</span>,<span class="keyword">this</span>.callback,<span class="keyword">this</span>);</span><br><span class="line">        sp1.setTag(<span class="number">11</span>);</span><br><span class="line">        sp2.setTag(<span class="number">12</span>);</span><br><span class="line">        sp1.setPositionY(<span class="number">50</span>);</span><br><span class="line">        <span class="keyword">var</span> menu=<span class="keyword">new</span> cc.Menu(sp1,sp2);</span><br><span class="line">        <span class="keyword">this</span>.addChild(menu);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    getRole:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.chooseRole;</span><br><span class="line">    &#125;,</span><br><span class="line">    callback:<span class="function"><span class="keyword">function</span>(<span class="params">obj</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">switch</span>(obj.tag)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">11</span>:<span class="comment">//鸣人</span></span><br><span class="line">                <span class="keyword">this</span>.sprite.stopAllActions();</span><br><span class="line">                <span class="keyword">this</span>.sprite.setTexture(cc.textureCache.addImage(<span class="string">"res/1.png"</span>),cc.rect(<span class="number">32</span>,<span class="number">0</span>,<span class="number">32</span>,<span class="number">48</span>));</span><br><span class="line">                <span class="keyword">this</span>.chooseRole=<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">12</span>:<span class="comment">//小樱</span></span><br><span class="line">                <span class="keyword">this</span>.sprite.stopAllActions();</span><br><span class="line">                <span class="keyword">this</span>.sprite.setTexture(cc.textureCache.addImage(<span class="string">"res/2.png"</span>),cc.rect(<span class="number">32</span>,<span class="number">0</span>,<span class="number">32</span>,<span class="number">48</span>));</span><br><span class="line">                <span class="keyword">this</span>.chooseRole=<span class="number">2</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    onEnter:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="comment">//添加触屏事件</span></span><br><span class="line">        cc.eventManager.addListener(&#123;</span><br><span class="line">           event:cc.EventListener.TOUCH_ONE_BY_ONE,</span><br><span class="line">           swallowTouches:<span class="literal">true</span>,<span class="comment">//吞噬事件 不再传递</span></span><br><span class="line">           onTouchBegan:<span class="keyword">this</span>.touchbegan,</span><br><span class="line">           onTouchMoved:<span class="keyword">this</span>.touchmoved,</span><br><span class="line">           onTouchEnded:<span class="keyword">this</span>.touchended</span><br><span class="line">       &#125;,<span class="keyword">this</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    touchbegan:<span class="function"><span class="keyword">function</span>(<span class="params">touch,event</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> x = touch.getLocation().x;</span><br><span class="line">        <span class="keyword">var</span> y = touch.getLocation().y;</span><br><span class="line">        <span class="keyword">var</span> bn = event.getCurrentTarget().getChildByTag(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 走路时间</span></span><br><span class="line">        <span class="keyword">var</span> time = <span class="built_in">Math</span>.round(<span class="built_in">Math</span>.sqrt(<span class="built_in">Math</span>.pow(x-bn.getPositionX(),<span class="number">2</span>)+<span class="built_in">Math</span>.pow(y-bn.getPositionY(),<span class="number">2</span>)))/<span class="number">100</span>;</span><br><span class="line">        bn.stopAllActions();</span><br><span class="line">        <span class="keyword">if</span>(x&lt;bn.getPositionX())&#123;<span class="comment">// 点击人物左侧</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">Math</span>.abs(x-bn.getPositionX())/<span class="built_in">Math</span>.abs(y-bn.getPositionY())&lt;<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(y&lt;bn.getPositionY())&#123;</span><br><span class="line">                    <span class="comment">//  向下走</span></span><br><span class="line">                    <span class="keyword">var</span> role = <span class="built_in">Number</span>(event.getCurrentTarget().getRole());</span><br><span class="line">                    <span class="keyword">var</span> act=role==<span class="number">1</span>?cc.animate(cc.animationCache.getAnimation(<span class="string">"sp1down"</span>)).repeatForever():cc.animate(cc.animationCache.getAnimation(<span class="string">"sp2down"</span>)).repeatForever();</span><br><span class="line">                    bn.runAction(act);</span><br><span class="line">                    bn.runAction(cc.sequence(cc.moveTo(time,cc.p(x,y)),cc.callFunc(</span><br><span class="line">                                <span class="function"><span class="keyword">function</span>(<span class="params">sprite</span>)</span>&#123;</span><br><span class="line">                                    sprite.stopAllActions();</span><br><span class="line">                                &#125;,event.getCurrentTarget().sprite)));</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="comment">// 向上走</span></span><br><span class="line">                     <span class="keyword">var</span> role = event.getCurrentTarget().getRole();</span><br><span class="line">                    <span class="keyword">var</span> act=role==<span class="number">1</span>?cc.animate(cc.animationCache.getAnimation(<span class="string">"sp1up"</span>)).repeatForever():cc.animate(cc.animationCache.getAnimation(<span class="string">"sp2up"</span>)).repeatForever();</span><br><span class="line">                    bn.runAction(act);</span><br><span class="line">                    bn.runAction(cc.sequence(cc.moveTo(time,cc.p(x,y)),cc.callFunc(</span><br><span class="line">                                <span class="function"><span class="keyword">function</span>(<span class="params">sprite</span>)</span>&#123;</span><br><span class="line">                                    sprite.stopAllActions();</span><br><span class="line">                                &#125;,event.getCurrentTarget().sprite)));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">Math</span>.abs(x-bn.getPositionX())/<span class="built_in">Math</span>.abs(y-bn.getPositionY())&gt;=<span class="number">1</span>)&#123;<span class="comment">// 向左走</span></span><br><span class="line">                <span class="keyword">var</span> role = event.getCurrentTarget().getRole();</span><br><span class="line">                <span class="keyword">var</span> act=role==<span class="number">1</span>?cc.animate(cc.animationCache.getAnimation(<span class="string">"sp1left"</span>)).repeatForever():cc.animate(cc.animationCache.getAnimation(<span class="string">"sp2left"</span>)).repeatForever();</span><br><span class="line">                bn.runAction(act);</span><br><span class="line">                bn.runAction(cc.sequence(cc.moveTo(time,cc.p(x,y)),cc.callFunc(</span><br><span class="line">                            <span class="function"><span class="keyword">function</span>(<span class="params">sprite</span>)</span>&#123;</span><br><span class="line">                                sprite.stopAllActions();</span><br><span class="line">                            &#125;,event.getCurrentTarget().sprite)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(x&gt;bn.getPositionX())&#123;</span><br><span class="line">           <span class="keyword">if</span>(<span class="built_in">Math</span>.abs(x-bn.getPositionX())/<span class="built_in">Math</span>.abs(y-bn.getPositionY())&lt;<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(y&lt;bn.getPositionY())&#123;</span><br><span class="line">                    <span class="comment">//  向下走</span></span><br><span class="line">                    <span class="keyword">var</span> role = event.getCurrentTarget().getRole();</span><br><span class="line">                    <span class="keyword">var</span> act=role==<span class="number">1</span>?cc.animate(cc.animationCache.getAnimation(<span class="string">"sp1down"</span>)).repeatForever():cc.animate(cc.animationCache.getAnimation(<span class="string">"sp2down"</span>)).repeatForever();</span><br><span class="line">                    bn.runAction(act);</span><br><span class="line">                    bn.runAction(cc.sequence(cc.moveTo(time,cc.p(x,y)),cc.callFunc(</span><br><span class="line">                                <span class="function"><span class="keyword">function</span>(<span class="params">sprite</span>)</span>&#123;</span><br><span class="line">                                    sprite.stopAllActions();</span><br><span class="line">                                &#125;,event.getCurrentTarget().sprite)));</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="comment">// 向上走</span></span><br><span class="line">                    <span class="keyword">var</span> role = event.getCurrentTarget().getRole();</span><br><span class="line">                    <span class="keyword">var</span> act=role==<span class="number">1</span>?cc.animate(cc.animationCache.getAnimation(<span class="string">"sp1up"</span>)).repeatForever():cc.animate(cc.animationCache.getAnimation(<span class="string">"sp2up"</span>)).repeatForever();</span><br><span class="line">                    bn.runAction(act);</span><br><span class="line">                    bn.runAction(cc.sequence(cc.moveTo(time,cc.p(x,y)),cc.callFunc(</span><br><span class="line">                                <span class="function"><span class="keyword">function</span>(<span class="params">sprite</span>)</span>&#123;</span><br><span class="line">                                    sprite.stopAllActions();</span><br><span class="line">                                &#125;,event.getCurrentTarget().sprite)));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">Math</span>.abs(x-bn.getPositionX())/<span class="built_in">Math</span>.abs(y-bn.getPositionY())&gt;=<span class="number">1</span>)&#123;<span class="comment">// 向右走</span></span><br><span class="line">                <span class="keyword">var</span> role = event.getCurrentTarget().getRole();</span><br><span class="line">                <span class="keyword">var</span> act=role==<span class="number">1</span>?cc.animate(cc.animationCache.getAnimation(<span class="string">"sp1right"</span>)).repeatForever():cc.animate(cc.animationCache.getAnimation(<span class="string">"sp2right"</span>)).repeatForever();</span><br><span class="line">                bn.runAction(act);</span><br><span class="line">                bn.runAction(cc.sequence(cc.moveTo(time,cc.p(x,y)),cc.callFunc(</span><br><span class="line">                            <span class="function"><span class="keyword">function</span>(<span class="params">sprite</span>)</span>&#123;</span><br><span class="line">                                sprite.stopAllActions();</span><br><span class="line">                            &#125;,event.getCurrentTarget().sprite)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    touchmoved:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    touchended:<span class="function"><span class="keyword">function</span>(<span class="params">touch,event</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> HelloWorldScene = cc.Scene.extend(&#123;</span><br><span class="line">    onEnter:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> layer = <span class="keyword">new</span> HelloWorldLayer();</span><br><span class="line">        <span class="keyword">this</span>.addChild(layer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h3 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h3><p><a href="http://www.cocoscvp.com/usercode/2016_04_24/3faf3ea09347be95a5fd15287ff32724995d4f09/" target="_blank" rel="external">http://www.cocoscvp.com/usercode/2016_04_24/3faf3ea09347be95a5fd15287ff32724995d4f09/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;概念&quot;&gt;&lt;a href=&quot;#概念&quot; class=&quot;headerlink&quot; title=&quot;概念&quot;&gt;&lt;/a&gt;概念&lt;/h3&gt;&lt;p&gt;本节内容是掌握cocos中的动画缓存，通过cc.animationCache.addAnimation，可以将预先写好的一组动画放入动画缓存，当一些事件触发时，如触摸点击屏幕精灵时，便可以通过cc.animationCache.getAnimation获取到先前缓存的动画。
    
    </summary>
    
      <category term="cocos2d-js" scheme="http://hjcenry.github.io/categories/cocos2d-js/"/>
    
    
      <category term="cocos2d-js" scheme="http://hjcenry.github.io/tags/cocos2d-js/"/>
    
      <category term="cvp" scheme="http://hjcenry.github.io/tags/cvp/"/>
    
  </entry>
  
  <entry>
    <title>CVP认证学习笔记--(何小成)019--实现帧动画处理</title>
    <link href="http://hjcenry.github.io/2016/04/24/CVP%E8%AE%A4%E8%AF%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0--(%E4%BD%95%E5%B0%8F%E6%88%90)019--%E5%AE%9E%E7%8E%B0%E5%B8%A7%E5%8A%A8%E7%94%BB%E5%A4%84%E7%90%86/"/>
    <id>http://hjcenry.github.io/2016/04/24/CVP认证学习笔记--(何小成)019--实现帧动画处理/</id>
    <published>2016-04-24T14:33:00.000Z</published>
    <updated>2016-04-30T07:46:53.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>本节课的内容是通过帧的纹理定时切换就实现动画效果，游戏中的人物通常在每个状态都会有一个循环播放的动画，我们都知道动画的实质就是一帧一帧的画面，cocos中的动画实现就是将一张一张的图片衔接起来播放，一连贯性来达到一个动画的效果。<a id="more"></a></p>
<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><p>本节课的主要方法如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> animation=<span class="keyword">new</span> cc.Animation();</span><br><span class="line">animation.addSpriteFrameWithFile(frameName);</span><br><span class="line"><span class="keyword">var</span> act = cc.animate(animation).repeatForever();</span><br></pre></td></tr></table></figure></p>
<p>其步骤就是先创建一个Animation，然后通过addSpriteFrameWithFile往Animation中添加精灵帧，然后将其封装为动画，精灵执行这个动画就可以实现帧动画播放。</p>
<h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h3><p>最后课程留下的作业是通过实现点击屏幕，让npc移动，并且能在转向时实现翻转，实际上在本周的第一节课程的作业中，我已经实现了这个效果，只是没有帧动画播放的过程，作业实现如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> HelloWorldLayer = cc.Layer.extend(&#123;</span><br><span class="line">    sprite:<span class="literal">null</span>,</span><br><span class="line">    ac:<span class="literal">null</span>,</span><br><span class="line">    npcDirect:<span class="string">"right"</span>,</span><br><span class="line">    ctor:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">//////////////////////////////</span></span><br><span class="line">        <span class="comment">// 1. super init first</span></span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/////////////////////////////</span></span><br><span class="line">        <span class="comment">// 2. add a menu item with "X" image, which is clicked to quit the program</span></span><br><span class="line">        <span class="comment">//    you may modify it.</span></span><br><span class="line">        <span class="comment">// ask the window size</span></span><br><span class="line">        <span class="keyword">var</span> size = cc.winSize;</span><br><span class="line">       <span class="comment">//添加背景</span></span><br><span class="line">        <span class="keyword">var</span> bg=<span class="keyword">new</span> cc.Sprite(res.bg_jpg);</span><br><span class="line">        <span class="keyword">this</span>.addChild(bg);</span><br><span class="line">        bg.setPosition(size.width/<span class="number">2</span>,size.height/<span class="number">2</span>);</span><br><span class="line">        <span class="comment">//添加动画层</span></span><br><span class="line">        <span class="keyword">var</span> sphero=<span class="keyword">new</span> cc.Sprite(<span class="string">"res/walk01.png"</span>);</span><br><span class="line">        <span class="keyword">var</span> animation=<span class="keyword">new</span> cc.Animation();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">1</span>;i&lt;=<span class="number">5</span>;i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> frameName=<span class="string">"res/walk0"</span>+i+<span class="string">".png"</span>;</span><br><span class="line">            animation.addSpriteFrameWithFile(frameName);</span><br><span class="line">        &#125;</span><br><span class="line">        animation.setDelayPerUnit(<span class="number">0.1</span>);<span class="comment">//300毫秒每帧</span></span><br><span class="line">        <span class="keyword">this</span>.ac=cc.animate(animation).repeatForever();<span class="comment">//包装成动作</span></span><br><span class="line">        <span class="keyword">this</span>.addChild(sphero);</span><br><span class="line">        sphero.setTag(<span class="number">1</span>);</span><br><span class="line">        sphero.setPosition(<span class="number">200</span>,<span class="number">200</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    onEnter:<span class="function"><span class="keyword">function</span>(<span class="params">touch,event</span>)</span>&#123;</span><br><span class="line">       <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="comment">//添加触屏事件</span></span><br><span class="line">       cc.eventManager.addListener(&#123;</span><br><span class="line">           event:cc.EventListener.TOUCH_ONE_BY_ONE,</span><br><span class="line">           swallowTouches:<span class="literal">true</span>,<span class="comment">//吞噬事件 不再传递</span></span><br><span class="line">           onTouchBegan:<span class="keyword">this</span>.touchbegan,</span><br><span class="line">           onTouchMoved:<span class="keyword">this</span>.touchmoved,</span><br><span class="line">           onTouchEnded:<span class="keyword">this</span>.touchended</span><br><span class="line">       &#125;,<span class="keyword">this</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    touchbegan:<span class="function"><span class="keyword">function</span>(<span class="params">touch,event</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> x = touch.getLocation().x;</span><br><span class="line">        <span class="keyword">var</span> y = touch.getLocation().y;</span><br><span class="line">        <span class="keyword">var</span> bn = event.getCurrentTarget().getChildByTag(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 走路时间</span></span><br><span class="line">        <span class="keyword">var</span> time = <span class="built_in">Math</span>.round(<span class="built_in">Math</span>.sqrt(<span class="built_in">Math</span>.pow(x-bn.getPositionX(),<span class="number">2</span>)+<span class="built_in">Math</span>.pow(y-bn.getPositionY(),<span class="number">2</span>)))/<span class="number">100</span>;</span><br><span class="line">        bn.stopAllActions();</span><br><span class="line">        <span class="keyword">if</span>(event.getCurrentTarget().npcDirect==<span class="string">"right"</span>&amp;&amp;x&lt;bn.getPositionX())&#123;</span><br><span class="line">            <span class="comment">// 转向</span></span><br><span class="line">            event.getCurrentTarget().npcDirect = <span class="string">"left"</span>;</span><br><span class="line">            bn.runAction(cc.flipX(<span class="literal">true</span>));<span class="comment">// 水平翻转</span></span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(event.getCurrentTarget().npcDirect==<span class="string">"left"</span>&amp;&amp;x&gt;bn.getPositionX())&#123;</span><br><span class="line">            <span class="comment">// 转向</span></span><br><span class="line">            event.getCurrentTarget().npcDirect = <span class="string">"right"</span>;</span><br><span class="line">            bn.runAction(cc.flipX(<span class="literal">false</span>));<span class="comment">// 翻转回来</span></span><br><span class="line">        &#125;</span><br><span class="line">        cc.log(event.getCurrentTarget().ac);</span><br><span class="line">        <span class="comment">// 执行走路动画</span></span><br><span class="line">        bn.runAction(event.getCurrentTarget().ac);</span><br><span class="line">        bn.runAction(cc.sequence(cc.moveTo(time,cc.p(x,y)),cc.callFunc(<span class="function"><span class="keyword">function</span>(<span class="params">bn</span>)</span>&#123;</span><br><span class="line">            <span class="comment">// 移动动作完成之后停止精灵的动画，并设置精灵图片为第一张</span></span><br><span class="line">            bn.stopAllActions();</span><br><span class="line">            bn.setTexture(<span class="string">"res/walk01.png"</span>);</span><br><span class="line">        &#125;,bn)));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    touchmoved:<span class="function"><span class="keyword">function</span>(<span class="params">touch,event</span>)</span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;,</span><br><span class="line">    touchended:<span class="function"><span class="keyword">function</span>(<span class="params">touch,event</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> HelloWorldScene = cc.Scene.extend(&#123;</span><br><span class="line">    onEnter:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> layer = <span class="keyword">new</span> HelloWorldLayer();</span><br><span class="line">        <span class="keyword">this</span>.addChild(layer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h3 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h3><p><a href="http://www.cocoscvp.com/usercode/2016_04_24/f5abb96ca567c25d6c217acbad8daee4aad15b1e/" target="_blank" rel="external">http://www.cocoscvp.com/usercode/2016_04_24/f5abb96ca567c25d6c217acbad8daee4aad15b1e/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;概念&quot;&gt;&lt;a href=&quot;#概念&quot; class=&quot;headerlink&quot; title=&quot;概念&quot;&gt;&lt;/a&gt;概念&lt;/h3&gt;&lt;p&gt;本节课的内容是通过帧的纹理定时切换就实现动画效果，游戏中的人物通常在每个状态都会有一个循环播放的动画，我们都知道动画的实质就是一帧一帧的画面，cocos中的动画实现就是将一张一张的图片衔接起来播放，一连贯性来达到一个动画的效果。
    
    </summary>
    
      <category term="cocos2d-js" scheme="http://hjcenry.github.io/categories/cocos2d-js/"/>
    
    
      <category term="cocos2d-js" scheme="http://hjcenry.github.io/tags/cocos2d-js/"/>
    
      <category term="cvp" scheme="http://hjcenry.github.io/tags/cvp/"/>
    
  </entry>
  
  <entry>
    <title>CVP认证学习笔记--(何小成)018--批处理纹理绘图</title>
    <link href="http://hjcenry.github.io/2016/04/23/CVP%E8%AE%A4%E8%AF%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0--(%E4%BD%95%E5%B0%8F%E6%88%90)018--%E6%89%B9%E5%A4%84%E7%90%86%E7%BA%B9%E7%90%86%E7%BB%98%E5%9B%BE/"/>
    <id>http://hjcenry.github.io/2016/04/23/CVP认证学习笔记--(何小成)018--批处理纹理绘图/</id>
    <published>2016-04-23T15:44:00.000Z</published>
    <updated>2016-04-30T07:47:00.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>本节课讲了cocos中的批处理纹理绘图，一般情况下，每绘制一个精灵，都需要绘制一个纹理，而cocos中提供批处理纹理绘图SpriteBatchNode，查阅官方文档 <a href="http://www.cocos.com/doc/cocos2d-x-3.0/dd/d2f/classcocos2d_1_1_sprite_batch_node.html#details" target="_blank" rel="external">http://www.cocos.com/doc/cocos2d-x-3.0/dd/d2f/classcocos2d_1_1_sprite_batch_node.html#details</a> <a id="more"></a>这其中对SpriteBatchNode的解释如下：<br>SpriteBatchNode与批量节点类似，如果包含子节点会在一次OpenGL调用内绘制完成(一般称为”batch draw”)<br>一个SpriteBatchNode可以引用一个且只有一个纹理(一个图像文件或一个纹理集)，只有包含该纹理的Sprite可以加入到SpriteBatchNode中。 加入SpriteBatchNode的所有Sprite在一次OpenGL ES调用内绘制完成，而未加入SpriteBatchNode的Sprite每一个都需要单独调用OpenGL ES绘制，这样效率比较低。<br>限制：<br>只有Sprite或Sprite的子类对象才允许作为子节点(或孙子节点，等等)加入到SpriteBatchNode中，例如：particles、labels和layer不能加入SpriteBatchNode。<br>所有子节点的”alias”属性必须统一为Aliased或Antialiased，不能二者同时存在，因为”alias”是纹理的属性，而SpriteBatchNode全部的子节点共用一个纹理。<br>由cocos官方文档可见，cocos中批处理纹理绘图，可以使多个Sprite在一个OpenGL ES调用内绘制完成，很明显，这样减少了Sprite绘制的次数，从而提高画面渲染的效率。</p>
<h3 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h3><p>使用SpriteBatchNode的代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> HelloWorldLayer = cc.Layer.extend(&#123;</span><br><span class="line">    sprite:<span class="literal">null</span>,</span><br><span class="line">    ctor:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">//////////////////////////////</span></span><br><span class="line">        <span class="comment">// 1. super init first</span></span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> add=<span class="keyword">new</span> cc.MenuItemFont(<span class="string">"添加Sprite"</span>,<span class="keyword">this</span>.callback,<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">var</span> menu=<span class="keyword">new</span> cc.Menu(add);</span><br><span class="line">        <span class="keyword">this</span>.addChild(menu,<span class="number">10000</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    callback:<span class="function"><span class="keyword">function</span>(<span class="params">obj</span>)</span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.sprite==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">this</span>.sprite=<span class="keyword">new</span> cc.SpriteBatchNode(<span class="string">"res/HelloWorld.png"</span>,<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">this</span>.addChild(<span class="keyword">this</span>.sprite);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> sp2=<span class="keyword">new</span> cc.Sprite(<span class="keyword">this</span>.sprite.texture,cc.rect(<span class="number">0</span>,<span class="number">0</span>,<span class="number">195</span>,<span class="number">270</span>));</span><br><span class="line">        <span class="keyword">this</span>.sprite.addChild(sp2);</span><br><span class="line">        sp2.setPosition(<span class="built_in">Math</span>.random()*<span class="number">300</span>+<span class="number">300</span>,<span class="built_in">Math</span>.random()*<span class="number">300</span>);</span><br><span class="line">        sp2.setScale(<span class="built_in">Math</span>.random());</span><br><span class="line">        sp2.setRotation(<span class="built_in">Math</span>.round(<span class="built_in">Math</span>.random()*<span class="number">360</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> HelloWorldScene = cc.Scene.extend(&#123;</span><br><span class="line">    onEnter:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._super();</span><br><span class="line">        <span class="keyword">var</span> layer = <span class="keyword">new</span> HelloWorldLayer();</span><br><span class="line">        <span class="keyword">this</span>.addChild(layer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>本节课内容的api介绍很简单，重点是要理解SpriteBatchNode的运作原理，具体查阅官方文档就能明白，很多时候程序中可以通过SpriteBatchNode来优化Sprite渲染次数，从而提高运行效率。</p>
<h3 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h3><p><a href="http://www.cocoscvp.com/usercode/2016_04_23/5608bd70128bddf09770f642e784f35643acadc9/" target="_blank" rel="external">http://www.cocoscvp.com/usercode/2016_04_23/5608bd70128bddf09770f642e784f35643acadc9/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;概念&quot;&gt;&lt;a href=&quot;#概念&quot; class=&quot;headerlink&quot; title=&quot;概念&quot;&gt;&lt;/a&gt;概念&lt;/h3&gt;&lt;p&gt;本节课讲了cocos中的批处理纹理绘图，一般情况下，每绘制一个精灵，都需要绘制一个纹理，而cocos中提供批处理纹理绘图SpriteBatchNode，查阅官方文档 &lt;a href=&quot;http://www.cocos.com/doc/cocos2d-x-3.0/dd/d2f/classcocos2d_1_1_sprite_batch_node.html#details&quot;&gt;http://www.cocos.com/doc/cocos2d-x-3.0/dd/d2f/classcocos2d_1_1_sprite_batch_node.html#details&lt;/a&gt;
    
    </summary>
    
      <category term="cocos2d-js" scheme="http://hjcenry.github.io/categories/cocos2d-js/"/>
    
    
      <category term="cocos2d-js" scheme="http://hjcenry.github.io/tags/cocos2d-js/"/>
    
      <category term="cvp" scheme="http://hjcenry.github.io/tags/cvp/"/>
    
  </entry>
  
</feed>
